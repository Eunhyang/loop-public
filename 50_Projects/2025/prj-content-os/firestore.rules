rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // Helper Functions
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is admin (based on custom claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // Check if user owns the resource
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }

    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    // Check if request is from server (service account)
    // Usage: Future migration to allow server-only writes for vault_*/kpi_*
    function isServer() {
      return isAuthenticated() && request.auth.token.service_account == true;
    }

    // Validate required fields for contentos_contents
    // Supports both legacy format and future format with source map
    function isValidContent() {
      let data = request.resource.data;

      // Common required fields (always at top-level)
      let commonValid = data.keys().hasAll(['title', 'status', 'finalScore', 'createdAt', 'updatedAt'])
        && data.status in ['candidate', 'selected', 'rejected', 'published']
        && data.finalScore >= 0 && data.finalScore <= 100;

      // Legacy structure: all fields at top level
      let hasLegacy = data.keys().hasAll(['videoId', 'channelName', 'keyword', 'marketScore', 'fitScore', 'saturation'])
        && data.marketScore >= 0 && data.marketScore <= 100
        && data.fitScore >= 0 && data.fitScore <= 100
        && data.saturation >= 0 && data.saturation <= 1;

      // Future structure: scores still top-level + source map (additional metadata)
      let hasFuture = data.keys().hasAll(['marketScore', 'fitScore', 'saturation', 'source'])
        && data.marketScore >= 0 && data.marketScore <= 100
        && data.fitScore >= 0 && data.fitScore <= 100
        && data.saturation >= 0 && data.saturation <= 1
        && data.source is map
        && data.source.size() > 0;

      return commonValid && (hasLegacy || hasFuture);
    }

    // Validate required fields for contentos_publishes
    // Supports conditional validation based on publish status
    function isValidPublish() {
      let data = request.resource.data;
      let baseValid = data.keys().hasAll(['contentId', 'status', 'createdAt', 'updatedAt'])
        && data.status in ['published', 'scheduled', 'failed', 'queued', 'running', 'success'];

      let completionFields = data.status in ['success', 'published']
        ? data.keys().hasAll(['youtubeVideoId', 'publishedAt'])
        : (data.status == 'scheduled' ? data.keys().hasAll(['youtubeVideoId']) : true);

      return baseValid && completionFields;
    }

    // Validate required fields for contentos_assets
    function isValidAsset() {
      return request.resource.data.keys().hasAll([
        'type', 'url', 'filename', 'mimeType', 'createdAt', 'updatedAt'
      ])
      && request.resource.data.type in ['thumbnail', 'script', 'video', 'audio'];
    }

    // ========================================
    // Root Collection: loop
    // ========================================

    match /loop/{document=**} {
      // Default: deny all (explicit rules below)
      allow read, write: if false;
    }

    // ========================================
    // Root Document: loop/main
    // ========================================

    match /loop/main {
      // Only admins can read/write root document
      allow read: if isAdmin();
      allow write: if isAdmin();

      // ========================================
      // ContentOS Subcollections
      // ========================================

      // contentos_contents: 인증된 사용자는 읽기 가능, 쓰기는 admin만
      match /contentos_contents/{contentId} {
        allow read: if isAuthenticated();
        allow create: if isAdmin() && isValidContent();
        allow update: if isAdmin() && isValidContent();
        allow delete: if isAdmin();
      }

      // contentos_publishes: 인증된 사용자는 읽기 가능, 쓰기는 admin만
      match /contentos_publishes/{publishId} {
        allow read: if isAuthenticated();
        allow create: if isAdmin() && isValidPublish();
        allow update: if isAdmin(); // 성과 데이터 업데이트 (validation 완화)
        allow delete: if isAdmin();
      }

      // contentos_assets: 인증된 사용자는 읽기 가능, 쓰기는 admin만
      match /contentos_assets/{assetId} {
        allow read: if isAuthenticated();
        allow create: if isAdmin() && isValidAsset();
        allow update: if isAdmin();
        allow delete: if isAdmin();
      }

      // ========================================
      // Vault Sync Subcollections (Read-Only)
      // ========================================

      // vault_projects: 읽기 전용 (n8n sync 전용)
      match /vault_projects/{projectId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin(); // n8n이 admin 권한으로 동기화
      }

      // vault_tasks: 읽기 전용 (n8n sync 전용)
      match /vault_tasks/{taskId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin(); // n8n이 admin 권한으로 동기화
      }

      // vault_pending_reviews: 인증된 사용자는 읽기, admin은 쓰기
      match /vault_pending_reviews/{reviewId} {
        allow read: if isAuthenticated();
        allow create: if isAdmin(); // n8n이 생성
        allow update: if isAuthenticated(); // 사용자가 승인/거부 가능
        allow delete: if isAdmin();
      }

      // ========================================
      // KPI Subcollections
      // ========================================

      // kpi_defs: 읽기 전용 (admin만 수정)
      match /kpi_defs/{kpiId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // kpi_rollups: 읽기 전용 (n8n이 집계)
      match /kpi_rollups/{scopeId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin(); // n8n이 admin 권한으로 집계

        // days subcollection
        match /days/{dayId} {
          allow read: if isAuthenticated();
          allow write: if isAdmin(); // n8n이 admin 권한으로 집계
        }
      }
    }

    // ========================================
    // Test Rules (Development Only)
    // ========================================

    // Uncomment below for testing with Firestore Emulator
    // match /test/{document=**} {
    //   allow read, write: if true;
    // }
  }
}
