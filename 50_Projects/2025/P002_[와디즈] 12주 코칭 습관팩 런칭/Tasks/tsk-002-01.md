---
entity_type: Task
entity_id: tsk-002-01
entity_name: ì™€ë””ì¦ˆ ë¦¬ì›Œë“œ ë°œì†¡ - 2ë…„/1ë…„ êµ¬ë…ê¶Œ í”„ë¡œëª¨ì…˜ ì½”ë“œ ìƒì„± ë° í…ŒìŠ¤íŠ¸
created: 2026-01-09
updated: 2026-01-09
status: done
project_id: prj-002
parent_id: prj-002
assignee: ê¹€ì€í–¥
priority: high
start_date: 2026-01-07
due: 2026-01-09
closed: 2026-01-09
aliases:
  - tsk-002-01
tags:
  - revenuecat
  - promotion
  - wadiz
type: dev
---

# ì™€ë””ì¦ˆ ë¦¬ì›Œë“œ ë°œì†¡ - 2ë…„/1ë…„ êµ¬ë…ê¶Œ í”„ë¡œëª¨ì…˜ ì½”ë“œ ìƒì„± ë° í…ŒìŠ¤íŠ¸

> Task ID: `tsk-002-01` | Project: `prj-002` | Status: done

## ë°°ê²½

ì™€ë””ì¦ˆ 12ì£¼ ì½”ì¹­ ìŠµê´€íŒ© ë¦¬ì›Œë“œ ë°œì†¡ì„ ìœ„í•´ 2ë…„ êµ¬ë…ê¶Œ 2ê±´, 1ë…„ êµ¬ë…ê¶Œ 4ê±´ì˜ í”„ë¡œëª¨ì…˜ ì½”ë“œ ìƒì„±ì´ í•„ìš”í–ˆìŒ. ê¸°ì¡´ RevenueCat APIëŠ” duration ê¸°ë°˜(yearly ìµœëŒ€ 365ì¼)ë§Œ ì§€ì›í•˜ì—¬ 2ë…„(24ê°œì›”) êµ¬ë…ê¶Œì„ ì •í™•í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ì—†ì—ˆìŒ.

## ì™„ë£Œëœ ì‘ì—…

### 1. RevenueCat 2ë…„ êµ¬ë…ê¶Œ end_time_ms ê¸°ëŠ¥ ê°œë°œ

**ë³€ê²½ ì‚¬í•­:**
- RevenueCatPayload íƒ€ì… ì¶”ê°€ (`duration | end_time_ms`)
- `convertToDuration()` â†’ `convertToPayload()` í•¨ìˆ˜ ë³€ê²½
- 12ê°œì›” ì´ˆê³¼ ì‹œ `end_time_ms` ì‚¬ìš© (ì •í™•í•œ ìº˜ë¦°ë” ê¸°ì¤€ ë§Œë£Œì¼)
- `calculateEndTimeMs()` í•¨ìˆ˜ ì¶”ê°€ (ì›”ë§ ë¡¤ì˜¤ë²„ ë°©ì§€ í¬í•¨)

**ê´€ë ¨ ì»¤ë°‹:**
- `83ec9b3` feat(functions): RevenueCat 2ë…„ êµ¬ë…ê¶Œ end_time_ms ì§€ì›
- `db22438` fix(functions): RevenueCat API í˜¸ì¶œ ì•ˆì •ì„± ê°œì„ 
- `40a44ba` style(functions): ESLint í¬ë§·íŒ… ì ìš©

### 2. ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì§„í–‰

**í…ŒìŠ¤íŠ¸ í™˜ê²½:**
- í…ŒìŠ¤íŠ¸ ì½”ë“œ: `WADIZ24M-001` (24ê°œì›”)
- í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì: `QIFVVnu0VeWWWR8ZBFgfSWw9MvN2`

**Firebase Functions ë¡œê·¸ í™•ì¸:**
```
[RevenueCat] Granting promotional entitlement: {
  userId: 'QIFVVnu0VeWWWR8ZBFgfSWw9MvN2',
  payload: { end_time_ms: 1831015264423 },
  code: 'WADIZ24M-001'
}
```

**RevenueCat API ì§ì ‘ ì¡°íšŒë¡œ ê²€ì¦:**
```json
{
  "pro": {
    "expires_date": "2028-01-09T07:21:04Z",
    "purchase_date": "2026-01-09T07:21:04Z",
    "product_identifier": "rc_promo_pro_custom"
  }
}
```

**ê²°ê³¼**: ë§Œë£Œì¼ì´ ì •í™•íˆ 2ë…„ í›„(2028-01-09)ë¡œ ì„¤ì •ë¨ âœ…

### 3. ì‹¤ì œ ë°œì†¡ìš© í”„ë¡œëª¨ì…˜ ì½”ë“œ ìƒì„±

Python ìŠ¤í¬ë¦½íŠ¸(`scripts/promotion/upload_promotion_codes.py`) ì‚¬ìš©í•˜ì—¬ Firestoreì— ì—…ë¡œë“œ

**24ê°œì›” êµ¬ë…ê¶Œ (2ê±´)**

| ì½”ë“œ | ê¸°ê°„ | ì‚¬ìš©íšŸìˆ˜ | ìƒíƒœ |
|------|------|---------|------|
| WADIZ24M-002 | 24ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |
| WADIZ24M-003 | 24ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |

**12ê°œì›” êµ¬ë…ê¶Œ (4ê±´)**

| ì½”ë“œ | ê¸°ê°„ | ì‚¬ìš©íšŸìˆ˜ | ìƒíƒœ |
|------|------|---------|------|
| WADIZ12M-001 | 12ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |
| WADIZ12M-002 | 12ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |
| WADIZ12M-003 | 12ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |
| WADIZ12M-004 | 12ê°œì›” | 1íšŒ | âœ… ë°œì†¡ ê°€ëŠ¥ |

**í…ŒìŠ¤íŠ¸ ì‚¬ìš©ë¨ (ë°œì†¡ ë¶ˆê°€)**

| ì½”ë“œ | ìƒíƒœ |
|------|------|
| WADIZ24M-001 | âŒ í…ŒìŠ¤íŠ¸ë¡œ ì†Œì§„ë¨ |

## ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### end_time_ms vs duration ì°¨ì´

| ë°©ì‹ | ì„¤ëª… | ì œí•œ |
|------|------|------|
| `duration` | RevenueCat ë¯¸ë¦¬ ì •ì˜ëœ ê¸°ê°„ | daily, weekly, monthly, yearly ë“± (ìµœëŒ€ 365ì¼) |
| `end_time_ms` | ì •í™•í•œ UTC timestampë¡œ ë§Œë£Œì¼ ì§ì ‘ ì§€ì • | 12ê°œì›” ì´ˆê³¼ ì‹œ ì‚¬ìš© |

### calculateEndTimeMs() í•¨ìˆ˜ ë¡œì§

```typescript
function calculateEndTimeMs(months: number): number {
  const now = Date.now();
  const date = new Date(now);
  const originalDay = date.getUTCDate();
  date.setUTCMonth(date.getUTCMonth() + months);
  // ì›”ë§ ë¡¤ì˜¤ë²„ ë°©ì§€
  if (date.getUTCDate() < originalDay) {
    date.setUTCDate(0);
  }
  return date.getTime();
}
```

### ê²€ì¦ ë°©ë²•

1. Firebase Functions ë¡œê·¸ì—ì„œ payload í™•ì¸ (`end_time_ms` ì‚¬ìš© ì—¬ë¶€)
2. RevenueCat APIë¡œ subscriber ì¡°íšŒí•˜ì—¬ ì‹¤ì œ ì €ì¥ëœ `expires_date` í™•ì¸

## ê²°ê³¼

- âœ… 2ë…„ êµ¬ë…ê¶Œ `end_time_ms` ê¸°ëŠ¥ ì •ìƒ ë™ì‘ í™•ì¸
- âœ… ì™€ë””ì¦ˆ ë¦¬ì›Œë“œ ë°œì†¡ìš© í”„ë¡œëª¨ì…˜ ì½”ë“œ 6ê°œ ìƒì„± ì™„ë£Œ
- âœ… ê³ ê°ì—ê²Œ ë°œì†¡ ì¤€ë¹„ ì™„ë£Œ

## ê´€ë ¨ íŒŒì¼

- `sosi/functions/src/revenuecat-helper.ts` - RevenueCat API í—¬í¼ í•¨ìˆ˜ (sosi í”„ë¡œì íŠ¸)
- `sosi/scripts/promotion/upload_promotion_codes.py` - í”„ë¡œëª¨ì…˜ ì½”ë“œ ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸

## Firestore ìŠ¤í‚¤ë§ˆ

**ì»¬ë ‰ì…˜**: `promotion_codes`

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| code | string | í”„ë¡œëª¨ì…˜ ì½”ë“œ |
| durationMonths | number | êµ¬ë… ê¸°ê°„ (ê°œì›”) |
| maxUses | number | ìµœëŒ€ ì‚¬ìš© íšŸìˆ˜ |
| currentUses | number | í˜„ì¬ ì‚¬ìš© íšŸìˆ˜ |
| usedBy | array | ì‚¬ìš©í•œ ì‚¬ìš©ì ID ëª©ë¡ |
| type | string | personal/group/event |
| validFrom | timestamp | ìœ íš¨ ì‹œì‘ì¼ |
| validUntil | timestamp | ìœ íš¨ ì¢…ë£Œì¼ |

**ë‹¨ì¼ ì‚¬ìš© ê°•ì œ**: `maxUses: 1` + `currentUses` ì¦ê°€ë¡œ ì¤‘ë³µ ì‚¬ìš© ë°©ì§€

## Codex Review í”¼ë“œë°±

1. âœ… íŒŒì¼ ê²½ë¡œ ìˆ˜ì •ë¨ (sosi í”„ë¡œì íŠ¸ ëª…ì‹œ)
2. âš ï¸ 12ê°œì›” `duration` ê²½ë¡œ ë¯¸í…ŒìŠ¤íŠ¸ - ê¸°ì¡´ ê²€ì¦ ì™„ë£Œëœ ê¸°ëŠ¥ì´ë¯€ë¡œ ë³„ë„ í…ŒìŠ¤íŠ¸ ìƒëµ
3. âœ… Firestore ìŠ¤í‚¤ë§ˆ ì¶”ê°€ë¨
4. ğŸ“ í…ŒìŠ¤íŠ¸ ì½”ë“œ(WADIZ24M-001) ì²˜ë¦¬: Firestoreì—ì„œ `currentUses: 1`ë¡œ ìë™ ì†Œì§„ ì²˜ë¦¬ë¨
5. ğŸ“ 12ê°œì›” í”„ë¡œëª¨ì…˜: `duration: yearly`(365ì¼) ì‚¬ìš© - 1ë…„ êµ¬ë…ê¶Œì€ ìº˜ë¦°ë” ì •ë ¬ ë¶ˆí•„ìš”

---

**Created**: 2026-01-09 | **Closed**: 2026-01-09 | **Assignee**: ê¹€ì€í–¥
