---
entity_type: Task
entity_id: "tsk-88fe92-1767962816471"
entity_name: Promotion - Redemption ì›ì¥ ê¸°ë¡ ì¶”ê°€
created: 2026-01-09
updated: 2026-01-09
status: doing
project_id: prj-002
parent_id: prj-002
assignee: ê¹€ì€í–¥
priority: high
start_date: 2026-01-09
due: 2026-01-09
aliases:
  - tsk-002-02
tags:
  - firebase
  - promotion
  - revenuecat
type: dev
---

# Promotion - Redemption ì›ì¥ ê¸°ë¡ ì¶”ê°€

> Task ID: `tsk-002-02` | Project: `prj-002` | Status: todo

## Notes

## ğŸ“Š ì•„í‚¤í…ì²˜ ë„ì‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Promotion Redemption Ledger Architecture            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Firebase Functions (promotions.ts)                        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  validateAndApplyPromoCode()                             â”‚   â”‚
â”‚  â”‚       â”‚                                                   â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€â†’ 1. ì½”ë“œ ê²€ì¦                                   â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€â†’ 2. RevenueCat API í˜¸ì¶œ                        â”‚   â”‚
â”‚  â”‚       â”‚         â”‚                                         â”‚   â”‚
â”‚  â”‚       â”‚         â†“ (ì‘ë‹µ: expires_date, payload)          â”‚   â”‚
â”‚  â”‚       â”‚                                                   â”‚   â”‚
â”‚  â”‚       â””â”€â”€â†’ 3. Firestore íŠ¸ëœì­ì…˜                         â”‚   â”‚
â”‚  â”‚                 â”‚                                         â”‚   â”‚
â”‚  â”‚                 â”œâ”€â”€â†’ promotion_codes/{code} ì—…ë°ì´íŠ¸     â”‚   â”‚
â”‚  â”‚                 â”œâ”€â”€â†’ users/{userId}/premium ì—…ë°ì´íŠ¸     â”‚   â”‚
â”‚  â”‚                 â””â”€â”€â†’ ğŸ†• promotion_redemptions ì¶”ê°€       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                          â”‚
â”‚       â†“                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Firestore Collections                                     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  promotion_codes/{code}         â† ê¸°ì¡´                    â”‚   â”‚
â”‚  â”‚  users/{userId}                 â† ê¸°ì¡´                    â”‚   â”‚
â”‚  â”‚  ğŸ†• promotion_redemptions/{id}  â† ì‹ ê·œ (ì›ì¥)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ ë°°ê²½

- í˜„ì¬ í”„ë¡œëª¨ì…˜ ì½”ë“œ ì‚¬ìš© ì‹œ RevenueCatì— entitlementë§Œ ë¶€ì—¬í•˜ê³  ëë‚¨
- ë‚˜ì¤‘ì— ë¶„ìŸ/ë³µêµ¬ ì‹œ ì¦ê±°ê°€ ì—†ìŒ
- Proê°€ ê°‘ìê¸° í•´ì œë˜ëŠ” ê²½ìš° ë³µêµ¬ ì–´ë ¤ì›€

## ğŸ¯ êµ¬í˜„ ë²”ìœ„

### ì£¼ìš” ê¸°ëŠ¥
1. í”„ë¡œëª¨ì…˜ ì½”ë“œ redemption ì„±ê³µ ì‹œ `promotion_redemptions` ì»¬ë ‰ì…˜ì— ì›ì¥ ê¸°ë¡
2. RevenueCat API ì‘ë‹µ ì •ë³´ í¬í•¨ (expires_date, payload íƒ€ì…)
3. ë¶„ìŸ/ë³µêµ¬ ì‹œ ì¦ê±°ë¡œ í™œìš© ê°€ëŠ¥í•œ ìƒì„¸ ì •ë³´ ì €ì¥

### íŒŒì¼ êµ¬ì¡°
```
functions/src/
â”œâ”€â”€ promotions.ts          â† ìˆ˜ì • (ì›ì¥ ê¸°ë¡ ì¶”ê°€)
â””â”€â”€ revenuecat-helper.ts   â† ìˆ˜ì • (ì‘ë‹µ ì •ë³´ ë°˜í™˜ ê°œì„ )
```

## ğŸ“ ìƒì„¸ ìš”êµ¬ì‚¬í•­

### 1. revenuecat-helper.ts ìˆ˜ì •

**ë³€ê²½ í›„ ë°˜í™˜ê°’**:
```typescript
{
  success: boolean;
  message: string;
  expires_date?: string;       // "2028-01-09T07:21:04Z"
  payload?: RevenueCatPayload; // { duration: "yearly" } or { end_time_ms: 123... }
}
```

### 2. promotions.ts ìˆ˜ì •

**íŠ¸ëœì­ì…˜ ë‚´ë¶€ì— ì¶”ê°€**:
```typescript
const redemptionRef = db.collection("promotion_redemptions").doc();
transaction.set(redemptionRef, {
  code: code,
  userId: userId,
  expires_date: revenueCatResult.expires_date || expiryDate.toISOString(),
  granted_at: now,
  durationMonths: durationMonths,
  rc_payload: revenueCatResult.payload || null,
  rc_success: revenueCatResult.success,
  deviceId: deviceId || null,
});
```

### 3. Firestore ì»¬ë ‰ì…˜ ìŠ¤í‚¤ë§ˆ

**ì»¬ë ‰ì…˜**: `promotion_redemptions`

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `code` | string | í”„ë¡œëª¨ì…˜ ì½”ë“œ |
| `userId` | string | Firebase Auth UID |
| `expires_date` | string (ISO) | RevenueCat ë§Œë£Œì¼ |
| `granted_at` | timestamp | ë¶€ì—¬ ì‹œê° |
| `durationMonths` | number | êµ¬ë… ê¸°ê°„ (ê°œì›”) |
| `rc_payload` | object | RevenueCat ìš”ì²­ payload |
| `rc_success` | boolean | RevenueCat ì„±ê³µ ì—¬ë¶€ |
| `deviceId` | string? | ë””ë°”ì´ìŠ¤ ID (ì„ íƒ) |

## âœ… ì„±ê³µ ê¸°ì¤€

- [ ] RevenueCat ì„±ê³µ ì‹œ `promotion_redemptions` ì»¬ë ‰ì…˜ì— ë¬¸ì„œ ìƒì„±ë¨
- [ ] `expires_date`ê°€ RevenueCat ì‘ë‹µê³¼ ì¼ì¹˜í•¨
- [ ] `rc_payload`ì— ì‚¬ìš©ëœ payload íƒ€ì…ì´ ì •í™•íˆ ê¸°ë¡ë¨
- [ ] ê¸°ì¡´ í”„ë¡œëª¨ì…˜ ì½”ë“œ ê¸°ëŠ¥ì— ì˜í–¥ ì—†ìŒ (íšŒê·€ ì—†ìŒ)
- [ ] íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ ì‹œ ì›ì¥ë„ í•¨ê»˜ ë¡¤ë°±ë¨
- [ ] ë°°í¬ í›„ ì‹¤ì œ ì½”ë“œ ì‚¬ìš© ì‹œ ì›ì¥ ê¸°ë¡ í™•ì¸

## ğŸ¤– Codex Review í”¼ë“œë°±

### ê²°ì • ì‚¬í•­

| í•­ëª© | ê²°ì • |
|------|------|
| **RC ì‹¤íŒ¨ ì‹œ ë¬¸ì„œ ì‘ì„±** | âŒ ë¯¸ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€, ì„±ê³µ ì‹œì—ë§Œ ê¸°ë¡) |
| **ë©±ë“±ì„±/ì¤‘ë³µ ë°©ì§€** | âœ… ê¸°ì¡´ `usedBy` ì²´í¬ë¡œ ì´ë¯¸ ë°©ì§€ë¨ |
| **íŠ¸ëœì­ì…˜ ìœ„ì¹˜** | RC í˜¸ì¶œ â†’ ì„±ê³µ â†’ Firestore íŠ¸ëœì­ì…˜ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€) |
| **granted_at ì†ŒìŠ¤** | `admin.firestore.Timestamp.now()` (ì„œë²„ ì‹œê°„) |
| **expires_date íƒ€ì…** | string (ISO 8601) - RC ì‘ë‹µ ê·¸ëŒ€ë¡œ ì €ì¥ |
| **ë°±í•„/ë§ˆì´ê·¸ë ˆì´ì…˜** | Forward-only (ê¸°ì¡´ redemption ë¯¸ì§€ì›) |
| **Firestore ë³´ì•ˆ** | Functionsë§Œ ì“°ê¸° ê°€ëŠ¥ (í´ë¼ì´ì–¸íŠ¸ write: false) |

### í–¥í›„ ê°œì„  ê³ ë ¤ì‚¬í•­ (Phase 2)

- RC ì‹¤íŒ¨ ì‹œì—ë„ ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ (rc_success=false)
- Correlation ID ì¶”ê°€ (ë””ë²„ê¹…ìš©)
- ê¸°ì¡´ redemption ë°±í•„ ìŠ¤í¬ë¦½íŠ¸

## ğŸ”§ êµ¬í˜„ ì™„ë£Œ

### ë³€ê²½ ì‚¬í•­
1. **revenuecat-helper.ts**
   - ë°˜í™˜ íƒ€ì…ì— `expires_date`, `payload` ì¶”ê°€
   - RevenueCat ì‘ë‹µì—ì„œ expires_date ì¶”ì¶œ (pro â†’ first active entitlement)
   - ëª¨ë“  ì—ëŸ¬ ê²½ë¡œì—ì„œ null ë°˜í™˜

2. **promotions.ts**
   - íŠ¸ëœì­ì…˜ ë‚´ `promotion_redemptions` ì»¬ë ‰ì…˜ ê¸°ë¡ ì¶”ê°€
   - RevenueCat expires_date ìš°ì„  ì‚¬ìš© (ì¼ê´€ì„± ê°œì„ )
   - ëª¨ë“  í•„ë“œ safe defaults ë³´ì¥

### PR
- https://github.com/Eunhyang/sosi-flutter/pull/6

### Codex Review í”¼ë“œë°±
- âœ… expires_date ì¼ê´€ì„± ë¬¸ì œ ìˆ˜ì • ì™„ë£Œ
- âš ï¸ RevenueCat íŠ¸ëœì­ì…˜ ì™¸ë¶€ í˜¸ì¶œ (ê¸°ì¡´ ì•„í‚¤í…ì²˜ ì´ìŠˆ, ë³„ë„ ê°œì„  í•„ìš”)
- âš ï¸ ë™ì‹œì„± maxUses ê²€ì¦ (ê¸°ì¡´ ì•„í‚¤í…ì²˜ ì´ìŠˆ, ë³„ë„ ê°œì„  í•„ìš”)

---

**Created**: 2026-01-09 | **Assignee**: ê¹€ì€í–¥
