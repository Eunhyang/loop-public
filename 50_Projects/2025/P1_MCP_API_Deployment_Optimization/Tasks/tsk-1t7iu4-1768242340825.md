---
entity_type: Task
entity_id: tsk-1t7iu4-1768242340825
entity_name: Blue-Green Deployment - MCP API
created: '2026-01-13'
updated: '2026-01-13'
status: todo
project_id: prj-1t7iu4
parent_id: prj-1t7iu4
assignee: 김은향
priority: medium
start_date: '2026-01-13'
due: '2026-01-13'
aliases:
- tsk-1t7iu4-1768242340825
tags: []
type: dev
---

# Blue-Green Deployment - MCP API

## 설명

Blue-Green Deployment 전략을 MCP API에 도입하여 zero-downtime 배포를 구현합니다. 현재 배포 방식은 `docker compose up -d --build`로 인해 5-10분 다운타임이 발생합니다. 이를 개선하여 배포 중에도 API 서비스가 중단 없이 운영되도록 합니다.

## 체크리스트

- [ ] Blue-Green 배포 스크립트 작성
- [ ] Health check 엔드포인트 동작 확인
- [ ] Nginx 설정 수정 (upstream 동적 전환)
- [ ] 배포 스크립트 테스트 (local)
- [ ] NAS 환경 테스트
- [ ] 롤백 시나리오 검증
- [ ] 문서 업데이트

## 참고

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-1t7iu4 (MCP API - Deployment Optimization)
- Architecture Pattern: Docker multi-container with nginx reverse proxy
- Current Setup: nginx (8080) → loop-auth (8084→8083) + loop-api (8082→8081)
- Deployment Method: Replace `docker compose up -d --build` with Blue-Green strategy

**Current Problems:**
1. **Downtime during rebuild**: `docker compose up -d --build` causes 5-10 min downtime (frontend npm build + Python deps install)
2. **Single container deployment**: Only one `loop-api` container exists, no redundancy
3. **OAuth session disruption**: Although loop-auth is separate, API downtime affects user experience
4. **No rollback capability**: If new version fails, must rebuild previous version (another 5-10 min)

**Blue-Green Strategy:**
- **Blue**: Current production container (e.g., `loop-api-blue`)
- **Green**: New version container (e.g., `loop-api-green`)
- **Workflow**: Build Green → Health check Green → Nginx switch to Green → Remove Blue
- **Rollback**: Nginx switch back to Blue (instant)

**File Structure:**
```
/Users/gim-eunhyang/dev/loop/public/
├── docker-compose.blue-green.yml    # Blue-Green 배포용 compose 파일
├── nginx-blue-green.conf            # 동적 upstream 설정
├── scripts/
│   ├── deploy-blue-green.sh         # Blue-Green 배포 스크립트
│   └── rollback.sh                  # 롤백 스크립트
└── .env.blue-green                  # Blue-Green 환경변수 (색상 식별)
```

**Implementation Details:**

**1. Docker Compose Changes:**
- Create `docker-compose.blue-green.yml` with two API services:
  - `loop-api-blue` (port 8082)
  - `loop-api-green` (port 8085)
- Nginx routes traffic to active color (default: blue)
- Both containers use same volumes/env but different ports

**2. Nginx Configuration:**
- File: `/Users/gim-eunhyang/dev/loop/public/nginx-blue-green.conf`
- Dynamic upstream switching via environment variable or config reload
- Approach: Use `include /etc/nginx/conf.d/active-upstream.conf` pattern
- Active upstream file is symlink: `active-upstream.conf → blue-upstream.conf` or `green-upstream.conf`

**3. Deployment Script (`deploy-blue-green.sh`):**
```bash
#!/bin/bash
# Steps:
# 1. Detect current active color (blue/green)
# 2. Build inactive color container
# 3. Start inactive container
# 4. Health check inactive container (retry 30 times, 10s interval = 5min max)
# 5. Switch nginx upstream to inactive color
# 6. Reload nginx (docker exec loop-nginx nginx -s reload)
# 7. Stop old active container
# 8. Mark new color as active (write to /volume1/LOOP_CORE/vault/LOOP/_build/.active-color)
```

**4. Health Check Logic:**
- Endpoint: `GET /health` (already exists in api/main.py)
- Expected response: `{"status": "healthy"}` with 200 status
- Validation: Check response status + parse JSON + verify vault mount
- Retry strategy: Max 30 attempts, 10s interval (total 5 min timeout)

**5. Rollback Script (`rollback.sh`):**
```bash
#!/bin/bash
# Steps:
# 1. Read .active-color file
# 2. Switch nginx to opposite color
# 3. Reload nginx
# 4. Update .active-color file
# Usage: ./rollback.sh (no args needed, auto-detects)
```

**Key Functions:**

**deploy-blue-green.sh:**
- `get_active_color()`: Read from `/volume1/LOOP_CORE/vault/LOOP/_build/.active-color` (default: blue)
- `get_inactive_color()`: Return opposite color
- `build_container(COLOR)`: `docker compose -f docker-compose.blue-green.yml build loop-api-$COLOR`
- `start_container(COLOR)`: `docker compose -f docker-compose.blue-green.yml up -d loop-api-$COLOR`
- `health_check(COLOR, PORT)`: Curl `http://localhost:$PORT/health` with retry logic
- `switch_nginx(COLOR)`: Update symlink + reload nginx
- `stop_container(COLOR)`: `docker compose -f docker-compose.blue-green.yml stop loop-api-$COLOR`
- `mark_active(COLOR)`: Write COLOR to `.active-color` file

**rollback.sh:**
- `get_active_color()`: Same as above
- `switch_nginx(COLOR)`: Same as above
- `mark_active(COLOR)`: Same as above

**Dependencies:**
- No new packages needed
- Uses existing: docker, docker compose, curl, bash

**Edge Cases:**

1. **Health check fails after 5 min:**
   - Action: Keep old container running, stop new container, log error
   - User notification: Exit with error message "Health check failed, rollback not performed"
   - Rollback: Manual via `./rollback.sh`

2. **Nginx reload fails:**
   - Action: Log error, but new container keeps running
   - User notification: "Nginx reload failed, manual intervention required"
   - Recovery: Run `docker exec loop-nginx nginx -s reload` manually

3. **Both containers running (deployment interrupted):**
   - Action: Script detects via `docker ps` and asks user which to keep
   - User prompt: "Both blue and green are running. Keep which? (blue/green/abort)"

4. **First deployment (no .active-color file):**
   - Action: Assume blue is active, create `.active-color` file
   - Default behavior: Deploy to green first time

5. **Port conflict (8082 or 8085 already in use):**
   - Action: Script detects via `docker ps` and exits with error
   - User notification: "Port conflict detected, check running containers"

6. **Disk space insufficient for two containers:**
   - Action: Docker build fails, script catches error and exits
   - User notification: "Build failed, check disk space on NAS"

7. **Volume mount issues (vault path unavailable):**
   - Action: Health check fails (vault not accessible)
   - Recovery: Check NAS mount, verify `/volume1/LOOP_CORE/vault/LOOP` exists

### Todo

- [ ] Create `docker-compose.blue-green.yml` with loop-api-blue and loop-api-green services (ports 8082, 8085)
- [ ] Create `nginx-blue-green.conf` with upstream switching logic (include pattern for active-upstream.conf)
- [ ] Create `blue-upstream.conf` and `green-upstream.conf` in nginx config directory
- [ ] Write `scripts/deploy-blue-green.sh` with 8 functions (get_active_color, get_inactive_color, build_container, start_container, health_check, switch_nginx, stop_container, mark_active)
- [ ] Write `scripts/rollback.sh` with 3 functions (get_active_color, switch_nginx, mark_active)
- [ ] Test deployment script locally (MacBook Docker environment)
- [ ] Test health check retry logic (simulate failure by stopping container mid-check)
- [ ] Test rollback script (deploy green, then rollback to blue)
- [ ] Test edge case: both containers running (manual cleanup scenario)
- [ ] Deploy to NAS and verify zero-downtime (monitor nginx access logs during switch)
- [ ] Update `/Users/gim-eunhyang/dev/loop/public/CLAUDE.md` with new deployment commands
- [ ] Update `/Users/gim-eunhyang/dev/loop/CLAUDE.md` with Blue-Green deployment workflow
- [ ] Verify build passes
- [ ] Write tests (if applicable)

### Execution Log

**Date**: 2026-01-13
**Status**: Implementation Complete

#### Phase 1: Planning & Codex Plan Review
- Created detailed implementation plan based on Tech Spec
- Codex plan review identified critical architecture concerns:
  - Port mapping must use host ports (8082/8085) for health checks
  - Nginx include must be in http{} scope (not server{})
  - Need 30s traffic verification before stopping old container
  - Rollback must verify container health before switching
  - Atomic .active-color writes required (temp + mv)
  - oauth-data should be read-only for API containers

#### Phase 2: Implementation
**Files Created/Modified**:
1. `docker-compose.blue-green.yml` - Dual API services (blue/green) with bind mount for nginx config
2. `nginx-blue-green.conf` - Dynamic upstream via include, routes to `api_active`
3. `scripts/blue-upstream.conf` - Upstream config pointing to loop-api-blue:8081
4. `scripts/green-upstream.conf` - Upstream config pointing to loop-api-green:8081
5. `scripts/active-upstream.conf` - Default active upstream (blue)
6. `scripts/deploy-blue-green.sh` - Comprehensive deployment script with 11 functions
7. `scripts/rollback.sh` - Rollback script with health verification

**Key Features**:
- Health check: 30 attempts × 10s interval, validates JSON response + vault_exists
- Port conflict detection using lsof
- Atomic file operations for .active-color
- 30s traffic verification through nginx before stopping old container
- Automatic rollback on failures
- Conflict resolution when both containers running

#### Phase 3: Codex Code Review
Codex identified 5 critical bugs:
1. **Missing upstream seed**: nginx-config volume empty on first boot → FIXED: Use bind mount
2. **Conflict handler causes downtime**: detect_conflicts stops container but doesn't update nginx → FIXED: Added switch_nginx call
3. **Health check false positive**: grep "healthy" matches "unhealthy" → FIXED: Use python JSON parsing
4. **Reload failure handling dead code**: set -e exits before error recovery → FIXED: Removed set -e, use proper error handling
5. **Rollback doesn't restore container config**: Only restores host file → FIXED: Bind mount auto-reflects changes

#### Phase 4: Bug Fixes
**docker-compose.blue-green.yml**:
- Changed oauth-data to read-only (`:ro`) for API containers
- Removed nginx-config volume, use bind mount instead
- Bind mount: `./scripts/active-upstream.conf:/etc/nginx/conf.d/active-upstream.conf:rw`

**nginx-blue-green.conf**:
- Fixed proxy_pass from `http://api` to `http://api_active`

**scripts/deploy-blue-green.sh**:
- Removed `set -e` to allow error handling code to run
- Fixed health check to use python JSON parsing (no false positives)
- Simplified switch_nginx (no docker cp needed with bind mount)
- Fixed detect_conflicts to call switch_nginx after stopping container
- Proper error handling with backup restoration

**scripts/rollback.sh**:
- Removed `set -e`
- Fixed health check to use python JSON parsing
- Simplified switch_nginx (bind mount auto-reflects changes)
- Proper error handling with backup restoration

#### Test Plan
1. **Local Testing** (MacBook Docker):
   - Deploy to green from blue (simulate first deployment)
   - Health check validation
   - Traffic verification through nginx
   - Rollback to blue
   - Edge case: both containers running

2. **NAS Testing**:
   - Deploy with actual volume mounts (`/volume1/LOOP_CORE/vault/LOOP`)
   - Monitor nginx access logs during switch (verify zero-downtime)
   - Simulate health check failure (stop container mid-check)
   - Test rollback after deployment
   - Verify .active-color persistence

#### Evidence
- **Codex Plan Review**: YES (initial plan validation)
- **Codex Code Review**: YES (implementation review + bug identification)
- **Files Modified**: 7 files (compose, nginx config, upstream configs, deployment scripts)
- **Critical Bugs Fixed**: 5 (all Codex-identified issues resolved)
- **Lines of Code**: ~450 lines (deploy + rollback scripts)

#### Next Steps
1. Commit changes in worktree
2. Merge to main
3. Test locally on MacBook Docker
4. Deploy to NAS and verify zero-downtime
5. Update CLAUDE.md with new deployment commands
