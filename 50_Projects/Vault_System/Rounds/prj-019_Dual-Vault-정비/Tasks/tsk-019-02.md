---
entity_type: Task
entity_id: "tsk-019-02"
entity_name: "API - Task ID 생성 project_id 기반 버그 수정"
created: 2026-01-07
updated: 2026-01-07
status: doing

# === 계층 ===
parent_id: "prj-019"
project_id: "prj-019"
aliases: ["tsk-019-02"]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: "김은향"
start_date: 2026-01-07
due: 2026-01-07
priority: high
estimated_hours: null
actual_hours: null

# === Task 유형 (dev Task 연동용) ===
type: dev
target_project: loop

# === 분류 ===
tags: ["api", "bug", "task-id", "critical"]
priority_flag: high
---

# API - Task ID 생성 project_id 기반 버그 수정

> Task ID: `tsk-019-02` | Project: `prj-019` | Status: doing

## 목표

**완료 조건**:
1. `api/cache/vault_cache.py` - `get_next_task_id(project_id)` 파라미터 추가
2. project_id 기반 ID 생성 로직 구현 완료
3. `api/routers/tasks.py` - project_id 전달 수정
4. 신규 Task 생성 시 올바른 ID 패턴 생성 검증 (tsk-{prj_num}-{seq})

---

## 상세 내용

### 배경

**근본 원인**: API의 `get_next_task_id()` 함수가 `project_id`를 무시하고 전역 카운터로 작동

**스키마 규칙** (schema_constants.yaml:254):
```yaml
tsk: "^tsk-(\\d{3}-\\d{2}|[a-z][a-z0-9-]+-\\d{2})$"
# 형식: tsk-001-01 또는 tsk-vault-gpt-01
```

**예상 동작**:
- prj-019의 Task → `tsk-019-01`, `tsk-019-02`, ...
- prj-023의 Task → `tsk-023-01`, `tsk-023-02`, ...

**실제 동작**:
- 모든 Task → `tsk-001-01`, `tsk-022-24`, ... (프로젝트 무관 전역 카운터)

**영향 범위**:
- prj-019: 9개 Task 중 8개가 잘못된 ID (`tsk-017-XX`, `tsk-022-XX`)
- prj-023: 2개 Task 모두 잘못된 ID (`tsk-022-XX`)
- 전체 Vault: 수십 개의 Task ID가 잘못되었을 가능성

### 작업 내용

**1. API 버그 수정**

**A. `api/cache/vault_cache.py:1250` - `get_next_task_id()` 함수 수정**

BEFORE:
```python
def get_next_task_id(self) -> str:
    """다음 Task ID 생성"""
    with self._lock:
        max_id = 0

        for entity_id in self.tasks.keys():
            match = re.match(r'tsk-(\d+)-(\d+)', entity_id)
            if match:
                main_num = int(match.group(1))
                sub_num = int(match.group(2))
                combined = main_num * 100 + sub_num
                max_id = max(max_id, combined)
```

AFTER:
```python
def get_next_task_id(self, project_id: str) -> str:
    """다음 Task ID 생성 (project_id 기반)

    Args:
        project_id: 프로젝트 ID (예: prj-019)

    Returns:
        str: Task ID (예: tsk-019-01)
    """
    with self._lock:
        # Extract project number from project_id
        prj_match = re.match(r'prj-(\d{3})', project_id)
        if not prj_match:
            raise ValueError(f"Invalid project_id format: {project_id}")

        prj_num = int(prj_match.group(1))
        max_seq = 0

        # Find highest sequence number for this project
        for entity_id in self.tasks.keys():
            match = re.match(r'tsk-(\d{3})-(\d{2})', entity_id)
            if match:
                task_prj_num = int(match.group(1))
                task_seq = int(match.group(2))

                # Only consider tasks from the same project
                if task_prj_num == prj_num:
                    max_seq = max(max_seq, task_seq)

        next_seq = max_seq + 1
        return f"tsk-{prj_num:03d}-{next_seq:02d}"
```

**B. `api/routers/tasks.py:114` - project_id 전달**

BEFORE:
```python
# 3. Task ID 생성 (캐시 기반)
task_id = cache.get_next_task_id()
```

AFTER:
```python
# 3. Task ID 생성 (캐시 기반, project_id 전달)
task_id = cache.get_next_task_id(task.project_id)
```

**2. 테스트 계획**

```python
# Test Case 1: prj-019에서 Task 생성
# Expected: tsk-019-02 (이미 tsk-019-01 존재)

# Test Case 2: prj-023에서 Task 생성
# Expected: tsk-023-04 (이미 tsk-023-01~03 존재)

# Test Case 3: 새 프로젝트 prj-024에서 첫 Task 생성
# Expected: tsk-024-01
```

**3. 기존 Task ID 마이그레이션 (별도 Task)**

이 Task는 API 버그 수정만 다루며, 기존 잘못된 ID들의 마이그레이션은 별도 Task로 분리.

---

## 체크리스트

- [ ] `api/cache/vault_cache.py` - `get_next_task_id()` 수정
- [ ] `api/routers/tasks.py` - project_id 전달 추가
- [ ] Unit test 작성 (project_id 기반 ID 생성)
- [ ] 신규 Task 3개 생성 테스트 (prj-019, prj-023, 새 프로젝트)
- [ ] validate_schema.py 실행 (에러 없음)
- [ ] Git commit 완료

---

## Notes

### Todo
- [ ] API 버그 수정 코드 작성
- [ ] 테스트 케이스 검증
- [ ] 문서 업데이트 (SSOT_CONTRACT 버그 노트 추가)

### 작업 로그
<!--
작업 완료 시 아래 형식으로 기록 (workthrough 스킬 자동 생성)

#### YYYY-MM-DD HH:MM
**개요**: 2-3문장 요약

**변경사항**:
- 개발:
- 수정:
- 개선:

**핵심 코드**: (필요시)

**결과**: ✅ 빌드 성공 / ❌ 실패

**다음 단계**:
-->


---

## 참고 문서

- [[prj-019]] - 소속 Project
- [[tsk-019-01]] - 선행 Task (SSOT Task 파일명)
- [[00_Meta/schema_constants.yaml]] - Task ID 패턴 규칙

---

**Created**: 2026-01-07
**Assignee**: 김은향
**Due**: 2026-01-07
