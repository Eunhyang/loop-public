---
entity_type: Task
entity_id: tsk-019-07
entity_name: SSOT - 규칙 구현 상태 검증
created: 2026-01-07
updated: '2026-01-09'
status: done
parent_id: prj-019
project_id: prj-019
aliases:
- tsk-022-21
outgoing_relations: []
validates: []
validated_by: []
assignee: 김은향
start_date: 2026-01-07
due: 2026-01-07
priority: medium
estimated_hours: null
actual_hours: null
type: dev
target_project: null
tags:
- ssot
- validation
- verification
priority_flag: high
notes: "# SSOT - 규칙 구현 상태 검증\n\n> Task ID: `tsk-022-21` | Project: `prj-019` | Status:\
  \ doing\n\n## 목표\n\n**완료 조건**:\n\n1. SSOT_CONTRACT.md v1.1의 3가지 규칙 구현 상태 확인 완료\n\
  2. Gap 분석 문서 작성 (구현됨/미구현/부분구현)\n3. 누락된 구현 목록 정리\n\n---\n\n## 상세 내용\n\n### 배경\n\n\
  SSOT_CONTRACT.md v1.1에서 3가지 규칙을 강제 조항으로 추가:\n\n- A) Task 파일명 규칙 (Section 4.2): `tsk-{id}.md`\
  \ Phase 1/2 강제\n- B) 동시성/경합 방지 (Section 6.5): `expected_updated_at` + 409 Conflict\n\
  - C) Audit Log 스키마 (Section 6.2): `_build/audit_log.jsonl` + 필드 정의\n\n현재 코드베이스에서\
  \ 이 규칙들이 실제로 구현되어 있는지 검증 필요.\n\n### 작업 내용\n\n**Phase 1: 현재 상태 파악 (읽기만)**\n\n1. Task\
  \ 파일명 생성 로직 확인\n\n   - `loop-entity-creator/SKILL.md` 읽기\n   - `api/routers/tasks.py`\
  \ CREATE 확인\n   - `api/utils/entity_generator.py` 확인\n\n2. 동시성 방지 로직 확인\n\n   -\
  \ `api/routers/tasks.py` UPDATE 확인\n   - `api/routers/projects.py` UPDATE 확인\n \
  \  - `api/models/entities.py` 스키마 확인\n\n3. Audit log 구현 확인\n\n   - `_build/audit_log.jsonl`\
  \ 존재 여부\n   - API 라우터에서 audit log 기록 코드 검색\n   - 스키마 필드 준수 확인\n\n**Phase 2: Gap\
  \ 분석**\n\n- 구현됨 ✅\n- 구현 안 됨 ❌\n- 부분 구현 ⚠️\n\n**Phase 3: 보고**\n\n- 각 항목별 현재 상태\n\
  - 누락된 구현 목록\n- 수정 필요 사항 (코드는 절대 안 건드림)\n\n---\n\n## 체크리스트\n\n- [ ] A) Task 파일명 규칙\
  \ 구현 확인\n\n- [ ] B) 동시성 방지 구현 확인\n\n- [ ] C) Audit log 구현 확인\n\n- [ ] Gap 분석 문서\
  \ 작성\n\n- [ ] 보고서 작성\n\n---\n\n## Notes\n\n### Gap Analysis Report\n\n**검증 일시**:\
  \ 2026-01-07 19:10 **검증자**: Claude Code Agent **SSOT_CONTRACT 버전**: v1.1\n\n---\n\
  \nA) Task 파일명 규칙 (Section 4.2) ❌ NOT IMPLEMENTED\n\n**요구사항**:\n\n```yaml\nPhase\
  \ 1 (즉시): 신규 생성은 무조건 tsk-{id}.md\nPhase 2 (마이그레이션): 기존 파일 rename (scripts/rename_task_files.py)\n\
  ```\n\n**현재 상태**:\n\n- **API**: `api/routers/tasks.py:117` - `sanitize_filename(task.entity_name)\
  \ + \".md\"`\n  - entity_name 기반 파일명 사용 (예: `CoachOS_프로토타입_개발.md`)\n  - tsk-{id}.md\
  \ 패턴 사용 안 함\n- **loop-entity-creator 스킬**: Step 4 - `50_Projects/{project_name}/Tasks/{entity_name}.md`\n\
  \  - entity_name 기반 경로 사용\n- **cache/vault_cache.py**: L283, L302 - 파일명으로 검색하지 않음\
  \ (frontmatter entity_id로 검색)\n  - 파일명과 무관하게 동작하므로 변경 시 영향 없음\n\n**Gap**: ❌ **완전히\
  \ 미구현**\n\n- Phase 1: 신규 생성 시 `tsk-{id}.md` 강제 안 됨\n- Phase 2: 마이그레이션 스크립트 존재하지\
  \ 않음\n\n**영향**: 파일명이 내용 기반이라 동일 이름 Task 생성 시 `_1`, `_2` 접미사 추가 (L122-127)\n\n---\n\
  \nB) 동시성/경합 방지 (Section 6.5) ❌ NOT IMPLEMENTED\n\n**요구사항**:\n\n```python\nPUT /api/tasks/tsk-001-02\n\
  {\n  \"status\": \"in_progress\",\n  \"expected_updated_at\": \"2026-01-07T10:30:00Z\"\
  \n}\n\n# 409 Conflict if version mismatch\n```\n\n**현재 상태**:\n\n- **Pydantic models**:\
  \ `api/models/entities.py`\n  - `TaskUpdate` (L35-53): `expected_updated_at` 필드\
  \ 없음\n  - `ProjectUpdate` (L78-92): `expected_updated_at` 필드 없음\n- **API UPDATE\
  \ 엔드포인트**:\n  - `tasks.py`: 409 Conflict 코드 없음\n  - `projects.py`: 409 Conflict\
  \ 코드 없음\n- **Concurrency check**: frontmatter의 `updated` 필드 비교 로직 없음\n\n**Gap**:\
  \ ❌ **완전히 미구현**\n\n- `expected_updated_at` 파라미터 존재하지 않음\n- Version mismatch 감지 로직\
  \ 없음\n- 409 Conflict 응답 없음\n- 동시 수정 시 \"last write wins\" (후자가 덮어씀)\n\n**영향**: n8n\
  \ + Dashboard + API 동시 수정 시 데이터 유실 위험\n\n---\n\nC) Audit Log 스키마 (Section 6.2) ⚠️\
  \ PARTIALLY IMPLEMENTED\n\n**요구사항**:\n\n```json\n{\n  \"run_id\": \"uuid-v4\",\n\
  \  \"timestamp\": \"ISO-8601\",\n  \"actor\": \"user:김은향 | api:n8n | script:validate\"\
  ,\n  \"source\": \"ui | api | script | cli\",\n  \"entity_type\": \"Task | Project\
  \ | Hypothesis\",\n  \"entity_id\": \"tsk-001-02\",\n  \"action\": \"create | update\
  \ | delete | approve | reject\",\n  \"modified_fields\": [\"status\", \"assignee\"\
  ],\n  \"diff\": { \"status\": {\"old\": \"todo\", \"new\": \"doing\"} }\n}\n\n위치:\
  \ _build/audit_log.jsonl\n```\n\n**현재 상태**:\n\n- **파일 위치**: `_build/audit.log` (✅\
  \ JSONL 형식, ❌ 파일명 불일치)\n\n- **스키마**: `api/routers/audit.py:52-60`\n\n  ```json\n\
  \  {\n    \"timestamp\": \"ISO-8601\",     # ✅ 존재\n    \"action\": \"create|update|delete|autofill\"\
  ,  # ✅ 존재\n    \"entity_type\": \"Task|Project|Hypothesis\",   # ✅ 존재\n    \"entity_id\"\
  : \"tsk-xxx\",      # ✅ 존재\n    \"entity_name\": \"...\",        # ⚠️ 명세에 없음\n \
  \   \"user\": \"api\",               # ⚠️ \"actor\"가 아님\n    \"details\": {}   \
  \             # ⚠️ \"source\", \"modified_fields\", \"diff\" 없음\n  }\n  ```\n\n\
  **Gap**: ⚠️ **부분 구현**\n\n- ❌ 파일명: `audit.log` → `audit_log.jsonl`로 변경 필요\n- ❌ `run_id`\
  \ 필드 없음\n- ❌ `actor` 필드 없음 (`user` 필드로 대체)\n- ❌ `source` 필드 없음\n- ❌ `modified_fields`\
  \ 필드 없음\n- ❌ `diff` 필드 없음 (변경 전/후 값)\n- ✅ 기본 필드 (`timestamp`, `action`, `entity_type`,\
  \ `entity_id`) 존재\n\n**영향**:\n\n- 감사 추적은 가능하지만 상세도 낮음\n- 변경 전/후 비교 불가 (diff 없음)\n\
  - 실행 단위 추적 불가 (run_id 없음)\n\n---\n\n### 요약\n\n| 규칙 | 상태 | 구현도 | 핵심 누락 |\n| --- |\
  \ --- | --- | --- |\n| A) Task 파일명 | ❌ NOT IMPLEMENTED | 0% | tsk-{id}.md 패턴, 마이그레이션\
  \ 스크립트 |\n| B) 동시성 방지 | ❌ NOT IMPLEMENTED | 0% | expected_updated_at, 409 Conflict\
  \ |\n| C) Audit log | ⚠️ PARTIAL | 40% | run_id, actor, source, modified_fields,\
  \ diff, 파일명 |\n\n---\n\n### 수정 필요 파일 (코드 수정 불가, 참고용)\n\n**Rule A (Task 파일명)**:\n\
  \n1. `api/routers/tasks.py:117` - filename 생성 로직\n2. `.claude/skills/loop-entity-creator/SKILL.md:399`\
  \ - Step 4 경로 생성\n3. `scripts/rename_task_files.py` - 새 스크립트 필요\n\n**Rule B (동시성)**:\n\
  \n1. `api/models/entities.py:35` - TaskUpdate 모델\n2. `api/models/entities.py:78`\
  \ - ProjectUpdate 모델\n3. `api/routers/tasks.py` - UPDATE 엔드포인트 (409 추가)\n4. `api/routers/projects.py`\
  \ - UPDATE 엔드포인트 (409 추가)\n\n**Rule C (Audit log)**:\n\n1. `api/routers/audit.py:28`\
  \ - 파일명 변경 (audit.log → audit_log.jsonl)\n2. `api/routers/audit.py:52-60` - 스키마\
  \ 확장 (run_id, actor, source, modified_fields, diff)\n3. 모든 로그 호출부 - `user` → `actor`\
  \ + `source` 분리\n\n### Todo\n\n- [x] loop-entity-creator 스킬 파일 읽기\n\n- [x] API 코드\
  \ 확인 (tasks.py, projects.py)\n\n- [x] Audit log 파일 확인\n\n- [x] 각 규칙별 구현 상태 정리\n\n\
  - [x] Gap 분석 문서 작성\n\n### 작업 로그\n\n2026-01-07 19:10\n\n**개요**: SSOT_CONTRACT.md\
  \ v1.1의 3가지 규칙 구현 상태 검증 완료. 파일 읽기만 수행, 코드 수정 없음.\n\n**검증 결과**:\n\n- Rule A (Task\
  \ 파일명): 완전히 미구현 (0%)\n- Rule B (동시성 방지): 완전히 미구현 (0%)\n- Rule C (Audit log): 부분\
  \ 구현 (40%)\n\n**핵심 파인딩**:\n\n- Task 파일명은 여전히 entity_name 기반 (`CoachOS_프로토타입_개발.md`)\n\
  - 동시성 제어 없음 (expected_updated_at, 409 Conflict 미구현)\n- Audit log 스키마 부분적 (run_id,\
  \ diff 등 누락)\n\n**결과**: ✅ 검증 완료 (코드 수정 없음)\n\n**다음 단계**: 사용자에게 Gap 분석 보고 및 승인 대기\n\
  \n---\n\n## 참고 문서\n\n- \\[\\[prj-019\\]\\] - 소속 Project\n- \\[\\[00_Meta/SSOT_CONTRACT.md\\\
  ]\\] - 검증 대상 규칙\n- \\[\\[tsk-022-18\\]\\] - 선행 Task (파일명 통일)\n\n---\n\n**Created**:\
  \ 2026-01-07 **Assignee**: 김은향 **Due**: 2026-01-07"
---
# SSOT - 규칙 구현 상태 검증

> Task ID: `tsk-022-21` | Project: `prj-019` | Status: doing

## 목표

**완료 조건**:
1. SSOT_CONTRACT.md v1.1의 3가지 규칙 구현 상태 확인 완료
2. Gap 분석 문서 작성 (구현됨/미구현/부분구현)
3. 누락된 구현 목록 정리

---

## 상세 내용

### 배경

SSOT_CONTRACT.md v1.1에서 3가지 규칙을 강제 조항으로 추가:
- A) Task 파일명 규칙 (Section 4.2): `tsk-{id}.md` Phase 1/2 강제
- B) 동시성/경합 방지 (Section 6.5): `expected_updated_at` + 409 Conflict
- C) Audit Log 스키마 (Section 6.2): `_build/audit_log.jsonl` + 필드 정의

현재 코드베이스에서 이 규칙들이 실제로 구현되어 있는지 검증 필요.

### 작업 내용

**Phase 1: 현재 상태 파악 (읽기만)**
1. Task 파일명 생성 로직 확인
   - `loop-entity-creator/SKILL.md` 읽기
   - `api/routers/tasks.py` CREATE 확인
   - `api/utils/entity_generator.py` 확인

2. 동시성 방지 로직 확인
   - `api/routers/tasks.py` UPDATE 확인
   - `api/routers/projects.py` UPDATE 확인
   - `api/models/entities.py` 스키마 확인

3. Audit log 구현 확인
   - `_build/audit_log.jsonl` 존재 여부
   - API 라우터에서 audit log 기록 코드 검색
   - 스키마 필드 준수 확인

**Phase 2: Gap 분석**
- 구현됨 ✅
- 구현 안 됨 ❌
- 부분 구현 ⚠️

**Phase 3: 보고**
- 각 항목별 현재 상태
- 누락된 구현 목록
- 수정 필요 사항 (코드는 절대 안 건드림)

---

## 체크리스트

- [ ] A) Task 파일명 규칙 구현 확인
- [ ] B) 동시성 방지 구현 확인
- [ ] C) Audit log 구현 확인
- [ ] Gap 분석 문서 작성
- [ ] 보고서 작성

---

## Notes

### Gap Analysis Report

**검증 일시**: 2026-01-07 19:10
**검증자**: Claude Code Agent
**SSOT_CONTRACT 버전**: v1.1

---

#### A) Task 파일명 규칙 (Section 4.2) ❌ NOT IMPLEMENTED

**요구사항**:
```yaml
Phase 1 (즉시): 신규 생성은 무조건 tsk-{id}.md
Phase 2 (마이그레이션): 기존 파일 rename (scripts/rename_task_files.py)
```

**현재 상태**:
- **API**: `api/routers/tasks.py:117` - `sanitize_filename(task.entity_name) + ".md"`
  - entity_name 기반 파일명 사용 (예: `CoachOS_프로토타입_개발.md`)
  - tsk-{id}.md 패턴 사용 안 함
- **loop-entity-creator 스킬**: Step 4 - `50_Projects/{project_name}/Tasks/{entity_name}.md`
  - entity_name 기반 경로 사용
- **cache/vault_cache.py**: L283, L302 - 파일명으로 검색하지 않음 (frontmatter entity_id로 검색)
  - 파일명과 무관하게 동작하므로 변경 시 영향 없음

**Gap**: ❌ **완전히 미구현**
- Phase 1: 신규 생성 시 `tsk-{id}.md` 강제 안 됨
- Phase 2: 마이그레이션 스크립트 존재하지 않음

**영향**: 파일명이 내용 기반이라 동일 이름 Task 생성 시 `_1`, `_2` 접미사 추가 (L122-127)

---

#### B) 동시성/경합 방지 (Section 6.5) ❌ NOT IMPLEMENTED

**요구사항**:
```python
PUT /api/tasks/tsk-001-02
{
  "status": "in_progress",
  "expected_updated_at": "2026-01-07T10:30:00Z"
}

# 409 Conflict if version mismatch
```

**현재 상태**:
- **Pydantic models**: `api/models/entities.py`
  - `TaskUpdate` (L35-53): `expected_updated_at` 필드 없음
  - `ProjectUpdate` (L78-92): `expected_updated_at` 필드 없음
- **API UPDATE 엔드포인트**:
  - `tasks.py`: 409 Conflict 코드 없음
  - `projects.py`: 409 Conflict 코드 없음
- **Concurrency check**: frontmatter의 `updated` 필드 비교 로직 없음

**Gap**: ❌ **완전히 미구현**
- `expected_updated_at` 파라미터 존재하지 않음
- Version mismatch 감지 로직 없음
- 409 Conflict 응답 없음
- 동시 수정 시 "last write wins" (후자가 덮어씀)

**영향**: n8n + Dashboard + API 동시 수정 시 데이터 유실 위험

---

#### C) Audit Log 스키마 (Section 6.2) ⚠️ PARTIALLY IMPLEMENTED

**요구사항**:
```json
{
  "run_id": "uuid-v4",
  "timestamp": "ISO-8601",
  "actor": "user:김은향 | api:n8n | script:validate",
  "source": "ui | api | script | cli",
  "entity_type": "Task | Project | Hypothesis",
  "entity_id": "tsk-001-02",
  "action": "create | update | delete | approve | reject",
  "modified_fields": ["status", "assignee"],
  "diff": { "status": {"old": "todo", "new": "doing"} }
}

위치: _build/audit_log.jsonl
```

**현재 상태**:
- **파일 위치**: `_build/audit.log` (✅ JSONL 형식, ❌ 파일명 불일치)
- **스키마**: `api/routers/audit.py:52-60`
  ```json
  {
    "timestamp": "ISO-8601",     # ✅ 존재
    "action": "create|update|delete|autofill",  # ✅ 존재
    "entity_type": "Task|Project|Hypothesis",   # ✅ 존재
    "entity_id": "tsk-xxx",      # ✅ 존재
    "entity_name": "...",        # ⚠️ 명세에 없음
    "user": "api",               # ⚠️ "actor"가 아님
    "details": {}                # ⚠️ "source", "modified_fields", "diff" 없음
  }
  ```

**Gap**: ⚠️ **부분 구현**
- ❌ 파일명: `audit.log` → `audit_log.jsonl`로 변경 필요
- ❌ `run_id` 필드 없음
- ❌ `actor` 필드 없음 (`user` 필드로 대체)
- ❌ `source` 필드 없음
- ❌ `modified_fields` 필드 없음
- ❌ `diff` 필드 없음 (변경 전/후 값)
- ✅ 기본 필드 (`timestamp`, `action`, `entity_type`, `entity_id`) 존재

**영향**:
- 감사 추적은 가능하지만 상세도 낮음
- 변경 전/후 비교 불가 (diff 없음)
- 실행 단위 추적 불가 (run_id 없음)

---

### 요약

| 규칙 | 상태 | 구현도 | 핵심 누락 |
|------|------|--------|----------|
| A) Task 파일명 | ❌ NOT IMPLEMENTED | 0% | tsk-{id}.md 패턴, 마이그레이션 스크립트 |
| B) 동시성 방지 | ❌ NOT IMPLEMENTED | 0% | expected_updated_at, 409 Conflict |
| C) Audit log | ⚠️ PARTIAL | 40% | run_id, actor, source, modified_fields, diff, 파일명 |

---

### 수정 필요 파일 (코드 수정 불가, 참고용)

**Rule A (Task 파일명)**:
1. `api/routers/tasks.py:117` - filename 생성 로직
2. `.claude/skills/loop-entity-creator/SKILL.md:399` - Step 4 경로 생성
3. `scripts/rename_task_files.py` - 새 스크립트 필요

**Rule B (동시성)**:
1. `api/models/entities.py:35` - TaskUpdate 모델
2. `api/models/entities.py:78` - ProjectUpdate 모델
3. `api/routers/tasks.py` - UPDATE 엔드포인트 (409 추가)
4. `api/routers/projects.py` - UPDATE 엔드포인트 (409 추가)

**Rule C (Audit log)**:
1. `api/routers/audit.py:28` - 파일명 변경 (audit.log → audit_log.jsonl)
2. `api/routers/audit.py:52-60` - 스키마 확장 (run_id, actor, source, modified_fields, diff)
3. 모든 로그 호출부 - `user` → `actor` + `source` 분리

### Todo
- [x] loop-entity-creator 스킬 파일 읽기
- [x] API 코드 확인 (tasks.py, projects.py)
- [x] Audit log 파일 확인
- [x] 각 규칙별 구현 상태 정리
- [x] Gap 분석 문서 작성

### 작업 로그

#### 2026-01-07 19:10
**개요**: SSOT_CONTRACT.md v1.1의 3가지 규칙 구현 상태 검증 완료. 파일 읽기만 수행, 코드 수정 없음.

**검증 결과**:
- Rule A (Task 파일명): 완전히 미구현 (0%)
- Rule B (동시성 방지): 완전히 미구현 (0%)
- Rule C (Audit log): 부분 구현 (40%)

**핵심 파인딩**:
- Task 파일명은 여전히 entity_name 기반 (`CoachOS_프로토타입_개발.md`)
- 동시성 제어 없음 (expected_updated_at, 409 Conflict 미구현)
- Audit log 스키마 부분적 (run_id, diff 등 누락)

**결과**: ✅ 검증 완료 (코드 수정 없음)

**다음 단계**: 사용자에게 Gap 분석 보고 및 승인 대기


---

## 참고 문서

- [[prj-019]] - 소속 Project
- [[00_Meta/SSOT_CONTRACT.md]] - 검증 대상 규칙
- [[tsk-022-18]] - 선행 Task (파일명 통일)

---

**Created**: 2026-01-07
**Assignee**: 김은향
**Due**: 2026-01-07
