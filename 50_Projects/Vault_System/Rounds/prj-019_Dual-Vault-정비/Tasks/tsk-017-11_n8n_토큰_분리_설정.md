---
entity_type: Task
entity_id: "tsk-017-11"
entity_name: "Dual-Vault - n8n 토큰 분리 설정"
created: 2026-01-02
updated: 2026-01-02
status: doing

# === 계층 ===
parent_id: "prj-019"
project_id: "prj-019"
aliases: ["tsk-017-11"]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: "김은향"
start_date: 2026-01-02
due: 2026-01-02
priority: high
estimated_hours: 4
actual_hours: null

# === Task 유형 ===
type: ops
target_project: null

# === 3Y 전략 연결 ===
# === 분류 ===
tags: ["n8n", "token", "security", "ops", "dual-vault"]
priority_flag: high
---

# Dual-Vault - n8n 토큰 분리 설정

> Task ID: `tsk-017-11` | Project: `prj-019` | Status: doing

## 목표

**완료 조건**:
1. svc_public 토큰 생성 완료 (팀 자동화용, public API만 접근)
2. svc_admin 토큰 생성 완료 (exec 수집/집계용, admin API 접근)
3. API 서버 권한 분리 구현 (/admin/* 경로 → admin 토큰 필수)
4. n8n 워크플로우별 토큰 전환 완료
5. 기존 토큰 폐기 계획 수립

---

## 상세 내용

### 배경

Dual-Vault 구조 (LOOP public + loop_exec) 에서 접근 권한 분리 필요.
현재 n8n에서 단일 토큰으로 모든 API에 접근 가능한 상태.
팀 자동화와 C-Level 전용 데이터를 토큰 수준에서 분리해야 함.

### 작업 내용

1. **토큰 분리 설계**
   - svc_public: public API 전용 (팀 자동화)
   - svc_admin: admin API 포함 (exec 수집, 집계, rollup)

2. **API 서버 권한 분리**
   - /admin/* 경로 → admin 역할 필수
   - 일반 /api/* 경로 → public 토큰으로 접근 가능

3. **n8n 워크플로우 업데이트**
   - 팀 자동화 워크플로우: svc_public 토큰 사용
   - exec 수집 워크플로우: svc_admin 토큰 사용

4. **기존 토큰 폐기**
   - 전환 완료 후 기존 토큰 비활성화

---

## 체크리스트

- [x] ServiceAccount 모델 구현 (`api/oauth/models.py`)
- [x] 서비스 계정 CLI 명령어 구현 (`api/oauth/cli.py`)
- [x] API 서버 /admin/* 경로 권한 체크 추가 (`api/main.py`)
- [x] 토큰 revocation 체크 구현 (`api/oauth/jwks.py`)
- [ ] svc_public 서비스 계정 생성 (배포 후)
- [ ] svc_admin 서비스 계정 생성 (배포 후)
- [ ] n8n 환경변수 설정 (LOOP_API_TOKEN_PUBLIC, LOOP_API_TOKEN_ADMIN)
- [ ] 팀 자동화 워크플로우 토큰 전환
- [ ] exec 수집 워크플로우 토큰 전환
- [ ] 접근 제어 테스트
- [ ] 기존 토큰 폐기

---

## Notes

### Tech Spec

**토큰 구조:**
```yaml
svc_public:
  role: member
  scope: ["api:read", "api:write"]
  access: /api/* (public endpoints only)
  use_case: 팀 자동화 워크플로우

svc_admin:
  role: admin
  scope: ["api:read", "api:write", "admin:read", "admin:write"]
  access: /api/*, /admin/*
  use_case: exec 수집, 집계, rollup
```

**API 경로 권한:**
```yaml
/api/*:           # public endpoints
  - member: OK
  - admin: OK

/admin/*:         # admin endpoints (신규)
  - member: FORBIDDEN
  - admin: OK
```

**n8n 환경변수:**
```bash
LOOP_API_TOKEN_PUBLIC=xxx   # svc_public 토큰
LOOP_API_TOKEN_ADMIN=yyy    # svc_admin 토큰
```

### Todo
- [x] oauth/cli.py에 서비스 계정 생성 명령어 추가
- [x] main.py에 /admin/* 경로 권한 미들웨어 추가
- [ ] svc_public 토큰 생성 (role=member) - 배포 후 실행
- [ ] svc_admin 토큰 생성 (role=admin) - 배포 후 실행
- [ ] n8n 워크플로우별 환경변수 분리 - 토큰 생성 후
- [ ] 접근 제어 테스트 (public 토큰으로 /admin 접근 시 403) - 토큰 생성 후
- [ ] 기존 토큰 폐기 및 문서화 - 전환 완료 후

### 작업 로그

#### 2026-01-02 17:30
**개요**: n8n 토큰 분리를 위한 서비스 계정 시스템 구현 완료

**변경사항**:
- 개발: `api/oauth/models.py` - ServiceAccount 모델 추가 (jti 기반 revocation 지원)
- 개발: `api/oauth/cli.py` - create-service-account, list-service-accounts, revoke-service-account, delete-service-account 명령어 추가
- 개발: `api/oauth/jwks.py` - is_service_account_revoked() 함수 추가, create_jwt()에 장기 토큰 만료 지원
- 개발: `api/main.py` - /admin/* 경로 보호 (role=admin 필수), ADMIN_PREFIXES 추가

**핵심 설계**:
- Fail-closed 보안: 서비스 계정 레코드 없으면 토큰 무효
- 장기 토큰: 서비스 계정은 10년 만료 (SVC_TOKEN_EXPIRE_YEARS 환경변수로 조정)
- 역할 기반 scope: member/exec/admin 역할별 scope 자동 할당

**Codex 리뷰 반영**:
- Revocation fail-open 버그 수정 (fail-closed로 변경)
- JWT 만료 시간 문제 수정 (서비스 계정용 장기 토큰)
- DB 쓰기 최적화 (last_used_at 업데이트 제거)

**결과**: 빌드 성공 (Python import 검증 완료)

**다음 단계**:
- NAS 배포 후 svc_public/svc_admin 토큰 생성
- n8n 워크플로우별 토큰 적용
- 기존 정적 토큰 폐기


---

## 참고 문서

- [[prj-019]] - 소속 Project (Dual-Vault - 정비)
- [[prj-mcp-dual-vault-rbac]] - Dual-Vault RBAC 기반 프로젝트

---

**Created**: 2026-01-02
**Assignee**: 김은향
**Due**: 2026-01-02
