---
entity_type: Task
entity_id: tsk-019-12
entity_name: Dual-Vault - Program-Round 조인 API
created: 2026-01-02
updated: 2026-01-02
status: done
parent_id: prj-019
project_id: prj-019
aliases:
- tsk-017-09
outgoing_relations: []
validates: []
validated_by: []
assignee: 김은향
start_date: 2026-01-02
due: 2026-01-02
priority: high
estimated_hours: null
actual_hours: null
type: dev
target_project: loop-api
tags:
- api
- dual-vault
- admin
- composite
priority_flag: high
---
# Dual-Vault - Program-Round 조인 API

> Task ID: `tsk-017-09` | Project: `prj-019` | Status: done

## 목표

**완료 조건**:
1. GET `/api/admin/programs/{pgm-id}/rounds` 엔드포인트 구현
2. LOOP vault에서 Program 정보 조회 기능
3. exec vault에서 program_id 일치하는 Project(Round) 스캔 기능
4. Admin 권한 검증 (role=admin 필수)
5. 에러 처리 (404, 403, 500)
6. API 응답 시간 < 500ms

---

## 상세 내용

### 배경

Dual-Vault 구조에서 Program과 Round(Project) 정보를 조인하여 조회하는 API가 필요합니다.
- LOOP vault: Program 정보 보유
- exec vault: Round(Project) 정보 보유 (민감 데이터 포함)

Admin 권한이 있는 사용자만 이 API를 호출할 수 있어야 하며, 민감 필드(salary, contract_terms)는 응답에서 제외해야 합니다.

### 작업 내용

1. **라우터 확장**: `api/routers/mcp_composite.py`에 새 엔드포인트 추가
2. **권한 검증**: `require_exec_access()` 사용하여 Admin 권한 확인
3. **데이터 조인**:
   - LOOP vault에서 Program 정보 조회
   - exec vault에서 해당 program_id를 가진 Project 스캔
4. **응답 모델**: RoundSummary 목록 + Program 전체 정보

---

## 체크리스트

- [x] 엔드포인트 라우터 추가
- [x] Admin 권한 검증 구현
- [x] Program 정보 조회 함수
- [x] Round(Project) 스캔 함수
- [x] 민감 필드 필터링
- [x] 에러 처리 (404, 403, 500)
- [ ] 단위 테스트 작성
- [ ] API 문서 업데이트

---

## Notes

### Tech Spec
- **프레임워크**: FastAPI
- **라우터**: `api/routers/mcp_composite.py`
- **권한**: `require_exec_access()` 데코레이터
- **응답 모델**:
  ```python
  class RoundSummary(BaseModel):
      project_id: str
      entity_name: str
      status: str
      owner: str
      cycle: Optional[str]
      # 민감 필드 제외: salary, contract_terms

  class ProgramRoundsResponse(BaseModel):
      program: Program  # 전체 Program 정보
      rounds: List[RoundSummary]
      total_count: int
  ```
- **에러 코드**:
  - 404: Program not found
  - 403: Unauthorized (not admin)
  - 500: Internal server error

### Todo
- [x] mcp_composite.py에 `/api/admin/programs/{pgm_id}/rounds` 엔드포인트 추가
- [x] require_exec_access() 권한 검증 적용
- [x] VaultCache에서 Program 조회 로직 구현
- [x] exec vault 스캔하여 program_id 일치 Project 필터링
- [x] RoundSummary, ProgramRoundsResponse Pydantic 모델 정의
- [x] 민감 필드 필터링 로직 (salary, contract_terms 제외)
- [x] 에러 핸들링 (HTTPException 404, 403, 500)
- [ ] 테스트 코드 작성
- [x] 빌드 확인

### 작업 로그

#### 2026-01-02 18:14
**개요**: Program-Round 조인 API 엔드포인트 구현 완료. LOOP vault의 Program 정보와 exec vault의 Round(Project) 정보를 조인하여 Admin 전용 API로 제공.

**변경사항**:
- 개발: `GET /api/admin/programs/{pgm_id}/rounds` 엔드포인트 추가
- 개발: `ProgramSummary`, `RoundSummary`, `ProgramRoundsResponse` Pydantic 모델 추가
- 개발: exec vault 비동기 스캔 로직 구현 (asyncio.to_thread)
- 개선: 민감 필드 화이트리스트 필터링 (salary, contract_terms 제외)
- 개선: 페이지네이션 지원 (total_count, returned_count, limit_applied)

**파일 변경**:
- `api/models/entities.py` - 3개 응답 모델 추가 (+52 lines)
- `api/routers/mcp_composite.py` - 엔드포인트 + 헬퍼 함수 추가 (+236 lines)
- `50_Projects/.../Tasks/tsk-017-09_*.md` - Task 파일 생성

**결과**: ✅ 빌드 성공, Python 문법 검사 통과, 스키마 검증 통과

**Codex 리뷰 반영**:
- Program 필드 화이트리스트 방식으로 안전한 필드만 노출
- 명시적 admin role 체크 (`if role != "admin"`)
- `_normalize_date()` 함수로 "None" 문자열 방지
- 개별 파일 에러 핸들링 (try-except)

**다음 단계**:
- [ ] API 서버 배포 (`/mcp-server rebuild`)
- [ ] 통합 테스트 실행


---

## 참고 문서

- [[prj-019]] - 소속 Project (Dual-Vault - 정비)
- [[pgm-vault-system]] - 상위 Program
- `api/routers/mcp_composite.py` - 확장 대상 라우터

---

**Created**: 2026-01-02
**Assignee**: 김은향
**Due**: 2026-01-02
