---
entity_type: Task
entity_id: tsk-019-14
entity_name: SSOT - 규칙 3종 인프라 스프린트
created: '2026-01-09'
updated: '2026-01-09'
status: todo
parent_id: prj-019
project_id: prj-019
aliases:
- tsk-019-14
- SSOT 규칙 3종 인프라 스프린트
outgoing_relations: []
validates: []
validated_by: []
assignee: 김은향
start_date: '2026-01-09'
due: '2026-01-16'
priority: high
estimated_hours: 16
actual_hours: null
type: dev
target_project: loop-api
tags:
- ssot
- concurrency
- audit-log
- infrastructure
priority_flag: high
notes: null
---
# SSOT - 규칙 3종 인프라 스프린트

> Task ID: `tsk-019-14` | Project: `prj-019` | Status: todo

## 목표

SSOT_CONTRACT.md에 정의된 규칙 중 미구현 2종(동시성 방지, Audit Log 확장)을 구현하여 n8n + Dashboard + API 동시 운영의 신뢰도를 확보한다.

**완료 조건**:
1. Rule B: `expected_updated_at` + 409 Conflict 동시성 방지 구현
2. Rule C: Audit Log 스키마 확장 (`run_id`, `actor`, `source`, `diff` 등)
3. 클라이언트 업데이트 (Dashboard 409 핸들링, n8n 워크플로우 수정)

---

## Tech Spec

### 현황

| 규칙 | 현재 상태 | 목표 |
|------|----------|------|
| A) Task 파일명 `tsk-{id}.md` | **이미 구현됨** | 추가 작업 없음 |
| B) 동시성 방지 (409 Conflict) | **미구현 (0%)** | API + 클라이언트 구현 |
| C) Audit Log 스키마 확장 | **부분 구현 (40%)** | 필드 확장 |

### Rule B: 동시성 방지

**목표**: 낙관적 동시성 제어 (Optimistic Concurrency Control)

**동작 방식**:
```
1. 클라이언트가 GET으로 엔티티 조회 → updated 값 수신
2. 클라이언트가 PUT 요청 시 expected_updated_at에 해당 값 포함
3. 서버가 현재 updated 값과 비교
4. 불일치 시 → 409 Conflict 반환
5. 일치 시 → 정상 업데이트
```

**수정 파일**:
- `api/models/entities.py`: `expected_updated_at` 필드 추가 (TaskUpdate, ProjectUpdate, HypothesisUpdate)
- `api/routers/tasks.py`: 409 Conflict 로직 추가
- `api/routers/projects.py`: 동일 로직 추가
- `api/routers/hypotheses.py`: 동일 로직 추가

**409 응답 형식**:
```json
{
  "error": "Conflict: Entity was modified",
  "current_updated_at": "2026-01-09T14:35:10Z",
  "expected_updated_at": "2026-01-09T14:30:45Z"
}
```

### Rule C: Audit Log 스키마 확장

**현재 스키마 vs 목표 스키마**:

| 필드 | 현재 | 목표 | 상태 |
|------|------|------|------|
| `run_id` | ❌ | uuid-v4 | 추가 |
| `timestamp` | ✅ | ISO-8601 | OK |
| `actor` | ⚠️ user="api" | user:김은향 \| api:n8n | 확장 |
| `source` | ❌ | ui \| api \| script \| cli | 추가 |
| `modified_fields` | ⚠️ details 내 | ["status", "assignee"] | 구조화 |
| `diff` | ❌ | {field: {old, new}} | 추가 |
| 파일명 | audit.log | audit_log.jsonl | 변경 |

**수정 파일**:
- `api/routers/audit.py`: 함수 시그니처 확장 + 파일명 변경
- `api/routers/tasks.py`: 로깅 호출 업데이트 (diff 포함)
- `api/routers/projects.py`: 동일 업데이트
- `api/routers/hypotheses.py`: 동일 업데이트

### Phase 3: 클라이언트 업데이트

**Dashboard**:
- `_dashboard/js/api.js`: `expected_updated_at` 전달 + 409 핸들링
- `_dashboard/js/state.js`: 엔티티 updated 값 저장
- 409 응답 시 사용자에게 충돌 알림 + 재시도 옵션

**n8n 워크플로우**:
- `_build/n8n_workflows/*.json`: HTTP Request에 동시성 파라미터 추가
- GET → PUT 흐름에서 `updated` 값 전달

---

## Todo

### Phase 1: Rule B - API 동시성 방지
- [ ] `api/models/entities.py` - Pydantic 모델에 `expected_updated_at` 추가
- [ ] `api/routers/tasks.py` - 409 Conflict 로직 추가
- [ ] `api/routers/projects.py` - 동일 로직 추가
- [ ] `api/routers/hypotheses.py` - 동일 로직 추가
- [ ] 테스트: 동시 수정 시나리오 검증

### Phase 2: Rule C - Audit Log 확장
- [ ] `api/routers/audit.py` - 함수 시그니처 확장 + 파일명 변경
- [ ] `api/routers/tasks.py` - 로깅 호출 업데이트 (diff 포함)
- [ ] `api/routers/projects.py` - 동일 업데이트
- [ ] `api/routers/hypotheses.py` - 동일 업데이트
- [ ] 테스트: 로그 형식 검증

### Phase 3: 클라이언트 업데이트
- [ ] `_dashboard/js/api.js` - 409 에러 핸들링 UI
- [ ] `_dashboard/js/state.js` - updated 값 저장
- [ ] n8n 워크플로우 - 동시성 파라미터 추가
- [ ] `loop-entity-creator` 스킬 - API 호출 시 동시성 지원

---

## 검증 방법

### Rule B 검증
```bash
# 1. Task 조회
curl -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/tasks/tsk-001-01"
# → updated 값 확인

# 2. 정상 업데이트 (일치하는 expected_updated_at)
curl -X PUT -H "Authorization: Bearer $LOOP_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"status": "done", "expected_updated_at": "2026-01-09T..."}' \
  "$LOOP_API_URL/api/tasks/tsk-001-01"
# → 200 OK

# 3. 충돌 테스트 (불일치하는 expected_updated_at)
curl -X PUT ... \
  -d '{"status": "done", "expected_updated_at": "2026-01-01T00:00:00"}' \
  "$LOOP_API_URL/api/tasks/tsk-001-01"
# → 409 Conflict
```

### Rule C 검증
```bash
# 로그 파일 확인
tail -5 public/_build/audit_log.jsonl | jq .

# 필수 필드 존재 확인: run_id, actor, source, modified_fields, diff
```

### 클라이언트 검증
1. 브라우저 탭 2개에서 동일 Task 열기
2. 탭 A에서 status 변경 → 저장
3. 탭 B에서 priority 변경 → 저장 시도
4. 409 Conflict 알림 표시 확인

---

## Codex Review (2026-01-09)

> Codex (gpt-5.1-codex-max)가 검토한 PRD 피드백

### Critical Issues (구현 시 반영 필요)

1. **타임스탬프 정밀도**: `expected_updated_at`의 형식/정밀도/타임존 명시 필요 (UTC ISO-8601, 마이크로초 권장)
2. **DELETE/PATCH 규칙 누락**: PUT만 언급됨. DELETE에도 동시성 체크 필요한지 결정 필요
3. **updated 변경 시점**: 어떤 필드 변경 시 updated가 갱신되는지 명시 필요 (no-op 업데이트 포함?)
4. **에러 응답 계약**: 409 응답에 entity_id 포함? 다른 validation 에러와 구분?

### Medium Priority Suggestions

5. **캐시 레이어**: 캐시된 GET이 stale updated 반환 시 지속적 409 발생 가능
6. **Dashboard 재시도 UX**: "재시도 옵션"의 구체적 흐름 (전체 payload 재시도? refresh 먼저?)
7. **actor/source 검증**: 클라이언트 제공 시 spoofing 위험 → 서버 측 검증 필요
8. **run_id 의미**: 요청별? 워크플로우별? 전파 방식?

### Low Priority (Future Consideration)

9. **Audit log 보안**: 파일 권한, 로테이션, 크기 제한, PII 수정
10. **diff 계산**: 배열/중첩 객체 처리 방식, 크기 제한
11. **기존 audit.log 마이그레이션**: 새 파일로 전환 시 기존 로그 처리 방안

### Decisions Made

| 항목 | 결정 |
|------|------|
| 버전 방식 | 타임스탬프 유지 (integer version 아님) - 단순성 우선 |
| DELETE 동시성 | 현재 범위 외 (향후 고려) |
| PATCH | 현재 범위 외 (PUT만 지원) |
| actor/source | 서버에서 추론 (클라이언트 override 불가) |

---

## 참고 문서

- [[prj-019]] - 소속 Project
- [[00_Meta/SSOT_CONTRACT.md]] - SSOT 규칙 정의
- [[tsk-019-07]] - SSOT 규칙 구현 상태 검증 (Gap Analysis)
- Plan file: `/Users/gim-eunhyang/.claude/plans/structured-questing-candy.md`

---

**Created**: 2026-01-09
**Assignee**: 김은향
**Due**: 2026-01-16
