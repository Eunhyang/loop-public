---
entity_type: Task
entity_id: tsk-023-1768228605920
entity_name: Task Drawer - Link Preview Card
created: '2026-01-12'
updated: '2026-01-13'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-12'
due: '2026-01-12'
aliases:
- tsk-023-1768228605920
tags: []
type: dev
notes: '# Task Drawer - Link Preview Card


  ## 설명


  ## 체크리스트


  - \[ \]


  ## 참고'
---
# Task Drawer - Link Preview Card

## 설명

Task Drawer에 Notion 스타일 링크 프리뷰 카드 기능 추가. OG 메타 태그(title, description, image)를 가져와 카드 형태로 표시하며, 실패 시 favicon + 도메인명을 fallback으로 표시한다.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Architecture Pattern: Clean Architecture + SSOT + Feature-based Modules
- Follows: `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/P023_Dashboard_ReactTS_마이그레이션/project.md`

**File Structure:**
```
public/api/routers/
└── link_preview.py                    # NEW: OG metadata fetch endpoint

public/dashboard-v2/src/
├── types/
│   └── task.ts                        # MODIFY: Add LinkPreview interface
├── features/tasks/
│   ├── api.ts                         # MODIFY: Add getLinkPreview function
│   ├── queries.ts                     # MODIFY: Add useLinkPreview hook
│   └── components/
│       ├── LinkPreviewCard.tsx        # NEW: Preview card component
│       └── LinkEditor.tsx             # MODIFY: Replace text links with preview cards
└── queries/
    └── keys.ts                        # MODIFY: Add linkPreview key
```

**Implementation Details:**

**Backend API:**
- **Router**: `/Users/gim-eunhyang/dev/loop/public/api/routers/link_preview.py`
  - Endpoint: `GET /api/link-preview?url={url}`
  - Response Schema:
    ```python
    {
      "url": str,
      "title": str | None,
      "description": str | None,
      "image": str | None,
      "site_name": str | None,
      "favicon": str | None
    }
    ```
  - Dependencies: `httpx`, `beautifulsoup4`, `lxml` (add to pyproject.toml [project.optional-dependencies.api])
  - TTL Cache: 24 hours, max 1000 entries
  - Timeout: 5 seconds
  - Security: Block internal IPs (127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
  - Error Handling: Return partial data on parse errors, empty fields on fetch failure

- **Router Registration**: Modify `/Users/gim-eunhyang/dev/loop/public/api/main.py`
  - Import: `from .routers import link_preview`
  - Include: `app.include_router(link_preview.router, prefix="/api", tags=["link-preview"])`

**Frontend Types:**
- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/types/task.ts`
  - Add interface:
    ```typescript
    export interface LinkPreview {
      url: string;
      title: string | null;
      description: string | null;
      image: string | null;
      site_name: string | null;
      favicon: string | null;
    }
    ```

**Frontend API Layer:**
- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/api.ts`
  - Add function:
    ```typescript
    getLinkPreview: (url: string) =>
      httpClient.get<LinkPreview>('/api/link-preview', { params: { url } })
        .then(res => res.data)
    ```

**React Query Hook:**
- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/queries.ts`
  - Add hook:
    ```typescript
    export const useLinkPreview = (url: string | null) =>
      useQuery({
        queryKey: queryKeys.linkPreview(url),
        queryFn: () => taskApi.getLinkPreview(url!),
        enabled: !!url && url.startsWith('http'),
        staleTime: 60 * 60 * 1000, // 1 hour client-side cache
        retry: 1, // Only retry once on failure
      });
    ```

- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/queries/keys.ts`
  - Add key:
    ```typescript
    linkPreview: (url: string | null) => ['linkPreview', url] as const
    ```

**New Component: LinkPreviewCard**
- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/components/LinkPreviewCard.tsx`
  - Props:
    ```typescript
    interface LinkPreviewCardProps {
      url: string;
      label: string;
      onRemove?: () => void; // Optional, only in edit mode
      readOnly?: boolean;
    }
    ```
  - Layout:
    - Card container: `border border-zinc-200 rounded-lg p-3 hover:bg-zinc-50 transition-colors cursor-pointer`
    - Flex layout: `flex gap-3 items-start`
    - Thumbnail: `60x60px`, rounded, object-cover, fallback to site icon or globe emoji
    - Content: `flex-1 min-w-0` (prevent overflow)
      - Title: `font-medium text-sm text-zinc-900 truncate` (1 line)
      - Description: `text-xs text-zinc-600 line-clamp-2` (2 lines max)
      - Domain: `text-xs text-zinc-400 flex items-center gap-1` (globe icon + domain)
    - Remove button (edit mode only): `absolute top-2 right-2 text-zinc-400 hover:text-red-600 transition-colors`
  - States:
    - Loading: Skeleton animation (shimmer effect)
    - Error/Fallback: Show favicon + domain only
    - Success: Full card with image/title/description
  - Behavior:
    - Click: Open URL in new tab (`target="_blank" rel="noopener noreferrer"`)
    - Remove button: Call `onRemove()` callback (only in edit mode)

**Modified Component: LinkEditor**
- **File**: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/components/LinkEditor.tsx`
  - Replace text link rendering (lines 92-104, 113-131) with `<LinkPreviewCard>`
  - Read-only mode:
    ```tsx
    <div className="space-y-2">
      {links.map((link, idx) => (
        <LinkPreviewCard
          key={idx}
          url={link.url}
          label={link.label}
          readOnly={true}
        />
      ))}
    </div>
    ```
  - Edit mode:
    ```tsx
    <div className="space-y-2">
      {links.map((link, idx) => (
        <LinkPreviewCard
          key={idx}
          url={link.url}
          label={link.label}
          onRemove={() => handleRemove(idx)}
          readOnly={false}
        />
      ))}
    </div>
    ```
  - Keep existing add/edit form logic unchanged (lines 140-186)

**Data Storage:**
- Vault SSOT: Only `{ label, url }` stored in Task frontmatter (no change)
- OG metadata: NOT stored in vault, only cached server-side (24h) and client-side (1h)
- Rationale: External data can change; vault remains SSOT for user-provided data only

**Edge Cases:**
- **Invalid URL**: Do not call API, show original text link format
- **Fetch timeout (5s)**: Return empty metadata, show fallback (favicon + domain)
- **No OG tags**: Parse basic HTML (title tag), use favicon, show domain
- **CORS error**: Server-side fetch bypasses CORS, but if URL blocks requests, show fallback
- **Image load failure**: Use alt text or hide image, show text-only card
- **Internal IP in URL**: Backend blocks request, return error, show fallback
- **Malformed HTML**: BeautifulSoup handles gracefully, extract what's available
- **Cache miss**: Fresh fetch from API (5s timeout applies)
- **Edit mode removal**: onClick on card vs remove button - use stopPropagation() on remove button
- **Multiple identical URLs**: Each gets own preview (no deduplication in UI)

**Key Functions:**

Backend (`api/routers/link_preview.py`):
```python
@router.get("/link-preview")
async def get_link_preview(url: str) -> LinkPreviewResponse:
    """
    Fetch OG metadata for URL.

    Args:
        url: Full URL starting with http/https

    Returns:
        LinkPreviewResponse with title, description, image, site_name, favicon

    Raises:
        HTTPException 400: Invalid URL format
        HTTPException 403: Internal IP blocked
    """
    pass

def is_internal_ip(url: str) -> bool:
    """Check if URL resolves to internal/private IP"""
    pass

def extract_og_metadata(html: str, url: str) -> dict:
    """Parse HTML and extract OG tags + fallbacks"""
    pass
```

Frontend (`src/features/tasks/components/LinkPreviewCard.tsx`):
```typescript
const LinkPreviewCard: React.FC<LinkPreviewCardProps> = ({
  url,
  label,
  onRemove,
  readOnly = false
}) => {
  const { data: preview, isLoading, isError } = useLinkPreview(url);

  const handleCardClick = (e: React.MouseEvent) => {
    if (readOnly || !onRemove) {
      window.open(url, '_blank', 'noopener,noreferrer');
    }
  };

  const handleRemoveClick = (e: React.MouseEvent) => {
    e.stopPropagation(); // Prevent card click
    onRemove?.();
  };

  // Render loading, error, or success state
};
```

**Dependencies:**
- Backend: Add to `pyproject.toml` under `[project.optional-dependencies.api]`:
  - `httpx>=0.27.0` (async HTTP client)
  - `beautifulsoup4>=4.12.0` (HTML parsing)
  - `lxml>=5.0.0` (fast HTML parser)
- Frontend: No new packages (React Query already configured)

### Todo
- [ ] Add `httpx`, `beautifulsoup4`, `lxml` to `pyproject.toml` under `[project.optional-dependencies.api]`
- [ ] Create backend router `public/api/routers/link_preview.py` with OG metadata fetch logic
- [ ] Register link_preview router in `public/api/main.py`
- [ ] Add `LinkPreview` interface to `public/dashboard-v2/src/types/task.ts`
- [ ] Add `getLinkPreview` function to `public/dashboard-v2/src/features/tasks/api.ts`
- [ ] Add `linkPreview` query key to `public/dashboard-v2/src/queries/keys.ts`
- [ ] Add `useLinkPreview` hook to `public/dashboard-v2/src/features/tasks/queries.ts`
- [ ] Create `LinkPreviewCard` component at `public/dashboard-v2/src/features/tasks/components/LinkPreviewCard.tsx`
- [ ] Modify `LinkEditor` component to use `LinkPreviewCard` (replace text links in read/edit modes)
- [ ] Test backend endpoint: `curl "http://localhost:8081/api/link-preview?url=https://github.com"`
- [ ] Test frontend: Add link in Task Drawer, verify preview card displays correctly
- [ ] Test fallback: Use URL without OG tags, verify favicon + domain displays
- [ ] Test error handling: Use invalid URL, verify graceful fallback
- [ ] Test edit mode: Verify remove button works and doesn't trigger card click
- [ ] Test read-only mode: Verify card click opens URL in new tab
- [ ] Run `npm run build` in `public/dashboard-v2/` directory
- [ ] Verify TypeScript compilation passes with no errors

## 체크리스트

- [ ] Backend API endpoint implemented and tested
- [ ] Frontend types, API layer, and query hooks added
- [ ] LinkPreviewCard component implemented with all states
- [ ] LinkEditor modified to use preview cards
- [ ] Manual testing completed (success, fallback, error cases)
- [ ] Build passes without errors

## 참고

- Project Architecture: `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/P023_Dashboard_ReactTS_마이그레이션/project.md`
- Plan Reference: `/Users/gim-eunhyang/.claude/plans/streamed-frolicking-hedgehog.md`
- Existing LinkEditor: `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/components/LinkEditor.tsx`

## Execution Log

### Implementation Summary (2026-01-12)

**Status**: ✅ Implementation Complete

**Files Modified/Created**:

1. **Backend (API)**:
   - ✅ `/Users/gim-eunhyang/dev/loop/public/pyproject.toml` - Added dependencies (httpx, beautifulsoup4, lxml)
   - ✅ `/Users/gim-eunhyang/dev/loop/public/api/routers/link_preview.py` - NEW: OG metadata fetch router with caching and security
   - ✅ `/Users/gim-eunhyang/dev/loop/public/api/main.py` - Registered link_preview router

2. **Frontend (Types & API)**:
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/types/task.ts` - Added LinkPreview interface
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/api.ts` - Added getLinkPreview function
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/queries/keys.ts` - Added linkPreview query key
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/queries.ts` - Added useLinkPreview hook

3. **Frontend (Components)**:
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/components/LinkPreviewCard.tsx` - NEW: Preview card component with loading/error/success states
   - ✅ `/Users/gim-eunhyang/dev/loop/public/dashboard-v2/src/features/tasks/components/LinkEditor.tsx` - Modified to use LinkPreviewCard (replaced text links)

**Implementation Details**:

Backend API (`/api/link-preview`):
- ✅ OG metadata extraction (title, description, image, site_name, favicon)
- ✅ 24-hour TTL cache (max 1000 entries)
- ✅ 5-second timeout for external requests
- ✅ Security: Blocks internal IPs (127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
- ✅ Graceful error handling (returns empty metadata on failure)
- ✅ BeautifulSoup HTML parsing with lxml parser

Frontend Component:
- ✅ Loading state with skeleton animation
- ✅ Error/fallback state with favicon + domain
- ✅ Success state with full card (image/title/description)
- ✅ Read-only mode (click opens URL in new tab)
- ✅ Edit mode (remove button with stopPropagation)
- ✅ 1-hour client-side cache (React Query staleTime)
- ✅ Inline SVG icons (no external dependencies)

**Build Verification**:
- ✅ TypeScript compilation: No errors in new files
- ✅ Pre-existing errors in other components (unrelated to this task)
- ✅ All SSOT principles followed (no metadata stored in vault)

**Architecture Compliance**:
- ✅ Clean Architecture: API layer → Query hooks → Components
- ✅ SSOT: Only `{ label, url }` stored in vault frontmatter
- ✅ Feature-based modules: All code in `features/tasks/`
- ✅ No common/ pollution: LinkPreviewCard is domain-specific

**Next Steps**:
1. Install backend dependencies: `cd public && poetry install --with api`
2. Restart API server: `/mcp-server rebuild`
3. Manual testing in Dashboard v2:
   - Add link in Task Drawer
   - Verify preview card displays
   - Test fallback with non-OG URL
   - Test edit mode remove button
   - Test read-only mode click behavior

**Test Scenarios to Verify**:
- [ ] Valid OG tags URL (e.g., https://github.com)
- [ ] URL without OG tags (fallback to title + favicon)
- [ ] Invalid/timeout URL (graceful fallback)
- [ ] Edit mode: Remove button vs card click
- [ ] Read-only mode: Card click opens new tab
- [ ] Loading state during fetch
- [ ] Cached response (should be instant on 2nd load)

**Codex Review**: Pending (Step 6 not executed per workflow modification)
