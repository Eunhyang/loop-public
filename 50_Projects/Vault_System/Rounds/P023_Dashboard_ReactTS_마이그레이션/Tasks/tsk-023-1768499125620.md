---
entity_type: Task
entity_id: tsk-023-1768499125620
entity_name: Dashboard - Hypothesis CRUD 구현
created: '2026-01-16'
updated: '2026-01-16'
status: done
closed: '2026-01-16'
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768499125620
tags: []
type: dev
---

# Dashboard - Hypothesis CRUD 구현

## 설명

Dashboard v2에 Hypothesis 엔티티의 CRUD(Create, Read, Update, Delete) 기능을 구현한다.

**현황**:
- **API 백엔드**: `/api/hypotheses` CRUD 완전 구현됨 ✅
- **프론트엔드**: `HypothesisForm.tsx`가 View-Only 상태 (읽기만 가능)

**작업 범위**: 프론트엔드만 작업 (API는 이미 완료)

---

## Tech Spec

### Architecture Compliance

- **Parent Project**: prj-023 (Dashboard - React+TS 마이그레이션)
- **Target**: ~/dev/loop/code/dashboard-v2

### File Structure

```
code/dashboard-v2/src/
├── types/
│   ├── hypothesis.ts            # [NEW] Hypothesis 타입 정의
│   └── index.ts                 # [MODIFY] export 추가
├── features/strategy/
│   ├── api.ts                   # [NEW] Hypothesis API 호출 함수
│   ├── queries.ts               # [NEW] React Query hooks
│   └── components/
│       └── HypothesisForm.tsx   # [MODIFY] View-only → Full CRUD
└── queries/
    └── keys.ts                  # [MODIFY] hypothesis keys 추가
```

### Implementation Details

#### 1. Type Definition (`types/hypothesis.ts`)

> **Note**: 기존 `types/index.ts`에 간단한 Hypothesis 인터페이스가 있음. 새 파일로 확장 후 re-export.

```typescript
export interface Hypothesis {
  entity_id: string;
  entity_name: string;
  parent_id: string;           // Track ID (trk-N)
  hypothesis_question: string; // Must end with ?
  success_criteria: string;
  failure_criteria: string;
  measurement: string;
  horizon: string;             // 4-digit year (e.g., "2026")
  deadline?: string;
  evidence_status: 'assumed' | 'validating' | 'validated' | 'falsified' | 'learning';
  confidence: number;          // 0.0 ~ 1.0
  loop_layer: string[];
  tags: string[];
  validates?: string[];        // Project IDs
  created: string;
  updated: string;
  _body?: string;              // Markdown body (from API)
}

export interface CreateHypothesisDTO {
  entity_name: string;
  parent_id: string;           // Required: trk-N format
  hypothesis_question: string; // Required: must end with ?
  success_criteria: string;
  failure_criteria: string;
  measurement: string;
  horizon?: string;            // Default: current year
  deadline?: string;
  evidence_status?: string;    // Default: 'assumed'
  confidence?: number;         // Default: 0.0
  loop_layer?: string[];
  tags?: string[];
  project_ids?: string[];      // Links to Project.validates
}

export interface UpdateHypothesisDTO {
  entity_name?: string;
  hypothesis_question?: string;
  success_criteria?: string;
  failure_criteria?: string;
  measurement?: string;
  horizon?: string;
  deadline?: string;
  evidence_status?: string;
  confidence?: number;
  loop_layer?: string[];
  tags?: string[];
  expected_updated_at?: string; // Optimistic locking
}
```

#### 2. API Layer (`features/strategy/api.ts`)

```typescript
import { httpClient } from '@/services/http';
import { Hypothesis, CreateHypothesisDTO, UpdateHypothesisDTO } from '@/types/hypothesis';

interface HypothesisResponse {
  success: boolean;
  hypothesis_id: string;
  file_path?: string;
  message: string;
}

interface HypothesisDetailResponse extends Hypothesis {
  _body?: string;
  _path?: string;
}

export const hypothesisApi = {
  getHypotheses: (params?: { parent_id?: string; evidence_status?: string; horizon?: string }) =>
    httpClient.get<{ hypotheses: Hypothesis[] }>('/api/hypotheses', { params }),

  getHypothesis: (id: string) =>
    httpClient.get<HypothesisDetailResponse>(`/api/hypotheses/${id}`),

  createHypothesis: (data: CreateHypothesisDTO) =>
    httpClient.post<HypothesisResponse>('/api/hypotheses', data),

  updateHypothesis: (id: string, data: UpdateHypothesisDTO) =>
    httpClient.put<HypothesisResponse>(`/api/hypotheses/${id}`, data),

  deleteHypothesis: (id: string) =>
    httpClient.delete<HypothesisResponse>(`/api/hypotheses/${id}`),
};
```

#### 3. Query Hooks (`features/strategy/queries.ts`)

- `useHypothesis(id)` - 단일 조회 (enabled when id provided)
- `useCreateHypothesis()` - 생성 mutation + dashboardInit invalidate
- `useUpdateHypothesis()` - 수정 mutation + optimistic update
- `useDeleteHypothesis()` - 삭제 mutation + cache remove

**Cache Invalidation 전략** (Codex 피드백 반영):
```typescript
// Create: dashboardInit 전체 invalidate (hypotheses 목록 갱신)
onSuccess: () => queryClient.invalidateQueries({ queryKey: queryKeys.dashboardInit })

// Update: 개별 hypothesis + dashboardInit invalidate
onSuccess: (_, { id }) => {
  queryClient.invalidateQueries({ queryKey: queryKeys.hypothesis(id) });
  queryClient.invalidateQueries({ queryKey: queryKeys.dashboardInit });
}

// Delete: 개별 제거 + dashboardInit invalidate
onSuccess: (_, id) => {
  queryClient.removeQueries({ queryKey: queryKeys.hypothesis(id) });
  queryClient.invalidateQueries({ queryKey: queryKeys.dashboardInit });
}
```

**Optimistic Locking 처리** (409 Conflict):
```typescript
// Update 시 expected_updated_at 전송
const { mutate: updateHypothesis } = useUpdateHypothesis();
updateHypothesis({
  id: hypothesis.entity_id,
  data: { ...changes, expected_updated_at: hypothesis.updated }
});

// 409 에러 처리
onError: (error, variables, context) => {
  if (error.response?.status === 409) {
    toast.error('다른 사용자가 수정했습니다. 새로고침 후 다시 시도하세요.');
    queryClient.invalidateQueries({ queryKey: queryKeys.hypothesis(variables.id) });
  }
  // rollback
  if (context?.previousData) {
    queryClient.setQueryData(queryKeys.hypothesis(variables.id), context.previousData);
  }
}
```

Pattern: Task/Project queries.ts 참조 (optimistic update + rollback)

#### 4. Query Keys (`queries/keys.ts`)

```typescript
export const queryKeys = {
  // ... existing keys
  hypotheses: () => ['hypotheses'] as const,
  hypothesis: (id: string) => ['hypotheses', id] as const,
};
```

#### 5. HypothesisForm 확장 (`features/strategy/components/HypothesisForm.tsx`)

**Mode 지원**: `'create' | 'edit' | 'view'`

**필수 필드**:
- entity_name (텍스트)
- parent_id (Track 선택 - dashboardInit.tracks)
- hypothesis_question (텍스트, "?"로 끝나야 함)
- success_criteria (텍스트)
- failure_criteria (텍스트)
- measurement (텍스트)

**선택 필드**:
- horizon (년도 선택, 기본: 현재 연도)
- deadline (날짜 선택)
- evidence_status (ChipSelect: assumed/validating/validated/falsified/learning)
- confidence (슬라이더 0.0~1.0)
- loop_layer (다중 선택: emotional/eating/habit/reward/autonomic)
- tags (다중 입력)

**UI 패턴**: TaskForm/ProjectForm의 PropertiesGrid + PropertyRow 패턴 사용

**Form UX** (Codex 피드백 반영):
- **저장 방식**: Submit 버튼 클릭 시 저장 (auto-save 아님)
- **Delete 버튼**: Form footer에 위치 (edit 모드에서만 표시)
- **Delete 확인**: 확인 모달 표시 후 삭제 실행
- **Create 모드**: Track 선택 필수, 저장 성공 시 Drawer 닫기
- **Edit 모드**: 변경 감지 후 저장 버튼 활성화

**EntityDrawer 통합**:
- `src/components/layout/EntityDrawer.tsx`에 `useDeleteHypothesis` import 추가
- hypothesis 타입일 때 delete 액션 렌더링 추가 (line 85-175 참조)

### Edge Cases

1. **hypothesis_question 검증**: "?"로 끝나지 않으면 저장 전 경고
2. **parent_id 미선택**: Track 선택 필수 - 폼 제출 차단
3. **Optimistic locking 실패**: 409 응답 시 "다른 사용자가 수정함" 알림 + reload
4. **삭제 확인**: 삭제 전 확인 모달 표시

---

## 체크리스트

- [ ] `src/types/hypothesis.ts` 생성 - Type 정의
- [ ] `src/types/index.ts` 수정 - Hypothesis export 추가
- [ ] `src/features/strategy/api.ts` 생성 - API 호출 함수
- [ ] `src/features/strategy/queries.ts` 생성 - React Query hooks
- [ ] `src/queries/keys.ts` 수정 - hypothesis keys 추가
- [ ] `src/features/strategy/components/HypothesisForm.tsx` 수정 - Full CRUD 지원
- [ ] `src/components/layout/EntityDrawer.tsx` 수정 - Hypothesis delete 지원
- [ ] `npm run build` 통과 확인
- [ ] 로컬 테스트: Create/Read/Update/Delete 동작 확인

---

## 검증 방법

```bash
# 1. API 서버 실행
cd ~/dev/loop/code && poetry run uvicorn api.main:app --port 8081 --reload

# 2. Dashboard 개발 서버 실행
cd ~/dev/loop/code/dashboard-v2 && npm run dev

# 3. CRUD 테스트
# - Create: Track Drawer에서 "+" 클릭 → Hypothesis 생성
# - Read: 생성된 Hypothesis 클릭 → 상세 표시 확인
# - Update: Edit 모드에서 필드 수정 → 저장
# - Delete: 삭제 버튼 → 확인 → 삭제 완료

# 4. 빌드 확인
npm run build
```

---

## 작업 로그

#### 2026-01-16 03:05
**개요**: Dashboard v2에 Hypothesis CRUD 기능 구현 완료

**변경사항**:
- 개발: Hypothesis 타입 정의 (comprehensive schema)
- 개발: API 레이어 (hypothesisApi with full CRUD endpoints)
- 개발: React Query hooks (useHypothesis, useCreateHypothesis, useUpdateHypothesis, useDeleteHypothesis)
- 수정: HypothesisForm 컴포넌트를 View-Only에서 Full CRUD로 확장
- 수정: EntityDrawer에 Hypothesis 삭제 액션 추가
- 수정: Query keys에 hypothesis 관련 키 추가

**파일 변경**:
- `dashboard-v2/src/types/hypothesis.ts` - 새로 생성: Hypothesis, CreateHypothesisDTO, UpdateHypothesisDTO 타입 정의
- `dashboard-v2/src/types/index.ts` - 수정: hypothesis.ts export 추가
- `dashboard-v2/src/features/strategy/api.ts` - 새로 생성: hypothesisApi (getHypotheses, getHypothesis, createHypothesis, updateHypothesis, deleteHypothesis)
- `dashboard-v2/src/features/strategy/queries.ts` - 새로 생성: React Query hooks with optimistic updates
- `dashboard-v2/src/queries/keys.ts` - 수정: hypotheses(), hypothesis(id) keys 추가
- `dashboard-v2/src/features/strategy/components/HypothesisForm.tsx` - 수정: Full CRUD 지원 (create/edit/view 모드)
- `dashboard-v2/src/components/layout/EntityDrawer.tsx` - 수정: useDeleteHypothesis import 및 delete 액션 추가

**결과**: ✅ 빌드 성공 (npm run build 통과), 배포 준비 완료

**커밋**: `6ecaffa4a` on branch `main` (merged from `task/tsk-023-1768499125620`)

---

## 참고

- API: `/api/hypotheses` (code/api/routers/hypotheses.py)
- Pattern: TaskForm, ProjectForm 참조
- 계획 파일: ~/.claude/plans/eager-purring-kernighan.md
