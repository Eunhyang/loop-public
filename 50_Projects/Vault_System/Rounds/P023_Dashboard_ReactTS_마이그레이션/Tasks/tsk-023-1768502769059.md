---
entity_type: Task
entity_id: tsk-023-1768502769059
entity_name: API - suggest_batch MISSING_CONSTRAINTS 기본값 자동 생성
created: '2026-01-16'
updated: '2026-01-16'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768502769059
tags: []
type: dev
notes: "# API - suggest_batch MISSING_CONSTRAINTS 기본값 자동 생성\n\n## 설명\n\n`suggest_batch`\
  \ API 호출 시 프로젝트에 `parent_id`, `conditions_3y` 등이 없으면 `MISSING_CONSTRAINTS` 에러가 발생한다.\
  \ 이를 vault 전체를 기본 allowlist로 사용하도록 수정하여 LLM 호출이 진행되도록 한다.\n\n### 문제 상황\n\nChatGPT에서\
  \ MCP 도구로 `suggest_batch` 호출 시 일부 프로젝트에서 에러 발생:\n\n```\nconstraints are required\
  \ for suggest_batch\n```\n\n**원인**: `build_constraints_from_context()` 함수에서 다음 필드가\
  \ 비어있으면 constraints 생성 실패:\n\n- `allowed_condition_ids`: `project.conditions_3y`가\
  \ 없음\n- `allowed_track_ids`: `project.parent_id`가 없음 (Track 미연결)\n- `allowed_hypothesis_ids`:\
  \ `parent_id` 없어서 `filter_candidate_hypotheses()` 스킵\n\n## Notes\n\n### Tech Spec\n\
  \n**Architecture Compliance:**\n\n- Parent Project: prj-023 (Dashboard v2)\n- Target:\
  \ loop (LOOP API)\n\n**File Structure:**\n\n```\n~/dev/loop/code/api/routers/impact_batch.py\
  \  # 수정 대상\n```\n\n**Implementation Details:**\n\n1. `build_constraints_from_context()`\
  \ 함수 수정 (L352-414)\n\n현재 로직:\n\n```python\n# conditions_3y 없으면 빈 리스트\nallowed_condition_ids\
  \ = []\n\n# parent_id 없으면 빈 리스트\nallowed_track_ids = []\n\n# parent_id 없으면 빈 리스트\
  \ (filter_candidate_hypotheses가 빈 결과)\nallowed_hypothesis_ids = []\n```\n\n수정 로직\
  \ (각 allowlist 생성 후 fallback 추가):\n\n```python\n# Fallback: vault 전체 Condition\n\
  if not allowed_condition_ids:\n    all_conditions = cache.get_all_conditions() if\
  \ hasattr(cache, 'get_all_conditions') else []\n    allowed_condition_ids = [c.get(\"\
  entity_id\") for c in all_conditions if c.get(\"entity_id\")]\n\n# Fallback: vault\
  \ 전체 Track\nif not allowed_track_ids:\n    all_tracks = cache.get_all_tracks() if\
  \ hasattr(cache, 'get_all_tracks') else []\n    allowed_track_ids = [t.get(\"entity_id\"\
  ) for t in all_tracks if t.get(\"entity_id\")]\n\n# Fallback: vault 전체 Hypothesis\n\
  if not allowed_hypothesis_ids:\n    all_hypotheses = cache.get_all_hypotheses()\
  \ if hasattr(cache, 'get_all_hypotheses') else []\n    allowed_hypothesis_ids =\
  \ [h.get(\"entity_id\") for h in all_hypotheses if h.get(\"entity_id\")]\n```\n\n\
  2. 에러 처리 로직 수정 (L871-887)\n\n현재: constraints 비면 즉시 실패\n\n```python\nif not item_constraints\
  \ or not item_constraints.allowed_*:\n    error=SuggestBatchError(code=\"MISSING_CONSTRAINTS\"\
  , ...)\n```\n\n수정: fallback이 항상 채워지므로 에러 블록 제거 또는 간소화\n\n```python\nif not item_constraints:\n\
  \    # constraints 객체 자체가 None인 경우만 실패\n    error=SuggestBatchError(code=\"MISSING_CONSTRAINTS\"\
  , ...)\n```\n\n**Edge Cases:**\n\n- vault에 Track/Condition/Hypothesis가 하나도 없는 경우:\
  \ 빈 리스트 유지 (기존과 동일)\n- cache 메서드가 없는 경우: `hasattr` 체크로 안전 처리 (기존 패턴 유지)\n\n### Todo\n\
  \n- [ ] `build_constraints_from_context()` 수정 - 각 allowlist에 vault 전체 fallback 추가\
  \ (`code/api/routers/impact_batch.py:361-390`)\n\n- [ ] 에러 처리 로직 간소화 (`code/api/routers/impact_batch.py:872-887`)\n\
  \n- [ ] 로컬 API 서버로 테스트 (`poetry run uvicorn api.main:app --reload`)\n\n- [ ] `parent_id`,\
  \ `conditions_3y` 없는 프로젝트로 suggest_batch 호출 테스트\n\n- [ ] npm run build 통과 확인 (Dashboard\
  \ 영향 없음)\n\n## 참고\n\n- 기존 Plan 파일: `~/.claude/plans/foamy-strolling-marble.md`\n\
  - 관련 코드: `code/api/routers/impact_batch.py`\n- cache 메서드: `get_all_conditions()`,\
  \ `get_all_tracks()`, `get_all_hypotheses()`"
---
# API - suggest_batch MISSING_CONSTRAINTS 기본값 자동 생성

## 설명

`suggest_batch` API 호출 시 프로젝트에 `parent_id`, `conditions_3y` 등이 없으면 `MISSING_CONSTRAINTS` 에러가 발생한다.
이를 vault 전체를 기본 allowlist로 사용하도록 수정하여 LLM 호출이 진행되도록 한다.

### 문제 상황

ChatGPT에서 MCP 도구로 `suggest_batch` 호출 시 일부 프로젝트에서 에러 발생:
```
constraints are required for suggest_batch
```

**원인**: `build_constraints_from_context()` 함수에서 다음 필드가 비어있으면 constraints 생성 실패:
- `allowed_condition_ids`: `project.conditions_3y`가 없음
- `allowed_track_ids`: `project.parent_id`가 없음 (Track 미연결)
- `allowed_hypothesis_ids`: `parent_id` 없어서 `filter_candidate_hypotheses()` 스킵

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard v2)
- Target: loop (LOOP API)

**File Structure:**
```
~/dev/loop/code/api/routers/impact_batch.py  # 수정 대상
```

**Implementation Details:**

1. `build_constraints_from_context()` 함수 수정 (L352-414)

현재 로직:
```python
# conditions_3y 없으면 빈 리스트
allowed_condition_ids = []

# parent_id 없으면 빈 리스트
allowed_track_ids = []

# parent_id 없으면 빈 리스트 (filter_candidate_hypotheses가 빈 결과)
allowed_hypothesis_ids = []
```

수정 로직 (각 allowlist 생성 후 fallback 추가):
```python
# Fallback: vault 전체 Condition
if not allowed_condition_ids:
    all_conditions = cache.get_all_conditions() if hasattr(cache, 'get_all_conditions') else []
    allowed_condition_ids = [c.get("entity_id") for c in all_conditions if c.get("entity_id")]

# Fallback: vault 전체 Track
if not allowed_track_ids:
    all_tracks = cache.get_all_tracks() if hasattr(cache, 'get_all_tracks') else []
    allowed_track_ids = [t.get("entity_id") for t in all_tracks if t.get("entity_id")]

# Fallback: vault 전체 Hypothesis
if not allowed_hypothesis_ids:
    all_hypotheses = cache.get_all_hypotheses() if hasattr(cache, 'get_all_hypotheses') else []
    allowed_hypothesis_ids = [h.get("entity_id") for h in all_hypotheses if h.get("entity_id")]
```

2. 에러 처리 로직 수정 (L871-887)

현재: constraints 비면 즉시 실패
```python
if not item_constraints or not item_constraints.allowed_*:
    error=SuggestBatchError(code="MISSING_CONSTRAINTS", ...)
```

수정: fallback이 항상 채워지므로 에러 블록 제거 또는 간소화
```python
if not item_constraints:
    # constraints 객체 자체가 None인 경우만 실패
    error=SuggestBatchError(code="MISSING_CONSTRAINTS", ...)
```

**Edge Cases:**
- vault에 Track/Condition/Hypothesis가 하나도 없는 경우: 빈 리스트 유지 (기존과 동일)
- cache 메서드가 없는 경우: `hasattr` 체크로 안전 처리 (기존 패턴 유지)

### Todo

- [ ] `build_constraints_from_context()` 수정 - 각 allowlist에 vault 전체 fallback 추가 (`code/api/routers/impact_batch.py:361-390`)
- [ ] 에러 처리 로직 간소화 (`code/api/routers/impact_batch.py:872-887`)
- [ ] 로컬 API 서버로 테스트 (`poetry run uvicorn api.main:app --reload`)
- [ ] `parent_id`, `conditions_3y` 없는 프로젝트로 suggest_batch 호출 테스트
- [ ] npm run build 통과 확인 (Dashboard 영향 없음)

## 참고

- 기존 Plan 파일: `~/.claude/plans/foamy-strolling-marble.md`
- 관련 코드: `code/api/routers/impact_batch.py`
- cache 메서드: `get_all_conditions()`, `get_all_tracks()`, `get_all_hypotheses()`
