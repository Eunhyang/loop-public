---
entity_type: Task
entity_id: "tsk-023-1768386479760"
entity_name: Dashboard v2 - Expected/Hypothesis AI feedback loop
created: '2026-01-14'
updated: '2026-01-14'
status: todo
assignee: 김은향
project_id: prj-023
parent_id: prj-023
program_id: pgm-vault-system
type: dev
priority_flag: high
target_project: loop
aliases:
- tsk-023-1768386479760
- Dashboard v2 - Expected/Hypothesis AI feedback loop
outgoing_relations: []
validates: []
validated_by: []
due: '2026-01-28'
priority: high
---
# Dashboard v2 - Expected/Hypothesis AI feedback loop

> Task ID: `tsk-023-1768386479760` | Project: `prj-023` | Status: todo | Assignee: 김은향

## Summary

Dashboard v2 프로젝트/가설 편집에서 Expected Impact A 스코어와 Hypothesis 초안을 노션 스타일 인라인 UI로 호출·재생성·피드백·승인(pending)까지 완결하는 기능을 설계/구현한다. 프론트엔드(`dashboard-v2/`)와 백엔드 API(`/api/mcp/impact/expected/*`, `/api/ai/infer/hypothesis_draft`)를 정리해, 동일 스키마/재검증/펜딩+diff를 강제한다.

## Notes

### Tech Spec

**Architecture Compliance**
- Parent Project: prj-023 (Dashboard - React+TS 마이그레이션)
- Pattern: Feature-based, SSOT(HTTP `src/services/http.ts`, DTO `src/types/*`, Query Keys `src/queries/keys.ts`), Drawer 단일 진입, common↛feature 의존 금지, legacy `_dashboard/` 수정 금지.
- Target codebase: `public/dashboard-v2/` (프런트), `public/api/` (백엔드).

**File Structure (planned)**
```
public/api/
├── models/impact_expected.py                 # InferRequest/InferenceResult 확장 (feedback/mode/prev/diff)
├── routers/impact_expected.py                # /infer 구현, pending/apply revalidate+normalize, diff_summary
├── services/impact_expected_inference.py     # LLM 호출 래퍼 (context+previous_output+feedback, iteration 서버 계산)
├── services/impact_expected_service.py       # normalize/validate/calc SSOT 사용, diff builder
└── routers/ai.py                             # /infer/hypothesis_draft: feedback/prev_output, pending diff 추가

public/dashboard-v2/src/
├── features/impact/api.ts                    # NEW: expected impact infer/pending/apply client
├── features/impact/queries.ts                # NEW: react-query mutations for infer/apply
├── features/impact/components/ExpectedImpactAiCard.tsx  # NEW notion-style card (preview/retry/pending/apply)
├── features/impact/components/HypothesisAiCard.tsx      # NEW notion-style card (preview/retry/pending/apply)
├── features/projects/components/ProjectForm.tsx         # create/edit에 AI 카드 배치 + gating + state hookup
├── features/pending/components/*             # diff/summary badge 노출 (필요 시)
└── types/*, queries/keys.ts                  # DTO/키 확장 (필요 시)
```

**Implementation Details**
- Backend – Expected Impact
  - Extend `InferRequest` with `mode (preview|pending|apply)`, `previous_output`, `user_feedback`, `run_id?`, `actor/source_workflow`; iteration은 서버가 `previous_output.run_id` or latest pending 기준으로 +1 계산(클라 값 무시).
  - `/infer` 구현: `build_expected_context` → `impact_expected_inference.run_llm`(context + prev + feedback) → `normalize_llm_output` → `validate_expected_output` → `build_calculated_fields` → response {normalized_output, calculated_fields, validation_errors, run_id, iteration}.  
  - Pending path(mode=pending): include `current_expected`, `proposed_expected`, `diff`(changed fields + calculated score delta), `diff_summary`(3줄), `run_id`, `audit_ref`.  
  - Apply path(mode=apply): server-side revalidate + normalize + calculated_fields, then `apply_batch`-equivalent patch; never trust client formData.
  - SSOT 필드 고정: tier/magnitude/confidence/summary(statement)/metric/target/validates/primary_hypothesis_id/condition_contributes/track_contributes/assumptions/evidence_refs/linking_reason + `calculated_fields.score_breakdown`.
- Backend – Hypothesis Draft
  - `InferHypothesisDraftRequest`에 `previous_output`, `user_feedback`, `mode (preview|pending)`, iteration 서버 계산 추가.  
  - Prompt에 previous_output + feedback 포함, preview는 pending 생성 금지. Pending 생성 시 `suggested_fields`에 draft + validates link + `diff`(current hypothesis_text/validates vs proposal) + `diff_summary`, `run_id/audit_ref`.
  - 승인 시 1단계로 프로젝트에 반영(primary_hypothesis_id/validates/hypothesis_text); 별도 Hypothesis 엔티티 생성은 후순위(명시).
- Frontend – Notion 스타일 AI 카드
  - Activation gate(둘 다 공통): `entity_name` + `owner` + (`parent_id` or `conditions_3y`) + LLM 컨텍스트 텍스트 200자 이상. 컨텍스트는 create에서는 `description`(또는 전용 “LLM Context” 필드), edit에서는 `(_body || hypothesis_text || description)` 중 우선값을 사용해 길이 계산.
  - Expected Impact 카드(create/edit/viewable):  
    - Actions: `생성(Preview)` → `/api/mcp/impact/expected/infer` mode=preview; `재생성` with `previous_output + feedback`; `펜딩으로 보내기`(기본 CTA, mode=pending); `즉시 적용`(보조 CTA, 권한 플래그/role guard, mode=apply).  
    - UI: inline card showing tier/magnitude/confidence/summary, validates/primary, contributes, A score breakdown; feedback textarea; diff vs current when pending/apply previewed.
  - Hypothesis 카드(edit/create):  
    - Actions: `생성(Preview)` → `/api/ai/infer/hypothesis_draft` mode=preview; `재생성` with prev+feedback; `펜딩으로 보내기`(기본); `초안을 폼에 채우기`(보조, 로컬만). Preview는 pending 금지.
    - Outputs: draft body + validates/primary suggestion + quality_score/evidence_readiness if 제공; diff vs current; run_id 표시.
  - State wiring: use `httpClient` SSOT, new feature api + react-query mutations; invalidate `queryKeys.project(id)`/`dashboardInit` after apply/pending creation; never mutate cache without server response.
- Diff/iteration rules
  - Server owns iteration(run_id 기반); client only sends previous_output; UI 표시용 iteration from response.
  - Pending stores `current`, `proposed`, `diff`, `diff_summary`, `run_id`, `audit_ref`; UI diff renderer uses these.
- Role/CTA rule
  - Default CTA for edit = “펜딩으로 보내기”; “즉시 적용”는 owner/founder/exec 등 role flag 체크(placeholder prop from auth context; fall back to disabled with tooltip if unavailable).

**Edge Cases**
- 컨텍스트 텍스트 <200자일 때 버튼 비활성 + tooltip; 필수 필드 미충족 시 API 호출 차단.
- Validation errors from `/infer`: show inline errors; disable apply/pending until success.
- Existing pending for same project/field: warn user and allow new run_id but mark UI with “existing pending present”.
- Network/LLM 실패 시 graceful fallback, no pending creation on preview.
- Multi-track/condition references must respect weight sum ≤1; server revalidation handles, UI shows error badge.

### Todo
- [ ] Backend: `models/impact_expected.py` request/response 확장 (mode/feedback/prev/run_id/diff/calculated_fields 표준화)
- [ ] Backend: `/api/mcp/impact/expected/infer` LLM 호출 구현 + pending/apply 경로 재검증/정규화/diff_summary
- [ ] Backend: `impact_expected_inference.py` 컨텍스트+피드백 프롬프트 구성, iteration 서버 계산
- [ ] Backend: `/api/ai/infer/hypothesis_draft` feedback/previous_output/iteration + pending diff 추가
- [ ] Frontend: impact/hypothesis AI API client + react-query hooks 추가
- [ ] Frontend: ProjectForm에 Expected/Hypothesis AI 카드 삽입(게이트/CTA/피드백/재생성/적용)
- [ ] Frontend: pending diff/summary UI 연결(필요 시 Pending 3-pane)
- [ ] Tests: 빌드(`npm run build`), 주요 플로우 수동 검증(가드, preview/pending/apply, diff 렌더)
