---
entity_type: Task
entity_id: tsk-023-1768545831670
entity_name: API - ai.py → impact_batch.py 통합 (n8n 워크플로우 변경)
created: '2026-01-16'
updated: '2026-01-16'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768545831670
tags: []
type: dev
---

# API - ai.py → impact_batch.py 통합 (n8n 워크플로우 변경)

## 설명

`ai.py`의 `/infer/project_impact`와 `impact_batch.py`의 `/suggest-batch`가 중복 기능을 수행.
`ai.py`는 constraints 로직이 없어서 프로젝트 Track에 관계없이 동일한 가설을 추천하는 문제 발생.
`impact_batch.py`는 `gather_project_context` + `build_constraints_from_context`로 Track별 가설 필터링 구현됨.

**해결**: n8n이 `/suggest-batch`를 직접 호출하도록 변경하여 중복 제거 + 올바른 가설 추천.

---

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Target: loop (api/)

**File Structure:**
```
api/
├── models/impact_batch.py        # SuggestBatchRequest 필드 추가
├── routers/impact_batch.py       # suggest_batch에 pending 생성 로직 추가
└── routers/pending.py            # save_pending, generate_review_id 재사용
```

**Implementation Details:**

1. **SuggestBatchRequest 모델 확장** (`api/models/impact_batch.py:311`)
   - `actor: str = Field(default="api")` 추가
   - `source_workflow: Optional[str] = Field(default=None)` 추가

2. **suggest_batch 함수에 pending 생성 로직** (`api/routers/impact_batch.py:1136` 이후)
   - `mode="pending"` 조건 체크
   - 각 성공 suggestion에 대해 pending review 생성
   - `save_pending()` 헬퍼 함수 재사용
   - `entity_name` 필드 추가 필요 (SuggestBatchSuggestion에 없음)

3. **n8n 워크플로우 수정** (H5UsoJ7wtVltkCPf - "LOOP Entity Validator & Auto-filler")
   - URL 변경: `/api/ai/infer/project_impact` → `/api/mcp/impact/expected/suggest-batch`
   - Request body 형식 변경
   - Response 파싱 로직 변경

**Edge Cases:**
- n8n에서 단일 project 처리: `items: [{project_id: "..."}]` 배열로 감싸기
- 기존 ai.py 엔드포인트 유지 (하위 호환성)
- suggestion 실패 시 pending 생성 안 함 (status="success"만)

---

### Todo

- [ ] `api/models/impact_batch.py:311` - SuggestBatchRequest에 `actor`, `source_workflow` 필드 추가
- [ ] `api/models/impact_batch.py:342` - SuggestBatchSuggestion에 `entity_name` 필드 추가
- [ ] `api/routers/impact_batch.py:1136` 이후 - mode="pending" 시 pending review 생성 로직 추가
- [ ] n8n 워크플로우 수정 (배포 후)
- [ ] API 로컬 테스트: `curl -X POST http://localhost:8081/api/mcp/impact/expected/suggest-batch`
- [ ] 배포 후 n8n 테스트: prj-023(trk-2)가 hyp-2-xx만 추천받는지 확인

---

## 참고

- `impact_batch.py:853-869` - gather_project_context + build_constraints_from_context 호출
- `impact_batch.py:871` - merge_constraints로 item/request constraints 병합
- `pending.py:92-99` - save_pending, generate_review_id 함수
- n8n 워크플로우 ID: H5UsoJ7wtVltkCPf
