---
entity_type: Task
entity_id: tsk-023-1768331190178
entity_name: Create Project Gate - Require Hypothesis + Expected Impact
created: '2026-01-14'
updated: '2026-01-14'
status: todo
assignee: 김은향
project_id: prj-023
parent_id: prj-023
program_id: pgm-vault-system
type: dev
priority_flag: medium
target_project: loop
aliases:
  - tsk-023-1768331190178
  - Create Project Gate - Require Hypothesis + Expected Impact
outgoing_relations: []
validates: []
validated_by: []
---

# Create Project Gate - Require Hypothesis + Expected Impact

> Task ID: `tsk-023-1768331190178` | Project: `prj-023` | Status: todo | Assignee: 김은향

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard - React+TS 마이그레이션)
- Architecture Pattern: Feature-based, SSOT rules (http.ts, types/*, query keys, feature-owned forms)
- Target Codebase: `dashboard-v2/`
- Backend API: `api/`

**Problem Statement:**
Users can create projects without setting hypotheses or Expected Impact (A Score), causing missing impact linkage and forcing later edits. We need a UI gate so project creation is impossible unless both Expected Impact (tier, magnitude, confidence) and at least one hypothesis with a primary selection are provided.

**File Structure:**
```
dashboard-v2/
├── src/
│   ├── types/project.ts           # Update CreateProjectDTO interface
│   ├── features/projects/
│   │   ├── api.ts                 # Update createProject mutation payload
│   │   └── components/
│   │       └── ProjectForm.tsx    # Modify existing form - add validation to create mode
│   └── features/impact/components/
│       ├── ImpactSection.tsx         # [EXISTS - reuse, already used in ProjectForm line 449]
│       └── HypothesisSelector.tsx    # [EXISTS - reuse, already has hypothesis handling]
api/
├── models/entities.py         # Update ProjectCreate schema
└── routers/projects.py        # Add inline validation logic
```

**Implementation Details:**

**1. Frontend Type Definitions** (`src/types/project.ts`):
   - Extend `CreateProjectDTO` interface in `src/features/projects/api.ts`:
     ```typescript
     export interface CreateProjectDTO {
       entity_name: string;
       owner: string;
       parent_id?: string;
       program_id?: string;
       status: string;
       priority_flag: string;
       description?: string;
       // NEW REQUIRED FIELDS
       expected_impact: {
         tier: 'strategic' | 'enabling' | 'operational';
         impact_magnitude: 'high' | 'mid' | 'low';
         confidence: number; // 0-1
         contributes: string[];
         rationale?: string;
       };
       validates: string[];  // hypothesis IDs
       primary_hypothesis_id: string;
       conditions_3y?: string[];
     }
     ```

**2. ProjectForm Component** (`features/projects/components/ProjectForm.tsx`):
   - **Note**: This component already uses `ImpactSection` and has hypothesis handling code. We need to **modify** create mode behavior to make these fields required and add validation.

   **A. State Management** (add to existing useState):
   ```typescript
   const [formData, setFormData] = useState({
     // ... existing fields
     expected_impact: null as ExpectedImpact | null,
     validates: [] as string[],
     primary_hypothesis_id: '' as string,
   });
   ```

   **B. Validation Function** (add before submit handler):
   ```typescript
   const isFormValid = useMemo(() => {
     if (mode !== 'create') return true; // only gate create mode
     return (
       formData.entity_name.trim() !== '' &&
       formData.owner !== '' &&
       formData.expected_impact !== null &&
       formData.validates.length > 0 &&
       formData.primary_hypothesis_id !== '' &&
       formData.validates.includes(formData.primary_hypothesis_id)
     );
   }, [mode, formData]);
   ```

   **C. UI Sections to Modify** (modify existing sections in create mode to add validation):

   Section 1 - Expected Impact (modify existing section to make required in create mode):
   ```tsx
   {mode === 'create' && (
     <div className="space-y-2">
       <label className="block text-sm font-medium text-gray-700">
         A. Expected Impact <span className="text-red-500">*</span>
       </label>
       <ImpactSection
         expectedImpact={formData.expected_impact}
         realizedImpact={null}
         onExpectedChange={(impact) => setFormData({ ...formData, expected_impact: impact })}
         onRealizedChange={() => {}}
         mode="expected"
       />
       {formData.expected_impact && (
         <div className="text-sm text-gray-600">
           A Score: {calculateExpectedScore(formData.expected_impact).toFixed(2)}
         </div>
       )}
     </div>
   )}
   ```

   Section 2 - Hypotheses (modify existing section to make required in create mode):
   ```tsx
   {mode === 'create' && (
     <div className="space-y-2">
       <label className="block text-sm font-medium text-gray-700">
         Hypotheses <span className="text-red-500">*</span>
       </label>
       <HypothesisSelector
         validates={formData.validates}
         primaryHypothesisId={formData.primary_hypothesis_id}
         hypotheses={dashboardData?.hypotheses || []}
         onValidatesChange={(validates) =>
           setFormData({ ...formData, validates })
         }
         onPrimaryChange={(primary) =>
           setFormData({ ...formData, primary_hypothesis_id: primary })
         }
       />
     </div>
   )}
   ```

   **D. Submit Button State**:
   ```tsx
   <button
     disabled={!isFormValid || isPending}
     onClick={handleSubmit}
     className={cn(
       "px-4 py-2 rounded",
       !isFormValid || isPending ? "bg-gray-300 cursor-not-allowed" : "bg-blue-600 text-white"
     )}
   >
     {isPending ? 'Creating...' : 'Create Project'}
   </button>
   ```

   **E. Error Display** (add before submit button):
   ```tsx
   {formError && (
     <div className="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
       {formError}
     </div>
   )}
   ```

**3. API Mutation Update** (`features/projects/api.ts`):
   - Update `createProject` function to include new fields in payload:
     ```typescript
     createProject: (data: CreateProjectDTO) =>
       httpClient.post<{ success: boolean; project_id: string; expected_score?: number }>('/api/projects', {
         entity_name: data.entity_name,
         owner: data.owner,
         parent_id: data.parent_id,
         program_id: data.program_id,
         status: data.status,
         priority_flag: data.priority_flag,
         description: data.description,
         expected_impact: data.expected_impact,
         validates: data.validates,
         primary_hypothesis_id: data.primary_hypothesis_id,
         conditions_3y: data.conditions_3y || [],
         autofill_expected_impact: false,  // UI always sends explicit values
       }),
     ```
   - **Note**: Frontend MUST send `autofill_expected_impact: false` to trigger backend validation gate

**4. Backend Model Update** (`api/models/entities.py`):
   - **CRITICAL**: Keep fields OPTIONAL in ProjectCreate to preserve autofill_expected_impact flow:
     ```python
     class ExpectedImpactInput(BaseModel):
       """Expected Impact 입력용 모델"""
       tier: str = Field(..., pattern="^(strategic|enabling|operational)$")
       impact_magnitude: str = Field(..., pattern="^(high|mid|low)$")
       confidence: float = Field(..., ge=0.0, le=1.0)
       contributes: List[str] = Field(default_factory=list)
       rationale: Optional[str] = Field(default=None, description="Impact 판단 근거")

     class ProjectCreate(BaseModel):
       """Project 생성 요청"""
       entity_name: str = Field(..., description="프로젝트 이름 (주제 - 내용 형식)")
       owner: str = Field(..., description="책임자 ID")
       parent_id: Optional[str] = Field(default=None, description="부모 Track ID")
       program_id: Optional[str] = Field(default=None, description="소속 Program ID")
       priority: str = Field(default="medium", description="우선순위 (priority_flag로 저장)")
       conditions_3y: List[str] = Field(default_factory=list)

       # OPTIONAL - fields are required ONLY when autofill_expected_impact=False
       expected_impact: Optional[ExpectedImpactInput] = Field(default=None, description="Expected Impact")
       validates: Optional[List[str]] = Field(default=None, description="Hypothesis IDs")
       primary_hypothesis_id: Optional[str] = Field(default=None, description="Primary hypothesis")

       # Optional flags
       autofill_expected_impact: bool = Field(default=False, description="If True, LLM fills Expected Impact")
       auto_validate: bool = Field(default=False)
     ```

**5. Backend Validation Logic** (`api/routers/projects.py`):
   - Add conditional validation in `create_project` function (after line 110, before project_id generation):
     ```python
     # Conditional validation based on autofill_expected_impact flag
     if not project.autofill_expected_impact:
         # Gate: Require fields when autofill is OFF (UI-driven creation)
         if not project.validates:
             raise HTTPException(status_code=400, detail="At least one hypothesis required in validates")

         if not project.primary_hypothesis_id:
             raise HTTPException(status_code=400, detail="primary_hypothesis_id is required")

         if project.primary_hypothesis_id not in project.validates:
             raise HTTPException(
                 status_code=400,
                 detail=f"primary_hypothesis_id ({project.primary_hypothesis_id}) must be in validates list"
             )

         # Validate all hypothesis IDs exist in cache (inline)
         for hyp_id in project.validates:
             hyp = cache.get_hypothesis(hyp_id)
             if not hyp:
                 raise HTTPException(status_code=400, detail=f"Hypothesis not found: {hyp_id}")

         # Validate expected_impact is provided
         if not project.expected_impact:
             raise HTTPException(status_code=400, detail="expected_impact is required")
     # else: autofill_expected_impact=True → allow missing fields (LLM fills them later)
     ```

   - Add hypothesis fields to frontmatter (after line 165):
     ```python
     frontmatter.update({
         "validates": project.validates,
         "primary_hypothesis_id": project.primary_hypothesis_id,
     })
     ```

   - Include expected_score in response (already exists at line ~250)

**Edge Cases:**
- **Hypotheses not loaded**: If `dashboardData.hypotheses` is empty/loading, keep form disabled and show "Loading hypotheses..." message
- **Empty hypothesis list**: Show warning "No hypotheses available. Create hypotheses first." and disable submit
- **Primary not in validates**: Block submit with error "Primary hypothesis must be selected first"
- **Invalid hypothesis IDs on backend**: Return 400 "Hypothesis {id} not found"
- **Missing required fields**: Block submit with inline error per field
- **API network failure**: Show error toast with retry option
- **Dashboard v1 vs v2**: Changes ONLY affect `dashboard-v2`, leave `_dashboard` v1 untouched

**Helper Functions:**
- `calculateExpectedScore(expectedImpact)`: Already exists in `dashboard-v2/src/features/impact/utils/calculator`

**Testing Checklist:**
- [ ] Submit without expected_impact → blocked with error
- [ ] Submit with expected_impact but no hypothesis → blocked
- [ ] Submit with validates but no primary → blocked
- [ ] Submit with primary not in validates → blocked
- [ ] Submit with all valid data → success, drawer closes, A Score displayed
- [ ] A Score badge displays correctly when impact fields set
- [ ] Backend rejects invalid hypothesis IDs with 400
- [ ] Backend accepts valid payload and persists to frontmatter
- [ ] `npm run build` in dashboard-v2 succeeds with no errors
- [ ] Existing edit/view modes still work (no regression)

### Todo

- [ ] Read `src/features/projects/components/ProjectForm.tsx` to understand current form structure and state management
- [ ] Read `src/features/impact/components/ExpectedImpactEditor.tsx` to understand its props interface
- [ ] Read `src/features/impact/components/HypothesisSelector.tsx` to understand its props interface
- [ ] Update `src/features/projects/api.ts` - extend `CreateProjectDTO` interface with `expected_impact`, `validates`, `primary_hypothesis_id` fields
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - add state fields for `expected_impact`, `validates`, `primary_hypothesis_id`
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - add `isFormValid` useMemo hook for validation logic
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - add Expected Impact section UI (ImpactSection component + A Score display)
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - add Hypotheses section UI (HypothesisSelector component)
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - update submit button disabled state to use `isFormValid`
- [ ] Update `src/features/projects/components/ProjectForm.tsx` - add formError state and error banner UI
- [ ] Update `src/features/projects/api.ts` - modify `createProject` function to include new fields in request payload
- [ ] Update `api/models/entities.py` - add `rationale` field to `ExpectedImpactInput`, keep `ProjectCreate` fields OPTIONAL, add conditional validation logic
- [ ] Update `api/routers/projects.py` - add conditional hypothesis validation logic after line 110 (check autofill_expected_impact flag, validate validates array, primary_hypothesis_id, hypothesis existence in cache)
- [ ] Update `api/routers/projects.py` - add `validates` and `primary_hypothesis_id` fields to frontmatter dict (after line 165)
- [ ] Test frontend: attempt create with missing expected_impact → should show error and block submit
- [ ] Test frontend: attempt create with expected_impact but no validates → should show error and block submit
- [ ] Test frontend: attempt create with validates but no primary → should show error and block submit
- [ ] Test frontend: attempt create with primary not in validates → should show error and block submit
- [ ] Test frontend: valid create with all required fields → should succeed, show A Score, close drawer
- [ ] Test backend: `curl -X POST /api/projects` with missing expected_impact → expect 400 error
- [ ] Test backend: `curl -X POST /api/projects` with primary not in validates → expect 400 error
- [ ] Test backend: `curl -X POST /api/projects` with invalid hypothesis ID → expect 400 "Hypothesis not found"
- [ ] Test backend: `curl -X POST /api/projects` with valid payload → expect 200 with project_id and expected_score
- [ ] Run `npm run build` in `dashboard-v2/` → must succeed with no TypeScript errors
- [ ] Manual QA: create project via Dashboard v2 UI with all fields → verify frontmatter in created `project.md` contains expected_impact, validates, primary_hypothesis_id
- [ ] Manual QA: verify existing edit/view modes still work (no regression)

## Execution Log (2026-01-14)

### Plan Review
- Codex gpt-5-codex: 강조된 포인트 → 가설 목록 미존재 시 UX/검증 처리, async 로드 후 validation 흐름, autofill 기본값 및 레거시 클라이언트 처리, 테스트/빌드 필요성

### Implementation
- Modified: 7 files
- Key changes: 프로젝트 생성 폼에 Expected Impact/Hypothesis 게이트 추가 및 유효성 검증, CreateProject DTO·payload 확장, 백엔드 모델/라우터에 expected_impact·validates·primary 검증/패턴 추가 및 frontmatter 저장, rationale 보존

### Code Review
- Codex code review (gpt-5-codex) 시도했으나 두 차례 타임아웃 → 수동 검토 필요

### Result
- Status: partial — `npm run build` 실패(tsc 미설치) + 코드 리뷰 미완료
- Next: node deps 설치 후 build/lint 실행, 수동/재시도 코드 리뷰 진행
