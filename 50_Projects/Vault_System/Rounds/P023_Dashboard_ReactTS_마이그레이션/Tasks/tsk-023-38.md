---
entity_type: Task
entity_id: tsk-023-38
entity_name: VaultCache - get_project_path 메서드 추가
created: 2026-01-09
updated: 2026-01-09
status: done
closed: 2026-01-09

# === 계층 ===
parent_id: prj-023
project_id: prj-023
aliases: [tsk-023-38]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: 김은향
start_date: 2026-01-09
due: 2026-01-09
priority: high
estimated_hours: 2
actual_hours: 2

# === Task 유형 (dev Task 연동용) ===
type: dev
target_project: loop

# === 분류 ===
tags: [api, vault-cache, project, refactor]
priority_flag: high

# === Dev Task 연동 (LOOP Vault 내부) ===
pr_url: null
merged_commit: fc3047ce766016487695b494157ab6a9543b6ec6
---

# VaultCache - get_project_path 메서드 추가

> Task ID: `tsk-023-38` | Project: `prj-023` | Status: done

## 목표

**완료 조건**:
1. `VaultCache.get_project_path()` 메서드 추가하여 project_id로 파일 경로 조회
2. `GET /api/projects/{id}` 엔드포인트에서 exec vault 민감 필드 유출 방지
3. Dashboard v2 ProjectForm Edit 모드에 body 편집기 추가
4. 모든 변경사항 테스트 완료

---

## 상세 내용

### 배경

`projects.py`의 `get_project()` 함수에서 project 파일 경로가 필요했으나, VaultCache에 `get_project_path()` 메서드가 없어서 직접 파일 시스템을 탐색해야 했다. 이는 다음 문제를 야기했다:

1. **일관성 부족**: Task는 `get_task_path()`가 있지만 Project는 없음
2. **성능 이슈**: 캐시된 경로를 활용하지 못하고 매번 파일 시스템 탐색
3. **유지보수성**: 프로젝트 파일 경로 로직이 여러 곳에 중복

또한 exec vault의 민감 필드(contract, salary 등)가 API 응답에 그대로 노출되는 보안 이슈가 있었다.

### 작업 내용

#### 1. VaultCache에 get_project_path() 메서드 추가

**파일**: `api/cache/vault_cache.py` (line 524-528)

```python
def get_project_path(self, project_id: str) -> Optional[Path]:
    """Get project file path by project_id"""
    with self._lock:
        entry = self.projects.get(project_id)
        return entry.path if entry else None
```

**특징**:
- Task의 `get_task_path()`와 동일한 패턴
- 캐시된 경로를 O(1)로 반환
- Thread-safe (lock 사용)

#### 2. GET /api/projects/{id} exec vault 보안 강화

**파일**: `api/routers/projects.py` (line 82-86)

```python
# exec vault 민감 필드 제거
if project_path.as_posix().startswith(str(EXEC_VAULT)):
    sensitive_fields = {'contract', 'salary', 'bank_account', 'terms'}
    for field in sensitive_fields:
        frontmatter.pop(field, None)
```

**보안 조치**:
- exec vault 프로젝트의 민감 필드 자동 제거
- API 응답에서 계약 조건, 급여 정보 등 보호
- public vault는 영향 없음

#### 3. Dashboard v2 - ProjectForm Edit 모드에 body 편집기 추가

**파일**: `dashboard-v2/src/components/ProjectForm.tsx`

**변경사항**:
- Edit 모드에서도 body 필드 표시 및 편집 가능
- Create 모드와 동일한 UI/UX
- Project body 수정 API 연동

---

## 체크리스트

- [x] `VaultCache.get_project_path()` 메서드 구현
- [x] `projects.py`에서 새 메서드 사용
- [x] exec vault 민감 필드 유출 방지 로직 추가
- [x] Dashboard ProjectForm Edit 모드에 body 편집기 추가
- [x] API 테스트 (`GET /api/projects/prj-023`)
- [x] Dashboard 테스트 (Edit Project)
- [x] 기존 기능 회귀 테스트

---

## Notes

### Tech Spec

| 항목 | 내용 |
|------|------|
| 수정 파일 | `vault_cache.py`, `projects.py`, `ProjectForm.tsx` |
| 영향 범위 | Project API, VaultCache, Dashboard v2 |
| 기술 스택 | Python, FastAPI, React, TypeScript |

### 결정 사항

| 항목 | 결정 |
|------|------|
| 메서드명 | `get_project_path()` (Task와 일관성 유지) |
| 보안 처리 | exec vault 민감 필드 자동 제거 (API 레벨) |
| Dashboard | Edit/Create 모드 모두 body 편집 지원 |

### 검증 방법

```bash
# 1. API 테스트 (public vault)
curl -s -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/projects/prj-023" | jq .project._body

# 2. exec vault 보안 테스트 (민감 필드 제거 확인)
curl -s -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/projects/prj-exec-001" | jq .project.contract
# 예상: null (제거됨)

# 3. Dashboard 테스트
# - http://localhost:3000/projects/prj-023
# - Edit 버튼 클릭
# - Body 필드 편집 확인
```

### 작업 로그

#### 2026-01-09 13:28
**개요**: VaultCache get_project_path 메서드 추가 + exec vault 보안 수정 완료

**변경사항**:
- 개발:
  - `VaultCache.get_project_path()` 메서드 추가 (vault_cache.py:524-528)
  - exec vault 민감 필드 제거 로직 추가 (projects.py:82-86)
  - Dashboard ProjectForm Edit 모드 body 편집기 추가 (ProjectForm.tsx)
- 수정:
  - `get_project()` 함수에서 새 메서드 사용
  - exec vault 프로젝트의 contract, salary 등 필드 API 응답에서 제거
- 개선:
  - 캐시 활용으로 성능 개선 (파일 시스템 탐색 → O(1) 조회)
  - API 레벨 보안 강화 (민감 정보 유출 방지)

**핵심 코드**:
```python
# VaultCache 메서드 추가
def get_project_path(self, project_id: str) -> Optional[Path]:
    """Get project file path by project_id"""
    with self._lock:
        entry = self.projects.get(project_id)
        return entry.path if entry else None

# exec vault 보안 처리
if project_path.as_posix().startswith(str(EXEC_VAULT)):
    sensitive_fields = {'contract', 'salary', 'bank_account', 'terms'}
    for field in sensitive_fields:
        frontmatter.pop(field, None)
```

**커밋**:
- `fc3047c` - feat(tsk-023-38): Add get_project_path() + exec vault security fix
- `431a1e5` - feat(dashboard): Add body editor to ProjectForm Edit mode
- `d766d24` - feat(tsk-023-38): VaultCache - get_project_path 메서드 추가

**결과**:
- ✅ API 테스트 성공 (`GET /api/projects/prj-023` 200 OK)
- ✅ exec vault 민감 필드 제거 확인
- ✅ Dashboard Edit Project 정상 동작
- ✅ 기존 `get_project_dir()` 호환성 유지

**배포**:
- NAS API 서버 재시작 완료
- Dashboard v2 rebuild 완료

**최종 상태**: done

#### 2026-01-09 (Task 완료)
**개요**: Task 완료 - VaultCache get_project_path 메서드 추가 및 보안 강화

**결과**:
- ✅ `VaultCache.get_project_path()` 메서드 추가 완료
- ✅ exec vault 민감 필드 유출 방지 로직 추가 완료
- ✅ Dashboard ProjectForm Edit 모드 body 편집기 추가 완료
- ✅ 모든 테스트 통과

**변경 파일**:
- `public/api/cache/vault_cache.py` - get_project_path() 메서드 추가
- `public/api/routers/projects.py` - exec vault 보안 처리 추가
- `dashboard-v2/src/components/ProjectForm.tsx` - Edit 모드 body 편집기

**최종 상태**: done

---

## 참고 문서

- [[prj-023]] - 소속 Project (Dashboard v2 마이그레이션)
- [[tsk-023-36]] - 관련 Task (Project body 조회/수정 기능)
- [[vault_cache.py]] - VaultCache 구현
- [[projects.py]] - Projects API 라우터

---

**Created**: 2026-01-09
**Assignee**: 김은향
**Due**: 2026-01-09
