---
entity_type: Task
entity_id: "tsk-023-36"
entity_name: "API - Project body 조회/수정 기능 추가"
created: 2026-01-09
updated: 2026-01-09
status: done
closed: 2026-01-09

# === 계층 ===
parent_id: "prj-023"
project_id: "prj-023"
aliases: ["tsk-023-36"]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: "김은향"
start_date: 2026-01-09
due: null
priority: high
estimated_hours: 2
actual_hours: null

# === Task 유형 (dev Task 연동용) ===
type: dev
target_project: loop

# === 분류 ===
tags: ["api", "project", "body", "crud"]
priority_flag: high
---

# API - Project body 조회/수정 기능 추가

> Task ID: `tsk-023-36` | Project: `prj-023` | Status: done

## 목표

**완료 조건**:
1. GET /api/projects/{id} 응답에 `_body` 필드 포함
2. PUT /api/projects/{id} 요청 시 `body` 필드로 본문 수정 가능
3. 빈 문자열(`body: ""`)로 본문 비우기 가능
4. 기존 기능 회귀 없음 (body 미포함 PUT 시 기존 body 보존)

---

## 상세 내용

### 배경

현재 Task API는 notes를 frontmatter 필드로 가져오고 수정할 수 있다. 그러나 Project API는:
- GET: frontmatter만 반환 (body 조회 불가)
- PUT: body를 보존만 함 (수정 불가)

Project도 Task처럼 body(frontmatter 아래 마크다운 본문)를 조회/수정할 수 있어야 한다.

### 작업 내용

#### 1. GET /api/projects/{project_id} 수정

**파일**: `public/api/routers/projects.py` (라인 43-53)

```python
def get_project(project_id: str):
    cache = get_cache()
    project = cache.get_project(project_id)

    # Task처럼 body 항상 포함
    project_file = cache.get_project_path(project_id)
    if project_file and project_file.exists():
        content = project_file.read_text(encoding='utf-8')
        match = re.match(r'^---\s*\n(.*?)\n---\s*\n(.*)$', content, re.DOTALL)
        if match:
            project['_body'] = match.group(2)

    return {"project": project}
```

#### 2. ProjectUpdate 모델에 body 필드 추가

**파일**: `public/api/models/entities.py` (라인 79-92)

```python
class ProjectUpdate(BaseModel):
    # 기존 필드들...
    body: Optional[str] = None  # 새로 추가
```

#### 3. PUT /api/projects/{project_id} 수정

**파일**: `public/api/routers/projects.py` (라인 373-375)

```python
# body 수정 요청이 있으면 새 body 사용 (빈 문자열도 허용)
final_body = project.body if project.body is not None else body

new_content = f"""---
{yaml.dump(frontmatter, allow_unicode=True, sort_keys=False)}---
{final_body}"""
```

---

## 체크리스트

- [ ] GET /api/projects/{id} 에 `_body` 필드 추가
- [ ] ProjectUpdate 모델에 `body: Optional[str]` 추가
- [ ] PUT /api/projects/{id} 에서 body 수정 로직 추가
- [ ] 빈 body("") 처리 확인
- [ ] 기존 기능 회귀 테스트

---

## Notes

### Tech Spec

| 항목 | 내용 |
|------|------|
| 수정 파일 | `projects.py`, `entities.py` |
| 영향 범위 | Project CRUD API |
| 기술 스택 | FastAPI, Pydantic |

### 결정 사항

| 항목 | 결정 |
|------|------|
| GET body 반환 | 항상 포함 (`_body` 필드) |
| 빈 body 처리 | 허용 (`body: ""`로 본문 비우기 가능) |
| 파싱 실패 시 | `_body: ""` 기본값 설정 |

### Codex Review 피드백 (2026-01-09)

**Critical Issues (수정 필요)**:
1. **GET _body 항상 포함 보장 안됨**: regex 매칭 실패 시 `_body` 필드 누락 → 기본값 `""` 설정 필요
2. **Error handling 누락**: project 없거나 파일 없을 때 예외 발생 가능 → 가드 추가
3. **PUT body 보존 가정 문제**: 기존 body가 읽히지 않으면 빈 body 작성 위험

**Suggestions**:
- Regex 실패 시 `_body = ""` 기본값 설정
- `cache.get_project()` 반환값 None 체크
- PUT에서 기존 body 읽기 실패 시 안전한 폴백 처리

### Todo
- [ ] projects.py GET 함수 수정 (+ `_body` 기본값 처리)
- [ ] entities.py ProjectUpdate 모델 수정
- [ ] projects.py PUT 함수 수정 (+ body 보존 안전 처리)
- [ ] 테스트 실행

### 검증 방법

```bash
# 1. GET 테스트 (body 포함 확인)
curl -s -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/projects/prj-023" | jq .project._body

# 2. PUT 테스트 (body 수정)
curl -X PUT "$LOOP_API_URL/api/projects/prj-023" \
  -H "Authorization: Bearer $LOOP_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"body": "# 새로운 본문\n\n내용..."}'

# 3. 빈 body 테스트
curl -X PUT "$LOOP_API_URL/api/projects/prj-023" \
  -H "Authorization: Bearer $LOOP_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"body": ""}'

# 4. 기존 기능 회귀 테스트
# body 없이 PUT → 기존 body 보존
```

### 작업 로그

#### 2026-01-09 03:30
**개요**: Project body 조회/수정 기능 구현 완료 (codex-claude-loop 워크플로우)

**변경사항**:
- 개발:
  - GET `/api/projects/{id}` 에 `_body` 필드 추가 (projects.py:44-85)
  - PUT `/api/projects/{id}` 에서 body 수정 지원 (projects.py:389-391)
  - ProjectUpdate 모델에 `body: Optional[str]` 필드 추가 (entities.py:94)
- 수정:
  - GET: 캐시 오염 방지를 위해 yaml.safe_load()로 새 dict 생성
  - GET: YAML 파싱 오류 처리 추가 (YAMLError → 400 응답)
  - GET: Regex 실패 시 전체 내용을 body로 반환 (데이터 손실 방지)
- 개선:
  - re.DOTALL 플래그 사용으로 멀티라인 body 파싱 보장
  - cached_project.copy() 사용으로 캐시 변경 방지

**핵심 코드**:
```python
# GET - 파일에서 직접 읽어 캐시 오염 방지
match = re.match(r'^---\s*\n(.*?)\n---\s*\n(.*)$', content, re.DOTALL)
if match:
    frontmatter = yaml.safe_load(match.group(1))
    if not isinstance(frontmatter, dict):
        raise HTTPException(400, "Invalid frontmatter")
    body = match.group(2)
else:
    frontmatter = cached_project.copy()
    body = content

# PUT - body 수정 지원
if project.body is not None:
    body = project.body  # 빈 문자열도 허용
```

**Codex Review 반영 사항**:
1. ✅ 캐시 변경 방지 (yaml.safe_load() + .copy() 사용)
2. ✅ YAML 파싱 오류 처리 (try/except yaml.YAMLError)
3. ✅ Regex 실패 시 데이터 손실 방지 (전체 내용 반환)
4. ✅ frontmatter 타입 검증 (isinstance dict 체크)

**결과**: ✅ 구문 검사 성공 (py_compile)

**다음 단계**:
- API 서버 재시작 후 테스트
- GET /api/projects/prj-023 호출하여 _body 필드 확인
- PUT으로 body 수정 테스트

#### 2026-01-09 (Task 완료)
**개요**: Task 완료 - Project body 조회/수정 기능 구현 완료

**결과**:
- ✅ GET /api/projects/{id}에 `_body` 필드 추가 완료
- ✅ PUT /api/projects/{id}에서 body 수정 기능 추가 완료
- ✅ ProjectUpdate 모델에 body 필드 추가 완료
- ✅ Codex review 피드백 반영 (캐시 오염 방지, 에러 처리, 데이터 손실 방지)

**변경 파일**:
- `public/api/routers/projects.py` - GET/PUT 엔드포인트 수정
- `public/api/models/entities.py` - ProjectUpdate 모델 수정

**최종 상태**: done

---

## 참고 문서

- [[prj-023]] - 소속 Project
- [[tasks.py]] - Task API 참고 (notes 처리 패턴)
- Plan Mode 계획: `/Users/gim-eunhyang/.claude/plans/noble-strolling-gray.md`

---

**Created**: 2026-01-09
**Assignee**: 김은향
**Due**:
