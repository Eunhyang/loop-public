---
entity_type: Task
entity_id: tsk-023-1768030620896
entity_name: Dashboard - Discord 알림 링크 추가
created: '2026-01-10'
updated: '2026-01-10'
<<<<<<< HEAD
status: todo
=======
status: doing
>>>>>>> b1c8eee (feat(tsk-023-1768030620896): Dashboard - Discord 알림 링크 추가)
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-10'
due: '2026-01-10'
aliases:
- tsk-023-1768030620896
tags: []
type: dev
<<<<<<< HEAD
notes: '# Dashboard - Discord 알림 링크 추가


  ## 설명


  ## 체크리스트


  - \[ \]


  ## 참고'
---
=======
target_project: loop
---

>>>>>>> b1c8eee (feat(tsk-023-1768030620896): Dashboard - Discord 알림 링크 추가)
# Dashboard - Discord 알림 링크 추가

## 설명

<<<<<<< HEAD
## 체크리스트

- [ ]

## 참고
=======
Discord 알림 메시지를 클릭하면 해당 엔티티(Task, Project, Program, Comment)의 Dashboard 페이지로 바로 이동할 수 있게 한다.

---

## Notes

### PRD - Discord 알림 클릭 시 Dashboard 이동 링크 추가

#### 목표
Discord 알림 메시지를 클릭하면 해당 엔티티(Task, Project, Program, Comment)의 Dashboard 페이지로 바로 이동할 수 있게 한다.

---

### Tech Spec

#### Dashboard URL 패턴

**Base URL**: `https://mcp.sosilab.synology.me/v2`

| Entity Type | URL Pattern | 예시 |
|-------------|-------------|------|
| Task | `/v2/tasks/{task_id}` | `/v2/tasks/tsk-023-001` |
| Project | `/v2/projects/{project_id}` | `/v2/projects/prj-023` |
| Program | `/v2/program` | (리스트 페이지) |
| Comment | `/v2/{target_type}s/{target_entity}` | Target 엔티티 페이지로 이동 |

#### 변경 파일 (1개)

##### `public/api/services/notification_service.py`

**위치**: `send_entity_created_notification()` 함수 (줄 70-136)

**변경 내용**:

1. **Dashboard Base URL 상수 추가** (줄 20 부근)
```python
DASHBOARD_BASE_URL = os.getenv("DASHBOARD_BASE_URL", "https://mcp.sosilab.synology.me/v2")
```

2. **URL 생성 헬퍼 함수 추가**
```python
def _build_entity_url(
    entity_type: str,
    entity_id: str,
    extra_fields: Optional[Dict[str, str]] = None
) -> Optional[str]:
    """
    엔티티 타입과 ID로 Dashboard URL 생성

    Comment의 경우 target_type, target_entity를 사용하여 대상 페이지 URL 생성
    """
    if entity_type == "Task":
        return f"{DASHBOARD_BASE_URL}/tasks/{entity_id}"
    elif entity_type == "Project":
        return f"{DASHBOARD_BASE_URL}/projects/{entity_id}"
    elif entity_type == "Program":
        return f"{DASHBOARD_BASE_URL}/program"
    elif entity_type == "Comment":
        # Comment는 target 엔티티 페이지로 이동
        if extra_fields:
            target_type = extra_fields.get("target_type", "").lower()
            target_entity = extra_fields.get("target_entity", "")
            if target_type and target_entity:
                if target_type == "task":
                    return f"{DASHBOARD_BASE_URL}/tasks/{target_entity}"
                elif target_type == "project":
                    return f"{DASHBOARD_BASE_URL}/projects/{target_entity}"
        return None
    else:
        return None
```

3. **embed에 url 필드 추가** (`send_entity_created_notification` 함수 내)
```python
# Build entity URL for clickable link
entity_url = _build_entity_url(entity_type, entity_id, extra_fields)

embed = {
    "title": f"New {entity_type} Created",
    "description": f"**{entity_name}**",
    "color": color,
    "fields": fields,
    "timestamp": timestamp,
    "footer": {"text": "LOOP Vault"},
}

# Add URL for clickable embed title
if entity_url:
    embed["url"] = entity_url
```

---

### Todo Checklist

- [x] notification_service.py에 DASHBOARD_BASE_URL 상수 추가
- [x] _build_entity_url() 헬퍼 함수 추가
- [x] send_entity_created_notification() 함수에서 embed에 url 필드 추가
- [ ] /mcp-server rebuild (Docker 재배포)
- [ ] Discord 알림 클릭 → Dashboard 이동 확인

---

### 검증 단계

1. Docker 배포: `/mcp-server rebuild`
2. API 테스트: POST /api/tasks (새 Task 생성)
3. Discord 알림 확인:
   - Embed 제목이 클릭 가능한 링크인지 확인
   - 클릭 시 Dashboard 해당 페이지로 이동하는지 확인
4. Comment 알림 테스트:
   - Task에 Comment 생성 → 해당 Task 페이지 링크 확인

---

## 구현 내역 (2026-01-10)

### 변경 파일
- `public/api/services/notification_service.py`

### 구현 상세

1. **DASHBOARD_BASE_URL 상수 추가** (line 22)
   ```python
   DASHBOARD_BASE_URL = os.getenv("DASHBOARD_BASE_URL", "https://mcp.sosilab.synology.me/v2")
   ```

2. **_build_entity_url() 헬퍼 함수** (lines 71-122)
   - Task → `/v2/tasks/{task_id}`
   - Project → `/v2/projects/{project_id}`
   - Program → `/v2/program`
   - Comment → `/v2/{target_type}s/{target_entity}` (proper pluralization mapping)
   - Type safety: `str()` coercion for extra_fields values
   - Validation for Comment extra_fields
   - Returns None for unknown entity types

3. **send_entity_created_notification() 업데이트** (lines 180-183)
   - `_build_entity_url()` 호출하여 URL 생성
   - URL이 있으면 `embed["url"]` 추가
   - Discord embed title이 클릭 가능한 링크가 됨

### Codex Review 결과
- **Phase 2 (Plan Validation)**:
  - 이슈: Double `/v2` risk, Comment pluralization, type safety
  - 해결: Base URL에 `/v2` 포함, 명시적 pluralization mapping, `str()` coercion
- **Phase 5 (Code Review)**:
  - 이슈: `target_type` None 처리 시 AttributeError 가능
  - 해결: `str(extra_fields.get(...))` 적용

### 알려진 제약
- Comment 알림의 경우 현재 caller(`audit.py`)가 `target_type`/`target_entity`를 전달하지 않음
  - URL 생성 실패 시 warning 로그 출력
  - Embed는 생성되지만 URL 없이 전송됨
  - 향후 Comment 기능 구현 시 caller 수정 필요

---

## 참고

- Discord embed의 `url` 필드를 추가하면 제목이 클릭 가능한 하이퍼링크가 됨
- 기존 Discord 알림 패턴 (`notification_service.py`) 참고
>>>>>>> b1c8eee (feat(tsk-023-1768030620896): Dashboard - Discord 알림 링크 추가)
