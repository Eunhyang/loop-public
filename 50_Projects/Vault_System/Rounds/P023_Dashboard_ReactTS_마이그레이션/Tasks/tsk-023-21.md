---
entity_type: Task
entity_id: tsk-023-21
entity_name: "Dashboard - 필터뷰 Program/Project 하위 항목 표시 버그 수정"
created: 2026-01-08
updated: 2026-01-08
status: done

# === 계층 ===
project_id: prj-023
parent_id: prj-023
aliases: []

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []
primary_hypothesis_id: null

# === Task 전용 ===
type: dev
target_project: loop
assignee: "김은향"
due: null
priority: high
notes: ""
attachments: []
links: []
closed: 2026-01-08

# === 분류 ===
tags: ["task", "dashboard-v2", "bugfix", "filter"]
---

# Dashboard - 필터뷰 Program/Project 하위 항목 표시 버그 수정

> Task ID: `tsk-023-21` | Project: [[prj-023]] | Status: done

---

## Notes

### Problem Summary

대시보드 상단 필터뷰에서 **Program이나 Project를 선택했을 때 하위 프로젝트/태스크가 표시되지 않는 버그**

### Root Cause

**버그 위치**: `TaskFilterBar.tsx`

1. **`filteredTasks`가 assignee 필터만 적용** (54-57줄)
```typescript
const filteredTasks = useMemo(() => {
  if (assignees.length === 0) return tasks;
  return tasks.filter(t => assignees.includes(t.assignee));  // ← assignee만 필터
}, [tasks, assignees]);
```

2. **`childProjects`에서 taskCount=0인 프로젝트 제외** (75-81줄)
```typescript
const childProjects = useMemo(() => {
  if (!programId) return [];
  return projects
    .filter(p => p.program_id === programId)
    .map(p => ({ ...p, taskCount: getProjectTaskCount(p.entity_id) }))
    .filter(p => p.taskCount > 0);  // ← taskCount=0이면 버튼 안 보임
}, [programId, projects, filteredTasks]);
```

### Bug Scenario

1. Assignee 필터: `['김은향', '한명학']` 선택됨
2. Program 클릭: `pgm-kkokkkokfit` 선택
3. `childProjects` 계산:
   - 프로젝트 A의 태스크가 모두 `김제훈` 담당이면
   - `filteredTasks`에 프로젝트 A 태스크 0개 → `taskCount = 0`
   - `.filter(p => p.taskCount > 0)`에서 제외
   - **결과: 프로젝트 A 버튼이 화면에 안 보임**

---

## Tech Spec

### Target File
- `public/dashboard-v2/src/features/filters/components/TaskFilterBar.tsx`

### Solution (Option B)
전체 태스크 기준으로 taskCount 계산하여 필터 무관하게 실제 프로젝트 구조 표시

### Code Changes

```typescript
// Line 59-62: getAllTaskCount 함수 추가
const getAllTaskCount = (projectId: string) => {
  return tasks.filter(t => t.project_id === projectId).length;
};

// Line 65-72: programsWithTasks - 전체 태스크로 계산
const programsWithTasks = useMemo(() => {
  return programs.map(prog => {
    const programProjects = projects.filter(p => p.program_id === prog.entity_id);
    const projectIdList = programProjects.map(p => p.entity_id);
    const taskCount = tasks.filter(t => projectIdList.includes(t.project_id)).length;
    return { ...prog, taskCount };
  }).filter(p => p.taskCount > 0);
}, [programs, projects, tasks]);  // filteredTasks → tasks

// Line 75-81: childProjects - 전체 태스크로 계산
const childProjects = useMemo(() => {
  if (!programId) return [];
  return projects
    .filter(p => p.program_id === programId)
    .map(p => ({ ...p, taskCount: getAllTaskCount(p.entity_id) }))
    .filter(p => p.taskCount > 0);
}, [programId, projects, tasks]);  // filteredTasks → tasks

// Line 84-89: independentProjects - 전체 태스크로 계산
const independentProjects = useMemo(() => {
  return projects
    .filter(p => !p.program_id)
    .map(p => ({ ...p, taskCount: getAllTaskCount(p.entity_id) }))
    .filter(p => p.taskCount > 0);
}, [projects, tasks]);  // filteredTasks → tasks
```

### Summary of Changes
- `getProjectTaskCount()` → `getAllTaskCount()` (전체 tasks 사용)
- 모든 useMemo 의존성에서 `filteredTasks` → `tasks`
- `.filter(p => p.taskCount > 0)` 유지 (태스크 0개인 빈 프로젝트는 숨김)

---

## Todo

- [ ] `getAllTaskCount` 함수 추가
- [ ] `programsWithTasks` useMemo 수정 (tasks 의존성)
- [ ] `childProjects` useMemo 수정 (tasks 의존성)
- [ ] `independentProjects` useMemo 수정 (tasks 의존성)
- [ ] 테스트: Program 클릭 → 하위 Project 버튼 표시 확인
- [ ] 테스트: 다양한 Assignee 조합에서 프로젝트 표시 확인

---

## Verification

1. **Dev 서버 실행**
   ```bash
   cd public/dashboard-v2 && npm run dev
   ```

2. **테스트 시나리오**
   - Assignee 1-2명만 선택
   - Program 버튼 클릭 → 하위 Project 버튼들이 표시되는지 확인
   - Project 버튼 클릭 → Kanban에 해당 프로젝트 태스크가 표시되는지 확인

3. **엣지 케이스**
   - 태스크가 전혀 없는 프로젝트 (active 상태지만 태스크 0개)
   - 모든 태스크가 done 상태인 프로젝트
   - Assignee 선택 해제 후 Program 클릭

---

## Implementation Summary (2026-01-08)

### Changes Made
File: `public/dashboard-v2/src/features/filters/components/TaskFilterBar.tsx`

1. **Added useCallback import** (line 1)
2. **Replaced getProjectTaskCount with getAllTaskCount** (lines 62-67)
   - Wrapped in useCallback for memoization stability
   - Uses full `tasks` array instead of `filteredTasks`
3. **Updated programsWithTasks** (lines 69-77)
   - Changed from `filteredTasks` to `tasks` for counting
   - Updated dependency array: `[programs, projects, tasks]`
4. **Updated childProjects** (lines 79-86)
   - Uses `getAllTaskCount` instead of `getProjectTaskCount`
   - Updated dependency array: `[programId, projects, getAllTaskCount]`
5. **Updated independentProjects** (lines 88-94)
   - Uses `getAllTaskCount` instead of `getProjectTaskCount`
   - Updated dependency array: `[projects, getAllTaskCount]`
6. **Added comprehensive comments** explaining intentional design:
   - Filter bar is for NAVIGATION, not filtered results
   - Shows full project hierarchy regardless of filters
   - Other filters (status/date) apply in `buildKanbanColumns`

### Codex Review Summary

**Session**: 019b9e04-c2ad-7ee0-8821-a474cf94895d | **Model**: gpt-5.1-codex-max

#### Plan Validation (Phase 2)
- ✅ Logic is sound for fixing the bug
- ⚠️ Noted: Using raw tasks ignores other filters (intentional for navigation)
- ✅ useCallback usage is correct
- ✅ Dependency arrays are properly updated

#### Final Code Review (Phase 5)
- ✅ No critical bugs detected
- ✅ TypeScript correctness verified
- ⚠️ Performance: O(p·n + m·n) repeated filtering (acceptable for typical usage)
- ✅ Comments clarified to prevent future misunderstandings

### Build Status
- ✅ Build successful: `npm run build` passed with no errors
- ✅ TypeScript compilation: No type errors
- Bundle size: 433.09 kB (128.82 kB gzipped)

---

## 작업 로그

### 2026-01-08 (Task Completion)
**개요**: Dashboard-v2 필터바 버그 수정 완료 - Program/Project 선택 시 하위 항목이 표시되지 않던 문제 해결

**변경사항**:
- 수정: `TaskFilterBar.tsx` - 필터 로직을 전체 태스크 기준으로 변경
  - `getProjectTaskCount()` → `getAllTaskCount()` (filteredTasks 대신 tasks 사용)
  - `programsWithTasks`, `childProjects`, `independentProjects` 모두 전체 태스크로 계산
  - 필터바는 네비게이션 용도이므로 전체 구조 표시가 의도된 동작임을 명시하는 주석 추가

**파일 변경**:
- `public/dashboard-v2/src/features/filters/components/TaskFilterBar.tsx`
  - useCallback import 추가
  - getAllTaskCount 함수 추가 (useCallback로 메모이제이션)
  - programsWithTasks, childProjects, independentProjects useMemo 의존성 업데이트
  - 주석 추가로 의도된 동작 명확화

**검증**:
- ✅ Codex 리뷰 통과 (gpt-5.1-codex-max)
  - Plan validation: 로직 타당성 확인
  - Code review: 크리티컬 버그 없음, TypeScript 타입 정확성 확인
  - Performance: O(p·n + m·n) 복잡도, 일반적 사용 환경에서 허용 가능
- ✅ 빌드 성공 (npm run build)
- ✅ TypeScript 컴파일 에러 없음

**결과**: Task 완료 - 필터바에서 Program/Project 선택 시 하위 항목이 정상적으로 표시됨

**최종 상태**: done
