---
entity_type: Task
entity_id: tsk-023-1768500289204
entity_name: Dashboard - Hypothesis Candidates API 구현
created: '2026-01-16'
updated: '2026-01-16'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768500289204
tags: []
type: dev
---

# Dashboard - Hypothesis Candidates API 구현

## 설명

프로젝트에 연결할 가설(Hypothesis) 후보를 추천하는 API 엔드포인트 구현.
기존 API/Cache 조합으로 구현하며, 새 DB 쿼리 없이 3단계 후보 생성 로직 적용.

**엔드포인트**: `GET /api/mcp/project/{project_id}/hypothesis-candidates`

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard v2)
- Target: loop (api)
- 기존 mcp_composite.py 패턴 준수

**File Structure:**
```
~/dev/loop/code/api/
├── models/
│   └── hypothesis_candidates.py      # [NEW] Pydantic 응답 모델
├── utils/
│   └── text_similarity.py            # [NEW] TF-IDF 텍스트 유사도
├── services/
│   └── hypothesis_candidates_service.py  # [NEW] 후보 생성 로직
├── routers/
│   └── mcp_composite.py              # [MODIFY] 엔드포인트 추가
└── pyproject.toml                    # [MODIFY] scikit-learn 의존성
```

**Implementation Details:**

1. **Pydantic 모델** (`api/models/hypothesis_candidates.py`):
   ```python
   class CandidateItem(BaseModel):
       hypothesis_id: str                    # e.g., "hyp-2-01"
       hypothesis_name: str                  # e.g., "천천히 먹기: 행동 변화"
       score: float = Field(ge=0.0, le=1.0)  # 0.0-1.0 normalized score
       why: str                              # Human-readable reason

   class CandidatesGroup(BaseModel):
       track_based: List[CandidateItem] = Field(default_factory=list)
       condition_based: List[CandidateItem] = Field(default_factory=list)
       keyword_based: List[CandidateItem] = Field(default_factory=list)

   class Recommendation(BaseModel):
       validates: List[str] = Field(default_factory=list, max_length=5)  # hypothesis_ids
       primary: Optional[str] = None         # hypothesis_id, validates[0] if not LLM
       reasons: List[str] = Field(default_factory=list)  # Human-readable (max 3)
       confidence: float = Field(ge=0.0, le=1.0, default=0.5)  # Rule-based: 0.5 fixed

   class HypothesisCandidatesResponse(BaseModel):
       project_id: str
       project_name: str
       track_id: Optional[str]               # null if project.parent_id is null
       conditions_3y: List[str]
       candidates: CandidatesGroup
       recommendation: Recommendation
   ```

2. **텍스트 유사도** (`api/utils/text_similarity.py`):
   - **Corpus**: 모든 hypothesis 텍스트 (entity_name + hypothesis_question + success_criteria)
   - **Cache Strategy**: 모듈 레벨 싱글톤 - API 서버 시작 시 한 번 fit, reload 시 갱신
   - **Empty Text**: 빈 문자열이면 score 0.0 반환
   - **Vectorizer**: `TfidfVectorizer(tokenizer=str.split)` - 한글 공백 토크나이징
   ```python
   class TextSimilarityEngine:
       _instance = None

       def __init__(self):
           self.vectorizer = TfidfVectorizer(tokenizer=str.split)
           self.corpus_vectors = None
           self.hypothesis_ids = []

       def fit(self, hypotheses: List[Dict]):
           """API 시작 시 또는 cache reload 시 호출"""
           texts = [self._build_text(h) for h in hypotheses]
           self.corpus_vectors = self.vectorizer.fit_transform(texts)
           self.hypothesis_ids = [h['entity_id'] for h in hypotheses]

       def get_similar(self, query_text: str, top_k: int) -> List[Tuple[str, float]]:
           """Returns [(hypothesis_id, score), ...] sorted by score desc"""
   ```

3. **후보 생성 서비스** (`api/services/hypothesis_candidates_service.py`):

   **Scoring Rules:**
   | Source | Base Score | Bonus | Total |
   |--------|-----------|-------|-------|
   | track_based | 0.80 | +0.05 (planning) | max 0.85 |
   | condition_based | 0.60 | +0.05 (planning) | max 0.65 |
   | keyword_based | TF-IDF similarity | - | 0.0-1.0 |

   **Deduplication**: 동일 hypothesis_id가 여러 그룹에 있으면, 가장 높은 score 그룹에만 포함

   **max_candidates**: 그룹별 최대 N개 (default 10)

   **build_recommendation():**
   - 모든 그룹 통합 → score desc 정렬 → top 3 선택 → validates
   - primary = validates[0]
   - confidence = 0.5 (규칙 기반 고정값)
   - reasons = 각 후보의 why 필드 활용

4. **LLM 리랭크** (`llm_rerank_candidates()`):
   ```python
   async def llm_rerank_candidates(
       candidates: List[CandidateItem],  # 규칙 기반 top 10
       project: Dict,
       provider: str = "openai"
   ) -> Recommendation:
       """
       Input: 최대 10개 후보
       Output: validates (max 3), primary, reasons, confidence (LLM 제공)
       Fallback: LLM 실패 시 규칙 기반 결과 반환
       """
       prompt = f"""
       프로젝트: {project['entity_name']}
       목표: {project.get('hypothesis_text', '')}

       후보 가설:
       {json.dumps([{'id': c.hypothesis_id, 'name': c.hypothesis_name} for c in candidates], ensure_ascii=False)}

       이 프로젝트가 validates해야 할 가설 3개를 선택하세요.

       JSON 응답:
       {{"validates": ["hyp-X-XX", ...], "primary": "hyp-X-XX", "reasons": ["...", "..."], "confidence": 0.7}}
       """
   ```

5. **엔드포인트** (`api/routers/mcp_composite.py`):
   ```python
   @router.get("/project/{project_id}/hypothesis-candidates")
   async def get_hypothesis_candidates(
       project_id: str,
       include_llm_rerank: bool = Query(False),
       max_candidates: int = Query(10, ge=1, le=30),
       provider: str = Query("openai")
   ):
       # Error handling:
       # - project not found → HTTPException 404
       # - no hypotheses → 빈 candidates, recommendation.validates=[]
   ```

**Response JSON Schema (with hypothesis_name):**
```json
{
  "project_id": "prj-023",
  "project_name": "Dashboard - React+TS 마이그레이션",
  "track_id": "trk-2",
  "conditions_3y": ["cond-e"],
  "candidates": {
    "track_based": [{"hypothesis_id": "hyp-2-01", "hypothesis_name": "SSOT 대시보드가 운영 복잡도를 낮춘다", "score": 0.85, "why": "같은 Track(trk-2) 소속"}],
    "condition_based": [{"hypothesis_id": "hyp-3-02", "hypothesis_name": "데이터 표준화로 의사결정 속도 향상", "score": 0.70, "why": "conditions_3y(cond-e)와 전략적 연결"}],
    "keyword_based": [{"hypothesis_id": "hyp-1-05", "hypothesis_name": "천천히 먹기: 행동 변화", "score": 0.55, "why": "텍스트 유사도: 0.55"}]
  },
  "recommendation": {
    "validates": ["hyp-2-01", "hyp-3-02"],
    "primary": "hyp-2-01",
    "reasons": ["Track_2 목표와 정합", "cond-e 기여 직접 연결"],
    "confidence": 0.5
  }
}
```

**Candidate Sourcing Rules (명확화):**

| Group | Source Field | Filter Logic | Example |
|-------|-------------|--------------|---------|
| track_based | `project.parent_id` | `hypothesis.entity_id.startswith(f"hyp-{track_num}-")` | parent_id="trk-2" → hyp-2-* |
| condition_based | `project.conditions_3y` | `track.validates ∩ conditions_3y ≠ ∅` 인 Track의 가설들 | conditions_3y=["cond-e"] → trk-2,trk-5 → hyp-2-*,hyp-5-* |
| keyword_based | TF-IDF | project text vs hypothesis text cosine similarity | top_k 매칭 |

**Scoring Bonus Trigger:**
- "+0.05 (planning)": `hypothesis.evidence_status == "planning"` 일 때 적용

**Deduplication Tie-break:**
- 동일 hypothesis가 여러 그룹에 등장 시: `track_based > condition_based > keyword_based` 순위로 가장 높은 그룹에만 포함
- 같은 그룹 내 동점: entity_id 알파벳 순

**Text Similarity Lifecycle:**
- `fit()`: API 서버 시작 시 `cache.get_all_hypotheses()`로 corpus 구성
- `refresh()`: cache reload 이벤트 시 재호출 (현재는 서버 재시작 시점)
- `empty corpus`: 빈 리스트 반환, score 0.0
- `min_similarity_threshold`: 0.1 미만은 결과에서 제외

**LLM Rerank Rules:**
- `validates` 최대 3개 (초과 시 앞에서 자름)
- `confidence` 범위: 0.0-1.0 (범위 외 시 clamp)
- JSON 파싱 실패 또는 유효하지 않은 hypothesis_id 시 → 규칙 기반 결과 fallback
- 허용 provider: "openai" (기본), "anthropic"

**Edge Cases:**
1. project.parent_id가 null인 경우 → track_based 빈 배열 반환
2. project.conditions_3y가 빈 배열인 경우 → condition_based 빈 배열 반환
3. 가설이 하나도 없는 경우 → 빈 candidates + **빈 recommendation 객체** (validates=[], primary=null, reasons=[], confidence=0.0)
4. LLM 호출 실패 시 → 규칙 기반 recommendation 반환 (fallback)

**Empty State Contract (명확화):**
- Empty state에서도 recommendation은 **항상 객체** (null 아님)
- 후보가 없으면: `confidence: 0.0` (규칙 기반 기본값 0.5는 후보가 있을 때만 적용)
- validates, reasons는 빈 배열, primary는 null

**Dependencies:**
- `scikit-learn>=1.3.0,<2.0` - TF-IDF (pyproject.toml api 그룹에 추가)
- 기존: cache.get_all_hypotheses(), cache.get_track(), LLMService

**Empty State Response Example:**
```json
{
  "project_id": "prj-999",
  "project_name": "테스트 프로젝트",
  "track_id": null,
  "conditions_3y": [],
  "candidates": {
    "track_based": [],
    "condition_based": [],
    "keyword_based": []
  },
  "recommendation": {
    "validates": [],
    "primary": null,
    "reasons": [],
    "confidence": 0.0
  }
}
```

### Todo

- [ ] `api/models/hypothesis_candidates.py` 생성 (Pydantic 모델)
- [ ] `api/utils/text_similarity.py` 생성 (TF-IDF 유틸)
- [ ] `api/services/hypothesis_candidates_service.py` 생성 (비즈니스 로직)
- [ ] `api/routers/mcp_composite.py` 수정 (엔드포인트 추가)
- [ ] `pyproject.toml` 수정 (scikit-learn 추가)
- [ ] poetry install 실행
- [ ] curl로 API 테스트 (prj-023, prj-019 등)
- [ ] LLM 리랭크 옵션 테스트

## 참고

- Plan 파일: `~/.claude/plans/tender-jingling-shell.md`
- 관련 기존 코드: `api/routers/mcp_composite.py` (get_project_context, get_track_context)
- 참고 패턴: `api/routers/impact_batch.py` (suggest_batch)
