---
entity_type: Task
entity_id: tsk-023-1768462246386
entity_name: API - exec-api를 api로 통합
created: '2026-01-15'
updated: '2026-01-15'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
closed: '2026-01-15'
aliases:
- tsk-023-1768462246386
tags: []
type: dev
notes: '# API - exec-api를 api로 통합


  ## 설명


  `code/exec-api/`를 `code/api/`에 통합하여 두 개의 FastAPI 앱을 하나로 합친다. KPI 엔드포인트(`/api/kpi/*`)의
  `kpi:read` scope 검사는 유지한다.


  ## Tech Spec


  **Architecture Compliance:**


  - Parent Project: prj-023

  - Target: loop-code (`~/dev/loop/code/`)


  **File Structure:**


  ```

  code/

  ├── api/

  │   ├── main.py                      # 수정: KPI 라우터 등록, startup 초기화

  │   ├── routers/

  │   │   └── kpi.py                   # 신규: KPI 라우터 (scope 검사 포함)

  │   ├── services/

  │   │   └── kpi/                     # 신규: KPI 서비스 모듈

  │   │       ├── __init__.py

  │   │       ├── kpi_service.py       # exec-api에서 이동

  │   │       ├── amplitude_client.py  # exec-api에서 이동

  │   │       └── revenuecat_client.py # exec-api에서 이동

  │   └── models/

  │       └── kpi.py                   # 신규: KPI Pydantic 모델

  └── exec-api/                        # 삭제 (통합 후)

  ```


  **Implementation Details:**


  - KPI 라우터 scope 검사: route-level dependency 패턴 사용 (mcp_composite.py:218 참조)

  - `require_kpi_access()` 함수로 `kpi:read` scope 또는 admin/exec role 확인

  - MCP_ALLOWED_OPERATIONS에 KPI 엔드포인트 5개 추가


  **KPI Endpoints:**


  - `GET /api/kpi/overview` - KPI 개요 (Amplitude + RevenueCat)

  - `GET /api/kpi/mau` - MAU

  - `GET /api/kpi/conversion` - 전환율

  - `GET /api/kpi/user/{user_id}` - 사용자 여정

  - `POST /api/kpi/refund-analysis` - 환불 분석


  **Edge Cases:**


  - Amplitude/RevenueCat API 키 미설정 시: 503 Service Unavailable 반환

  - kpi:read scope 없는 토큰: 403 Forbidden


  **사전 작업:**


  - `~/dev/loop/api/` 잔여물 폴더 삭제 (v3.2 이전 잔여물)


  ## 체크리스트


  - [ ] Step 0: `~/dev/loop/api/` 잔여물 폴더 삭제


  - [ ] Step 1: `api/services/kpi/` 디렉토리 생성 및 서비스 이동


  - [ ] Step 2: `api/models/kpi.py` 생성


  - [ ] Step 3: `api/routers/kpi.py` 생성 (scope 검사 포함)


  - [ ] Step 4: `api/main.py` 수정 (라우터 등록, startup 초기화)


  - [ ] Step 5: `.env`에 Amplitude/RevenueCat 환경변수 확인


  - [ ] Step 6: MCP_ALLOWED_OPERATIONS에 KPI 엔드포인트 추가


  - [ ] Step 7: 로컬 테스트 (uvicorn)


  - [ ] Step 8: `code/exec-api/` 삭제


  - [ ] Step 9: 빌드 검증


  ## 참고


  - 계획 파일: `~/.claude/plans/synchronous-beaming-iverson.md`

  - 패턴 참조: `api/routers/mcp_composite.py:218` - `require_exec_access()`

  - scope 정의: `shared/auth/scope_checker.py:44` - `kpi:read`'
---
# API - exec-api를 api로 통합

## 설명

`code/exec-api/`를 `code/api/`에 통합하여 두 개의 FastAPI 앱을 하나로 합친다.
KPI 엔드포인트(`/api/kpi/*`)의 `kpi:read` scope 검사는 유지한다.

## Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Target: loop-code (`~/dev/loop/code/`)

**File Structure:**
```
code/
├── api/
│   ├── main.py                      # 수정: KPI 라우터 등록, startup 초기화
│   ├── routers/
│   │   └── kpi.py                   # 신규: KPI 라우터 (scope 검사 포함)
│   ├── services/
│   │   └── kpi/                     # 신규: KPI 서비스 모듈
│   │       ├── __init__.py
│   │       ├── kpi_service.py       # exec-api에서 이동
│   │       ├── amplitude_client.py  # exec-api에서 이동
│   │       └── revenuecat_client.py # exec-api에서 이동
│   └── models/
│       └── kpi.py                   # 신규: KPI Pydantic 모델
└── exec-api/                        # 삭제 (통합 후)
```

**Implementation Details:**
- KPI 라우터 scope 검사: route-level dependency 패턴 사용 (mcp_composite.py:218 참조)
- `require_kpi_access()` 함수로 `kpi:read` scope 또는 admin/exec role 확인
- MCP_ALLOWED_OPERATIONS에 KPI 엔드포인트 5개 추가

**KPI Endpoints:**
- `GET /api/kpi/overview` - KPI 개요 (Amplitude + RevenueCat)
- `GET /api/kpi/mau` - MAU
- `GET /api/kpi/conversion` - 전환율
- `GET /api/kpi/user/{user_id}` - 사용자 여정
- `POST /api/kpi/refund-analysis` - 환불 분석

**Edge Cases:**
- Amplitude/RevenueCat API 키 미설정 시: 503 Service Unavailable 반환
- kpi:read scope 없는 토큰: 403 Forbidden

**사전 작업:**
- `~/dev/loop/api/` 잔여물 폴더 삭제 (v3.2 이전 잔여물)

## 체크리스트

- [x] Step 0: `~/dev/loop/api/` 잔여물 폴더 삭제
- [x] Step 1: `api/services/kpi/` 디렉토리 생성 및 서비스 이동
- [x] Step 2: `api/models/kpi.py` 생성
- [x] Step 3: `api/routers/kpi.py` 생성 (scope 검사 포함)
- [x] Step 4: `api/main.py` 수정 (라우터 등록, startup 초기화)
- [x] Step 5: `.env`에 Amplitude/RevenueCat 환경변수 확인
- [x] Step 6: MCP_ALLOWED_OPERATIONS에 KPI 엔드포인트 추가
- [x] Step 7: 로컬 테스트 (uvicorn)
- [x] Step 8: `code/exec-api/` 삭제
- [x] Step 9: 빌드 검증

## 참고

- 계획 파일: `~/.claude/plans/synchronous-beaming-iverson.md`
- 패턴 참조: `api/routers/mcp_composite.py:218` - `require_exec_access()`
- scope 정의: `shared/auth/scope_checker.py:44` - `kpi:read`

## 작업 로그

#### 2026-01-15 16:48
**개요**: exec-api를 api로 통합. 두 개의 FastAPI 앱을 하나로 합치고 KPI 엔드포인트에 scope 검사 유지.

**변경사항**:
- 삭제: `~/dev/loop/api/` 잔여물 폴더 (v3.2 이전 remnant)
- 이동: `exec-api/services/` → `api/services/kpi/` (amplitude_client, revenuecat_client, kpi_service)
- 이동: `exec-api/models/schemas.py` → `api/models/kpi.py`
- 이동: `exec-api/routers/kpi.py` → `api/routers/kpi.py` (scope 검사 추가)
- 개발: `api/services/kpi/config.py` (환경변수 설정)
- 수정: `api/main.py` (KPI 라우터 등록, MCP_ALLOWED_OPERATIONS 추가)
- 삭제: `exec-api/` 전체 (통합 완료)

**핵심 코드** (`api/routers/kpi.py`):
```python
def require_kpi_access(request: Request):
    role = getattr(request.state, "role", "member")
    scope = getattr(request.state, "scope", "")
    if role in ("admin", "exec"):
        return
    if "kpi:read" not in scope:
        raise HTTPException(403, "kpi:read scope required")
```

**결과**: ✅ 빌드 검증 통과 (19 files changed, +152/-389 lines)

**다음 단계**:
- `/deploy-api` 실행하여 NAS 배포
