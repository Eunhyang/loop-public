---
entity_type: Task
entity_id: tsk-023-1768554593687
entity_name: Dashboard - Entity Form 패턴 통일 (로컬 상태 + Save 버튼)
created: '2026-01-16'
updated: '2026-01-16'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768554593687
tags: []
type: dev
---

# Dashboard - Entity Form 패턴 통일 (로컬 상태 + Save 버튼)

## 설명

모든 엔티티 폼(Task/Project/Program/Track/Condition/Hypothesis)의 UX를 "로컬 상태에 모아 Save 눌러야 저장"으로 통일하고, 이를 지원하는 공통 Form 모듈을 도입하되 feature 경계를 보존.

**배경**: 현재 폼 UX가 엔티티별로 다름. TaskForm은 필드 단위 즉시 PATCH, ProjectForm은 onBlur 로컬 상태 + Save 버튼 조합. 사용자 혼란(입력 후 Save 비활성 등)과 코드 패턴 분산이 발생.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard - React+TS 마이그레이션)
- Target: loop (dashboard-v2)
- Scope: `dashboard-v2/src/**`
- 프로젝트 룰: prj-023 project.md "Dashboard V2 Architecture & LLM Work Rules" 준수

**Functional Requirements:**
- FR1: 모든 엔티티 폼에서 변경 즉시 로컬 상태/dirty 반영, Save 버튼을 눌러야만 서버 반영
- FR2: 공통 Form 모듈 추가 (ChipSelect/MarkdownEditor 등 slot/children 기반 레이아웃)
- FR3: ProjectForm를 새 패턴으로 교체, 기존은 ProjectFormLegacy로 보존
- FR4: Task/Program/Track/Condition/Hypothesis 단계적 전환 가능하도록 훅/레이아웃 재사용성 확보

**Non-Goals:**
- 자동 저장(Auto-save) 유지/추가 없음
- DrawerShell, UiContext 구조 변경 없음
- API 스키마 변경 없음
- TaskForm 마이그레이션 (Phase 2에서 별도 Task로 처리)

**Success Criteria:**
- 필드 타이핑만 해도 Save 버튼이 즉시 활성화 (포커스 전환 필요 없음)
- Save 누르기 전까지 서버 데이터 변경 없음
- `npm run build` 통과, TypeScript 에러 없음
- common→feature 역참조 0건

**File Structure:**
```
dashboard-v2/src/
├── features/forms/                          # 새 디렉토리 (feature-neutral)
│   ├── index.ts                             # barrel export
│   ├── hooks/
│   │   └── useEntityFormState.ts            # 핵심 훅
│   ├── components/
│   │   └── FormActions.tsx                  # Save/Cancel/Delete 버튼 바
│   ├── utils/
│   │   └── serialize.ts                     # diffObject 유틸
│   └── types.ts                             # Form 관련 타입
├── features/projects/components/
│   ├── ProjectFormLegacy.tsx                # 기존 파일 리네임 (롤백용 보존)
│   └── ProjectForm.tsx                      # 새 구현
└── components/layout/
    └── EntityDrawer.tsx                     # import 경로 수정 (새 ProjectForm 사용)
```

---

### 1. useEntityFormState 계약 (Codex Issue #1)

**타입 정의:**
```typescript
// src/features/forms/types.ts
interface UseEntityFormStateOptions<TData extends Record<string, unknown>> {
  /** Query에서 가져온 초기 데이터 (undefined 시 loading 상태) */
  initialData: TData | undefined;

  /** 모드별 동작 */
  mode: 'create' | 'edit' | 'view' | 'review';

  /** 변경 사항만 추출 (PATCH 최소화) - optional, 기본은 diffObject */
  serialize?: (current: TData, original: TData) => Partial<TData>;

  /** 저장 전 검증 - null 반환 시 통과, Record 반환 시 에러 */
  validate?: (data: TData) => Record<string, string> | null;

  /** 저장 mutation (React Query mutation.mutate 주입) */
  onSubmit: (payload: Partial<TData>) => void;

  /** 저장 중 상태 (mutation.isPending 주입) */
  isSaving?: boolean;
}

interface UseEntityFormStateReturn<TData> {
  /** 현재 폼 값 (로컬 상태) */
  values: TData;

  /** 필드 단위 업데이트 */
  setField: <K extends keyof TData>(field: K, value: TData[K]) => void;

  /** 필드별 에러 맵 { entity_name: '필수 입력', owner: 'Owner 선택 필요' } */
  errors: Record<string, string>;

  /** 변경 여부 (initialData 대비) */
  isDirty: boolean;

  /** 저장 가능 여부 (isDirty && !hasErrors && !isSaving) */
  canSave: boolean;

  /** 저장 중 상태 */
  isSaving: boolean;

  /** 저장 처리 */
  handleSave: () => void;

  /** 초기 상태로 리셋 */
  reset: () => void;
}
```

**동작 규칙:**
| 조건 | 동작 |
|------|------|
| `initialData` 변경 (id 변경으로 새 query fetch) | 자동 rehydrate (values 재초기화) |
| `mode === 'view'` | `setField` 무시, `isDirty` 항상 false |
| `mode === 'create'` | `initialData`는 prefill 또는 빈 객체 |
| `mode === 'review'` | `useReviewMode`와 연동 (getFieldValue/setFieldValue 호환) |

---

### 2. Save/Dirty 라이프사이클 (Codex Issue #2)

| 시나리오 | 동작 | 근거 |
|---------|------|------|
| Drawer 닫기 + dirty | 경고 없이 닫기 | 기존 ProjectForm 정책 유지 |
| 동시 저장 방지 | `isSaving` 중 Save 버튼 disabled | 기존 구현 (ProjectForm.tsx:779) |
| MarkdownEditor 변경 | **Save 버튼 필요** (즉시 저장 제거) | FR1 준수 |
| TaskForm 마이그레이션 | Phase 2에서 처리 (별도 Task) | 본 Task는 ProjectForm만 |

**MarkdownEditor 처리:**
- 현재: `onChange` → 부모의 `handleUpdate` → 즉시 PATCH
- 변경: `onChange` → `setField('notes', value)` → 로컬 상태만 → Save 시 PATCH

---

### 3. serialize(changes) 명세 (Codex Issue #3)

**유틸 함수:**
```typescript
// src/features/forms/utils/serialize.ts
export function diffObject<T extends Record<string, unknown>>(
  current: T,
  original: T
): Partial<T> {
  const changes: Partial<T> = {};

  for (const key of Object.keys(current) as (keyof T)[]) {
    const currentVal = current[key];
    const originalVal = original[key];

    if (!shallowEqual(currentVal, originalVal)) {
      changes[key] = currentVal;
    }
  }

  return changes;
}

function shallowEqual(a: unknown, b: unknown): boolean {
  if (a === b) return true;
  if (typeof a !== typeof b) return false;

  // 배열/객체: JSON 비교 (키 정렬 후)
  if (typeof a === 'object' && a !== null) {
    return JSON.stringify(sortKeys(a)) === JSON.stringify(sortKeys(b));
  }

  return false;
}

function sortKeys(obj: unknown): unknown {
  if (Array.isArray(obj)) {
    return obj.map(sortKeys);
  }
  if (typeof obj === 'object' && obj !== null) {
    const sorted: Record<string, unknown> = {};
    for (const key of Object.keys(obj).sort()) {
      sorted[key] = sortKeys((obj as Record<string, unknown>)[key]);
    }
    return sorted;
  }
  return obj;
}
```

**적용:** 기존 ProjectForm의 `hasChanges` 로직 (lines 229-244) 을 이 유틸로 대체.

---

### 4. ProjectForm 마이그레이션 상세 (Codex Issue #4)

**파일 처리:**
| 항목 | 처리 | 경로 |
|------|------|------|
| 기존 파일 | 리네임 (롤백용 보존) | `ProjectForm.tsx` → `ProjectFormLegacy.tsx` |
| 새 파일 | 신규 생성 (useEntityFormState 사용) | `ProjectForm.tsx` |
| EntityDrawer | import 경로 수정 | 새 ProjectForm 사용 |

**모드별 처리:**
| 모드 | 동작 | 참조 코드 |
|------|------|----------|
| `create` | prefill → useEntityFormState | lines 803-858 로직 유지 |
| `edit` | id → useProject → useEntityFormState | lines 121-139, 299-352 로직 유지 |
| `view` | readonly (setField 무시) | isReadOnly 체크 유지 |
| `review` | useReviewMode 연동 | lines 36-42, 299-316 로직 유지 |

**Review 모드 호환:**
- `reviewMode.getFieldValue(field)` → 제안값 우선 반환
- `reviewMode.setFieldValue(field, value)` → 사용자 수정 추적
- `reviewMode.isSuggested(field)` → 하이라이트 표시
- `reviewMode.getReasoning(field)` → 추천 이유 표시

**서버 주도 필드 (폼 dirty와 무관):**
| 필드 | 처리 | 참조 |
|------|------|------|
| tasks 리스트 | 읽기 전용 (dashboardData에서) | lines 78-106 |
| attachments | 별도 섹션 | 기존 구조 유지 |
| realized_impact | 읽기 전용 (서버에서만 수정) | ImpactSection 컴포넌트 |

---

### 5. FormActions 명세 (Codex Issue #5)

**Props 정의:**
```typescript
// src/features/forms/components/FormActions.tsx
interface FormActionsProps {
  /** Save 버튼 활성화 여부 */
  canSave: boolean;

  /** 저장 중 상태 */
  isSaving: boolean;

  /** 삭제 중 상태 */
  isDeleting?: boolean;

  /** Save 클릭 핸들러 */
  onSave: () => void;

  /** Cancel/Close 클릭 핸들러 */
  onClose: () => void;

  /** Delete 클릭 핸들러 (optional) */
  onDelete?: () => void;

  /** 에러 메시지 */
  error?: string | null;
}
```

**Footer 소유권:**
| 컴포넌트 | 책임 |
|---------|------|
| DrawerShell | backdrop, slide-in, close 버튼, slots (header/body/footer) |
| EntityDrawer | 라우팅 (type/mode/id → 해당 Form 렌더) |
| ProjectForm | footer 직접 렌더 (FormActions 사용) |
| FormActions | 버튼 정렬/스타일만, 핸들러는 Form에서 정의 |

**키보드 핸들링:**
| 키 | 동작 | 담당 |
|---|------|------|
| ESC | Drawer 닫기 | DrawerShell (기존 구현) |
| Cmd+S/Ctrl+S | Save (후속 개선) | 본 Task 범위 외 |

---

### Dependencies

- 기존 SSOT: `src/services/http.ts`, `src/types/*`, `src/queries/keys.ts`
- 기존 queries: `useProject`, `useUpdateProject`, `useDeleteProject`, `useDashboardInit`
- 기존 hooks: `useReviewMode`, `useUi`
- 기존 components: `ChipSelect`, `ChipSelectExpand`, `MarkdownEditor`, `ImpactSection`

---

### Todo

- [ ] T1: `src/features/forms/` 디렉토리 생성
  - [ ] T1.1: `types.ts` - UseEntityFormStateOptions, UseEntityFormStateReturn 타입
  - [ ] T1.2: `hooks/useEntityFormState.ts` - 핵심 훅 구현
  - [ ] T1.3: `utils/serialize.ts` - diffObject, shallowEqual 유틸
  - [ ] T1.4: `components/FormActions.tsx` - Save/Cancel/Delete 버튼 바
  - [ ] T1.5: `index.ts` - barrel export
- [ ] T2: ProjectForm 레거시 리네임 (`ProjectForm.tsx` → `ProjectFormLegacy.tsx`)
- [ ] T3: 새 ProjectForm 작성
  - [ ] T3.1: useEntityFormState 연동 (create/edit/view/review 모드)
  - [ ] T3.2: useReviewMode 호환 (getFieldValue/setFieldValue/isSuggested)
  - [ ] T3.3: FormActions 사용 (footer 렌더)
  - [ ] T3.4: 기존 validation 로직 이전 (entity_name, owner, expected_impact gate)
- [ ] T4: EntityDrawer import 스위치 (새 ProjectForm으로 변경)
- [ ] T5: 빌드 검증 (`npm run build` 통과)
- [ ] T6: 수동 테스트
  - [ ] T6.1: Project 드로어 필드 수정 → Save 즉시 활성화 확인
  - [ ] T6.2: Save 클릭 → API 반영 확인
  - [ ] T6.3: Review 모드 → 제안값 표시/수정 확인
  - [ ] T6.4: Delete/Close 동작 확인

## 체크리스트

- [ ] T1: forms 모듈 생성 (types, hook, utils, components)
- [ ] T2: ProjectFormLegacy 리네임
- [ ] T3: 새 ProjectForm 구현 (모드별 처리, review 호환)
- [ ] T4: EntityDrawer import 수정
- [ ] T5: 빌드 검증
- [ ] T6: 수동 테스트

## 참고

- PRD 원본: `.agent/plan/prd-techspec-entity-form-unification.md`
- 프로젝트 아키텍처: `prj-023` project.md (Dashboard V2 Architecture & LLM Work Rules)
- 기존 ProjectForm 분석: lines 121-139 (formData 초기화), 227-244 (hasChanges), 299-352 (handleFieldChange/handleSave)
- 기존 TaskForm 분석: lines 631-649 (즉시 PATCH - Phase 2 마이그레이션 대상)
- 후속 작업: Task/Program/Track/Condition/Hypothesis 폼 마이그레이션 (별도 Task)
