---
entity_type: Task
entity_id: tsk-023-1768494544353
entity_name: Infra - MCP 전용 컨테이너 분리 (loop-mcp)
created: '2026-01-16'
updated: '2026-01-16'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768494544353
tags: []
type: dev
---

# Infra - MCP 전용 컨테이너 분리 (loop-mcp)

## 설명

ChatGPT MCP 연결이 API 배포 시마다 끊기는 문제 해결.
MCP 엔드포인트를 별도 컨테이너(loop-mcp)로 분리하여 API 배포와 독립적으로 운영.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Target: loop-code (code/infra, code/mcp)

**문제:**
- SSE 연결은 특정 서버에 바인딩 → 서버 재시작 시 끊김
- 하루 5-10회 API 배포 → 매번 MCP 재연결 필요

**해결책:**
```
분리 후 구조:
┌─────────────────────────────────┐
│          loop-api               │  ← 자주 배포 OK
│  - Dashboard API (/api/*)       │
│  - Write API                    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│          loop-mcp               │  ← 거의 배포 안함 (연결 유지)
│  - MCP Read API (/mcp)          │
│  - SSE 스트리밍                 │
└─────────────────────────────────┘
```

**File Structure:**
```
code/
├── mcp/                          # 신규 생성
│   ├── __init__.py
│   └── main.py                   # MCP 전용 FastAPI 앱
├── infra/
│   ├── Dockerfile.mcp            # 신규 생성
│   └── nginx.conf                # 수정: /mcp 라우팅
└── docker-compose.yml            # 수정: loop-mcp 서비스 추가
```

**Implementation Details:**
1. `code/mcp/main.py`: MCP 전용 FastAPI 앱
   - `api.routers.mcp_composite` 라우터 재사용
   - `api.cache`, `api.oauth.jwks` import
   - AuthMiddleware (SSE 호환) 적용
   - FastApiMCP 마운트

2. `code/infra/Dockerfile.mcp`: 경량 이미지
   - python:3.11-slim 기반
   - 최소 의존성만 설치
   - timeout-keep-alive: 300초

3. `code/docker-compose.yml`: loop-mcp 서비스
   - 포트: 8085:8085
   - 볼륨: /vault (읽기전용), /exec_vault (읽기전용), oauth-data (읽기전용)

4. `code/infra/nginx.conf`: /mcp 라우팅
   - upstream mcp 추가 (keepalive 64)
   - location /mcp → loop-mcp로 프록시

**Edge Cases:**
- MCP Write API 호출 시: loop-api에서 처리 (기존대로)
- 캐시 동기화: loop-mcp는 읽기전용
- OAuth 키: oauth-data 볼륨 공유로 JWT 검증 가능

### Todo
- [ ] `code/mcp/__init__.py` 생성
- [ ] `code/mcp/main.py` 작성
- [ ] `code/infra/Dockerfile.mcp` 작성
- [ ] `code/docker-compose.yml`에 loop-mcp 서비스 추가
- [ ] `code/infra/nginx.conf` 수정 (/mcp 라우팅)
- [ ] 로컬 빌드 테스트
- [ ] NAS 배포 후 MCP 연결 유지 확인

## 참고

- Plan 파일: `~/.claude/plans/graceful-scribbling-truffle.md`
