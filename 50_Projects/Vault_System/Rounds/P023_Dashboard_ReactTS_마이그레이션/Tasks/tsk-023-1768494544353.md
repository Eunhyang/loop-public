---
entity_type: Task
entity_id: tsk-023-1768494544353
entity_name: Infra - MCP 전용 컨테이너 분리 (loop-mcp)
created: '2026-01-16'
updated: '2026-01-16'
status: done
closed: '2026-01-16'
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
aliases:
- tsk-023-1768494544353
tags: []
type: dev
notes: "# Infra - MCP 전용 컨테이너 분리 (loop-mcp)\n\n## 설명\n\nChatGPT MCP 연결이 API 배포 시마다\
  \ 끊기는 문제 해결. MCP 엔드포인트를 별도 컨테이너(loop-mcp)로 분리하여 API 배포와 독립적으로 운영.\n\n## Notes\n\n\
  ### Tech Spec\n\n**Architecture Compliance:**\n\n- Parent Project: prj-023\n- Target:\
  \ loop-code (code/infra, code/mcp)\n\n**문제:**\n\n- SSE 연결은 특정 서버에 바인딩 → 서버 재시작 시\
  \ 끊김\n- 하루 5-10회 API 배포 → 매번 MCP 재연결 필요\n\n**해결책:**\n\n```\n분리 후 구조:\n┌─────────────────────────────────┐\n\
  │          loop-api               │  ← 자주 배포 OK\n│  - Dashboard API (/api/*)   \
  \    │\n│  - Write API                    │\n└─────────────────────────────────┘\n\
  \n┌─────────────────────────────────┐\n│          loop-mcp               │  ← 거의\
  \ 배포 안함 (연결 유지)\n│  - MCP Read API (/mcp)          │\n│  - SSE 스트리밍            \
  \     │\n└─────────────────────────────────┘\n```\n\n**File Structure:**\n\n```\n\
  code/\n├── mcp/                          # 신규 생성\n│   ├── __init__.py\n│   └── main.py\
  \                   # MCP 전용 FastAPI 앱\n├── infra/\n│   ├── Dockerfile.mcp     \
  \       # 신규 생성\n│   └── nginx.conf                # 수정: /mcp 라우팅\n└── docker-compose.yml\
  \            # 수정: loop-mcp 서비스 추가\n```\n\n**Implementation Details:**\n\n1. `code/mcp/main.py`:\
  \ MCP 전용 FastAPI 앱\n\n   - `api.routers.mcp_composite` 라우터 재사용\n   - `api.cache`,\
  \ `api.oauth.jwks` import\n   - AuthMiddleware (SSE 호환) 적용\n   - FastApiMCP 마운트\n\
  \n2. `code/infra/Dockerfile.mcp`: 경량 이미지\n\n   - python:3.11-slim 기반\n   - 최소 의존성만\
  \ 설치\n   - timeout-keep-alive: 300초\n\n3. `code/docker-compose.yml`: loop-mcp 서비스\n\
  \n   - 포트: 8085:8085\n   - 볼륨: /vault (읽기전용), /exec_vault (읽기전용), oauth-data (읽기전용)\n\
  \n4. `code/infra/nginx.conf`: /mcp 라우팅\n\n   - upstream mcp 추가 (keepalive 64)\n\
  \   - location /mcp → loop-mcp로 프록시\n\n**Edge Cases:**\n\n- MCP Write API 호출 시:\
  \ loop-api에서 처리 (기존대로)\n- 캐시 동기화: loop-mcp는 읽기전용\n- OAuth 키: oauth-data 볼륨 공유로 JWT\
  \ 검증 가능\n\n### Todo\n\n- [ ] `code/mcp/__init__.py` 생성\n\n- [ ] `code/mcp/main.py`\
  \ 작성\n\n- [ ] `code/infra/Dockerfile.mcp` 작성\n\n- [ ] `code/docker-compose.yml`에\
  \ loop-mcp 서비스 추가\n\n- [ ] `code/infra/nginx.conf` 수정 (/mcp 라우팅)\n\n- [ ] 로컬 빌드\
  \ 테스트\n\n- [ ] NAS 배포 후 MCP 연결 유지 확인\n\n## 참고\n\n- Plan 파일: `~/.claude/plans/graceful-scribbling-truffle.md`"
---
# Infra - MCP 전용 컨테이너 분리 (loop-mcp)

## 설명

ChatGPT MCP 연결이 API 배포 시마다 끊기는 문제 해결.
MCP 엔드포인트를 별도 컨테이너(loop-mcp)로 분리하여 API 배포와 독립적으로 운영.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Target: loop-code (code/infra, code/mcp)

**문제:**
- SSE 연결은 특정 서버에 바인딩 → 서버 재시작 시 끊김
- 하루 5-10회 API 배포 → 매번 MCP 재연결 필요

**해결책:**
```
분리 후 구조:
┌─────────────────────────────────┐
│          loop-api               │  ← 자주 배포 OK
│  - Dashboard API (/api/*)       │
│  - Write API                    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│          loop-mcp               │  ← 거의 배포 안함 (연결 유지)
│  - MCP Read API (/mcp)          │
│  - SSE 스트리밍                 │
└─────────────────────────────────┘
```

**File Structure:**
```
code/
├── mcp/                          # 신규 생성
│   ├── __init__.py
│   └── main.py                   # MCP 전용 FastAPI 앱
├── infra/
│   ├── Dockerfile.mcp            # 신규 생성
│   └── nginx.conf                # 수정: /mcp 라우팅
└── docker-compose.yml            # 수정: loop-mcp 서비스 추가
```

**Implementation Details:**
1. `code/mcp/main.py`: MCP 전용 FastAPI 앱
   - `api.routers.mcp_composite` 라우터 재사용
   - `api.cache`, `api.oauth.jwks` import
   - AuthMiddleware (SSE 호환) 적용
   - FastApiMCP 마운트

2. `code/infra/Dockerfile.mcp`: 경량 이미지
   - python:3.11-slim 기반
   - 최소 의존성만 설치
   - timeout-keep-alive: 300초

3. `code/docker-compose.yml`: loop-mcp 서비스
   - 포트: 8085:8085
   - 볼륨: /vault (읽기전용), /exec_vault (읽기전용), oauth-data (읽기전용)

4. `code/infra/nginx.conf`: /mcp 라우팅
   - upstream mcp 추가 (keepalive 64)
   - location /mcp → loop-mcp로 프록시

**Edge Cases:**
- MCP Write API 호출 시: loop-api에서 처리 (기존대로)
- 캐시 동기화: loop-mcp는 읽기전용
- OAuth 키: oauth-data 볼륨 공유로 JWT 검증 가능

### Todo
- [ ] `code/mcp/__init__.py` 생성
- [ ] `code/mcp/main.py` 작성
- [ ] `code/infra/Dockerfile.mcp` 작성
- [ ] `code/docker-compose.yml`에 loop-mcp 서비스 추가
- [ ] `code/infra/nginx.conf` 수정 (/mcp 라우팅)
- [ ] 로컬 빌드 테스트
- [ ] NAS 배포 후 MCP 연결 유지 확인

## 참고

- Plan 파일: `~/.claude/plans/graceful-scribbling-truffle.md`

### 작업 로그

#### 2026-01-16 01:40
**개요**: MCP 전용 컨테이너 분리 완료

**변경사항**:
- 신규 생성: `mcp/` 패키지 (MCP 전용 FastAPI 앱)
  - `mcp/__init__.py`: 패키지 초기화
  - `mcp/main.py`: SSE 호환 ASGI 미들웨어, 읽기전용 MCP 엔드포인트
- 신규 생성: `infra/Dockerfile.mcp` (경량 이미지, python:3.11-slim)
- 수정: `docker-compose.yml` - loop-mcp 서비스 추가
  - 포트 노출 제거 (nginx 통해서만 접근)
  - read-only vault 볼륨 마운트
  - loop-auth 의존성 추가
- 수정: `infra/nginx.conf` - /mcp 라우팅 추가
  - upstream mcp (keepalive 64)
  - SSE 최적화 설정 (proxy_buffering off, HTTP/1.1)

**파일 변경**:
- `mcp/__init__.py` (신규): 패키지 정의
- `mcp/main.py` (신규, 199줄): MCP 전용 서버
  - 환경변수 기반 API 토큰 (하드코딩 제거)
  - CORS 제한 (특정 origin만 허용)
  - 그레이스풀 헬스체크 (vault 미마운트 시에도 정상)
- `infra/Dockerfile.mcp` (신규, 29줄): 최소 의존성 이미지
- `docker-compose.yml` (수정, +42줄): loop-mcp 서비스
- `infra/nginx.conf` (수정, +27줄): /mcp 라우팅

**Codex 리뷰**: ✅ 2차 검토 통과
- 1차: 보안/의존성 이슈 5개 발견
- 개선: API 토큰 env화, CORS 제한, 포트 노출 제거, 그레이스풀 헬스체크
- 2차: 모든 보안 이슈 해결 확인

**결과**: ✅ 구현 완료, main 머지 완료

**커밋**: `58a545805` on branch `task/tsk-023-1768494544353`

**다음 단계**: NAS 배포 필요 (/deploy-api)
