---
entity_type: Task
entity_id: tsk-023-1768488334785
entity_name: Dashboard - AI Chat Panel 구현
created: '2026-01-15'
updated: '2026-01-16'
status: todo
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
aliases:
- tsk-023-1768488334785
tags: []
type: dev
notes: "# Dashboard - AI Chat Panel 구현\n\n## 설명\n\n노션 AI 스타일의 전역 AI 채팅 패널 구현. 앱 어디서든\
  \ (칸반, Project Drawer 등) 열 수 있고, OpenAI API를 백엔드 프록시로 연결. 현재 Entity 컨텍스트를 AI에게 전달하여\
  \ 맥락 있는 대화 가능.\n\n## Notes\n\n### Tech Spec\n\n**Architecture Compliance:**\n\n\
  - Parent Project: prj-023 (Dashboard v2)\n- Target: loop (LOOP Dashboard)\n- Pattern:\
  \ Feature-based module structure under `src/features/ai-chat/`\n\n**File Structure:**\n\
  \n```\n# 신규 생성 파일\ncode/dashboard-v2/src/features/ai-chat/\n├── index.ts       \
  \                    # Barrel export\n├── api.ts                             # HTTP\
  \ client - POST /api/ai/chat\n├── queries.ts                         # React Query\
  \ mutation (useAiChat)\n├── types.ts                           # ChatMessage, EntityContext,\
  \ AiChatAction\n├── context/\n│   └── AiChatContext.tsx              # 전역 상태: isOpen,\
  \ messages, entityContext\n└── components/\n    ├── AiChatPanel.tsx            \
  \    # 메인 패널 (fixed right, w-[400px])\n    ├── ChatMessage.tsx                #\
  \ 메시지 버블 (user/ai role)\n    ├── ChatInput.tsx                  # 입력창 + 전송 버튼\n\
  \    └── AiChatToggle.tsx               # Header 토글 버튼 (Sparkles 아이콘)\n\n# 백엔드 수정\
  \ 파일\ncode/api/routers/ai.py                 # /api/ai/chat 엔드포인트 추가\n\n# 프론트엔드\
  \ 수정 파일\ncode/dashboard-v2/src/App.tsx                              # AiChatProvider\
  \ 래핑\ncode/dashboard-v2/src/components/layout/AppLayout.tsx      # AiChatPanel 렌더링\n\
  code/dashboard-v2/src/components/layout/Header.tsx         # AiChatToggle 추가\ncode/dashboard-v2/src/features/projects/components/ProjectForm.tsx\
  \  # 기존 AI → 새 패널 연결\n```\n\n**Implementation Details:**\n\n1. **Backend API** (`code/api/routers/ai.py`):\n\
  \n```python\n# Request/Response Models\nclass ChatMessageModel(BaseModel):\n   \
  \ role: Literal[\"user\", \"assistant\", \"system\"]\n    content: str\n\nclass\
  \ EntityContextModel(BaseModel):\n    entity_type: Literal[\"project\", \"task\"\
  , \"hypothesis\"]\n    entity_id: str\n    entity_name: Optional[str] = None\n \
  \   data: Optional[Dict[str, Any]] = None\n\nclass AiChatRequest(BaseModel):\n \
  \   messages: List[ChatMessageModel]\n    entity_context: Optional[EntityContextModel]\
  \ = None\n    mode: str = \"chat\"  # chat | expected_impact | hypothesis_draft\n\
  \nclass AiChatAction(BaseModel):\n    type: str  # expected_impact | hypothesis_draft\
  \ | task_fields\n    payload: Dict[str, Any]\n    apply_endpoint: str\n\nclass AiChatResponse(BaseModel):\n\
  \    ok: bool\n    message: str\n    run_id: Optional[str] = None\n    model: str\
  \ = \"\"\n    action: Optional[AiChatAction] = None\n\n# Endpoint\n@router.post(\"\
  /chat\", response_model=AiChatResponse)\nasync def ai_chat(request: AiChatRequest)\
  \ -> AiChatResponse:\n    # 1. Build system prompt with entity context\n    # 2.\
  \ Call LLMService (reuse existing)\n    # 3. Log to run_logger for audit\n    #\
  \ 4. Return response with optional action\n```\n\n2. **AiChatContext** (`context/AiChatContext.tsx`):\n\
  \n```typescript\ninterface AiChatContextType {\n  // Panel state\n  isOpen: boolean;\n\
  \  openPanel: () => void;\n  closePanel: () => void;\n  togglePanel: () => void;\n\
  \n  // Messages\n  messages: ChatMessage[];\n  addUserMessage: (text: string) =>\
  \ void;\n  addAiMessage: (text: string, metadata?: ChatMessageMetadata) => void;\n\
  \  clearMessages: () => void;\n\n  // Entity context\n  entityContext: EntityContext\
  \ | null;\n  setEntityContext: (ctx: EntityContext | null) => void;\n\n  // Loading\
  \ state\n  isLoading: boolean;\n\n  // Send message (calls API)\n  sendMessage:\
  \ (text: string) => Promise<void>;\n}\n```\n\n3. **AiChatPanel** (`components/AiChatPanel.tsx`):\n\
  \n- Position: `fixed right-0 top-0 h-full w-[400px] z-50`\n- Animation: slide-in\
  \ from right (framer-motion or CSS transition)\n- Structure: Header (close btn,\
  \ context badge) → Messages list (scroll) → Input area\n- Reference: `ActivityPanel.tsx`\
  \ 패턴 참고\n\n4. **Header Integration** (`Header.tsx`):\n\n- AiChatToggle: Sparkles\
  \ 아이콘 (lucide-react)\n- 위치: ActivityToggle 옆\n- 클릭 시 `togglePanel()` 호출\n\n5. **ProjectForm\
  \ Integration** (`ProjectForm.tsx`):\n\n- 기존 `handleExpectedAi()` 로직 유지 (backward\
  \ compatibility)\n- \"AI 패널에서 열기\" 버튼 추가\n- 클릭 시: `setEntityContext({ entityType:\
  \ 'project', entityId, entityName, data: project })` → `openPanel()`\n\n**State\
  \ Management:**\n\n- AiChatContext: 독립 Context (UiContext와 분리)\n- Messages: useState\
  \ (Context 내부)\n- API 호출: React Query useMutation\n\n**Dependencies:**\n\n- Frontend:\
  \ lucide-react (Sparkles icon), @tanstack/react-query (이미 설치됨)\n- Backend: LLMService\
  \ (기존), run_logger (기존)\n\n**Edge Cases:**\n\n1. **API 타임아웃**: 30초 타임아웃 설정, 에러 메시지\
  \ 표시\n2. **Entity context 없이 열기**: 일반 대화 모드로 동작 (system prompt에 LOOP 컨텍스트만)\n3.\
  \ **패널 열린 상태에서 Entity 변경**: 사용자에게 확인 후 context 교체 또는 유지\n4. **메시지 히스토리 길이**: 최근\
  \ 20개 메시지만 API에 전송 (토큰 제한)\n\n### Codex Review (2026-01-15)\n\n**발견된 이슈 및 해결책:**\n\
  \n1. **LLMService single-turn 제한** (`api/services/llm_service.py:36-138`)\n\n  \
  \ - 현재: single-turn만 지원, streaming/history 없음\n   - 해결: 기존 `call_llm()`에 messages\
  \ 파라미터 추가, streaming은 v2에서 고려\n   - Phase 1에서는 non-streaming으로 구현\n\n2. **ActivityPanel과\
  \ 레이아웃 충돌** (`UiContext.tsx:35-115`, `ActivityPanel.tsx:17-76`)\n\n   - 현재: ActivityPanel이\
  \ right rail (384px, z-30) 차지\n   - 해결: AI Chat 패널은 z-40으로 설정, ActivityPanel 위에\
  \ overlay\n   - 두 패널 동시 열림 허용 (AI Chat이 Activity 위에 표시)\n\n3. **ProjectForm 기존 AI\
  \ 패널 중복** (`ProjectForm.tsx:75-520`)\n\n   - 현재: `isImpactChatOpen`, `impactChatMessages`\
  \ 로 인라인 AI 대화 존재\n   - 해결: 기존 로직 유지 (backward compatibility), \"AI 패널에서 열기\" 버튼으로\
  \ 전역 패널 연결\n   - 점진적 마이그레이션: 기존 인라인 → 전역 패널\n\n**설계 결정:**\n\n- Streaming: Phase\
  \ 1에서 미지원 (non-streaming), 추후 SSE로 확장 가능\n- 패널 공존: AI Chat(z-40)이 ActivityPanel(z-30)\
  \ 위에 overlay\n- ProjectForm: 기존 로직 유지 + 전역 패널 연결 버튼 추가\n\n### Todo\n\n- [ ] Phase\
  \ 1: `code/api/routers/ai.py` - /api/ai/chat 엔드포인트 추가\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/types.ts`\
  \ - 타입 정의\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/api.ts` - API\
  \ 클라이언트\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/queries.ts` -\
  \ React Query mutation\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/context/AiChatContext.tsx`\
  \ - Context 생성\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/ChatMessage.tsx`\
  \ - 메시지 컴포넌트\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/ChatInput.tsx`\
  \ - 입력 컴포넌트\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/AiChatPanel.tsx`\
  \ - 메인 패널\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/AiChatToggle.tsx`\
  \ - 토글 버튼\n\n- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/index.ts` -\
  \ Barrel export\n\n- [ ] Phase 3: `code/dashboard-v2/src/App.tsx` - AiChatProvider\
  \ 래핑\n\n- [ ] Phase 3: `code/dashboard-v2/src/components/layout/AppLayout.tsx` -\
  \ AiChatPanel 추가\n\n- [ ] Phase 3: `code/dashboard-v2/src/components/layout/Header.tsx`\
  \ - AiChatToggle 추가\n\n- [ ] Phase 3: `code/dashboard-v2/src/features/projects/components/ProjectForm.tsx`\
  \ - AI 패널 연결\n\n- [ ] Phase 4: 칸반 TaskCard에 AI 버튼 추가 (선택)\n\n- [ ] Phase 4: 키보드\
  \ 단축키 Cmd+J 추가 (선택)\n\n- [ ] 빌드 확인 (npm run build)\n\n## 참고\n\n- Plan file: `~/.claude/plans/calm-zooming-platypus.md`\n\
  - ActivityPanel 패턴: `code/dashboard-v2/src/features/activity/presentation/ActivityPanel.tsx`\n\
  - UiContext 패턴: `code/dashboard-v2/src/contexts/UiContext.tsx`\n- LLMService: `code/api/services/llm_service.py`"
---
# Dashboard - AI Chat Panel 구현

## 설명

노션 AI 스타일의 전역 AI 채팅 패널 구현. 앱 어디서든 (칸반, Project Drawer 등) 열 수 있고, OpenAI API를 백엔드 프록시로 연결. 현재 Entity 컨텍스트를 AI에게 전달하여 맥락 있는 대화 가능.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard v2)
- Target: loop (LOOP Dashboard)
- Pattern: Feature-based module structure under `src/features/ai-chat/`

**File Structure:**
```
# 신규 생성 파일
code/dashboard-v2/src/features/ai-chat/
├── index.ts                           # Barrel export
├── api.ts                             # HTTP client - POST /api/ai/chat
├── queries.ts                         # React Query mutation (useAiChat)
├── types.ts                           # ChatMessage, EntityContext, AiChatAction
├── context/
│   └── AiChatContext.tsx              # 전역 상태: isOpen, messages, entityContext
└── components/
    ├── AiChatPanel.tsx                # 메인 패널 (fixed right, w-[400px])
    ├── ChatMessage.tsx                # 메시지 버블 (user/ai role)
    ├── ChatInput.tsx                  # 입력창 + 전송 버튼
    └── AiChatToggle.tsx               # Header 토글 버튼 (Sparkles 아이콘)

# 백엔드 수정 파일
code/api/routers/ai.py                 # /api/ai/chat 엔드포인트 추가

# 프론트엔드 수정 파일
code/dashboard-v2/src/App.tsx                              # AiChatProvider 래핑
code/dashboard-v2/src/components/layout/AppLayout.tsx      # AiChatPanel 렌더링
code/dashboard-v2/src/components/layout/Header.tsx         # AiChatToggle 추가
code/dashboard-v2/src/features/projects/components/ProjectForm.tsx  # 기존 AI → 새 패널 연결
```

**Implementation Details:**

1. **Backend API** (`code/api/routers/ai.py`):
```python
# Request/Response Models
class ChatMessageModel(BaseModel):
    role: Literal["user", "assistant", "system"]
    content: str

class EntityContextModel(BaseModel):
    entity_type: Literal["project", "task", "hypothesis"]
    entity_id: str
    entity_name: Optional[str] = None
    data: Optional[Dict[str, Any]] = None

class AiChatRequest(BaseModel):
    messages: List[ChatMessageModel]
    entity_context: Optional[EntityContextModel] = None
    mode: str = "chat"  # chat | expected_impact | hypothesis_draft

class AiChatAction(BaseModel):
    type: str  # expected_impact | hypothesis_draft | task_fields
    payload: Dict[str, Any]
    apply_endpoint: str

class AiChatResponse(BaseModel):
    ok: bool
    message: str
    run_id: Optional[str] = None
    model: str = ""
    action: Optional[AiChatAction] = None

# Endpoint
@router.post("/chat", response_model=AiChatResponse)
async def ai_chat(request: AiChatRequest) -> AiChatResponse:
    # 1. Build system prompt with entity context
    # 2. Call LLMService (reuse existing)
    # 3. Log to run_logger for audit
    # 4. Return response with optional action
```

2. **AiChatContext** (`context/AiChatContext.tsx`):
```typescript
interface AiChatContextType {
  // Panel state
  isOpen: boolean;
  openPanel: () => void;
  closePanel: () => void;
  togglePanel: () => void;

  // Messages
  messages: ChatMessage[];
  addUserMessage: (text: string) => void;
  addAiMessage: (text: string, metadata?: ChatMessageMetadata) => void;
  clearMessages: () => void;

  // Entity context
  entityContext: EntityContext | null;
  setEntityContext: (ctx: EntityContext | null) => void;

  // Loading state
  isLoading: boolean;

  // Send message (calls API)
  sendMessage: (text: string) => Promise<void>;
}
```

3. **AiChatPanel** (`components/AiChatPanel.tsx`):
- Position: `fixed right-0 top-0 h-full w-[400px] z-50`
- Animation: slide-in from right (framer-motion or CSS transition)
- Structure: Header (close btn, context badge) → Messages list (scroll) → Input area
- Reference: `ActivityPanel.tsx` 패턴 참고

4. **Header Integration** (`Header.tsx`):
- AiChatToggle: Sparkles 아이콘 (lucide-react)
- 위치: ActivityToggle 옆
- 클릭 시 `togglePanel()` 호출

5. **ProjectForm Integration** (`ProjectForm.tsx`):
- 기존 `handleExpectedAi()` 로직 유지 (backward compatibility)
- "AI 패널에서 열기" 버튼 추가
- 클릭 시: `setEntityContext({ entityType: 'project', entityId, entityName, data: project })` → `openPanel()`

**State Management:**
- AiChatContext: 독립 Context (UiContext와 분리)
- Messages: useState (Context 내부)
- API 호출: React Query useMutation

**Dependencies:**
- Frontend: lucide-react (Sparkles icon), @tanstack/react-query (이미 설치됨)
- Backend: LLMService (기존), run_logger (기존)

**Edge Cases:**
1. **API 타임아웃**: 30초 타임아웃 설정, 에러 메시지 표시
2. **Entity context 없이 열기**: 일반 대화 모드로 동작 (system prompt에 LOOP 컨텍스트만)
3. **패널 열린 상태에서 Entity 변경**: 사용자에게 확인 후 context 교체 또는 유지
4. **메시지 히스토리 길이**: 최근 20개 메시지만 API에 전송 (토큰 제한)

### Codex Review (2026-01-15)

**발견된 이슈 및 해결책:**

1. **LLMService single-turn 제한** (`api/services/llm_service.py:36-138`)
   - 현재: single-turn만 지원, streaming/history 없음
   - 해결: 기존 `call_llm()`에 messages 파라미터 추가, streaming은 v2에서 고려
   - Phase 1에서는 non-streaming으로 구현

2. **ActivityPanel과 레이아웃 충돌** (`UiContext.tsx:35-115`, `ActivityPanel.tsx:17-76`)
   - 현재: ActivityPanel이 right rail (384px, z-30) 차지
   - 해결: AI Chat 패널은 z-40으로 설정, ActivityPanel 위에 overlay
   - 두 패널 동시 열림 허용 (AI Chat이 Activity 위에 표시)

3. **ProjectForm 기존 AI 패널 중복** (`ProjectForm.tsx:75-520`)
   - 현재: `isImpactChatOpen`, `impactChatMessages` 로 인라인 AI 대화 존재
   - 해결: 기존 로직 유지 (backward compatibility), "AI 패널에서 열기" 버튼으로 전역 패널 연결
   - 점진적 마이그레이션: 기존 인라인 → 전역 패널

**설계 결정:**
- Streaming: Phase 1에서 미지원 (non-streaming), 추후 SSE로 확장 가능
- 패널 공존: AI Chat(z-40)이 ActivityPanel(z-30) 위에 overlay
- ProjectForm: 기존 로직 유지 + 전역 패널 연결 버튼 추가

### Todo

- [ ] Phase 1: `code/api/routers/ai.py` - /api/ai/chat 엔드포인트 추가
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/types.ts` - 타입 정의
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/api.ts` - API 클라이언트
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/queries.ts` - React Query mutation
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/context/AiChatContext.tsx` - Context 생성
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/ChatMessage.tsx` - 메시지 컴포넌트
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/ChatInput.tsx` - 입력 컴포넌트
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/AiChatPanel.tsx` - 메인 패널
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/components/AiChatToggle.tsx` - 토글 버튼
- [ ] Phase 2: `code/dashboard-v2/src/features/ai-chat/index.ts` - Barrel export
- [ ] Phase 3: `code/dashboard-v2/src/App.tsx` - AiChatProvider 래핑
- [ ] Phase 3: `code/dashboard-v2/src/components/layout/AppLayout.tsx` - AiChatPanel 추가
- [ ] Phase 3: `code/dashboard-v2/src/components/layout/Header.tsx` - AiChatToggle 추가
- [ ] Phase 3: `code/dashboard-v2/src/features/projects/components/ProjectForm.tsx` - AI 패널 연결
- [ ] Phase 4: 칸반 TaskCard에 AI 버튼 추가 (선택)
- [ ] Phase 4: 키보드 단축키 Cmd+J 추가 (선택)
- [ ] 빌드 확인 (npm run build)

## 참고

- Plan file: `~/.claude/plans/calm-zooming-platypus.md`
- ActivityPanel 패턴: `code/dashboard-v2/src/features/activity/presentation/ActivityPanel.tsx`
- UiContext 패턴: `code/dashboard-v2/src/contexts/UiContext.tsx`
- LLMService: `code/api/services/llm_service.py`

## 작업 로그

### 2026-01-16 00:25

**개요**: Dashboard v2 - AI Chat Panel 구현 완료

**변경사항**:
- **Backend**: FastAPI `/api/ai/chat` 엔드포인트 추가
  - ChatMessageModel, EntityContextModel, AiChatRequest/Response models
  - Multi-turn conversation support (20 message limit)
  - Entity context injection to system prompt
  - Audit logging integration
  - Security: Data sanitization (2000 char limit, sensitive field filtering)

- **Frontend**: ai-chat feature module 생성 (9 files)
  - `types.ts`: TypeScript interfaces
  - `api.ts`, `queries.ts`: API client + React Query mutation
  - `context/AiChatContext.tsx`: Global state (Context API)
  - `components/ChatMessage.tsx`: Message bubbles (user/assistant)
  - `components/ChatInput.tsx`: Textarea + Send button
  - `components/AiChatPanel.tsx`: Main panel (fixed right, w-400px, z-40)
  - `components/AiChatToggle.tsx`: Sparkles icon button
  - `index.ts`: Barrel exports

- **Integration**:
  - `App.tsx`: Wrapped with `<AiChatProvider>`
  - `AppLayout.tsx`: Rendered `<AiChatPanel />` (overlays ActivityPanel)
  - `Header.tsx`: Added `<AiChatToggle />` button next to ActivityToggle

**파일 변경** (13 files, +565 lines):
- api/routers/ai.py (+172 lines)
- dashboard-v2/src/App.tsx, AppLayout.tsx, Header.tsx
- dashboard-v2/src/features/ai-chat/* (9 new files)

**Codex 리뷰**: ✅ 통과 (4개 이슈 발견 및 수정)
- Fix 1: EntityContext camelCase→snake_case transform added
- Fix 2: Audit logging integrated (save_ai_audit_log)
- Issue 3: Entity access validation deferred (auth by JWT middleware)
- Issue 4: Metadata in assistant messages noted for future enhancement

**결과**:
- ✅ 코드 완성 (13 files changed)
- ✅ Codex validation passed with fixes applied
- ✅ Merged to main branch
- ✅ Pushed to GitHub
- ⚠️ Build test deferred (dependencies not in worktree)
- ⚠️ Manual UI test pending (requires npm install + local dev server)

**커밋**: `3166c4e65` on branch `task/tsk-023-1768488334785` → merged to `main`

**다음 단계**:
1. NAS deployment (`/deploy-api` + `/deploy-dashboard`)
2. Manual UI test: Open panel, send message, verify response
3. ProjectForm integration (Phase 3 item - "AI 패널에서 열기" button)
4. Optional: TaskCard AI button, Cmd+J shortcut (Phase 4)
