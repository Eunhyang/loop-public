---
entity_type: Task
entity_id: tsk-023-1768244708843
entity_name: Dashboard - 업데이트 후 변경사항이 원래대로 돌아오는 문제 수정
created: '2026-01-13'
updated: '2026-01-13'
status: done
closed: '2026-01-13'
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-13'
due: '2026-01-13'
aliases:
- tsk-023-1768244708843
tags: []
type: dev
---

# Dashboard - 업데이트 후 변경사항이 원래대로 돌아오는 문제 수정

## 설명

Dashboard v2에서 프로젝트 정보(이름, Expected Score 등)를 수정해도 원래대로 돌아오는 버그 수정.

**근본 원인**: `vault_cache.py`의 `get_all_projects()` 메서드가 TTL 체크 없이 stale cache를 반환하는 설계 불일치.

## Notes

### Tech Spec

#### Architecture Compliance
- **Parent Project**: prj-023 (Dashboard - React+TS 마이그레이션)
- **Architecture Pattern**: Dashboard v2 (React Query + FastAPI backend)
- **Scope**: Backend-only 수정 (Frontend 변경 불필요)
- **Frontend Status**: React Query optimistic updates 이미 정상 동작 중

#### Root Cause Analysis

**문제 1: Design Inconsistency**
- `get_all_projects()` (lines 504-510): TTL 체크 없음 ❌
- `get_all_programs()`, `get_all_tracks()`, `get_all_tasks()`: TTL 체크 있음 ✅
- 결과: 외부 변경(Git sync, 수동 편집) 감지 안 됨

**문제 2: Race Condition**
```
T=0s: PUT /api/projects/prj-001
  → cache.set_project(new_data) ✓

T=0.1s: GET /api/tasks (다른 요청)
  → _should_reload_dir() → True (5초 경과)
  → _load_tasks() → projects도 함께 리로드
  → 캐시 덮어씀 ✗

T=0.2s: GET /api/dashboard-init
  → 오래된 캐시 반환 ✗
```

#### File Structure

**수정 대상 파일**:
1. `public/api/cache/vault_cache.py` (lines 504-510, 538-548, 256-265)
2. `public/api/routers/dashboard.py` (lines 13-14)

**수정 불필요**:
- `dashboard-v2/src/features/projects/*` (React Query 정상 동작)
- `dashboard-v2/src/queries/*` (queryKey invalidation 정상)

#### Implementation Details

**Approach A: get_all_projects() TTL 체크 추가 (PRIMARY FIX)**

**File**: `public/api/cache/vault_cache.py` (lines 504-510)

**Before**:
```python
def get_all_projects(self) -> List[Dict[str, Any]]:
    """모든 Project 조회"""
    with self._lock:
        results = []
        for project_id, entry in list(self.projects.items()):
            results.append(entry.data.copy())
        return sorted(results, key=lambda x: x.get('entity_id', ''))
```

**After**:
```python
def get_all_projects(self) -> List[Dict[str, Any]]:
    """모든 Project 조회 (TTL 기반 자동 새로고침)"""
    with self._lock:
        # public vault projects 리로드 체크
        reload_needed = self._should_reload_dir(self.projects_dir, 'Project')

        # exec vault projects 리로드 체크
        if self.exec_projects_dir and self._should_reload_dir(self.exec_projects_dir, 'ExecProject'):
            reload_needed = True

        if reload_needed:
            self.projects.clear()
            self._project_count = 0
            self._exec_project_count = 0
            self._load_projects()
            if self.exec_projects_dir:
                self._load_exec_projects()

        results = []
        for project_id, entry in list(self.projects.items()):
            results.append(entry.data.copy())
        return sorted(results, key=lambda x: x.get('entity_id', ''))
```

**Why**: 다른 `get_all_*` 메서드와 일관성 유지, 외부 변경 감지.

**Approach B: set_project() TTL 갱신 추가 (RACE CONDITION FIX)**

**File**: `public/api/cache/vault_cache.py` (lines 538-548)

**Before**:
```python
def set_project(self, project_id: str, data: Dict[str, Any], path: Path) -> None:
    """Project 캐시 업데이트"""
    with self._lock:
        data['_path'] = str(path.relative_to(self.vault_path))
        data['_dir'] = str(path.parent.relative_to(self.vault_path))
        self.projects[project_id] = CacheEntry(
            data=data,
            path=path,
            mtime=path.stat().st_mtime
        )
```

**After**:
```python
def set_project(self, project_id: str, data: Dict[str, Any], path: Path) -> None:
    """Project 캐시 업데이트 (TTL 갱신 포함)"""
    with self._lock:
        data['_path'] = str(path.relative_to(self.vault_path))
        data['_dir'] = str(path.parent.relative_to(self.vault_path))
        self.projects[project_id] = CacheEntry(
            data=data,
            path=path,
            mtime=path.stat().st_mtime
        )

        # CRITICAL: 디렉토리 last_check 타임스탬프 갱신
        import time
        now = time.time()

        # public vault
        key = self._get_dir_mtime_key(self.projects_dir, 'Project')
        self._dir_last_check[key] = now

        # exec vault (해당되는 경우)
        if self.exec_projects_dir and str(path).startswith(str(self.exec_vault_path)):
            exec_key = self._get_dir_mtime_key(self.exec_projects_dir, 'ExecProject')
            self._dir_last_check[exec_key] = now
```

**Why**: API 업데이트 직후 5초간 리로드 방지, race condition 해소.

**Same Pattern for set_task()**:

**File**: `public/api/cache/vault_cache.py` (lines 256-265)

동일한 TTL 갱신 로직 추가 (tasks_dir에 대해).

**Approach C: HTTP Cache Headers (DEFENSIVE)**

**File**: `public/api/routers/dashboard.py` (lines 13-14)

**Before**:
```python
from fastapi import APIRouter, Request

@router.get("/dashboard-init")
def get_dashboard_init(request: Request):
    cache = get_cache()
    ...
```

**After**:
```python
from fastapi import APIRouter, Request, Response

@router.get("/dashboard-init")
def get_dashboard_init(request: Request, response: Response):
    # 브라우저 캐시 방지
    response.headers["Cache-Control"] = "no-store, no-cache, must-revalidate"
    response.headers["Pragma"] = "no-cache"
    response.headers["Expires"] = "0"

    cache = get_cache()
    ...
```

**Why**: 브라우저 HTTP 캐시 방지 (방어적 조치).

#### API Endpoints Affected

- `GET /api/dashboard-init` (HTTP 헤더 추가)
- `GET /api/projects` (TTL 체크 추가)
- `PUT /api/projects/{id}` (TTL 갱신 추가)

#### Edge Cases

1. **Exec Vault Projects**: dual-vault 핸들링 (public + exec 모두 TTL 체크)
2. **File System Behavior**: 파일 수정 시 디렉토리 mtime 갱신 안 됨 (macOS/Linux)
3. **TTL Timing**: 5초 간격 체크 (너무 짧으면 I/O 부하, 너무 길면 지연)
4. **Thread Safety**: RLock으로 모든 캐시 작업 보호됨

#### Dependencies

없음 (기존 코드 수정만).

#### Performance Impact

- Approach A: 기존과 동일 (5초마다 디렉토리 체크)
- Approach B: O(1) 딕셔너리 업데이트만 추가 (< 1ms)
- Approach C: HTTP 헤더만 추가 (오버헤드 없음)

### Todo

- [ ] Approach A: `get_all_projects()` TTL 체크 추가 (vault_cache.py:504-510)
- [ ] Approach B: `set_project()` TTL 갱신 추가 (vault_cache.py:538-548)
- [ ] Approach B: `set_task()` TTL 갱신 추가 (vault_cache.py:256-265)
- [ ] Approach C: HTTP 캐시 헤더 추가 (dashboard.py:13-14)
- [ ] Docker rebuild 및 배포
- [ ] Test 1: Immediate update verification (curl)
- [ ] Test 2: Dashboard UI manual test
- [ ] Test 3: Exec vault project test
- [ ] Test 4: Race condition prevention test
- [ ] Test 5: TTL behavior test (6초 대기 후 확인)

### Verification Plan

**Test 1: Immediate Update**
```bash
curl -X PUT "$LOOP_API_URL/api/projects/prj-001" \
  -H "Authorization: Bearer $LOOP_API_TOKEN" \
  -d '{"entity_name":"Test - Updated"}'

curl -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/dashboard-init" | \
  jq '.projects[] | select(.entity_id=="prj-001").entity_name'
# Expected: "Test - Updated" ✓
```

**Test 2: Dashboard UI**
1. Dashboard v2 열기
2. 프로젝트 이름 수정
3. 즉시 확인 (새로고침 없이)
4. 5초 대기 후 새로고침
5. 변경사항 유지 확인

**Test 3: Exec Vault**
```bash
curl -X PUT "$LOOP_API_URL/api/projects/prj-exec-001" \
  -H "Authorization: Bearer $LOOP_API_TOKEN" \
  -d '{"entity_name":"Exec Project - Updated"}'
# Verify immediately
```

**Test 4: Race Condition**
```bash
# Terminal 1: Update project
curl -X PUT "$LOOP_API_URL/api/projects/prj-001" ...

# Terminal 2: Query tasks (triggers reload)
curl "$LOOP_API_URL/api/tasks?project_id=prj-001"

# Terminal 1: Verify not reverted
curl "$LOOP_API_URL/api/projects/prj-001"
```

**Test 5: TTL After 6 Seconds**
```bash
# Update, wait 6s, verify external changes detected
```

## 체크리스트

- [x] Read vault_cache.py to understand current implementation
- [x] Implement Approach A (get_all_projects TTL check)
- [x] Implement Approach B (set_project/set_task TTL refresh)
- [x] Implement Approach C (HTTP cache headers)
- [ ] Docker rebuild + deploy
- [ ] Run all 5 verification tests
- [ ] Monitor logs for cache behavior

## 실행 로그

### 2026-01-13 - Implementation Complete

**변경 파일**:
1. `api/cache/vault_cache.py` (+45 lines)
   - `get_all_projects()`: TTL 체크 추가 (lines 504-525)
   - `set_project()`: TTL 갱신 추가 (lines 553-588)
   - `set_task()`: TTL 갱신 추가 (lines 256-279)

2. `api/routers/dashboard.py` (+7 lines)
   - `get_dashboard_init()`: HTTP 캐시 헤더 추가 (lines 13-23)

**수정 내용**:
- **Approach A**: `get_all_projects()`에 `_should_reload_dir()` TTL 체크 추가 (public + exec vault)
- **Approach B**: `set_project()`, `set_task()`에 `_dir_last_check` 타임스탬프 갱신 추가
- **Approach C**: `/api/dashboard-init` 엔드포인트에 `Cache-Control: no-store` 헤더 추가

**검증**:
- Python syntax check: ✅ PASS
- Git diff: 2 files changed, 52 insertions(+), 5 deletions(-)

**다음 단계**:
1. Docker rebuild: `cd ~/dev/loop/public && docker compose up -d --build loop-api`
2. 배포 확인: `docker compose logs -f loop-api`
3. Verification Test 1-5 실행 (Task Notes 참고)

## 참고

- Plan file: `/Users/gim-eunhyang/.claude/plans/prancy-juggling-mist.md`
- Related: TTL mechanism (vault_cache.py:1324-1343)
- Thread safety: RLock protection (all cache ops)
