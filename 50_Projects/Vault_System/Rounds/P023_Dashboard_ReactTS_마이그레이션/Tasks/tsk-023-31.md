---
entity_type: Task
entity_id: "tsk-023-31"
entity_name: "EntityDrawer - 뒤로가기 네비게이션 스택 구현"
created: 2026-01-09
updated: 2026-01-09
status: todo

# === 계층 ===
parent_id: "prj-023"
project_id: "prj-023"
aliases: ["tsk-023-31"]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: "김은향"
start_date: 2026-01-09
due: 2026-01-09
priority: medium
estimated_hours: null
actual_hours: null

# === Task 유형 (dev Task 연동용) ===
type: dev
target_project: loop

# === 분류 ===
tags: ["dashboard", "ux", "navigation"]
priority_flag: medium
---

# EntityDrawer - 뒤로가기 네비게이션 스택 구현

> Task ID: `tsk-023-31` | Project: `prj-023` | Status: todo

## 목표

**완료 조건**:
1. EntityDrawer 내부에서 entity 클릭 시 스택에 push
2. 뒤로가기 버튼 클릭 시 이전 entity로 복귀
3. 히스토리가 있을 때만 뒤로가기 버튼 표시

---

## 상세 내용

### 배경

현재 EntityDrawer에서 관련 entity(Project, Track 등)를 클릭하면 기존 drawer가 교체되며 이전 컨텍스트가 사라집니다. 사용자가 Task → Project → Track으로 이동 후 다시 Task로 돌아오려면 drawer를 닫고 다시 열어야 하는 불편함이 있습니다.

### 작업 내용

1. **UiContext 수정**: `drawerStack` 상태 추가
2. **Navigation 함수**: `pushDrawer`, `popDrawer`, `canGoBack` 구현
3. **DrawerShell 수정**: 뒤로가기 버튼 추가
4. **기존 코드 연동**: `openEntityDrawer` → `pushDrawer` 전환

---

## 체크리스트

- [ ] UiContext에 drawerStack 상태 추가
- [ ] pushDrawer, popDrawer 함수 구현
- [ ] canGoBack 계산 로직 추가
- [ ] DrawerShell에 뒤로가기 버튼 UI 추가
- [ ] TaskForm 등에서 entity 클릭 시 pushDrawer 사용
- [ ] 테스트: Task → Project → Track → 뒤로가기 × 2 → Task

---

## Notes

### Tech Spec

#### 아키텍처 도식

```
┌─────────────────────────────────────────────────────────────────┐
│              EntityDrawer Navigation Stack Architecture          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ UiContext (State Layer)                                   │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │  drawerStack: ActiveEntityDrawer[]                        │   │
│  │       │                                                   │   │
│  │       ├── pushDrawer(drawer) ──→ [...stack, drawer]       │   │
│  │       ├── popDrawer() ──→ stack.slice(0, -1)              │   │
│  │       └── canGoBack ──→ stack.length > 1                  │   │
│  │                                                           │   │
│  │  activeEntityDrawer ──→ stack.at(-1) ?? null              │   │
│  └──────────────────────────────────────────────────────────┘   │
│       │                                                          │
│       ↓                                                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ DrawerShell (UI Layer) - Header                           │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │ [← Back]  Title            [Expand] [Close]         │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │       │                                                   │   │
│  │       └── onBack prop ──→ popDrawer()                     │   │
│  │       └── showBackButton ──→ canGoBack                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│       │                                                          │
│       ↓                                                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Form Components (TaskForm, ProjectForm, etc.)             │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │  Entity links onClick ──→ pushDrawer({ type, mode, id })  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

User Flow:
┌────────┐      ┌─────────┐      ┌───────┐
│  Task  │ ───► │ Project │ ───► │ Track │
│ Drawer │ push │ Drawer  │ push │Drawer │
└────────┘      └─────────┘      └───────┘
                                     │
     ◄──────────────────────────────┘
           pop (← Back button)
```

#### 프로젝트 컨텍스트

- **Framework**: React 19 + TypeScript
- **State Management**: React Context (UiContext)
- **Styling**: Tailwind CSS 4
- **Key Patterns**: `useUi()` hook, `DrawerShell` 공통 레이아웃

#### 파일 구조

```
dashboard-v2/src/
├── contexts/
│   └── UiContext.tsx          # 수정: drawerStack, pushDrawer, popDrawer 추가
├── components/
│   ├── common/
│   │   └── DrawerShell.tsx    # 수정: onBack, showBackButton props 추가
│   └── layout/
│       └── EntityDrawer.tsx   # 수정: canGoBack, popDrawer 연결
└── features/
    └── tasks/components/
        └── TaskForm.tsx       # 수정: openEntityDrawer → pushDrawer
```

#### 상세 구현

**1. UiContext 수정** (`src/contexts/UiContext.tsx`)

```typescript
// 상태 변경: 단일값 → 스택
const [drawerStack, setDrawerStack] = useState<ActiveEntityDrawer[]>([]);

// activeEntityDrawer는 스택의 마지막 요소로 계산
const activeEntityDrawer = drawerStack.at(-1) ?? null;

// canGoBack 계산
const canGoBack = drawerStack.length > 1;

// pushDrawer: 스택에 새 drawer 추가
const pushDrawer = useCallback((drawer: NonNullable<ActiveEntityDrawer>) => {
  setDrawerStack(prev => [...prev, drawer]);
  setActiveModal(null);
  setIsCommandPaletteOpen(false);
}, []);

// popDrawer: 스택에서 마지막 drawer 제거
const popDrawer = useCallback(() => {
  setDrawerStack(prev => prev.length > 1 ? prev.slice(0, -1) : []);
}, []);

// closeEntityDrawer: 스택 전체 초기화 (X 버튼)
const closeEntityDrawer = useCallback(() => {
  setDrawerStack([]);
  setIsDrawerExpanded(false);
}, []);

// openEntityDrawer: 하위호환성 유지 (내부에서 pushDrawer 호출)
const openEntityDrawer = useCallback((drawer: NonNullable<ActiveEntityDrawer>) => {
  // 새 스택 시작 (기존 동작 유지)
  setDrawerStack([drawer]);
  setActiveModal(null);
  setIsCommandPaletteOpen(false);
}, []);
```

**2. DrawerShell 수정** (`src/components/common/DrawerShell.tsx`)

```typescript
interface DrawerShellProps {
  // ... existing
  onBack?: () => void;
  showBackButton?: boolean;
}

// Header에 Back 버튼 추가 (title 왼쪽)
{showBackButton && onBack && (
  <button
    onClick={onBack}
    className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-2"
    aria-label="Go back"
  >
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
    </svg>
  </button>
)}
```

**3. EntityDrawer 수정** (`src/components/layout/EntityDrawer.tsx`)

```typescript
const { activeEntityDrawer, closeEntityDrawer, canGoBack, popDrawer, ... } = useUi();

<DrawerShell
  // ... existing
  onBack={popDrawer}
  showBackButton={canGoBack}
>
```

**4. TaskForm 수정** (`src/features/tasks/components/TaskForm.tsx`)

```typescript
const { pushDrawer, closeEntityDrawer } = useUi();

// entity 링크 클릭 시 pushDrawer 사용
onClick={() => pushDrawer({ type: 'project', mode: 'edit', id: formData.project_id! })}
onClick={() => pushDrawer({ type: 'track', mode: 'view', id: trackId! })}
```

### Todo
- [ ] UiContext 인터페이스에 canGoBack, pushDrawer, popDrawer 추가
- [ ] UiContext 상태를 drawerStack 배열로 변경
- [ ] activeEntityDrawer를 스택에서 계산하도록 변경
- [ ] DrawerShell에 onBack, showBackButton props 추가
- [ ] DrawerShell 헤더에 ← 버튼 UI 추가
- [ ] EntityDrawer에서 canGoBack, popDrawer 연결
- [ ] TaskForm에서 entity 클릭 시 pushDrawer 사용
- [ ] ProjectForm 등 다른 Form 컴포넌트도 수정
- [ ] 빌드 및 동작 테스트

### Codex Review Summary

**Critical Issues Found**: 0 (모두 고려사항)
**Suggestions**: 6개

**Codex 피드백:**

1. **Non-Task entry points**: TaskForm 외에 다른 곳(검색 결과, 리스트 등)에서도 pushDrawer 사용 필요
   - → 1차 구현에서는 Form 컴포넌트 내부 링크만 대상. 추후 확장.

2. **Stack edge cases**: popDrawer가 빈 스택에서 호출될 때 동작 정의 필요
   - → `prev.length > 1 ? prev.slice(0, -1) : []` 로 안전하게 처리

3. **Unsaved state handling**: 수정 중인 폼에서 뒤로가기 시 확인 없이 데이터 손실 가능
   - → 현재 autosave 패턴 사용 중이므로 큰 문제 없음. 추후 개선.

4. **Browser back/history**: 브라우저 뒤로가기와 drawer 스택 동기화 안 됨
   - → 의도된 동작. drawer 내부 네비게이션만 지원. 추후 URL 기반으로 확장 가능.

5. **Memory/perf**: 스택에 쌓인 drawer 컴포넌트 메모리 유지 가능성
   - → React 특성상 activeEntityDrawer만 렌더링되므로 문제 없음.

6. **UX gaps**: 애니메이션, 포커스 복원 등 미정의
   - → 기존 DrawerShell 애니메이션 유지. 포커스는 추후 개선.

### 작업 로그
<!--
작업 완료 시 아래 형식으로 기록 (workthrough 스킬 자동 생성)

#### YYYY-MM-DD HH:MM
**개요**: 2-3문장 요약

**변경사항**:
- 개발:
- 수정:
- 개선:

**핵심 코드**: (필요시)

**결과**: ✅ 빌드 성공 / ❌ 실패

**다음 단계**:
-->


---

## 참고 문서

- [[prj-023]] - 소속 Project
- `dashboard-v2/src/contexts/UiContext.tsx` - 현재 drawer 상태 관리
- `dashboard-v2/src/components/layout/EntityDrawer.tsx` - Drawer 컴포넌트
- `dashboard-v2/src/components/common/DrawerShell.tsx` - Drawer 공통 레이아웃

---

**Created**: 2026-01-09
**Assignee**: 김은향
**Due**: 2026-01-09
