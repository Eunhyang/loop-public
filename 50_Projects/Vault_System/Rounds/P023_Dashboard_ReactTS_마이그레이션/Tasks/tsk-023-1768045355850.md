---
entity_type: Task
entity_id: tsk-023-1768045355850
entity_name: Dashboard - 댓글 작성자 표시 버그 수정
created: '2026-01-10'
updated: '2026-01-10'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: high
start_date: '2026-01-10'
due: '2026-01-10'
aliases:
- tsk-023-1768045355850
tags:
- comments
- oauth
- bugfix
type: dev
target_project: loop
---

# Dashboard - 댓글 작성자 표시 버그 수정

## 설명

댓글 작성자가 이름 대신 숫자 ID("2", "3")로 표시되는 버그 수정.

## 구현 내용

### 수정 파일

1. **shared/auth/middleware.py** (Line 180)
   - JWT에서 `email` 필드 추출 추가
   - `return` dict에 `"email": jwt_payload.get("email")` 추가

2. **api/routers/comments.py** (Line 246-265)
   - `author_email` 추출 로직 변경
   - OAuth 토큰: `user.get('email')` 사용 (우선)
   - 비-OAuth 토큰: `user.get('user_id')` 사용 (fallback)
   - 정규화: `str().strip().lower()` 적용

### 주요 개선 사항

- Email 검증: truthy, string, non-blank 체크
- Fallback 경로: API 토큰/서비스 계정 지원
- 정규화: 대소문자, 공백 처리로 일관성 확보
- 역호환성: 기존 인증 플로우 유지

## 체크리스트

- [x] `shared/auth/middleware.py` 수정 (email 추출 추가)
- [x] `api/routers/comments.py` 수정 (email 사용, fallback, 정규화)
- [x] Codex 코드 리뷰 통과 (2회 iteration)
- [x] 역호환성 확보 (API 토큰 지원)

## 참고

- 관련 Task: tsk-023-39 (댓글 시스템 구현)
- 코드 리뷰: codex-claude-loop 스킬 사용
- 데이터 마이그레이션: 기존 댓글은 다음 배포 시 수동 수정 가능
