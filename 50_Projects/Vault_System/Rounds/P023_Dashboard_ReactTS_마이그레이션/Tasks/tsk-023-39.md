---
entity_type: Task
entity_id: "tsk-023-39"
entity_name: "Dashboard - 댓글 시스템 + @멘션 구현"
created: 2026-01-09
updated: 2026-01-09
status: todo

# === 계층 ===
parent_id: "prj-023"
project_id: "prj-023"
aliases: ["tsk-023-39"]

# === 관계 ===
outgoing_relations: []
validates: []
validated_by: []

# === Task 전용 ===
assignee: "김은향"
start_date: null
due: null
priority: high
estimated_hours: null
actual_hours: null

# === Task 유형 (dev Task 연동용) ===
type: dev
target_project: loop

# === 분류 ===
tags: [comments, mentions, oauth, tiptap]
priority_flag: high
---

# Dashboard - 댓글 시스템 + @멘션 구현

> Task ID: `tsk-023-39` | Project: `prj-023` | Status: todo

## 목표

**완료 조건**:
1. OAuth 사용자 계정 생성 (김은향, 한명학) + Members 연결
2. Comments 백엔드 API 구현 (CRUD)
3. @멘션 기능 구현 (Tiptap 확장)
4. 댓글 UI 컴포넌트 구현
5. Task Drawer에 댓글 섹션 통합

---

## Tech Spec

### 1. OAuth 계정 + Members 연결

**1.1 members.yaml에 email 필드 추가**
```yaml
# exec/40_People/members.yaml
- id: "김은향"
  email: "eunhyang@kkokkkok.app"  # 추가
  ...
- id: "한명학"
  email: "myeonghak@kkokkkok.app"  # 추가
  ...
```

**1.2 OAuth 계정 생성 (CLI)**
```bash
cd ~/dev/loop/public
python -m api.oauth.cli create-user --email eunhyang@kkokkkok.app --password admin123 --role admin
python -m api.oauth.cli create-user --email myeonghak@kkokkkok.app --password admin123 --role admin
```

**1.3 VaultCache에 email→member 조회 추가**
- 파일: `public/api/cache/vault_cache.py`
- 메서드: `get_member_by_email(email: str) -> Optional[Dict]`

---

### 2. Comments 백엔드

**2.1 SQLite 테이블**
```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_type VARCHAR(32) NOT NULL,  -- 'task' | 'project'
    entity_id VARCHAR(64) NOT NULL,    -- 'tsk-023-01' | 'prj-023'
    author_email VARCHAR(256) NOT NULL,
    content TEXT NOT NULL,             -- 마크다운 (멘션 포함)
    mentions JSON,                     -- ["tsk-023-02", "prj-023"]
    parent_id INTEGER,                 -- 답글용 (NULL = 최상위)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES comments(id)
);

CREATE INDEX idx_comments_entity ON comments(entity_type, entity_id);
```

**2.2 API 엔드포인트**
| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/comments?entity_type=task&entity_id=tsk-023-01` | 댓글 목록 |
| POST | `/api/comments` | 댓글 생성 |
| PUT | `/api/comments/{id}` | 댓글 수정 |
| DELETE | `/api/comments/{id}` | 댓글 삭제 |

**2.3 응답 형식**
```json
{
  "id": 1,
  "entity_type": "task",
  "entity_id": "tsk-023-01",
  "author": {
    "email": "eunhyang@kkokkkok.app",
    "member_id": "김은향",
    "name": "김은향",
    "icon": "👩‍💻"
  },
  "content": "이 태스크는 [@tsk-023-02](/tasks/tsk-023-02) 완료 후 진행",
  "mentions": ["tsk-023-02"],
  "replies": [...],
  "created_at": "2026-01-09T10:00:00Z"
}
```

---

### 3. @멘션 프론트엔드 (Tiptap 확장)

**3.1 MentionExtension 생성**
- 파일: `dashboard-v2/src/components/MarkdownEditor/MentionExtension.tsx`
- SlashMenu.tsx 패턴 복사 후 수정:
  - `char: '/'` → `char: '@'`
  - 데이터 소스: `useDashboardInit()`의 tasks, projects, members

**3.2 MentionMenu 컴포넌트**
- 파일: `dashboard-v2/src/components/MarkdownEditor/MentionMenu.tsx`
- 기능:
  - 엔티티 검색/필터링
  - 키보드 네비게이션 (↑↓ Enter Esc)
  - 타입별 아이콘 (Task, Project, Member)

**3.3 멘션 렌더링**
- 저장 형식: `[@tsk-023-01](tsk-023-01)`
- 렌더링: 클릭 가능한 링크 (배경색 구분)

**3.4 클릭 시 네비게이션**
```typescript
const handleMentionClick = (entityId: string) => {
  if (entityId.startsWith('tsk-')) {
    openEditTask(entityId);
  } else if (entityId.startsWith('prj-')) {
    navigate(`/projects/${entityId}`);
  }
};
```

---

### 4. 댓글 UI 컴포넌트

**4.1 CommentSection 컴포넌트**
- 파일: `dashboard-v2/src/features/comments/CommentSection.tsx`
- Props: `entityType`, `entityId`

**4.2 CommentItem 컴포넌트**
- 파일: `dashboard-v2/src/features/comments/CommentItem.tsx`

**4.3 CommentEditor 컴포넌트**
- 파일: `dashboard-v2/src/features/comments/CommentEditor.tsx`
- Tiptap MarkdownEditor + MentionExtension

**4.4 React Query 훅**
- `useComments(entityType, entityId)`
- `useCreateComment()`
- `useUpdateComment()`
- `useDeleteComment()`

---

### 5. Task/Project 통합

**5.1 TaskDrawer에 댓글 섹션 추가**
- 파일: `dashboard-v2/src/features/tasks/components/TaskDrawer.tsx`

---

## 파일 목록

### 수정할 파일
| 파일 | 변경 내용 |
|------|----------|
| `exec/40_People/members.yaml` | email 필드 추가 |
| `public/api/cache/vault_cache.py` | `get_member_by_email()` 추가 |
| `public/api/main.py` | comments 라우터 등록 |
| `dashboard-v2/src/components/MarkdownEditor/index.tsx` | MentionExtension 추가 |
| `dashboard-v2/src/features/tasks/components/TaskDrawer.tsx` | CommentSection 추가 |

### 생성할 파일
| 파일 | 설명 |
|------|------|
| `public/api/routers/comments.py` | Comments API |
| `public/api/models/comments.py` | Comment 모델 + DB |
| `dashboard-v2/src/components/MarkdownEditor/MentionExtension.tsx` | @멘션 Tiptap 확장 |
| `dashboard-v2/src/components/MarkdownEditor/MentionMenu.tsx` | 멘션 팝업 메뉴 |
| `dashboard-v2/src/features/comments/CommentSection.tsx` | 댓글 섹션 |
| `dashboard-v2/src/features/comments/CommentItem.tsx` | 댓글 아이템 |
| `dashboard-v2/src/features/comments/CommentEditor.tsx` | 댓글 에디터 |
| `dashboard-v2/src/features/comments/queries.ts` | React Query 훅 |
| `dashboard-v2/src/features/comments/types.ts` | 타입 정의 |

---

## 계정 정보

| 이름 | 이메일 | 비밀번호 | Role |
|------|--------|----------|------|
| 김은향 | eunhyang@kkokkkok.app | admin123 | admin |
| 한명학 | myeonghak@kkokkkok.app | admin123 | admin |

---

## 검증 방법

### 1. OAuth 계정 테스트
```bash
python -m api.oauth.cli list-users
```

### 2. Comments API 테스트
```bash
# 댓글 생성
curl -X POST http://localhost:8081/api/comments \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"entity_type":"task","entity_id":"tsk-023-01","content":"테스트 댓글"}'

# 댓글 조회
curl "http://localhost:8081/api/comments?entity_type=task&entity_id=tsk-023-01" \
  -H "Authorization: Bearer $TOKEN"
```

### 3. 프론트엔드 테스트
1. Dashboard 로그인
2. Task Drawer 열기
3. 댓글 입력란에 `@` 입력 → 멘션 팝업 확인
4. 엔티티 선택 → 링크로 변환 확인
5. 댓글 저장 → 목록에 표시 확인
6. 멘션 클릭 → 해당 엔티티로 이동 확인

---

## 의존성

### 백엔드
- 기존 FastAPI, SQLAlchemy 사용 (추가 없음)

### 프론트엔드
- 이미 설치됨: `@tiptap/core`, `@tiptap/suggestion`, `tippy.js`

---

## Codex Review Suggestions

> Codex PRD 검토 결과 (2026-01-09)

### 보안 관련
- [ ] 댓글 수정/삭제 시 작성자 본인만 가능하도록 권한 체크
- [ ] XSS 방지를 위한 마크다운 sanitization (DOMPurify 등)
- [ ] content 최대 길이 제한 (예: 10,000자)

### 데이터 무결성
- [ ] parent_id가 같은 entity_type/entity_id 내에서만 참조하도록 검증
- [ ] 멘션된 엔티티 존재 여부 검증 (옵션)

### API 개선
- [ ] GET 엔드포인트에 pagination 추가 (`?page=1&limit=20`)
- [ ] created_at 기준 정렬 (최신순/오래된순)
- [ ] replies 포함 여부 옵션 (`?include_replies=true`)

### UI/UX
- [ ] 빈 상태, 로딩 상태, 에러 상태 처리
- [ ] 댓글 작성/수정/삭제 시 토스트 알림
- [ ] 멘션 검색 debounce (300ms)

### 성능
- [ ] `created_at` 인덱스 추가 (정렬 최적화)
- [ ] 댓글 목록 초기 로드 제한 (최근 50개)

**우선순위**: 보안 관련 항목은 필수, 나머지는 v1 이후 점진적 개선

---

## Notes

B Score (Realized Impact) 연동:
- 댓글 데이터는 향후 Evidence 생성 시 참고 자료로 활용 가능
- `mentions` 필드로 어떤 엔티티가 논의되었는지 추적 가능
