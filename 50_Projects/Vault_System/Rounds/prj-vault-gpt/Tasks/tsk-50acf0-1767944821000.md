---
entity_type: Task
entity_id: tsk-50acf0-1767944821000
entity_name: Entity ID Migration - Hash+Epoch 형식 통일
created: 2026-01-09
updated: 2026-01-09

# === Project/Task 관계 ===
project_id: prj-vault-gpt
parent_id: null

# === 실행 정보 ===
assignee: 김은향
status: doing
priority_flag: high
type: dev
target_project: loop

# === 일정 ===
start_date: 2026-01-09
due: 2026-01-09
closed: null

# === 계층 (Derived) ===
program_id: pgm-vault-system
track_id: trk-2
conditions_3y:
  - cond-b

# === Ontology-Lite ===
aliases:
  - tsk-50acf0-1767944821000
  - Entity ID Migration
outgoing_relations: []
validates: []
validated_by: []
tags:
  - task
  - dev
  - vault-system
  - migration
  - id-format
---

# Entity ID Migration - Hash+Epoch 형식 통일

> Task ID: `tsk-50acf0-1767944821000` | Project: [[prj-vault-gpt]] | Assignee: 김은향 | Status: doing

## 개요

레거시 순차 ID 형식(`prj-NNN`, `tsk-NNN-NN`)을 Hash+Epoch 형식(`prj-{hash6}-{epoch13}`, `tsk-{hash6}-{epoch13}`)으로 통일하는 마이그레이션 작업.

## 목표

- 모든 Project ID를 `prj-{hash6}-{epoch13}` 형식으로 변환
- 모든 Task ID를 `tsk-{hash6}-{epoch13}` 형식으로 변환
- 모든 참조(frontmatter, wikilinks, body text) 업데이트
- Exec vault 참조 동기화
- Dashboard 하드코딩 제거

## Notes

### Tech Spec

**프레임워크/라이브러리:**
- Python 3.11
- PyYAML (frontmatter 파싱)
- pathlib (파일 경로 처리)
- re (정규식 패턴 매칭)

**아키텍처 패턴:**
- SSOT 기반 ID 생성 (shared/utils/ssot_service.py 활용)
- Dry-run/Apply 모드 분리
- ID 매핑 테이블 기반 변환
- Git checkpoint/rollback 전략

**파일 구조:**
```
public/scripts/
├── migrate_to_hash_id.py          # 신규 마이그레이션 스크립트
├── (migrate_id_format.py 삭제)    # 레거시 스크립트 제거
└── shared/utils/ssot_service.py    # ID 생성 로직 (SSOT)

_build/
└── id_mapping.json                 # 변환 매핑 테이블 (dry-run/apply 공유)
```

**의존성:**
- `shared/utils/ssot_service.py` - generate_project_id(), generate_task_id()
- `shared/utils/vault_utils.py` - 파일 탐색, frontmatter 파싱
- Pre-existing: validate_schema.py, build_graph_index.py, build_impact.py

**Codex Review Feedback 반영:**
1. ID 매핑을 JSON 파일에 저장 (dry-run/apply 재사용)
2. Git checkpoint 추가 (rollback 전략)
3. Body text 패턴 확장 (markdown 링크, YAML 앵커)
4. 최종 grep 검증 (레거시 ID 잔존 확인)
5. Dashboard 전체 프로젝트 ID 하드코딩 검색

### Todo

#### Phase 1: 준비
- [ ] 기존 `migrate_id_format.py` 스크립트 삭제
- [ ] 새 `migrate_to_hash_id.py` 스크립트 생성

#### Phase 2: 마이그레이션 스크립트 구현
- [ ] ID 매핑 테이블 생성 (모든 레거시 ID → 새 ID)
- [ ] ID 매핑을 `_build/id_mapping.json`에 저장
- [ ] Project 변환 로직 (하위 Task들의 project_id 먼저 업데이트)
- [ ] Task 변환 로직 (파일명 + entity_id)
- [ ] 참조 업데이트 로직:
  - Frontmatter 단일 값 (entity_id, project_id, parent_id)
  - Frontmatter 배열 (validates, tasks, related_tasks)
  - Wikilinks (`[[prj-001]]` → `[[prj-{hash}-{epoch}]]`)
  - Inline code (`` `tsk-001-09` ``)
  - Markdown links (`[text](prj-001)`)
  - YAML anchors
- [ ] Exec vault 동기화 (TaskExecDetail, Candidate)
- [ ] Dry-run 모드 구현
- [ ] Apply 모드 구현
- [ ] Git checkpoint 생성 (rollback 전략)

#### Phase 3: Dashboard 하드코딩 제거
- [ ] Dashboard 전체 소스에서 하드코딩된 프로젝트 ID 검색
- [ ] `dashboard-v2/src/pages/Kanban/index.tsx:33-34` 삭제
- [ ] 기타 발견된 하드코딩 제거

#### Phase 4: 실행 및 검증
- [ ] Dry-run 테스트 실행
- [ ] 매핑 테이블 검토
- [ ] Apply 실행
- [ ] 최종 grep 검증 (레거시 ID 잔존 확인)
- [ ] `build_graph_index.py` 실행
- [ ] `build_impact.py` 실행
- [ ] `validate_schema.py` 실행
- [ ] `check_orphans.py` 실행
- [ ] API 캐시 갱신 (`/mcp-server rebuild`)

#### Phase 5: Rollback 계획
- [ ] Git checkpoint 생성 문서화
- [ ] Rollback 명령어 테스트

## 구현 계획

### Step 1: ID 매핑 생성

```python
class HashIdMigrator:
    def __init__(self, vault_path, exec_vault_path=None):
        self.vault_path = vault_path
        self.exec_vault_path = exec_vault_path
        self.id_mapping = {}  # old_id → new_id
        self.ssot_service = SSOTService(vault_path)
        self.mapping_file = vault_path / "_build/id_mapping.json"

    def _build_id_mapping(self):
        """모든 레거시 ID에 대해 새 ID 미리 생성"""
        # Project IDs
        for prj_file in self._find_legacy_projects():
            old_id = extract_entity_id(prj_file)
            entity_name = extract_entity_name(prj_file)
            new_id = self.ssot_service.generate_project_id(entity_name)
            self.id_mapping[old_id] = new_id

        # Task IDs
        for tsk_file in self._find_legacy_tasks():
            old_id = extract_entity_id(tsk_file)
            project_id = extract_project_id(tsk_file)
            new_id = self.ssot_service.generate_task_id(project_id)
            self.id_mapping[old_id] = new_id

        # Save mapping to JSON
        with open(self.mapping_file, 'w') as f:
            json.dump(self.id_mapping, f, indent=2, ensure_ascii=False)

    def _is_legacy_id(self, entity_id):
        """레거시 ID 패턴 감지"""
        # prj-NNN (숫자 3자리)
        if re.match(r'^prj-\d{3}$', entity_id):
            return True
        # tsk-NNN-NN (숫자-숫자)
        if re.match(r'^tsk-\d{3}-\d{2}$', entity_id):
            return True
        return False
```

### Step 2: 변환 순서 (중요!)

```
1. ID 매핑 테이블 생성 및 저장 (_build/id_mapping.json)
2. Project 변환
   2a. 하위 Task들의 project_id 필드 업데이트
   2b. Project 파일 자체 변경 (entity_id)
3. Task 변환 (파일명 + entity_id)
4. 기타 참조 업데이트
   - Hypothesis.validates 배열
   - Wikilinks
   - 인라인 참조
   - Markdown 링크
   - YAML 앵커
5. Exec vault 동기화
6. 최종 grep 검증 (레거시 ID 잔존 확인)
```

### Step 3: Git Checkpoint

```bash
# Before migration
git checkout -b backup-before-id-migration
git add -A && git commit -m "Checkpoint before ID migration"

# If rollback needed
git checkout main
git reset --hard backup-before-id-migration
```

### Step 4: 최종 검증

```bash
# Check for remaining legacy IDs
grep -r "prj-[0-9]\{3\}[^0-9]" public/50_Projects/ public/60_Hypotheses/
grep -r "tsk-[0-9]\{3\}-[0-9]\{2\}[^0-9]" public/50_Projects/

# Expected: No matches
```

## 실행 예시

```bash
# 1. Dry-run
python3 public/scripts/migrate_to_hash_id.py . --dry-run

# 2. Review mapping
cat _build/id_mapping.json

# 3. Git checkpoint
git checkout -b backup-before-id-migration
git add -A && git commit -m "Checkpoint before ID migration"

# 4. Apply
python3 public/scripts/migrate_to_hash_id.py . --apply

# 5. Validate
python3 scripts/validate_schema.py .
python3 scripts/check_orphans.py .

# 6. Build
python3 scripts/build_graph_index.py .
python3 scripts/build_impact.py .

# 7. API cache refresh
/mcp-server rebuild
```

## 참조

- Plan: `/Users/gim-eunhyang/.claude/plans/agile-waddling-puppy.md`
- SSOT Service: `public/shared/utils/ssot_service.py`
- Vault Utils: `public/shared/utils/vault_utils.py`
