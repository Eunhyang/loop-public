---
entity_type: Task
entity_id: tsk-0vault-1768106628300
entity_name: OAuth - SQLite busy_timeout 설정
created: '2026-01-11'
updated: '2026-01-11'
status: doing
project_id: prj-api-exec-vault
parent_id: prj-api-exec-vault
assignee: 김은향
priority: medium
start_date: '2026-01-11'
due: '2026-01-11'
aliases:
- tsk-0vault-1768106628300
tags: []
type: dev
---

# OAuth - SQLite busy_timeout 설정

## 설명

SQLite "read-only database" 에러의 근본 원인(busy_timeout 미설정)을 해결합니다.
NAS 파일시스템에서 순간적인 lock 발생 시 기본 5초 대기시간 초과로 에러 발생하므로, 30초로 설정하여 안정성 향상.

## 구현

### Step 1: SQLite busy_timeout 설정 추가

3개 파일의 SQLAlchemy create_engine 설정에 `timeout: 30` 추가:
- `api/oauth/models.py` (Line 27-31)
- `api/models/google_accounts.py` (Line 28-33)
- `api/models/comments.py` (Line 175-187)

```python
engine = create_engine(
    f"sqlite:///{DB_PATH}",
    connect_args={
        "check_same_thread": False,
        "timeout": 30,  # SQLite busy_timeout 30초
    },
    echo=False
)
```

### Step 2: Docker 재빌드 및 배포

```bash
# NAS SSH
cd /volume1/LOOP_CORE/vault/LOOP
git pull origin main
docker compose build loop-auth loop-api
docker compose up -d loop-auth loop-api
```

또는 `/mcp-server rebuild` 명령어 사용

## 검증

1. chatgpt.com에서 MCP 재연결 시도
2. 여러 번 연속 연결/해제 테스트
3. NAS git-sync 실행 중에도 연결 테스트

## 체크리스트

- [ ] api/oauth/models.py 수정
- [ ] api/models/google_accounts.py 수정
- [ ] api/models/comments.py 수정
- [ ] Git commit
- [ ] Docker 재빌드 및 배포
- [ ] ChatGPT MCP 재연결 테스트

## 참고

- SQLite `timeout` = PRAGMA busy_timeout (초 단위)
- NAS Btrfs 파일시스템 + 백업/동기화로 인한 일시적 lock 해결
- 30초면 대부분의 경우 충분

## Execution Log (2026-01-11)

### Plan Review (Codex Phase 2)
- Codex validated implementation plan with medium reasoning effort
- Identified all 3 SQLite engines in codebase (no missed instances)
- Raised valid architectural concerns:
  - busy_timeout addresses "database is locked" not "read-only database"
  - Suggested verifying exact error type and mount permissions
  - Recommended considering WAL mode for concurrent writes on NAS
- Plan approved with notes for follow-up verification

### Implementation
- Modified: 3 files
- Key changes:
  - `api/oauth/models.py`: Added timeout=30 to connect_args
  - `api/models/google_accounts.py`: Added timeout=30 to connect_args
  - `api/models/comments.py`: Added timeout=30 to connect_args
- All changes consistent with Korean comment "SQLite busy_timeout 30초"

### Code Review (Codex Phase 5)
- Syntax: All changes syntactically correct
- Consistency: timeout=30 applied uniformly across all 3 files (lines 27-34, 28-34, 175-181)
- Concerns raised:
  - 30s timeout may block callers under heavy contention (check API timeout budgets)
  - Won't fix true "read-only database" errors (filesystem/permissions issue)
  - Consider WAL mode to reduce lock contention on Btrfs/NAS
- No bugs introduced, code ready for deployment

### Result
- Status: Implementation complete, code validated
- Next: Docker rebuild and deployment (Step 2 in task description)
- Follow-up: Monitor if errors persist (may need WAL mode or permission fixes)
