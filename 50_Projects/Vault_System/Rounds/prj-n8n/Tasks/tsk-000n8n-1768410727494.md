---
entity_type: Task
entity_id: tsk-000n8n-1768410727494
entity_name: n8n - ac-batch-daily-digest Save Snapshot 502 에러 수정
created: '2026-01-15'
updated: '2026-01-15'
status: todo
project_id: prj-n8n
parent_id: prj-n8n
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
aliases:
- tsk-000n8n-1768410727494
tags: []
type: dev
---

# n8n - ac-batch-daily-digest Save Snapshot 502 에러 수정

## 설명

n8n 워크플로우 `ac-batch-daily-digest`의 "Save Snapshot" 노드에서 502 Bad Gateway 에러 발생. 근본 원인은 HTTP Request 노드가 `x-api-token` 헤더 없이 API 요청을 전송하여 인증 실패로 인한 403 에러가 502로 표시됨.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-n8n
- Architecture Pattern: n8n workflow automation with LOOP API integration
- File Location: `_build/n8n_workflows/` (n8n workflow JSON storage)
- API Authentication: `x-api-token` header with value `loop_2024_kanban_secret`

**Root Cause Analysis:**
1. HTTP Request node sends API call without `x-api-token` header
2. API assigns default scope `mcp:read` due to authentication failure
3. `/api/mcp/file-write` endpoint requires `mcp:write` scope → 403 rejection
4. Error handling converts 403 to 502 Bad Gateway in n8n UI

**File Structure:**
```
/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/
└── ac_batch_daily_digest.json (line 307-331: Save Snapshot node)
```

**Implementation Details:**

**Affected Nodes in `ac_batch_daily_digest.json`:**
1. **Load Config JSON** (line 25-46)
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Status: Also needs fix (same authentication issue)

2. **Load Previous Snapshot** (line 233-255)
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Status: Also needs fix (same authentication issue)

3. **Save Snapshot** (line 307-331) - PRIMARY TARGET
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Issue: No actual credential attached, causing 502 error
   - Target API: `POST https://mcp.sosilab.synology.me/api/mcp/file-write`
   - Required scope: `mcp:write`

**Solution: HTTP Header Direct Addition (Recommended)**

Change node configuration to explicitly send `x-api-token` header:

```json
{
  "parameters": {
    "method": "POST",
    "url": "https://mcp.sosilab.synology.me/api/mcp/file-write",
    "authentication": "none",
    "sendHeaders": true,
    "headerParameters": {
      "parameters": [
        {
          "name": "x-api-token",
          "value": "loop_2024_kanban_secret"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={{ { path: '50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json', content: JSON.stringify($json.snapshot, null, 2) } }}",
    "options": {
      "timeout": 30000
    }
  },
  "id": "save-snapshot",
  "name": "Save Snapshot",
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 4.2,
  "position": [2620, 520],
  "onError": "continueRegularOutput",
  "alwaysOutputData": true,
  "notes": "Write snapshot to vault file (authenticated with x-api-token)"
}
```

**Key Changes:**
1. Remove: `"authentication": "predefinedCredentialType"`, `"nodeCredentialType": "httpHeaderAuth"`
2. Add: `"authentication": "none"`
3. Add: `"sendHeaders": true"`
4. Add: `"headerParameters"` section with `x-api-token` header
5. Update: `notes` field to document authentication method

**Consistency Pattern:**
- Apply same fix to all 3 HTTP Request nodes in `ac_batch_daily_digest.json`
- Ensures uniform authentication across the workflow
- Prevents similar 502 errors in Load Config JSON and Load Previous Snapshot nodes

**Edge Cases:**
1. **Token Change**: If `LOOP_API_TOKEN` changes in `.env`, must update hardcoded value in workflow JSON
2. **Missing Token**: If token is removed or invalid, API returns 403 with error message (no longer 502)
3. **Network Timeout**: 30-second timeout already configured, no change needed
4. **API Server Down**: `onError: continueRegularOutput` ensures workflow continues even if API fails
5. **Invalid JSON Body**: API validates input and returns 400 error with details
6. **File Path Error**: If snapshot path is incorrect, API returns 404 or 500 with message

**Security Considerations:**
- Token `loop_2024_kanban_secret` is hardcoded in workflow JSON
- JSON file is stored on NAS server with access control
- Token is for internal API only, no public exposure risk
- Alternative: Use n8n credential system (genericCredentialType) for production

**Verification Steps:**
1. Modify `ac_batch_daily_digest.json` lines 307-331 (Save Snapshot node)
2. Optionally fix lines 25-46 (Load Config JSON) and 233-255 (Load Previous Snapshot)
3. Upload modified workflow to n8n
4. Execute workflow manually in n8n UI
5. Check Save Snapshot node output for success message
6. Verify snapshot file updated at `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`

**Expected Result:**
- Save Snapshot node returns: `{"success": true, "path": "...", "bytes_written": ..., "updated_at": "..."}`
- No 502 Bad Gateway error
- Snapshot file successfully written to vault

### Todo
- [ ] Backup current `ac_batch_daily_digest.json` to `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_YYYYMMDD.json`
- [ ] Edit `ac_batch_daily_digest.json` line 307-331: Replace Save Snapshot node parameters with header authentication
- [ ] Edit `ac_batch_daily_digest.json` line 25-46: Fix Load Config JSON node authentication (consistency)
- [ ] Edit `ac_batch_daily_digest.json` line 233-255: Fix Load Previous Snapshot node authentication (consistency)
- [ ] Test workflow locally with curl: `curl -X POST https://mcp.sosilab.synology.me/api/mcp/file-write -H "x-api-token: loop_2024_kanban_secret" -H "Content-Type: application/json" -d '{"path":"test.json","content":"{\"test\":true}"}'`
- [ ] Upload modified workflow to n8n (via UI or direct file replacement on NAS)
- [ ] Execute `ac-batch-daily-digest` workflow manually in n8n
- [ ] Verify Save Snapshot node output shows success response (no 502 error)
- [ ] Check snapshot file timestamp updated: `ls -lh public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`
- [ ] Update project.md to document authentication pattern for future workflows

## 체크리스트

- [ ] 502 에러 해결 확인
- [ ] 스냅샷 파일 정상 저장 확인
- [ ] 다른 HTTP 노드도 동일하게 수정 완료

## 참고

- Plan file: `/Users/gim-eunhyang/.claude/plans/validated-meandering-kahn.md`
- Workflow JSON: `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`
- API router: `/Users/gim-eunhyang/dev/loop/public/api/routers/mcp_composite.py` (line 198-204: x-api-token validation)
- Environment vars: `/Users/gim-eunhyang/dev/loop/public/.env` (line 43: LOOP_API_TOKEN)
- Project doc: `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/project.md`

---

## Execution Log

### 2026-01-15 - Implementation Complete

**Changes Made:**
1. Created backup: `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_20260115.json`
2. Fixed 3 HTTP Request nodes in `ac_batch_daily_digest.json`:
   - **Load Config JSON** (lines 25-46): Added x-api-token header authentication
   - **Load Previous Snapshot** (lines 233-255): Added x-api-token header authentication
   - **Save Snapshot** (lines 307-331): Added x-api-token header authentication (PRIMARY TARGET)

**Technical Details:**
- Replaced `authentication: predefinedCredentialType` with `authentication: none`
- Added `sendHeaders: true`
- Added `headerParameters` section with `x-api-token: loop_2024_kanban_secret`
- Updated notes field for all 3 nodes to document authentication method
- Verified JSON syntax validity with `python3 -m json.tool`

**Code Review Results (Codex):**
- **Authentication**: Properly implemented with x-api-token header
- **Consistency**: All 3 nodes use identical authentication structure
- **JSON Validity**: Confirmed syntactically valid with `jq`
- **Security Note**: Codex flagged hardcoded token (documented as acceptable for internal use)

**Files Modified:**
- `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`

**Next Steps:**
- Upload modified workflow to n8n (via UI or direct file replacement on NAS)
- Execute `ac-batch-daily-digest` workflow manually in n8n
- Verify Save Snapshot node output shows success response (no 502 error)
- Check snapshot file timestamp updated

**Status**: Implementation complete, ready for n8n deployment and testing
