---
entity_type: Task
entity_id: tsk-000n8n-1768410727494
entity_name: n8n - ac-batch-daily-digest Save Snapshot 502 에러 수정
created: '2026-01-15'
updated: '2026-01-15'
status: todo
project_id: prj-n8n
parent_id: prj-n8n
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
aliases:
- tsk-000n8n-1768410727494
tags: []
type: dev
notes: "# n8n - ac-batch-daily-digest Save Snapshot 502 에러 수정\n\n## 설명\n\nn8n 워크플로우\
  \ `ac-batch-daily-digest`의 \"Save Snapshot\" 노드에서 502 Bad Gateway 에러 발생. 근본 원인은\
  \ HTTP Request 노드가 `x-api-token` 헤더 없이 API 요청을 전송하여 인증 실패로 인한 403 에러가 502로 표시됨.\n\
  \n## Notes\n\n### Tech Spec\n\n**Architecture Compliance:**\n\n- Parent Project:\
  \ prj-n8n\n- Architecture Pattern: n8n workflow automation with LOOP API integration\n\
  - File Location: `_build/n8n_workflows/` (n8n workflow JSON storage)\n- API Authentication:\
  \ `x-api-token` header with value `loop_2024_kanban_secret`\n\n**Root Cause Analysis:**\n\
  \n1. HTTP Request node sends API call without `x-api-token` header\n2. API assigns\
  \ default scope `mcp:read` due to authentication failure\n3. `/api/mcp/file-write`\
  \ endpoint requires `mcp:write` scope → 403 rejection\n4. Error handling converts\
  \ 403 to 502 Bad Gateway in n8n UI\n\n**File Structure:**\n\n```\n/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/\n\
  └── ac_batch_daily_digest.json (line 307-331: Save Snapshot node)\n```\n\n**Implementation\
  \ Details:**\n\n**Affected Nodes in** `ac_batch_daily_digest.json`**:**\n\n1. **Load\
  \ Config JSON** (line 25-46)\n\n   - Current: `authentication: predefinedCredentialType`,\
  \ `nodeCredentialType: httpHeaderAuth`\n   - Status: Also needs fix (same authentication\
  \ issue)\n\n2. **Load Previous Snapshot** (line 233-255)\n\n   - Current: `authentication:\
  \ predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`\n   - Status:\
  \ Also needs fix (same authentication issue)\n\n3. **Save Snapshot** (line 307-331)\
  \ - PRIMARY TARGET\n\n   - Current: `authentication: predefinedCredentialType`,\
  \ `nodeCredentialType: httpHeaderAuth`\n   - Issue: No actual credential attached,\
  \ causing 502 error\n   - Target API: `POST https://mcp.sosilab.synology.me/api/mcp/file-write`\n\
  \   - Required scope: `mcp:write`\n\n**Solution: HTTP Header Direct Addition (Recommended)**\n\
  \nChange node configuration to explicitly send `x-api-token` header:\n\n```json\n\
  {\n  \"parameters\": {\n    \"method\": \"POST\",\n    \"url\": \"https://mcp.sosilab.synology.me/api/mcp/file-write\"\
  ,\n    \"authentication\": \"none\",\n    \"sendHeaders\": true,\n    \"headerParameters\"\
  : {\n      \"parameters\": [\n        {\n          \"name\": \"x-api-token\",\n\
  \          \"value\": \"loop_2024_kanban_secret\"\n        }\n      ]\n    },\n\
  \    \"sendBody\": true,\n    \"specifyBody\": \"json\",\n    \"jsonBody\": \"={{\
  \ { path: '50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json',\
  \ content: JSON.stringify($json.snapshot, null, 2) } }}\",\n    \"options\": {\n\
  \      \"timeout\": 30000\n    }\n  },\n  \"id\": \"save-snapshot\",\n  \"name\"\
  : \"Save Snapshot\",\n  \"type\": \"n8n-nodes-base.httpRequest\",\n  \"typeVersion\"\
  : 4.2,\n  \"position\": [2620, 520],\n  \"onError\": \"continueRegularOutput\",\n\
  \  \"alwaysOutputData\": true,\n  \"notes\": \"Write snapshot to vault file (authenticated\
  \ with x-api-token)\"\n}\n```\n\n**Key Changes:**\n\n1. Remove: `\"authentication\"\
  : \"predefinedCredentialType\"`, `\"nodeCredentialType\": \"httpHeaderAuth\"`\n\
  2. Add: `\"authentication\": \"none\"`\n3. Add: `\"sendHeaders\": true\"`\n4. Add:\
  \ `\"headerParameters\"` section with `x-api-token` header\n5. Update: `notes` field\
  \ to document authentication method\n\n**Consistency Pattern:**\n\n- Apply same\
  \ fix to all 3 HTTP Request nodes in `ac_batch_daily_digest.json`\n- Ensures uniform\
  \ authentication across the workflow\n- Prevents similar 502 errors in Load Config\
  \ JSON and Load Previous Snapshot nodes\n\n**Edge Cases:**\n\n1. **Token Change**:\
  \ If `LOOP_API_TOKEN` changes in `.env`, must update hardcoded value in workflow\
  \ JSON\n2. **Missing Token**: If token is removed or invalid, API returns 403 with\
  \ error message (no longer 502)\n3. **Network Timeout**: 30-second timeout already\
  \ configured, no change needed\n4. **API Server Down**: `onError: continueRegularOutput`\
  \ ensures workflow continues even if API fails\n5. **Invalid JSON Body**: API validates\
  \ input and returns 400 error with details\n6. **File Path Error**: If snapshot\
  \ path is incorrect, API returns 404 or 500 with message\n\n**Security Considerations:**\n\
  \n- Token `loop_2024_kanban_secret` is hardcoded in workflow JSON\n- JSON file is\
  \ stored on NAS server with access control\n- Token is for internal API only, no\
  \ public exposure risk\n- Alternative: Use n8n credential system (genericCredentialType)\
  \ for production\n\n**Verification Steps:**\n\n1. Modify `ac_batch_daily_digest.json`\
  \ lines 307-331 (Save Snapshot node)\n2. Optionally fix lines 25-46 (Load Config\
  \ JSON) and 233-255 (Load Previous Snapshot)\n3. Upload modified workflow to n8n\n\
  4. Execute workflow manually in n8n UI\n5. Check Save Snapshot node output for success\
  \ message\n6. Verify snapshot file updated at `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`\n\
  \n**Expected Result:**\n\n- Save Snapshot node returns: `{\"success\": true, \"\
  path\": \"...\", \"bytes_written\": ..., \"updated_at\": \"...\"}`\n- No 502 Bad\
  \ Gateway error\n- Snapshot file successfully written to vault\n\n### Todo\n\n-\
  \ [ ] Backup current `ac_batch_daily_digest.json` to `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_YYYYMMDD.json`\n\
  \n- [ ] Edit `ac_batch_daily_digest.json` line 307-331: Replace Save Snapshot node\
  \ parameters with header authentication\n\n- [ ] Edit `ac_batch_daily_digest.json`\
  \ line 25-46: Fix Load Config JSON node authentication (consistency)\n\n- [ ] Edit\
  \ `ac_batch_daily_digest.json` line 233-255: Fix Load Previous Snapshot node authentication\
  \ (consistency)\n\n- [ ] Test workflow locally with curl: `curl -X POST https://mcp.sosilab.synology.me/api/mcp/file-write\
  \ -H \"x-api-token: loop_2024_kanban_secret\" -H \"Content-Type: application/json\"\
  \ -d '{\"path\":\"test.json\",\"content\":\"{\\\"test\\\":true}\"}'`\n\n- [ ] Upload\
  \ modified workflow to n8n (via UI or direct file replacement on NAS)\n\n- [ ] Execute\
  \ `ac-batch-daily-digest` workflow manually in n8n\n\n- [ ] Verify Save Snapshot\
  \ node output shows success response (no 502 error)\n\n- [ ] Check snapshot file\
  \ timestamp updated: `ls -lh public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`\n\
  \n- [ ] Update project.md to document authentication pattern for future workflows\n\
  \n## 체크리스트\n\n- [ ] 502 에러 해결 확인\n\n- [ ] 스냅샷 파일 정상 저장 확인\n\n- [ ] 다른 HTTP 노드도 동일하게\
  \ 수정 완료\n\n## 참고\n\n- Plan file: `/Users/gim-eunhyang/.claude/plans/validated-meandering-kahn.md`\n\
  - Workflow JSON: `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`\n\
  - API router: `/Users/gim-eunhyang/dev/loop/public/api/routers/mcp_composite.py`\
  \ (line 198-204: x-api-token validation)\n- Environment vars: `/Users/gim-eunhyang/dev/loop/public/.env`\
  \ (line 43: LOOP_API_TOKEN)\n- Project doc: `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/project.md`\n\
  \n---\n\n## Execution Log\n\n### 2026-01-15 - Implementation Complete\n\n**Changes\
  \ Made:**\n\n1. Created backup: `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_20260115.json`\n\
  2. Fixed 3 HTTP Request nodes in `ac_batch_daily_digest.json`:\n   - **Load Config\
  \ JSON** (lines 25-46): Added x-api-token header authentication\n   - **Load Previous\
  \ Snapshot** (lines 233-255): Added x-api-token header authentication\n   - **Save\
  \ Snapshot** (lines 307-331): Added x-api-token header authentication (PRIMARY TARGET)\n\
  \n**Technical Details:**\n\n- Replaced `authentication: predefinedCredentialType`\
  \ with `authentication: none`\n- Added `sendHeaders: true`\n- Added `headerParameters`\
  \ section with `x-api-token: loop_2024_kanban_secret`\n- Updated notes field for\
  \ all 3 nodes to document authentication method\n- Verified JSON syntax validity\
  \ with `python3 -m json.tool`\n\n**Code Review Results (Codex):**\n\n- **Authentication**:\
  \ Properly implemented with x-api-token header\n- **Consistency**: All 3 nodes use\
  \ identical authentication structure\n- **JSON Validity**: Confirmed syntactically\
  \ valid with `jq`\n- **Security Note**: Codex flagged hardcoded token (documented\
  \ as acceptable for internal use)\n\n**Files Modified:**\n\n- `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`\n\
  \n**Next Steps:**\n\n- Upload modified workflow to n8n (via UI or direct file replacement\
  \ on NAS)\n- Execute `ac-batch-daily-digest` workflow manually in n8n\n- Verify\
  \ Save Snapshot node output shows success response (no 502 error)\n- Check snapshot\
  \ file timestamp updated\n\n**Status**: Implementation complete, ready for n8n deployment\
  \ and testing\n\n---\n\n### 2026-01-15 - Node Connection Fix (Discord Empty Digest\
  \ Issue)\n\n**Problem Discovered:**\n\n- Discord received empty digest: `New: 0\
  \ | Updated: 0 | Deadline Soon: 0 | Open/Rolling: 0`\n- Root cause: Workflow node\
  \ connection error caused data loss between nodes\n\n**Root Cause Analysis:**\n\n\
  - **Incorrect flow**: `Redact Sensitive` → `Load Previous Snapshot` → `Diff and\
  \ Classify`\n- `Load Previous Snapshot` output (empty snapshot) overwrote crawled\
  \ entries from `Redact Sensitive`\n- `Diff and Classify` received empty data instead\
  \ of crawled K-Startup programs\n\n**Fix Applied:**\n\n- Modified `ac_batch_daily_digest.json`\
  \ line 538\n- Changed connection: `\"Redact Sensitive\"` → `\"Diff and Classify\"\
  ` (direct connection)\n- Before: `\"node\": \"Load Previous Snapshot\"`\n- After:\
  \ `\"node\": \"Diff and Classify\"`\n\n**Technical Details:**\n\n- `Diff and Classify`\
  \ node already references `$('Load Previous Snapshot').first().json` internally\n\
  - No need for direct input connection from `Load Previous Snapshot`\n- Direct input\
  \ should be crawled entries from `Redact Sensitive`\n- JSON syntax validated with\
  \ `python3 -m json.tool`\n\n**Expected Result After Deployment:**\n\n- Discord digest\
  \ will show non-zero counts (15+ new programs from K-Startup)\n- First run: All\
  \ entries classified as \"new\" (previous snapshot is empty)\n- Subsequent runs:\
  \ Proper diff detection (new/updated/deadline soon)\n\n**Files Modified:**\n\n-\
  \ `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`\
  \ (line 538)\n\n**Next Steps:**\n\n- Upload modified workflow to n8n\n- Execute\
  \ workflow and verify Discord message shows program counts\n- Confirm snapshot file\
  \ gets populated after first run\n\n---\n\n### 2026-01-15 - Discord Message Splitting\
  \ Fix (2000 Character Limit)\n\n**Problem Discovered:**\n\n- Discord API returned\
  \ 400 error: \"Must be 2000 or fewer in length\"\n- Format Discord Message node\
  \ split by **section** (New, Updated, etc.)\n- Single section with 15 entries (\\\
  ~3000 chars) exceeded Discord's 2000 char limit\n\n**Root Cause:**\n\n- Original\
  \ logic: Split by section → If \"New\" section &gt; 2000 chars, entire section goes\
  \ to one message\n- 15 programs × \\~200 chars/entry = \\~3000 chars → Discord rejects\n\
  \n**Fix Applied:**\n\n- Rewrote Format Discord Message node to split by **entry**\
  \ (line-by-line)\n- Modified `ac_batch_daily_digest.json` lines 287-289\n- New logic:\n\
  \  1. Add entries one-by-one to current message\n  2. Check length after each entry\n\
  \  3. If exceeds 2000 chars, start new message\n  4. Add \"(continued)\" suffix\
  \ for split sections\n\n**Technical Details:**\n\n```javascript\n// Before (section-based\
  \ splitting)\nfor (const block of sections) {\n  const next = `${current}\\\\n\\\
  \\n${block}`;  // Add entire section\n  if (next.length > limit) { ... }\n}\n\n\
  // After (entry-based splitting)\nfor (const section of sections) {\n  for (const\
  \ entry of section.entries) {  // Loop each entry\n    const entryLine = formatEntry(entry);\n\
  \    const next = `${current}${sectionHeader}\\\\n${entryLine}`;\n    if (next.length\
  \ > limit) {\n      messages.push(current);\n      current = `${header}\\\\n${counts}\\\
  \\n\\\\n**${section.title} (continued)**\\\\n${entryLine}`;\n    }\n  }\n}\n```\n\
  \n**Expected Result:**\n\n- 15 entries split across 2-3 Discord messages\n- Message\
  \ 1: Header + counts + entries 1-8\n- Message 2: Header + counts + \"**New (continued)**\"\
  \ + entries 9-15\n- All messages stay under 2000 chars\n\n**Files Modified:**\n\n\
  - `/Users/gim-eunhyang/dev/loop-wip-1768413797/_build/n8n_workflows/ac_batch_daily_digest.json`\
  \ (line 288)\n\n**Next Steps:**\n\n- Upload modified workflow to n8n\n- Execute\
  \ workflow and verify multiple Discord messages sent successfully\n- Confirm all\
  \ 15 entries appear across messages"
---
# n8n - ac-batch-daily-digest Save Snapshot 502 에러 수정

## 설명

n8n 워크플로우 `ac-batch-daily-digest`의 "Save Snapshot" 노드에서 502 Bad Gateway 에러 발생. 근본 원인은 HTTP Request 노드가 `x-api-token` 헤더 없이 API 요청을 전송하여 인증 실패로 인한 403 에러가 502로 표시됨.

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-n8n
- Architecture Pattern: n8n workflow automation with LOOP API integration
- File Location: `_build/n8n_workflows/` (n8n workflow JSON storage)
- API Authentication: `x-api-token` header with value `loop_2024_kanban_secret`

**Root Cause Analysis:**
1. HTTP Request node sends API call without `x-api-token` header
2. API assigns default scope `mcp:read` due to authentication failure
3. `/api/mcp/file-write` endpoint requires `mcp:write` scope → 403 rejection
4. Error handling converts 403 to 502 Bad Gateway in n8n UI

**File Structure:**
```
/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/
└── ac_batch_daily_digest.json (line 307-331: Save Snapshot node)
```

**Implementation Details:**

**Affected Nodes in `ac_batch_daily_digest.json`:**
1. **Load Config JSON** (line 25-46)
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Status: Also needs fix (same authentication issue)

2. **Load Previous Snapshot** (line 233-255)
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Status: Also needs fix (same authentication issue)

3. **Save Snapshot** (line 307-331) - PRIMARY TARGET
   - Current: `authentication: predefinedCredentialType`, `nodeCredentialType: httpHeaderAuth`
   - Issue: No actual credential attached, causing 502 error
   - Target API: `POST https://mcp.sosilab.synology.me/api/mcp/file-write`
   - Required scope: `mcp:write`

**Solution: HTTP Header Direct Addition (Recommended)**

Change node configuration to explicitly send `x-api-token` header:

```json
{
  "parameters": {
    "method": "POST",
    "url": "https://mcp.sosilab.synology.me/api/mcp/file-write",
    "authentication": "none",
    "sendHeaders": true,
    "headerParameters": {
      "parameters": [
        {
          "name": "x-api-token",
          "value": "loop_2024_kanban_secret"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={{ { path: '50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json', content: JSON.stringify($json.snapshot, null, 2) } }}",
    "options": {
      "timeout": 30000
    }
  },
  "id": "save-snapshot",
  "name": "Save Snapshot",
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 4.2,
  "position": [2620, 520],
  "onError": "continueRegularOutput",
  "alwaysOutputData": true,
  "notes": "Write snapshot to vault file (authenticated with x-api-token)"
}
```

**Key Changes:**
1. Remove: `"authentication": "predefinedCredentialType"`, `"nodeCredentialType": "httpHeaderAuth"`
2. Add: `"authentication": "none"`
3. Add: `"sendHeaders": true"`
4. Add: `"headerParameters"` section with `x-api-token` header
5. Update: `notes` field to document authentication method

**Consistency Pattern:**
- Apply same fix to all 3 HTTP Request nodes in `ac_batch_daily_digest.json`
- Ensures uniform authentication across the workflow
- Prevents similar 502 errors in Load Config JSON and Load Previous Snapshot nodes

**Edge Cases:**
1. **Token Change**: If `LOOP_API_TOKEN` changes in `.env`, must update hardcoded value in workflow JSON
2. **Missing Token**: If token is removed or invalid, API returns 403 with error message (no longer 502)
3. **Network Timeout**: 30-second timeout already configured, no change needed
4. **API Server Down**: `onError: continueRegularOutput` ensures workflow continues even if API fails
5. **Invalid JSON Body**: API validates input and returns 400 error with details
6. **File Path Error**: If snapshot path is incorrect, API returns 404 or 500 with message

**Security Considerations:**
- Token `loop_2024_kanban_secret` is hardcoded in workflow JSON
- JSON file is stored on NAS server with access control
- Token is for internal API only, no public exposure risk
- Alternative: Use n8n credential system (genericCredentialType) for production

**Verification Steps:**
1. Modify `ac_batch_daily_digest.json` lines 307-331 (Save Snapshot node)
2. Optionally fix lines 25-46 (Load Config JSON) and 233-255 (Load Previous Snapshot)
3. Upload modified workflow to n8n
4. Execute workflow manually in n8n UI
5. Check Save Snapshot node output for success message
6. Verify snapshot file updated at `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`

**Expected Result:**
- Save Snapshot node returns: `{"success": true, "path": "...", "bytes_written": ..., "updated_at": "..."}`
- No 502 Bad Gateway error
- Snapshot file successfully written to vault

### Todo
- [ ] Backup current `ac_batch_daily_digest.json` to `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_YYYYMMDD.json`
- [ ] Edit `ac_batch_daily_digest.json` line 307-331: Replace Save Snapshot node parameters with header authentication
- [ ] Edit `ac_batch_daily_digest.json` line 25-46: Fix Load Config JSON node authentication (consistency)
- [ ] Edit `ac_batch_daily_digest.json` line 233-255: Fix Load Previous Snapshot node authentication (consistency)
- [ ] Test workflow locally with curl: `curl -X POST https://mcp.sosilab.synology.me/api/mcp/file-write -H "x-api-token: loop_2024_kanban_secret" -H "Content-Type: application/json" -d '{"path":"test.json","content":"{\"test\":true}"}'`
- [ ] Upload modified workflow to n8n (via UI or direct file replacement on NAS)
- [ ] Execute `ac-batch-daily-digest` workflow manually in n8n
- [ ] Verify Save Snapshot node output shows success response (no 502 error)
- [ ] Check snapshot file timestamp updated: `ls -lh public/50_Projects/Vault_System/Rounds/prj-n8n/Sources/ac_batch_programs_snapshot.json`
- [ ] Update project.md to document authentication pattern for future workflows

## 체크리스트

- [ ] 502 에러 해결 확인
- [ ] 스냅샷 파일 정상 저장 확인
- [ ] 다른 HTTP 노드도 동일하게 수정 완료

## 참고

- Plan file: `/Users/gim-eunhyang/.claude/plans/validated-meandering-kahn.md`
- Workflow JSON: `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`
- API router: `/Users/gim-eunhyang/dev/loop/public/api/routers/mcp_composite.py` (line 198-204: x-api-token validation)
- Environment vars: `/Users/gim-eunhyang/dev/loop/public/.env` (line 43: LOOP_API_TOKEN)
- Project doc: `/Users/gim-eunhyang/dev/loop/public/50_Projects/Vault_System/Rounds/prj-n8n/project.md`

---

## Execution Log

### 2026-01-15 - Implementation Complete

**Changes Made:**
1. Created backup: `_build/n8n_workflows/_archive/ac_batch_daily_digest_backup_20260115.json`
2. Fixed 3 HTTP Request nodes in `ac_batch_daily_digest.json`:
   - **Load Config JSON** (lines 25-46): Added x-api-token header authentication
   - **Load Previous Snapshot** (lines 233-255): Added x-api-token header authentication
   - **Save Snapshot** (lines 307-331): Added x-api-token header authentication (PRIMARY TARGET)

**Technical Details:**
- Replaced `authentication: predefinedCredentialType` with `authentication: none`
- Added `sendHeaders: true`
- Added `headerParameters` section with `x-api-token: loop_2024_kanban_secret`
- Updated notes field for all 3 nodes to document authentication method
- Verified JSON syntax validity with `python3 -m json.tool`

**Code Review Results (Codex):**
- **Authentication**: Properly implemented with x-api-token header
- **Consistency**: All 3 nodes use identical authentication structure
- **JSON Validity**: Confirmed syntactically valid with `jq`
- **Security Note**: Codex flagged hardcoded token (documented as acceptable for internal use)

**Files Modified:**
- `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json`

**Next Steps:**
- Upload modified workflow to n8n (via UI or direct file replacement on NAS)
- Execute `ac-batch-daily-digest` workflow manually in n8n
- Verify Save Snapshot node output shows success response (no 502 error)
- Check snapshot file timestamp updated

**Status**: Implementation complete, ready for n8n deployment and testing

---

### 2026-01-15 - Node Connection Fix (Discord Empty Digest Issue)

**Problem Discovered:**
- Discord received empty digest: `New: 0 | Updated: 0 | Deadline Soon: 0 | Open/Rolling: 0`
- Root cause: Workflow node connection error caused data loss between nodes

**Root Cause Analysis:**
- **Incorrect flow**: `Redact Sensitive` → `Load Previous Snapshot` → `Diff and Classify`
- `Load Previous Snapshot` output (empty snapshot) overwrote crawled entries from `Redact Sensitive`
- `Diff and Classify` received empty data instead of crawled K-Startup programs

**Fix Applied:**
- Modified `ac_batch_daily_digest.json` line 538
- Changed connection: `"Redact Sensitive"` → `"Diff and Classify"` (direct connection)
- Before: `"node": "Load Previous Snapshot"`
- After: `"node": "Diff and Classify"`

**Technical Details:**
- `Diff and Classify` node already references `$('Load Previous Snapshot').first().json` internally
- No need for direct input connection from `Load Previous Snapshot`
- Direct input should be crawled entries from `Redact Sensitive`
- JSON syntax validated with `python3 -m json.tool`

**Expected Result After Deployment:**
- Discord digest will show non-zero counts (15+ new programs from K-Startup)
- First run: All entries classified as "new" (previous snapshot is empty)
- Subsequent runs: Proper diff detection (new/updated/deadline soon)

**Files Modified:**
- `/Users/gim-eunhyang/dev/loop/public/_build/n8n_workflows/ac_batch_daily_digest.json` (line 538)

**Next Steps:**
- Upload modified workflow to n8n
- Execute workflow and verify Discord message shows program counts
- Confirm snapshot file gets populated after first run

---

### 2026-01-15 - Discord Message Splitting Fix (2000 Character Limit)

**Problem Discovered:**
- Discord API returned 400 error: "Must be 2000 or fewer in length"
- Format Discord Message node split by **section** (New, Updated, etc.)
- Single section with 15 entries (~3000 chars) exceeded Discord's 2000 char limit

**Root Cause:**
- Original logic: Split by section → If "New" section > 2000 chars, entire section goes to one message
- 15 programs × ~200 chars/entry = ~3000 chars → Discord rejects

**Fix Applied:**
- Rewrote Format Discord Message node to split by **entry** (line-by-line)
- Modified `ac_batch_daily_digest.json` lines 287-289
- New logic:
  1. Add entries one-by-one to current message
  2. Check length after each entry
  3. If exceeds 2000 chars, start new message
  4. Add "(continued)" suffix for split sections

**Technical Details:**
```javascript
// Before (section-based splitting)
for (const block of sections) {
  const next = `${current}\\n\\n${block}`;  // Add entire section
  if (next.length > limit) { ... }
}

// After (entry-based splitting)
for (const section of sections) {
  for (const entry of section.entries) {  // Loop each entry
    const entryLine = formatEntry(entry);
    const next = `${current}${sectionHeader}\\n${entryLine}`;
    if (next.length > limit) {
      messages.push(current);
      current = `${header}\\n${counts}\\n\\n**${section.title} (continued)**\\n${entryLine}`;
    }
  }
}
```

**Expected Result:**
- 15 entries split across 2-3 Discord messages
- Message 1: Header + counts + entries 1-8
- Message 2: Header + counts + "**New (continued)**" + entries 9-15
- All messages stay under 2000 chars

**Files Modified:**
- `/Users/gim-eunhyang/dev/loop-wip-1768413797/_build/n8n_workflows/ac_batch_daily_digest.json` (line 288)

**Next Steps:**
- Upload modified workflow to n8n
- Execute workflow and verify multiple Discord messages sent successfully
- Confirm all 15 entries appear across messages
