---
entity_type: Task
entity_id: tsk-0000os-1768331167938
entity_name: Content OS - Inventory and Mapping
created: 2026-01-14
updated: '2026-01-14'
status: doing
project_id: prj-content-os
parent_id: prj-content-os
assignee: 김은향
type: dev
target_project: loop
target_project: loop
priority: high
tags: []
aliases: []
outgoing_relations: []
due: '2026-02-14'
---
# Content OS - Inventory and Mapping

> Task ID: `tsk-0000os-1768331167938` | Project: `prj-content-os` | Status: doing

---

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-content-os
- Architecture Pattern: Next.js 16.1.1 (App Router) + React 19.2.3 + TypeScript 5
- UI Stack: ShadCN UI (Radix UI), Tailwind CSS 4, Lucide React
- State Management: TanStack React Query 5
- Current Location: `/Users/gim-eunhyang/dev/loop-wip-1768331085/apps/content-os/`

### PRD (Inventory Deliverable)

- 목표: Content OS (Next.js App Router) 기능/데이터/의존성을 전부 맵핑해 Dashboard V2(Vite) 마이그레이션을 위한 단일 참고 문서를 만든다.
- 범위: 모든 라우트(`/login`, `/opportunity`, `/explorer`, `/pipeline`, `/retro`, `/performance`, `/performance/weekly`, `/performance/[videoId]`, middleware)와 Next API(`/api/auth/*`, `/api/youtube/*`), 주요 컴포넌트, 데이터 소스(Firestore, YouTube API, IndexedDB, LocalStorage, Cookies).
- 산출물: 라우트별 UI·훅·데이터 소스, API별 입력/출력 및 백엔드 호출, 스토리지/ENV 목록, Next 의존성, 마이그레이션 고려사항.
- 완료 기준: 위 항목이 Task Notes에 반영되어 있고 실제 코드 경로 기반으로 누락 없이 기록됨.

### Inventory & Mapping (2026-01-14)

**레이아웃/글로벌**
- `app/layout.tsx`: `MainLayout`(Sidebar+Header), `QueryProvider`, `ThemeProvider`, `TooltipProvider`.
- `components/layout/sidebar.tsx`: 네비(/opportunity, /explorer, /pipeline, /performance, /retro), `/api/auth/logout` 로그아웃, 다크모드 토글.
- `middleware.ts`: `loop_api_token` 쿠키 없으면 `/login`으로 리다이렉트(예외: /login, /api/auth/login, /api/auth/logout, static/_next).
- `lib/auth.ts`: 세션 쿠키명 `loop_api_token`, 만료 1h.
- `lib/firebase/config.ts`: ENV 기반 설정, Firestore root=`loop/main`.

**라우트 & UI**
- `/` → `/opportunity` 리다이렉트.
- `/login`: 클라이언트 페이지. `/api/auth/login` POST(email, password) → 대시보드 OAuth(`LOOP_API_URL/oauth/dashboard-login`) 호출, JWT 쿠키 설정 후 `callbackUrl` 이동. 오류 시 메시지 표시.
- `/opportunity`: `OpportunityDashboard` → `useOpportunities`(React Query + Firestore `loop/main/contentos_contents`, status=candidate, orderBy finalScore/createdAt, limit 50, onSnapshot). 로컬 state로 즐겨찾기/제외 유지, `OpportunityFiltersComponent`(purposeType/targetLoop/format/period), `OpportunityGrid` 카드 액션은 토스트만(드래프트 생성 미연결).
- `/explorer`: 기본 `dummyVideos` 가공(`processVideos`) + 검색 시 `useYouTubeSearch`(React Query → `/api/youtube/search` → YouTube Data API). `useCollection`/`useSearchHistory`(localStorage)로 콜렉션/차단/검색세션 보관. `ExplorerTabs`(탐색/collection/blocked), `VideoTable`, `BulkActions`는 UI-only placeholder. 채널/기간/검색/조회수 필터, 소트, 차단 토글, 번들/레퍼런스 버튼은 alert 수준.
- `/pipeline`: `PipelineBoard` with dnd-kit. 데이터는 `dummyTasks` 로컬 state; 상태변경/모달도 클라이언트 메모리 전용(백엔드 없음).
- `/retro`: `RetroDashboard` + `dummyABReports`/`dummyLearningCards`/`dummyNegativeEvidences`. 통계 `getRetroStats()`, UI 카드/배지 렌더 전용.
- `/performance`: `useMergedPerformance` → `usePerformanceData`(React Query → `/api/youtube/analytics/videos`) + `useSnapshot`(IndexedDB) 머지(`MergePerformanceDataUseCase`, `createIndexedDBSnapshotRepository`). Unauthorized/쿼터 초과 시 dummy 데이터(`dummyPerformanceData`) 메타 포함. `SnapshotImport`/`SnapshotPreview`로 YouTube Studio 클립보드 파싱 후 IndexedDB 저장, `SnapshotHistory`에 매칭 통계/스냅샷 날짜 표시. `AuthStatusBanner`는 `/api/auth/youtube/status` 결과로 경고/워닝 표시. 필터(검색/상태/기간/shorts 여부), 소트(publishedAt/CTR/노출/조회), 리프레시 버튼, 주간 요약 링크.
- `/performance/[videoId]`: `usePerformanceDetail`로 머지된 단일 항목 조회(없으면 빈 상태). 메트릭 비교 카드(24h vs 7d), 차트, Diagnosis Label.
- `/performance/weekly`: `getWeeklySummaries` 더미 데이터로 4주 비교 테이블/차트.

**API 라우트**
- `/api/auth/login` POST: `LOOP_API_URL/oauth/dashboard-login` 위임, 성공 시 `loop_api_token` HttpOnly 쿠키 설정(`SESSION_MAX_AGE` 또는 API 응답 만료).
- `/api/auth/logout` POST: 세션 쿠키 삭제.
- `/api/auth/youtube/login|callback|status|logout`: OAuth(PKCE) 플로우 → `generateAuthUrl`로 리다이렉트, `exchangeCodeForTokens` + `storeTokens`(쿠키 보관), 상태 확인(`getAuthState`), 토큰 제거(`clearTokens`).
- `/api/youtube/search` GET: 쿼리/파라미터 검증 후 `youtube-service.search`(YouTube Data API) 호출, 에러 코드별 HTTP 매핑.
- `/api/youtube/analytics/videos` GET: `getRecentVideosWithAnalytics`(YouTube Analytics + Data API, OAuth 토큰 필요). `dummy=true` 시 데모 데이터 반환, Unauthorized 시 dummy + warning, 기타 에러 시 코드/메시지 반환(429 on quota).

**데이터 소스/스토리지**
- Firestore: `loop/main/contentos_contents`(candidate opportunities). 읽기 전용, onSnapshot 실시간.
- Cookies: `loop_api_token`(대시보드 세션), YouTube OAuth 토큰(`oauth-service` 내부 관리).
- IndexedDB: YouTube Studio Snapshot 저장소(`createIndexedDBSnapshotRepository`), `useSnapshot`/`useSnapshotDeltas`.
- LocalStorage: Explorer 콜렉션/차단/채널, 검색 히스토리.
- External APIs: YouTube Data API(검색/비디오 상세), YouTube Analytics API(CTR/노출 등), Dashboard OAuth API.

**마이그레이션 포인트 (Dashboard V2, Vite)**
- Next API 라우트(`/api/auth/*`, `/api/youtube/*`)는 Vite 환경에서는 별도 BFF/Cloud Function으로 분리 필요.
- Firebase Firestore 접근(`getContents`/`subscribeToContents`)는 Vite용 SDK 초기화 및 ENV 로딩 경로 점검.
- IndexedDB 스냅샷 저장소는 동일하게 재사용 가능하나, React Query/Provider 설정이 Vite 루트에 재구성되어야 함.
- Middleware 기반 쿠키 가드(`middleware.ts`)는 Vite에서 라우팅 가드로 치환; 세션 쿠키명/도메인 일관성 유지.
- Dummy 데이터 사용 구간(Opportunity 제외 대부분)과 실제 API 연동 구간을 분리해 단계적 교체 계획 수립.

**Environment Variables**
- Dashboard OAuth: `LOOP_API_URL`, `NEXT_PUBLIC_APP_URL`, `NODE_ENV`.
- Firebase: `NEXT_PUBLIC_FIREBASE_API_KEY`, `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`, `NEXT_PUBLIC_FIREBASE_PROJECT_ID`, `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`, `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`, `NEXT_PUBLIC_FIREBASE_APP_ID`.
- YouTube OAuth/Analytics: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_REDIRECT_URI`.
- YouTube Data API: `YOUTUBE_API_KEY`.

**Risks/Unknowns**
- 많은 페이지가 dummy 데이터 기반이라 실제 API 계약/스토리지 모델 검증 필요(Explorer, Pipeline, Retro, Performance fallback).
- Dashboard V2 로그인 플로우와 Content OS 로그인 페이지 중복 여부 결정 필요(`/login` 유지 vs 공용 로그인 사용).
- Firestore `contentos_contents` 스키마 상세(필드 리스트, 인덱스) 미기록 → 마이그레이션 전 추가 조사 필요.
- YouTube Analytics 쿼터/권한 에러 처리(429/403) 시 UI 대응 로직 단순 토스트/메시지 수준.

## Execution Log (2026-01-14)

### Plan Review
- Codex Plan Review: NO (manual review in-session)

### Implementation
- Modified: 2 files
- Key changes: 프로젝트 Task 테이블에 참조 추가, Content OS 라우트/API/데이터 흐름 인벤토리 및 마이그레이션 포인트 정리

### Code Review
- Codex Code Review: NO (loop task, not run)

### Result
- Status: success
- Next: 마이그레이션 설계/대시보드 V2 구현 시 본 인벤토리 참조
