---
entity_type: Task
entity_id: tsk-0000os-1768331167938
entity_name: Content OS - Inventory and Mapping
created: 2026-01-14
updated: '2026-01-16'
closed: '2026-01-16'
status: done
project_id: prj-content-os
parent_id: prj-content-os
assignee: 김은향
type: dev
target_project: loop
priority: high
tags: []
aliases: []
outgoing_relations: []
due: '2026-02-14'
---
# Content OS - Inventory and Mapping

> Task ID: `tsk-0000os-1768331167938` | Project: `prj-content-os` | Status: done

---

## 체크리스트

- [x] 라우트/컴포넌트/데이터 소스 인벤토리
- [x] Next API 입력/출력 및 외부 의존성 정리
- [x] 스토리지/ENV/마이그레이션 포인트 문서화

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-content-os
- Architecture Pattern: Next.js 16.1.1 (App Router) + React 19.2.3 + TypeScript 5
- UI Stack: ShadCN UI (Radix UI), Tailwind CSS 4, Lucide React
- State Management: TanStack React Query 5
- Current Location: `/Users/gim-eunhyang/dev/loop/code/apps/content-os/`

### PRD (Inventory Deliverable)

- 목표: Content OS (Next.js App Router) 기능/데이터/의존성을 전부 맵핑해 Dashboard V2(Vite) 마이그레이션을 위한 단일 참고 문서를 만든다.
- 범위: 모든 라우트(`/login`, `/opportunity`, `/explorer`, `/pipeline`, `/retro`, `/performance`, `/performance/weekly`, `/performance/[videoId]`, middleware)와 Next API(`/api/auth/*`, `/api/youtube/*`), 주요 컴포넌트, 데이터 소스(Firestore, YouTube API, IndexedDB, LocalStorage, Cookies).
- 산출물: 라우트별 UI·훅·데이터 소스, API별 입력/출력 및 백엔드 호출, 스토리지/ENV 목록, Next 의존성, 마이그레이션 고려사항.
- 완료 기준: 위 항목이 Task Notes에 반영되어 있고 실제 코드 경로 기반으로 누락 없이 기록됨.

### Inventory & Mapping (2026-01-16 업데이트)

**글로벌/레이아웃/가드**
- `app/layout.tsx`: `QueryProvider`(React Query 기본 옵션 + DevTools), `ThemeProvider`, `TooltipProvider`, `MainLayout`(Sidebar 포함), 폰트 Geist.
- `components/layout/sidebar.tsx`: 네비(/opportunity, /explorer, /pipeline, /performance, /retro), 테마 토글, 로그아웃(`/api/auth/logout`). Active 매칭: pathname prefix.
- `middleware.ts`: `loop_api_token` 쿠키 없으면 `/login?callbackUrl=...`로 리다이렉트. 퍼블릭: `/login`, `/api/auth/login`, `/api/auth/logout`. `_next/*`, `favicon` 제외.
- `lib/auth.ts`: 세션 쿠키명 `loop_api_token`, 만료 1h.

**라우트 & UI**
- `/` → `/opportunity` 리다이렉트.
- `/login`: 클라이언트 폼 → `/api/auth/login` POST(email, password) → `LOOP_API_URL/oauth/dashboard-login` 위임, 응답 JWT를 HttpOnly 쿠키에 저장 후 `callbackUrl` 이동. 에러 메시지 표시.
- `/opportunity`: `OpportunityDashboard` → `useOpportunities`(React Query, 60초 폴링) → `fetchApi("api/content-os/opportunities", { status: candidate, orderByField: finalScore, limit: 50 })` / LOOP API(`NEXT_PUBLIC_API_BASE_URL` 기본 `http://localhost:8081`). 즐겨찾기/제외는 클라이언트 로컬 state만, 필터 purposeType/targetLoop/format/period, 카드 액션은 토스트.
- `/explorer`: 기본 `dummyVideos`, 검색 시 `useYouTubeSearch`(React Query → `/api/youtube/search?q&maxResults(≤50)&order&pageToken` → YouTube Data API). Pagination 메타(next/prev/resultsPerPage) + `YouTubePagination` 컨트롤. 로컬스토리지: collection(`video-collection`), blocked(`blocked-videos`/`blocked-channels`), 검색 히스토리(`search-history`). 탭(explore/collection/blocked), 필터(search/period/channel/minViews), 차단 토글, 번들/레퍼런스/콜렉션 액션은 UI placeholder.
- `/pipeline`: `PipelineBoard` + `dummyTasks` 클라이언트 메모리(dnd-kit), 백엔드 없음.
- `/retro`: `RetroDashboard` + `dummyABReports`/`dummyLearningCards`/`dummyNegativeEvidences`, 통계 `getRetroStats()`, UI-only.
- `/performance`: `useMergedPerformance` → `usePerformanceData`(React Query → `/api/youtube/analytics/videos?maxResults=100`) + `useSnapshot`(IndexedDB). Unauthorized 또는 `dummy=true` 시 `dummyPerformanceData` 병합. `SnapshotImport`(YouTube Studio 클립보드 파싱 → IndexedDB), `SnapshotHistory`(저장본/매칭 통계), 필터(search/status/period/shorts), 소트(publishedAt/CTR/노출/조회), 리프레시 버튼, `AuthStatusBanner`는 `/api/auth/youtube/status` 결과 노출, `SnapshotPreview`로 최근 입력 확인.
- `/performance/[videoId]`: `usePerformanceDetail`로 병합 데이터 단일 조회(없으면 빈 상태), 메트릭 비교/차트/Diagnosis Label.
- `/performance/weekly`: `getWeeklySummaries` 더미 데이터 4주 비교 테이블/차트.

**Next API 라우트**
- `/api/auth/login` POST: body `{email,password}` → `LOOP_API_URL/oauth/dashboard-login` 호출, 응답 `{access_token, expires_in}`을 `loop_api_token` HttpOnly 쿠키로 저장(secure/lax, maxAge 응답값 or 1h). 실패 시 400/401/500.
- `/api/auth/logout` POST: `loop_api_token` 쿠키 삭제.
- `/api/auth/youtube/login|callback|status|logout`: Google OAuth(PKCE). `yt_oauth_pkce`로 verifier/state 저장, `yt_oauth_tokens`(HttpOnly, 30일)로 액세스/리프레시 저장. Callback은 state 검증 후 토큰 저장, 실패 시 `/performance?error=...` 리다이렉트. Status는 토큰/채널 정보 반환. Logout은 토큰 쿠키 제거.
- `/api/youtube/search` GET: 파라미터 `q(>=2)`, `maxResults 1-50`, `pageToken`, `order`(relevance/date/viewCount/rating/title). `youtube-service.search` → YouTube Data API(`YOUTUBE_API_KEY`). 응답 `{success,data:{videos,totalResults,nextPageToken,prevPageToken,resultsPerPage,quotaUsed},meta.timestamp}`. INVALID_QUERY 400, FORBIDDEN/INVALID_API_KEY 403, QUOTA_EXCEEDED/RATE_LIMITED 429 등.
- `/api/youtube/analytics/videos` GET: 파라미터 `maxResults`(기본 20), `dummy=true` 강제 데모. `getRecentVideosWithAnalytics`(YouTube Analytics + Data API, OAuth 토큰 필요) 실패 시 UNAUTHORIZED만 dummy 반환, 기타 에러는 code/message와 429 on quota. 메타 source(`youtube_analytics`/`dummy`), fetchedAt, warning.

**스토리지/데이터 소스**
- External API: Loop API(`api/content-os/opportunities`), YouTube Data API(search/videos/channels via API key), YouTube Analytics API(CTR/노출 등, OAuth).
- Cookies: `loop_api_token`(대시보드 세션), `yt_oauth_tokens`(YouTube OAuth), `yt_oauth_pkce`(PKCE 임시). HttpOnly + secure/lax.
- LocalStorage: `video-collection`, `blocked-videos`, `blocked-channels`, `search-history`.
- IndexedDB: YouTube Studio Snapshot 저장소(`youtube-snapshots` via `IndexedDBSnapshotRepository`).

**환경변수 (코드 기준)**
- API Base: `NEXT_PUBLIC_API_BASE_URL` 또는 `NEXT_PUBLIC_API_URL`(기본 `http://localhost:8081`), `NEXT_PUBLIC_API_TOKEN`(옵션 헤더).
- OAuth/Dashboard: `LOOP_API_URL`, `NEXT_PUBLIC_APP_URL`, `NODE_ENV`.
- YouTube Data API: `YOUTUBE_API_KEY`.
- YouTube OAuth/Analytics: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_REDIRECT_URI`.
- Firebase ENV 템플릿 존재(`.env.local.example`), 현재 Opportunity 페이지는 Loop API 경유라 Firestore SDK 직접 호출 없음.

**마이그레이션 포인트 (갱신)**
- BFF 필요: `/api/auth/*`, `/api/youtube/*`는 Vite 환경에서 별도 서버/Cloud Function으로 이전. Loop API 호출 경로(`api/content-os/opportunities`)와 쿠키 도메인 일관성 확인.
- 세션/토큰: `loop_api_token`(Dashboard), `yt_oauth_tokens`(YouTube) 쿠키를 Vite/도메인에 맞춰 재구성. Middleware 가드는 라우터 가드로 치환.
- Storage: LocalStorage/IndexedDB 키는 그대로 재사용 가능. React Query Provider/ThemeProvider 설정을 Vite 루트로 옮길 것.
- Dummy/실데이터 분리: Explorer(YouTube API 키 필요, pagination 포함), Pipeline/Retro(전부 dummy), Performance(dummy fallback) → 마이그레이션 시 실제 데이터 계약 우선 정의.
- ENV 표준화: API Base/Token, YouTube/Data/OAuth, App URL을 Vite `.env` 네이밍으로 매핑.

## Execution Log (2026-01-14)

### Plan Review
- Codex Plan Review: NO (manual review in-session)

### Implementation
- Modified: 2 files
- Key changes: 프로젝트 Task 테이블에 참조 추가, Content OS 라우트/API/데이터 흐름 인벤토리 및 마이그레이션 포인트 정리

### Code Review
- Codex Code Review: NO (loop task, not run)

### Result
- Status: success
- Next: 마이그레이션 설계/대시보드 V2 구현 시 본 인벤토리 참조

### 작업 로그

#### 2026-01-16 20:05
**개요**: Content OS 전 라우트/Next API/스토리지/ENV 인벤토리 최신화 및 마이그레이션 포인트 정리

**변경사항**:
- 라우트별 데이터 소스/스토리지/의존성 재매핑(Explorer YouTube pagination, Opportunity=Loop API 폴링, Performance OAuth+IndexedDB 흐름 명시)
- Next API 입력/출력/외부 호출 요약 추가 (/api/auth/*, /api/youtube/*)
- 환경변수/쿠키/LocalStorage/IndexedDB 키 정리 및 Vite 마이그레이션 고려사항 업데이트

**파일 변경**:
- tsk-0000os-1768331167938.md

**Codex 리뷰**: 자체 점검
**결과**: 인벤토리 문서 최신화 완료
