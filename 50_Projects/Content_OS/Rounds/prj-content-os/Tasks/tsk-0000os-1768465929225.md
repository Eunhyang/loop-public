---
entity_type: Task
entity_id: tsk-0000os-1768465929225
entity_name: Content OS - YouTube Search Analytics API
created: '2026-01-15'
updated: '2026-01-15'
status: done
project_id: prj-content-os
parent_id: prj-content-os
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
closed: '2026-01-15'
aliases:
- tsk-0000os-1768465929225
tags: []
type: dev
---

# Content OS - YouTube Search Analytics API

## 설명

Migrate YouTube search and analytics endpoints from Content OS Next.js app to the centralized FastAPI backend (`code/api`).

## 체크리스트

- [ ] Move search endpoint to FastAPI
- [ ] Move analytics endpoint to FastAPI
- [ ] Port service logic from lib/youtube/*
- [ ] Implement caching for search results (5-minute TTL)
- [ ] Update response envelopes to match existing schema
- [ ] Test with manual curl commands
- [ ] Verify error codes match spec
- [ ] Confirm UI displays data correctly

## 참고

## Notes

### PRD (Product Requirements Document)

**VERY IMPORTANT**: Read `/Users/gim-eunhyang/dev/loop/.agent/plan/prd-techspec-merge-content-os-into-dashboard-v2.md` before starting implementation.

#### Purpose
Move YouTube search and analytics endpoints into `code/api` while preserving query behavior, error codes, and response envelopes.

#### Source Files
**Search handler**: `code/apps/content-os/app/api/youtube/search/route.ts`

**Analytics handler**: `code/apps/content-os/app/api/youtube/analytics/videos/route.ts`

**Services**:
- `code/apps/content-os/lib/youtube/youtube-service.ts`
- `code/apps/content-os/lib/youtube/youtube-analytics-service.ts`

**Types**:
- `code/apps/content-os/types/youtube.ts`
- `code/apps/content-os/types/youtube-api.ts`
- `code/apps/content-os/types/youtube-analytics.ts`
- `code/apps/content-os/types/video.ts`

#### Tech Spec

**Backend Framework**: FastAPI (Python)

**Target Location**: `~/dev/loop/code/api/routers/youtube.py`

**Dependencies**:
- `google-api-python-client` - YouTube Data API v3
- `google-auth-oauthlib` - YouTube Analytics API OAuth
- Python caching library (e.g., `cachetools` or Redis)

**Architecture**:
```
code/api/
├── routers/
│   └── youtube.py           # New router for YouTube endpoints
├── services/
│   └── youtube_service.py   # Business logic (search, analytics)
└── models/
    └── youtube_models.py    # Pydantic models for request/response
```

#### Endpoint Details to Preserve

**Search Endpoint**:
- Path: `/api/content-os/youtube/search`
- Method: GET
- Query Parameters:
  - `q` (required, min 2 chars) - Search query
  - `maxResults` (1-50, default 25) - Number of results
  - `pageToken` (optional) - Pagination token
  - `order` (optional) - Sort order: relevance|date|viewCount|rating|title
- Response:
```json
{
  "success": true,
  "data": {
    "videos": [...],
    "totalResults": 1000,
    "nextPageToken": "CAEQAA",
    "quotaUsed": 102
  },
  "meta": {
    "quotaUsed": 102,
    "timestamp": "2026-01-14T12:00:00Z"
  }
}
```
- Error Codes:
  - 400: INVALID_QUERY
  - 403: INVALID_API_KEY, FORBIDDEN
  - 429: RATE_LIMITED, QUOTA_EXCEEDED
  - 500: NETWORK_ERROR

**Analytics Endpoint**:
- Path: `/api/content-os/youtube/analytics/videos`
- Method: GET
- Query Parameters:
  - `maxResults` (default 20) - Number of videos
  - `dummy=true` - Force demo data
- Response:
```json
{
  "success": true,
  "data": [/* ContentPerformance array */],
  "meta": {
    "source": "youtube_analytics|dummy",
    "fetchedAt": "2026-01-14T12:00:00Z",
    "count": 20,
    "warning": "Not authenticated. Showing demo data." // Optional
  }
}
```
- Fallback Behavior: If unauthorized, return dummy data with warning (preserve current behavior)

#### Required Behavior

1. **Quota Management**: Respect YouTube API quotas and provide consistent error mapping
2. **Date Normalization**: Convert all date fields to ISO 8601 strings
3. **Search Caching**: Cache search results with 5-minute TTL to reduce quota consumption
4. **Analytics Fallback**: Keep analytics behavior consistent with `dummy-performance.ts` fallback when unauthorized
5. **Error Handling**: Map YouTube API errors to consistent error codes

#### Implementation Checklist

1. Create FastAPI router at `code/api/routers/youtube.py`
2. Port service logic from `lib/youtube/*` to `code/api/services/youtube_service.py`
3. Define Pydantic models in `code/api/models/youtube_models.py`
4. Implement search caching (in-memory or Redis)
5. Replace Next.js `fetch` options with explicit cache policy
6. Update response envelopes to match existing frontend expectations
7. Add comprehensive error handling and logging
8. Mount router in `code/api/main.py`

#### Acceptance Criteria

- Both endpoints respond with the same schema as the Next.js handlers
- Search results and analytics data appear correctly in UI after migration
- Error codes match specification
- Caching reduces quota consumption by >50%
- Manual curl tests pass for valid and invalid parameters

#### Validation Steps

```bash
# Search endpoint - valid query
curl -X GET "http://localhost:8081/api/content-os/youtube/search?q=sleep+routine&maxResults=10"

# Search endpoint - invalid query
curl -X GET "http://localhost:8081/api/content-os/youtube/search?q=a"

# Analytics endpoint - real data
curl -X GET "http://localhost:8081/api/content-os/youtube/analytics/videos?maxResults=20"

# Analytics endpoint - dummy data
curl -X GET "http://localhost:8081/api/content-os/youtube/analytics/videos?dummy=true"
```

#### Example Responses

**Search Success**:
```json
{
  "success": true,
  "data": {
    "videos": [
      {
        "id": "vid-1",
        "thumbnail": "https://...",
        "title": "Sleep routine",
        "channel": {
          "name": "Channel A",
          "subscribers": 12000
        },
        "publishedAt": "2026-01-01T00:00:00Z",
        "views": 12345,
        "marketScore": 7.2,
        "velocity": 321,
        "youtubeUrl": "https://youtube.com/watch?v=...",
        "duration": "10:32",
        "contributionScore": 8.1,
        "impactScore": 7.9,
        "exposureGrade": "Good"
      }
    ],
    "totalResults": 1000,
    "nextPageToken": "CAEQAA",
    "quotaUsed": 102
  },
  "meta": {
    "quotaUsed": 102,
    "timestamp": "2026-01-14T12:00:00Z"
  }
}
```

**Analytics Success**:
```json
{
  "success": true,
  "data": [/* ContentPerformance array */],
  "meta": {
    "source": "youtube_analytics",
    "fetchedAt": "2026-01-14T12:00:00Z",
    "count": 20
  }
}
```

**Analytics Fallback (Unauthorized)**:
```json
{
  "success": true,
  "data": [/* ContentPerformance dummy array */],
  "meta": {
    "source": "dummy",
    "fetchedAt": "2026-01-14T12:00:00Z",
    "count": 20,
    "warning": "Not authenticated. Showing demo data."
  }
}
```

#### Related Tasks
- tsk-0000os-1768465926049 (Content OS - API Migration Spec) - Parent migration specification

### 작업 로그

#### 2026-01-15 19:09
**개요**: FastAPI로 YouTube 검색/분석 엔드포인트 신규 작성 및 Content OS OAuth 쿠키 연동, 캐싱 적용.

**변경사항**:
- 개발: `api/routers/youtube.py` 신규 라우터로 검색/분석 엔드포인트 추가, 기존 Auth 쿠키 재사용.
- 개발: `api/services/youtube_service.py`에서 검색 로직/TTL 캐시/에러 매핑 및 OAuth 기반 분석 데이터(토큰 리프레시, 더미 fallback) 구현.
- 개발: `api/models/youtube_models.py`로 검색/퍼포먼스 응답 모델 정의 및 메트릭 추정 로직 정리.
- 수정: `api/main.py`에 라우터 마운트.

**파일 변경**:
- api/routers/youtube.py
- api/services/youtube_service.py
- api/models/youtube_models.py
- api/main.py

**Codex 리뷰**: ✅ 자체 검토 (새 파일 컴파일 체크 완료, API 키/토큰 필요로 런타임 검증은 수동 테스트 필요)

**결과**: ⚠️ 로컬 curl 미실행 (YouTube API 키/토큰 필요). `python -m compileall`로 문법 확인 완료.
**커밋**: 작업 브랜치 `task/tsk-0000os-1768465929225` (미커밋 상태)
