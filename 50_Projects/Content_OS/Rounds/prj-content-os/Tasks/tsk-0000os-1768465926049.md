---
entity_type: Task
entity_id: tsk-0000os-1768465926049
entity_name: Content OS - API Migration Spec
created: '2026-01-15'
updated: '2026-01-15'
status: done
closed: '2026-01-15'
project_id: prj-content-os
parent_id: prj-content-os
assignee: 김은향
priority: medium
start_date: '2026-01-15'
due: '2026-01-15'
aliases:
- tsk-0000os-1768465926049
tags: []
type: dev
notes: "# Content OS - API Migration Spec\n\n## 설명\n\nDefine the exact FastAPI endpoints,\
  \ request/response schemas, and error contracts for all Content OS backend needs.\n\
  \n## 체크리스트\n\n- [ ] Read `/Users/gim-eunhyang/dev/loop/.agent/plan/prd-techspec-merge-content-os-into-dashboard-v2.md`\n\
  \n- [ ] Review Next API routes in `code/apps/content-os/app/api/**/route.ts`\n\n\
  - [ ] Review domain types in `code/apps/content-os/types/*` and `code/apps/content-os/lib/types/*`\n\
  \n- [ ] Review YouTube services in `code/apps/content-os/lib/youtube/*`\n\n- [ ]\
  \ Review Firebase data access in `code/apps/content-os/lib/api/firestore/*`\n\n\
  - [ ] Create `/Users/gim-eunhyang/dev/loop/.agent/plan/content-os-api-spec.md`\n\
  \n- [ ] Define all required endpoints (YouTube OAuth, YouTube search/analytics,\
  \ Content data, Auth)\n\n- [ ] Define schema details for each endpoint (method,\
  \ params, response, errors, examples)\n\n- [ ] Validate against Next API route code\
  \ for parity\n\n## 참고\n\n## Notes\n\n### PRD (Product Requirements Document)\n\n\
  **VERY IMPORTANT - READ FIRST**\n\n- You MUST read `/Users/gim-eunhyang/dev/loop/.agent/plan/prd-techspec-merge-content-os-into-dashboard-v2.md`\
  \ before starting this task.\n- Do not proceed without reading it.\n\nPurpose\n\n\
  Define the exact FastAPI endpoints, request/response schemas, and error contracts\
  \ for all Content OS backend needs.\n\nInputs (source of truth)\n\n- Next API routes\
  \ in `code/apps/content-os/app/api/**/route.ts`\n- Domain types in `code/apps/content-os/types/*`\
  \ and `code/apps/content-os/lib/types/*`\n- YouTube services in `code/apps/content-os/lib/youtube/*`\n\
  - Firebase data access in `code/apps/content-os/lib/api/firestore/*`\n\nOutputs\n\
  \nCreate this doc:\n\n- `/Users/gim-eunhyang/dev/loop/.agent/plan/content-os-api-spec.md`\n\
  \nRequired endpoint list (must be included)\n\nYouTube OAuth\n\n- `GET /api/content-os/auth/youtube/login`\
  \ (redirect to Google OAuth)\n- `GET /api/content-os/auth/youtube/callback`\n- `GET\
  \ /api/content-os/auth/youtube/status`\n- `POST /api/content-os/auth/youtube/logout`\n\
  \nNote: PRD mentions `POST` for login. The spec must explicitly confirm method and\
  \ document rationale.\n\nYouTube search and analytics\n\n- `GET /api/content-os/youtube/search`\n\
  - `GET /api/content-os/youtube/analytics/videos`\n\nContent data\n\n- `GET /api/content-os/opportunities`\n\
  - `GET /api/content-os/contents`\n- `GET /api/content-os/tasks`\n\nAuth (Dashboard\
  \ login)\n\n- Existing Dashboard V2 login should be used. Document whether `/api/auth/login`\
  \ and `/api/auth/logout` are deprecated or re-exposed.\n\nRequired schema details\n\
  \nFor each endpoint, include:\n\n- Method + path\n- Query/body parameters (name,\
  \ type, required, default)\n- Response envelope (success/data/meta or error)\n-\
  \ Error codes and HTTP status mappings\n- Example request and response\n\nMinimum\
  \ details to include (from current Next handlers)\n\n`/api/content-os/youtube/search`\n\
  \n- Query params: `q` (min length 2), `maxResults` (1-50, default 25), `pageToken`,\
  \ `order` (relevance|date|viewCount|rating|title)\n- Success response: `{ success:\
  \ true, data, meta: { quotaUsed, timestamp } }`\n- Error codes: INVALID_QUERY, INVALID_API_KEY,\
  \ FORBIDDEN, RATE_LIMITED, QUOTA_EXCEEDED\n\n`/api/content-os/youtube/analytics/videos`\n\
  \n- Query params: `maxResults` (default 20), `dummy` (true/false)\n- Success response:\
  \ `{ success: true, data, meta: { source, fetchedAt, count?, warning? } }`\n- Error\
  \ codes: INVALID_PARAMETER, UNAUTHORIZED, QUOTA_EXCEEDED\n\n`/api/content-os/auth/youtube/status`\n\
  \n- Success response: `{ success: true, data: AuthState, meta: { timestamp } }`\n\
  - Error response: `{ success: false, error: { code, message }, meta: { timestamp\
  \ } }`\n\n`/api/content-os/auth/login` (if needed)\n\n- Body: `{ email, password\
  \ }`\n- Success response: `{ success: true, role }` plus auth token handling\n\n\
  Acceptance criteria\n\n- `content-os-api-spec.md` fully describes all required endpoints.\n\
  - DTO fields reference existing type files (e.g., `types/youtube-analytics.ts`,\
  \ `types/video.ts`, `lib/types/opportunity.ts`).\n- The spec resolves any method\
  \ mismatches (GET vs POST) and documents them.\n\nValidation\n\n- Manual review\
  \ against Next API route code to ensure parity.\n\nResponse envelope (standard)\n\
  \nSuccess:\n\n```json\n{ \"success\": true, \"data\": {}, \"meta\": { \"timestamp\"\
  : \"2026-01-14T12:00:00Z\" } }\n```\n\nError:\n\n```json\n{ \"success\": false,\
  \ \"error\": { \"code\": \"ERROR_CODE\", \"message\": \"...\", \"details\": \"...\"\
  \ }, \"meta\": { \"timestamp\": \"2026-01-14T12:00:00Z\" } }\n```\n\nDTO definitions\
  \ (minimum required fields)\n\nOpportunity\n\n```json\n{\n  \"id\": \"opp-001\"\
  ,\n  \"keyword\": \"sleep routine\",\n  \"finalScore\": 8.7,\n  \"marketScore\"\
  : 9.2,\n  \"fitScore\": 8.5,\n  \"saturationScore\": 0.15,\n  \"whyNow\": \"search\
  \ volume up\",\n  \"recommendedBundle\": { \"shorts\": 2, \"longform\": 1 },\n \
  \ \"purposeType\": \"protocol\",\n  \"targetLoop\": \"habit\",\n  \"format\": \"\
  shorts\",\n  \"createdAt\": \"2026-01-01T00:00:00Z\",\n  \"isFavorite\": false,\n\
  \  \"isExcluded\": false\n}\n```\n\nPipelineTask\n\n```json\n{\n  \"id\": \"task-001\"\
  ,\n  \"title\": \"Draft: sleep routine\",\n  \"format\": \"shorts\",\n  \"status\"\
  : \"draft\",\n  \"purposeType\": \"protocol\",\n  \"targetLoop\": \"habit\",\n \
  \ \"assignee\": \"owner\",\n  \"dueDate\": \"2026-01-20\",\n  \"score\": 8.1,\n\
  \  \"referenceCount\": 3,\n  \"createdAt\": \"2026-01-01T00:00:00Z\"\n}\n```\n\n\
  ContentPerformance (analytics list)\n\n```json\n{\n  \"id\": \"perf-001\",\n  \"\
  videoId\": \"yt-abc\",\n  \"title\": \"Sleep routine\",\n  \"thumbnail\": \"https://...\"\
  ,\n  \"duration\": 480,\n  \"publishedAt\": \"2026-01-01T00:00:00Z\",\n  \"uploadTime\"\
  : \"2026-01-01T00:00:00Z\",\n  \"metrics\": {\n    \"impressions_24h\": 1200,\n\
  \    \"impressions_7d\": 5200,\n    \"ctr_24h\": 4.2,\n    \"ctr_7d\": 5.1,\n  \
  \  \"views_24h\": 400,\n    \"views_7d\": 2100,\n    \"avg_view_duration_24h\":\
  \ 120,\n    \"avg_view_duration_7d\": 150\n  },\n  \"status\": \"stable\",\n  \"\
  problemType\": \"none\"\n}\n```\n\nRetroSummary\n\n```json\n{\n  \"abReports\":\
  \ [\n    {\n      \"id\": \"ab-001\",\n      \"projectName\": \"Project A\",\n \
  \     \"period\": \"2026-01\",\n      \"metrics\": [\n        { \"name\": \"CTR\"\
  , \"expected\": \"6%\", \"realized\": \"5%\", \"achievementRate\": 83 }\n      ],\n\
  \      \"overallAchievement\": 83\n    }\n  ],\n  \"learningCards\": [\n    {\n\
  \      \"id\": \"learn-001\",\n      \"type\": \"hook_pattern\",\n      \"title\"\
  : \"Top hooks\",\n      \"items\": [ { \"rank\": 1, \"name\": \"A\", \"value\":\
  \ \"12%\" } ]\n    }\n  ],\n  \"negativeEvidences\": [\n    {\n      \"id\": \"\
  neg-001\",\n      \"projectId\": \"prj-1\",\n      \"projectName\": \"Project A\"\
  ,\n      \"expected\": { \"ctr\": \"6%\", \"retention\": \"40%\" },\n      \"realized\"\
  : { \"ctr\": \"3%\", \"retention\": \"20%\" },\n      \"inferredTags\": [\"hook_strength\"\
  ],\n      \"lesson\": \"Need stronger hook\",\n      \"createdAt\": \"2026-01-01T00:00:00Z\"\
  \n    }\n  ]\n}\n```\n\nEndpoint examples (minimum)\n\nGET /api/content-os/opportunities\n\
  \n```json\n{\n  \"success\": true,\n  \"data\": { \"items\": [/* Opportunity */],\
  \ \"nextCursor\": null },\n  \"meta\": { \"timestamp\": \"2026-01-14T12:00:00Z\"\
  , \"count\": 50 }\n}\n```\n\nGET /api/content-os/tasks\n\n```json\n{\n  \"success\"\
  : true,\n  \"data\": { \"items\": [/* PipelineTask */], \"nextCursor\": null },\n\
  \  \"meta\": { \"timestamp\": \"2026-01-14T12:00:00Z\", \"count\": 30 }\n}\n```\n\
  \nPATCH /api/content-os/tasks/{taskId}\n\nRequest:\n\n```json\n{ \"status\": \"\
  approved\" }\n```\n\nResponse:\n\n```json\n{ \"success\": true, \"data\": {/* PipelineTask\
  \ */}, \"meta\": { \"timestamp\": \"2026-01-14T12:00:00Z\" } }\n```\n\nGET /api/content-os/retro\n\
  \n```json\n{ \"success\": true, \"data\": {/* RetroSummary */}, \"meta\": { \"timestamp\"\
  : \"2026-01-14T12:00:00Z\" } }\n```"
---
# Content OS - API Migration Spec

## 설명

Define the exact FastAPI endpoints, request/response schemas, and error contracts for all Content OS backend needs.

## 체크리스트

- [ ] Read `/Users/gim-eunhyang/dev/loop/.agent/plan/prd-techspec-merge-content-os-into-dashboard-v2.md`
- [ ] Review Next API routes in `code/apps/content-os/app/api/**/route.ts`
- [ ] Review domain types in `code/apps/content-os/types/*` and `code/apps/content-os/lib/types/*`
- [ ] Review YouTube services in `code/apps/content-os/lib/youtube/*`
- [ ] Review Firebase data access in `code/apps/content-os/lib/api/firestore/*`
- [ ] Create `/Users/gim-eunhyang/dev/loop/.agent/plan/content-os-api-spec.md`
- [ ] Define all required endpoints (YouTube OAuth, YouTube search/analytics, Content data, Auth)
- [ ] Define schema details for each endpoint (method, params, response, errors, examples)
- [ ] Validate against Next API route code for parity

## 참고

## Notes

### PRD (Product Requirements Document)

**VERY IMPORTANT - READ FIRST**
- You MUST read `/Users/gim-eunhyang/dev/loop/.agent/plan/prd-techspec-merge-content-os-into-dashboard-v2.md` before starting this task.
- Do not proceed without reading it.

#### Purpose
Define the exact FastAPI endpoints, request/response schemas, and error contracts for all Content OS backend needs.

#### Inputs (source of truth)
- Next API routes in `code/apps/content-os/app/api/**/route.ts`
- Domain types in `code/apps/content-os/types/*` and `code/apps/content-os/lib/types/*`
- YouTube services in `code/apps/content-os/lib/youtube/*`
- Firebase data access in `code/apps/content-os/lib/api/firestore/*`

#### Outputs
Create this doc:
- `/Users/gim-eunhyang/dev/loop/.agent/plan/content-os-api-spec.md`

#### Required endpoint list (must be included)

##### YouTube OAuth
- `GET /api/content-os/auth/youtube/login` (redirect to Google OAuth)
- `GET /api/content-os/auth/youtube/callback`
- `GET /api/content-os/auth/youtube/status`
- `POST /api/content-os/auth/youtube/logout`

Note: PRD mentions `POST` for login. The spec must explicitly confirm method and document rationale.

##### YouTube search and analytics
- `GET /api/content-os/youtube/search`
- `GET /api/content-os/youtube/analytics/videos`

##### Content data
- `GET /api/content-os/opportunities`
- `GET /api/content-os/contents`
- `GET /api/content-os/tasks`

##### Auth (Dashboard login)
- Existing Dashboard V2 login should be used. Document whether `/api/auth/login` and `/api/auth/logout` are deprecated or re-exposed.

#### Required schema details
For each endpoint, include:
- Method + path
- Query/body parameters (name, type, required, default)
- Response envelope (success/data/meta or error)
- Error codes and HTTP status mappings
- Example request and response

#### Minimum details to include (from current Next handlers)

##### `/api/content-os/youtube/search`
- Query params: `q` (min length 2), `maxResults` (1-50, default 25), `pageToken`, `order` (relevance|date|viewCount|rating|title)
- Success response: `{ success: true, data, meta: { quotaUsed, timestamp } }`
- Error codes: INVALID_QUERY, INVALID_API_KEY, FORBIDDEN, RATE_LIMITED, QUOTA_EXCEEDED

##### `/api/content-os/youtube/analytics/videos`
- Query params: `maxResults` (default 20), `dummy` (true/false)
- Success response: `{ success: true, data, meta: { source, fetchedAt, count?, warning? } }`
- Error codes: INVALID_PARAMETER, UNAUTHORIZED, QUOTA_EXCEEDED

##### `/api/content-os/auth/youtube/status`
- Success response: `{ success: true, data: AuthState, meta: { timestamp } }`
- Error response: `{ success: false, error: { code, message }, meta: { timestamp } }`

##### `/api/content-os/auth/login` (if needed)
- Body: `{ email, password }`
- Success response: `{ success: true, role }` plus auth token handling

#### Acceptance criteria
- `content-os-api-spec.md` fully describes all required endpoints.
- DTO fields reference existing type files (e.g., `types/youtube-analytics.ts`, `types/video.ts`, `lib/types/opportunity.ts`).
- The spec resolves any method mismatches (GET vs POST) and documents them.

#### Validation
- Manual review against Next API route code to ensure parity.

#### Response envelope (standard)
Success:
```json
{ "success": true, "data": {}, "meta": { "timestamp": "2026-01-14T12:00:00Z" } }
```
Error:
```json
{ "success": false, "error": { "code": "ERROR_CODE", "message": "...", "details": "..." }, "meta": { "timestamp": "2026-01-14T12:00:00Z" } }
```

#### DTO definitions (minimum required fields)

##### Opportunity
```json
{
  "id": "opp-001",
  "keyword": "sleep routine",
  "finalScore": 8.7,
  "marketScore": 9.2,
  "fitScore": 8.5,
  "saturationScore": 0.15,
  "whyNow": "search volume up",
  "recommendedBundle": { "shorts": 2, "longform": 1 },
  "purposeType": "protocol",
  "targetLoop": "habit",
  "format": "shorts",
  "createdAt": "2026-01-01T00:00:00Z",
  "isFavorite": false,
  "isExcluded": false
}
```

##### PipelineTask
```json
{
  "id": "task-001",
  "title": "Draft: sleep routine",
  "format": "shorts",
  "status": "draft",
  "purposeType": "protocol",
  "targetLoop": "habit",
  "assignee": "owner",
  "dueDate": "2026-01-20",
  "score": 8.1,
  "referenceCount": 3,
  "createdAt": "2026-01-01T00:00:00Z"
}
```

##### ContentPerformance (analytics list)
```json
{
  "id": "perf-001",
  "videoId": "yt-abc",
  "title": "Sleep routine",
  "thumbnail": "https://...",
  "duration": 480,
  "publishedAt": "2026-01-01T00:00:00Z",
  "uploadTime": "2026-01-01T00:00:00Z",
  "metrics": {
    "impressions_24h": 1200,
    "impressions_7d": 5200,
    "ctr_24h": 4.2,
    "ctr_7d": 5.1,
    "views_24h": 400,
    "views_7d": 2100,
    "avg_view_duration_24h": 120,
    "avg_view_duration_7d": 150
  },
  "status": "stable",
  "problemType": "none"
}
```

##### RetroSummary
```json
{
  "abReports": [
    {
      "id": "ab-001",
      "projectName": "Project A",
      "period": "2026-01",
      "metrics": [
        { "name": "CTR", "expected": "6%", "realized": "5%", "achievementRate": 83 }
      ],
      "overallAchievement": 83
    }
  ],
  "learningCards": [
    {
      "id": "learn-001",
      "type": "hook_pattern",
      "title": "Top hooks",
      "items": [ { "rank": 1, "name": "A", "value": "12%" } ]
    }
  ],
  "negativeEvidences": [
    {
      "id": "neg-001",
      "projectId": "prj-1",
      "projectName": "Project A",
      "expected": { "ctr": "6%", "retention": "40%" },
      "realized": { "ctr": "3%", "retention": "20%" },
      "inferredTags": ["hook_strength"],
      "lesson": "Need stronger hook",
      "createdAt": "2026-01-01T00:00:00Z"
    }
  ]
}
```

#### Endpoint examples (minimum)

##### GET /api/content-os/opportunities
```json
{
  "success": true,
  "data": { "items": [/* Opportunity */], "nextCursor": null },
  "meta": { "timestamp": "2026-01-14T12:00:00Z", "count": 50 }
}
```

##### GET /api/content-os/tasks
```json
{
  "success": true,
  "data": { "items": [/* PipelineTask */], "nextCursor": null },
  "meta": { "timestamp": "2026-01-14T12:00:00Z", "count": 30 }
}
```

##### PATCH /api/content-os/tasks/{taskId}
Request:
```json
{ "status": "approved" }
```
Response:
```json
{ "success": true, "data": {/* PipelineTask */}, "meta": { "timestamp": "2026-01-14T12:00:00Z" } }
```

##### GET /api/content-os/retro
```json
{ "success": true, "data": {/* RetroSummary */}, "meta": { "timestamp": "2026-01-14T12:00:00Z" } }
```

### 작업 로그

#### 2026-01-15 19:30
**개요**: Content OS API Migration Spec 문서 작성 완료

**작업 내용**:
- Master PRD (`prd-techspec-merge-content-os-into-dashboard-v2.md`) 검토
- Next.js API 라우트 8개 분석:
  - YouTube OAuth: login(GET), callback(GET), status(GET), logout(POST)
  - YouTube Search/Analytics
  - Dashboard Login
- 타입 정의 5개 파일 분석 (youtube-analytics.ts, opportunity.ts, task.ts, performance.ts, retro.ts)
- Firebase 접근 패턴 분석 (contentos_contents, vault_tasks)

**산출물**:
- `/Users/gim-eunhyang/dev/loop/.agent/plan/content-os-api-spec.md` (생성)

**주요 결정사항**:
1. **YouTube Login Method**: GET 사용 (OAuth 표준에 맞음, PRD의 POST 표기는 수정)
2. **Response Envelope**: `{ success, data?, error?, meta: { timestamp, source? } }` 통일
3. **Error Codes**: HTTP 상태별 매핑 정의 (400/401/403/404/429/500/502/503)
4. **Cookie Strategy**: HttpOnly + Secure + SameSite=Lax

**API 엔드포인트 정의 완료**:
- YouTube OAuth 4개 (login, callback, status, logout)
- YouTube Data 2개 (search, analytics/videos)
- Content Data 3개 (contents, tasks, retro/summary)

**검증 완료**:
✅ Next.js API 라우트와 parity 확인
✅ DTO 정의 기존 타입 파일 참조
✅ Method 불일치 해결 (GET vs POST)

**결과**: ✅ Design task 완료
