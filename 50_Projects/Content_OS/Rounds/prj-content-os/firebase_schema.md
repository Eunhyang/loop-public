# Firebase Schema - ContentOS

> **Database**: `loop` (Firestore, sosi-4a8ee 프로젝트)
> **Root Document**: `loop/{rootId}` (현재: `main`, 향후: `prod`, `staging`, `exec` 확장 가능)
> **Service Account**: `exec/sosi-4a8ee-firebase-adminsdk-3ds3s-3eae8a3e2d.json`

---

## Database Structure

```
Firestore Database: loop (sosi-4a8ee)

loop (collection)
└── {rootId} (document: main | prod | staging | exec)
    │
    ├── contentos_contents (subcollection)
    │   └── {contentId} (documents)
    │
    ├── contentos_publishes (subcollection)
    │   └── {publishId} (documents)
    │
    ├── contentos_assets (subcollection)
    │   └── {assetId} (documents)
    │
    ├── vault_projects (subcollection)
    │   └── {projectId} (documents)
    │
    ├── vault_tasks (subcollection)
    │   └── {taskId} (documents)
    │
    ├── vault_pending_reviews (subcollection)
    │   └── {reviewId} (documents)
    │
    ├── kpi_defs (subcollection)
    │   └── {kpiId} (documents)
    │
    └── kpi_rollups (subcollection)
        └── {scopeId} (document)
            └── days (subcollection)
                └── {yyyyMMdd} (documents)
```

---

## Subcollections Schema

### 1. contentos_contents

**Purpose**: 콘텐츠 후보 관리 (키워드 분석, 영상 스코어링)

**Document ID**: Auto-generated by Firestore or custom `cnt-{NNN}`

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `type` | string | ❌ | 콘텐츠 타입 (향후 확장) | `"youtube"`, `"blog"`, `"shorts"`, `"newsletter"` |
| `owner` | string | ❌ | 담당자 (향후 권한 관리용) | `"김은향"` |
| `tags` | array | ❌ | 분류 태그 | `["스트레칭", "오피스"]` |
| `keyword` | string | ✅ | 검색 키워드 | `"5분 스트레칭"` |
| `videoId` | string | ✅ (legacy) | YouTube 영상 ID (deprecated: use source.youtube.videoId) | `"dQw4w9WgXcQ"` |
| `title` | string | ✅ | 영상/콘텐츠 제목 | `"앉아서 하는 5분 스트레칭"` |
| `channelName` | string | ✅ (legacy) | 채널 이름 (deprecated: use source.youtube.channelName) | `"힐링타임"` |
| `source` | map | ❌ | 플랫폼별 소스 메타데이터 (향후 표준) | `{"youtube": {"videoId": "...", "channelName": "..."}}` |
| `marketScore` | number | ✅ | 시장 점수 (0-100) | `85.5` |
| `fitScore` | number | ✅ | 적합도 점수 (0-100) | `92.0` |
| `saturation` | number | ✅ | 포화도 (0-1) | `0.35` |
| `finalScore` | number | ✅ | 최종 점수 (marketScore × fitScore × (1-saturation)) | `51.7` |
| `status` | string | ✅ | 상태 | `"candidate"`, `"selected"`, `"rejected"` |
| `metadata` | map | ❌ | 추가 메타데이터 (조회수, 좋아요 등) | `{"views": 125000, "likes": 3500}` |
| `createdAt` | timestamp | ✅ | 생성 시각 | `2026-01-06T10:30:00Z` |
| `updatedAt` | timestamp | ✅ | 수정 시각 | `2026-01-06T11:00:00Z` |

**Indexes**:
- `finalScore DESC, createdAt DESC` - 점수 기반 정렬
- `status ASC, finalScore DESC` - 상태별 정렬

**Example Document (Legacy Format - Current)**:
```json
{
  "keyword": "5분 스트레칭",
  "videoId": "dQw4w9WgXcQ",
  "title": "앉아서 하는 5분 스트레칭",
  "channelName": "힐링타임",
  "marketScore": 85.5,
  "fitScore": 92.0,
  "saturation": 0.35,
  "finalScore": 51.7,
  "status": "candidate",
  "metadata": {
    "views": 125000,
    "likes": 3500,
    "duration": "PT5M30S"
  },
  "createdAt": "2026-01-06T10:30:00Z",
  "updatedAt": "2026-01-06T11:00:00Z"
}
```

**Example Document (Future Format - with source map)**:
```json
{
  "type": "youtube",
  "owner": "김은향",
  "tags": ["스트레칭", "오피스"],
  "keyword": "5분 스트레칭",
  "title": "앉아서 하는 5분 스트레칭",
  "source": {
    "youtube": {
      "videoId": "dQw4w9WgXcQ",
      "channelName": "힐링타임",
      "views": 125000,
      "likes": 3500,
      "duration": "PT5M30S"
    }
  },
  "marketScore": 85.5,
  "fitScore": 92.0,
  "saturation": 0.35,
  "finalScore": 51.7,
  "status": "candidate",
  "createdAt": "2026-01-06T10:30:00Z",
  "updatedAt": "2026-01-06T11:00:00Z"
}
```

**Migration Notes**:
- **Backward Compatibility**: Legacy `videoId`/`channelName` fields remain valid
- **Future Migration**: New documents should use `source.youtube.*` structure
- **Multi-platform Support**: `source.blog`, `source.shorts` structures for future expansion
- **Security**: `owner` field for future permission enforcement (currently not enforced)
- **Validation**: Current rules validate legacy format; update `isValidContent()` when migrating

---

### 2. contentos_publishes

**Purpose**: 발행 기록 및 YouTube 업로드 메타데이터

**Document ID**: Auto-generated or `pub-{NNN}`

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `contentId` | string | ✅ | 참조할 contentos_contents 문서 ID | `"cnt-001"` |
| `youtubeVideoId` | string | ✅ (현재) | 업로드된 YouTube 영상 ID<br>**Note**: 현재 validation rule에서 필수. queued/running 상태에서는 placeholder 값 사용 필요 | `"xyz123abc"` or `"pending"` |
| `publishedAt` | timestamp | ✅ (현재) | 발행 시각<br>**Note**: 현재 validation rule에서 필수. queued/running 상태에서는 예상 시각 사용 필요 | `2026-01-10T09:00:00Z` |
| `status` | string | ✅ | 발행 상태 | Legacy: `"published"`, `"scheduled"`, `"failed"`<br>New: `"queued"`, `"running"`, `"success"`, `"failed"` |
| `scheduledAt` | timestamp | ❌ | 예약 시각 (queued 상태 시) | `2026-01-10T08:00:00Z` |
| `executedAt` | timestamp | ❌ | 실행 완료 시각 (success/failed 시) | `2026-01-10T09:05:00Z` |
| `externalUrl` | string | ❌ | 발행된 외부 URL | `"https://youtu.be/xyz123abc"` |
| `platformId` | string | ❌ | 타겟 플랫폼 ID | `"youtube"`, `"tiktok"`, `"instagram"` |
| `views` | number | ❌ | 조회수 (업데이트 가능) | `5420` |
| `ctr` | number | ❌ | 클릭률 (0-1) | `0.12` |
| `avgViewDuration` | number | ❌ | 평균 시청 시간 (초) | `180.5` |
| `likes` | number | ❌ | 좋아요 수 | `320` |
| `comments` | number | ❌ | 댓글 수 | `45` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"thumbnail_url": "https://..."}` |
| `createdAt` | timestamp | ✅ | 생성 시각 | `2026-01-10T09:00:00Z` |
| `updatedAt` | timestamp | ✅ | 수정 시각 | `2026-01-10T12:00:00Z` |

**Indexes**:
- `publishedAt DESC` - 최근 발행 순
- `status ASC, publishedAt DESC` - 상태별 최근 발행 순
- `views DESC` - 조회수 순

**Example Document (Legacy Format)**:
```json
{
  "contentId": "cnt-001",
  "youtubeVideoId": "xyz123abc",
  "publishedAt": "2026-01-10T09:00:00Z",
  "status": "published",
  "views": 5420,
  "ctr": 0.12,
  "avgViewDuration": 180.5,
  "likes": 320,
  "comments": 45,
  "metadata": {
    "thumbnail_url": "https://i.ytimg.com/vi/xyz123abc/maxresdefault.jpg",
    "description": "앉아서 하는 5분 스트레칭 루틴"
  },
  "createdAt": "2026-01-10T09:00:00Z",
  "updatedAt": "2026-01-10T12:00:00Z"
}
```

**Example Document (New Workflow Format)**:
```json
{
  "contentId": "cnt-001",
  "youtubeVideoId": "xyz123abc",
  "platformId": "youtube",
  "status": "success",
  "scheduledAt": "2026-01-10T08:00:00Z",
  "executedAt": "2026-01-10T09:05:00Z",
  "publishedAt": "2026-01-10T09:00:00Z",
  "externalUrl": "https://youtu.be/xyz123abc",
  "views": 5420,
  "ctr": 0.12,
  "avgViewDuration": 180.5,
  "likes": 320,
  "comments": 45,
  "metadata": {
    "thumbnail_url": "https://i.ytimg.com/vi/xyz123abc/maxresdefault.jpg",
    "description": "앉아서 하는 5분 스트레칭 루틴"
  },
  "createdAt": "2026-01-10T08:00:00Z",
  "updatedAt": "2026-01-10T12:00:00Z"
}
```

**State Transition Diagram**:
```
queued → running → success
              ↘ failed

Legacy mapping:
- scheduled → queued
- published → success
- failed → failed (unchanged)
```

**Migration Notes**:
- **Backward Compatibility**: Legacy status values (`published`, `scheduled`, `failed`) remain valid
- **New Workflow**: Use `queued → running → success/failed` for automated publishing pipelines
- **Required Fields**:
  - `youtubeVideoId` and `publishedAt` are currently REQUIRED by validation rules
  - For `queued`/`running` states: use placeholder values (e.g., `"pending"`) or scheduled time
  - **Future**: Update `isValidPublish()` to make these fields optional for pre-publish states
- **Optional Fields**: `scheduledAt`, `executedAt`, `externalUrl`, `platformId` only for new workflow
- **Validation**: `isValidPublish()` accepts both legacy and new status values
- **Query Updates**: Update queries filtering `status == 'published'` to include `'success'`

---

### 3. contentos_assets

**Purpose**: 미디어 자산 관리 (썸네일, 스크립트, 영상 파일)

**Document ID**: Auto-generated or `ast-{NNN}`

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `type` | string | ✅ | 자산 타입 | `"thumbnail"`, `"script"`, `"video"`, `"audio"` |
| `url` | string | ✅ | 자산 URL (Firebase Storage 또는 외부) | `"gs://bucket/thumbnails/thumb-001.jpg"` |
| `contentId` | string | ❌ | 연관된 contentos_contents 문서 ID | `"cnt-001"` |
| `publishId` | string | ❌ | 연관된 contentos_publishes 문서 ID | `"pub-001"` |
| `filename` | string | ✅ | 파일명 | `"thumb-001.jpg"` |
| `mimeType` | string | ✅ | MIME 타입 | `"image/jpeg"` |
| `size` | number | ❌ | 파일 크기 (bytes) | `245678` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"width": 1920, "height": 1080}` |
| `createdAt` | timestamp | ✅ | 생성 시각 | `2026-01-08T14:00:00Z` |
| `updatedAt` | timestamp | ✅ | 수정 시각 | `2026-01-08T14:00:00Z` |

**Indexes**:
- `contentId ASC, type ASC` - 콘텐츠별 자산 조회
- `type ASC, createdAt DESC` - 타입별 최신 자산 조회

**Example Document**:
```json
{
  "type": "thumbnail",
  "url": "gs://sosi-4a8ee.appspot.com/contentos/thumbnails/thumb-001.jpg",
  "contentId": "cnt-001",
  "publishId": "pub-001",
  "filename": "thumb-001.jpg",
  "mimeType": "image/jpeg",
  "size": 245678,
  "metadata": {
    "width": 1920,
    "height": 1080,
    "generator": "dalle-3"
  },
  "createdAt": "2026-01-08T14:00:00Z",
  "updatedAt": "2026-01-08T14:00:00Z"
}
```

---

### 4. vault_projects

**Purpose**: LOOP Vault Project 동기화 (읽기 전용)

**Document ID**: Project entity_id (e.g., `prj-003`)

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `entity_id` | string | ✅ | Project ID | `"prj-003"` |
| `entity_name` | string | ✅ | Project 이름 | `"CoachOS - 프로토타입 개발"` |
| `status` | string | ✅ | 상태 | `"active"`, `"done"`, `"cancelled"` |
| `owner` | string | ✅ | 담당자 | `"김은향"` |
| `parent_id` | string | ❌ | 상위 Track ID | `"trk-6"` |
| `program_id` | string | ❌ | Program ID | `"pgm-content-os"` |
| `start_date` | string | ❌ | 시작일 (YYYY-MM-DD) | `"2026-01-01"` |
| `end_date` | string | ❌ | 종료일 (YYYY-MM-DD) | `"2026-03-31"` |
| `validates` | array | ❌ | 검증할 Hypothesis IDs | `["hyp-6-01", "hyp-6-02"]` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"priority": "high"}` |
| `syncedAt` | timestamp | ✅ | 마지막 동기화 시각 | `2026-01-06T15:00:00Z` |

**Indexes**:
- `status ASC, owner ASC` - 상태별, 담당자별 조회
- `syncedAt DESC` - 최근 동기화 순

**Example Document**:
```json
{
  "entity_id": "prj-003",
  "entity_name": "CoachOS - 프로토타입 개발",
  "status": "active",
  "owner": "김은향",
  "parent_id": "trk-6",
  "program_id": "pgm-content-os",
  "start_date": "2026-01-01",
  "end_date": "2026-03-31",
  "validates": ["hyp-6-01", "hyp-6-02"],
  "metadata": {
    "priority": "high",
    "team_size": 3
  },
  "syncedAt": "2026-01-06T15:00:00Z"
}
```

---

### 5. vault_tasks

**Purpose**: LOOP Vault Task 동기화 (읽기 전용)

**Document ID**: Task entity_id (e.g., `tsk-003-01`)

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `entity_id` | string | ✅ | Task ID | `"tsk-003-01"` |
| `entity_name` | string | ✅ | Task 이름 | `"CoachOS - 데이터 모델 설계"` |
| `project_id` | string | ✅ | 소속 Project ID | `"prj-003"` |
| `status` | string | ✅ | 상태 | `"todo"`, `"doing"`, `"done"`, `"blocked"` |
| `assignee` | string | ✅ | 담당자 | `"김은향"` |
| `start_date` | string | ❌ | 시작일 (YYYY-MM-DD) | `"2026-01-06"` |
| `due` | string | ❌ | 마감일 (YYYY-MM-DD) | `"2026-01-10"` |
| `priority` | string | ❌ | 우선순위 | `"high"`, `"medium"`, `"low"` |
| `type` | string | ❌ | Task 타입 | `"dev"`, `"bug"`, `"research"`, `"ops"` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"estimated_hours": 8}` |
| `syncedAt` | timestamp | ✅ | 마지막 동기화 시각 | `2026-01-06T15:00:00Z` |

**Indexes**:
- `status ASC, assignee ASC` - 상태별, 담당자별 조회
- `project_id ASC, status ASC` - 프로젝트별 Task 조회
- `due ASC` - 마감일 순

**Example Document**:
```json
{
  "entity_id": "tsk-003-01",
  "entity_name": "CoachOS - 데이터 모델 설계",
  "project_id": "prj-003",
  "status": "doing",
  "assignee": "김은향",
  "start_date": "2026-01-06",
  "due": "2026-01-10",
  "priority": "high",
  "type": "dev",
  "metadata": {
    "estimated_hours": 8,
    "actual_hours": 5
  },
  "syncedAt": "2026-01-06T15:00:00Z"
}
```

---

### 6. vault_pending_reviews

**Purpose**: Pending Review 동기화 (LLM 제안 대기)

**Document ID**: Auto-generated or review ID

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `entity_type` | string | ✅ | 엔티티 타입 | `"Project"`, `"Task"`, `"Hypothesis"` |
| `entity_id` | string | ✅ | 엔티티 ID | `"prj-003"` |
| `reason` | string | ✅ | 검토 사유 | `"impact_autofill_suggestion"` |
| `suggested_changes` | map | ✅ | 제안된 변경사항 | `{"tier": "L2", "magnitude": "M"}` |
| `status` | string | ✅ | 상태 | `"pending"`, `"approved"`, `"rejected"` |
| `created_by` | string | ✅ | 생성자 | `"n8n-autofill-workflow"` |
| `source_workflow` | string | ❌ | n8n 워크플로우 ID | `"impact-autofill-v1"` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"confidence": 0.85}` |
| `createdAt` | timestamp | ✅ | 생성 시각 | `2026-01-06T16:00:00Z` |
| `reviewedAt` | timestamp | ❌ | 검토 시각 | `2026-01-06T17:00:00Z` |
| `reviewer` | string | ❌ | 검토자 | `"김은향"` |

**Indexes**:
- `status ASC, createdAt DESC` - 상태별 최근 순
- `entity_id ASC, status ASC` - 엔티티별 리뷰 조회

**Example Document**:
```json
{
  "entity_type": "Project",
  "entity_id": "prj-003",
  "reason": "impact_autofill_suggestion",
  "suggested_changes": {
    "tier": "L2",
    "magnitude": "M",
    "confidence": "medium"
  },
  "status": "pending",
  "created_by": "n8n-autofill-workflow",
  "source_workflow": "impact-autofill-v1",
  "metadata": {
    "llm_confidence": 0.85,
    "model": "claude-sonnet-4"
  },
  "createdAt": "2026-01-06T16:00:00Z"
}
```

---

### 7. kpi_defs

**Purpose**: KPI 정의 (메트릭, 타겟, 윈도우)

**Document ID**: KPI ID (e.g., `kpi-revenue-monthly`)

**Fields**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `name` | string | ✅ | KPI 이름 | `"월 매출"` |
| `metric` | string | ✅ | 메트릭 키 | `"revenue"` |
| `target` | number | ✅ | 목표값 | `5000000` |
| `unit` | string | ✅ | 단위 | `"KRW"`, `"USD"`, `"count"` |
| `window` | string | ✅ | 집계 윈도우 | `"monthly"`, `"weekly"`, `"daily"` |
| `tier` | string | ❌ | 티어 구분 | `"L1"`, `"L2"`, `"L3"` |
| `description` | string | ❌ | 설명 | `"앱 내 월 총 매출 (구독+인앱)"` |
| `metadata` | map | ❌ | 추가 메타데이터 | `{"source": "RevenueCat"}` |
| `createdAt` | timestamp | ✅ | 생성 시각 | `2026-01-01T00:00:00Z` |
| `updatedAt` | timestamp | ✅ | 수정 시각 | `2026-01-06T00:00:00Z` |

**Indexes**:
- `tier ASC, metric ASC` - 티어별, 메트릭별 조회
- `window ASC` - 윈도우별 조회

**Example Document**:
```json
{
  "name": "월 매출",
  "metric": "revenue",
  "target": 5000000,
  "unit": "KRW",
  "window": "monthly",
  "tier": "L1",
  "description": "앱 내 월 총 매출 (구독+인앱 결제)",
  "metadata": {
    "source": "RevenueCat",
    "data_lag_days": 1
  },
  "createdAt": "2026-01-01T00:00:00Z",
  "updatedAt": "2026-01-06T00:00:00Z"
}
```

---

### 8. kpi_rollups

**Purpose**: KPI 집계 데이터 (일별 subcollection)

**Document ID**: Scope ID (e.g., `global`, `prj-003`, `trk-6`)

**Subcollection**: `days/{yyyyMMdd}`

**Fields (Parent Document)**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `scope` | string | ✅ | 집계 범위 | `"global"`, `"prj-003"`, `"trk-6"` |
| `created` | timestamp | ✅ | 생성 시각 | `2026-01-01T00:00:00Z` |

**Fields (days Subcollection Document)**:

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `date` | string | ✅ | 날짜 (YYYY-MM-DD) | `"2026-01-06"` |
| `metrics` | map | ✅ | 메트릭 데이터 | `{"revenue": 150000, "dau": 320}` |
| `computed` | timestamp | ✅ | 계산 시각 | `2026-01-07T02:00:00Z` |

**Indexes**:
- `kpi_rollups/{scopeId}/days`: `date DESC` - 날짜 역순

**Example Structure**:
```
kpi_rollups/
├── global/
│   ├── scope: "global"
│   ├── created: 2026-01-01T00:00:00Z
│   └── days/
│       ├── 20260106/
│       │   ├── date: "2026-01-06"
│       │   ├── metrics: {"revenue": 150000, "dau": 320, "arpu": 468.75}
│       │   └── computed: 2026-01-07T02:00:00Z
│       └── 20260105/
│           ├── date: "2026-01-05"
│           ├── metrics: {"revenue": 140000, "dau": 310, "arpu": 451.61}
│           └── computed: 2026-01-06T02:00:00Z
└── prj-003/
    ├── scope: "prj-003"
    ├── created: 2026-01-01T00:00:00Z
    └── days/
        └── 20260106/
            ├── date: "2026-01-06"
            ├── metrics: {"task_completion": 0.75, "active_tasks": 4}
            └── computed: 2026-01-07T02:00:00Z
```

---

## Query Patterns

### 1. 최고 점수 콘텐츠 후보 조회
```javascript
db.collection('loop/main/contentos_contents')
  .where('status', '==', 'candidate')
  .orderBy('finalScore', 'desc')
  .limit(10)
```

### 2. 특정 프로젝트의 Task 조회
```javascript
db.collection('loop/main/vault_tasks')
  .where('project_id', '==', 'prj-003')
  .where('status', '==', 'doing')
  .orderBy('due', 'asc')
```

### 3. Pending Review 조회
```javascript
db.collection('loop/main/vault_pending_reviews')
  .where('status', '==', 'pending')
  .orderBy('createdAt', 'desc')
  .limit(20)
```

### 4. 최근 발행 영상 성과 조회
```javascript
// Note: Include both legacy 'published' and new 'success' status
db.collection('loop/main/contentos_publishes')
  .where('status', 'in', ['published', 'success'])
  .orderBy('publishedAt', 'desc')
  .orderBy('views', 'desc')
  .limit(10)
```

### 5. KPI 일별 데이터 조회 (최근 7일)
```javascript
db.collection('loop/main/kpi_rollups/global/days')
  .orderBy('date', 'desc')
  .limit(7)
```

---

## Security Considerations

1. **Authentication**: Firebase Admin SDK 서비스 계정 사용 (서버 측만)
2. **Authorization**: Firestore Security Rules로 접근 제어 (별도 파일 참조)
3. **Data Validation**: 클라이언트/서버 양측에서 스키마 검증
4. **Sensitive Data**: exec vault 데이터는 Firestore에 저장하지 않음 (접근 제어 불가능)

---

## Migration Notes

- **Initial Setup**: 수동으로 `loop/main` 문서 생성 필요
- **Sync Strategy**: n8n 워크플로우로 LOOP Vault → Firestore 동기화
- **Backup**: Firebase 자동 백업 활성화 권장
- **Testing**: 프로덕션 적용 전 Firestore Emulator 사용

---

## Related Files

- `firestore.rules` - Firestore Security Rules
- `firestore.indexes.json` - Composite Indexes 정의
- `exec/sosi-4a8ee-firebase-adminsdk-3ds3s-3eae8a3e2d.json` - Service Account Key (민감)

---

**Created**: 2026-01-06
**Last Updated**: 2026-01-06
**Version**: 1.0
