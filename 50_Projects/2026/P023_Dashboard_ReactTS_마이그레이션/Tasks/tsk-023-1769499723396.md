---
entity_type: Task
entity_id: tsk-023-1769499723396
entity_name: Hypothesis API - parent-child hierarchy 기능 추가
created: '2026-01-27'
updated: '2026-01-27'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
tags: []
type: dev
aliases:
- tsk-023-1769499723396
start_date: '2026-01-27'
due: '2026-01-27'
---

# Hypothesis API - parent-child hierarchy 기능 추가

## Notes

### Summary
Hypothesis 엔티티 간 부모-자식 관계를 표현하는 parent_hypothesis_id 필드를 추가하고, API에 필터/트리 조회 기능을 구현함.

### Changes Made
- `api/models/entities.py`: HypothesisUpdate에 parent_hypothesis_id 필드 추가
- `api/routers/hypotheses.py`: GET 필터(parent_hypothesis_id, has_parent), child_hypotheses 응답, tree 엔드포인트 추가 (+144 lines)
- `scripts/validate_schema.py` (v7.4): 패턴 검증, 순환 참조 검사, 존재 여부 검증 (+146 lines)
- `public/00_Meta/schema_constants.yaml`: v5.16으로 업데이트 (known_fields, writable_fields, derived_fields)
- `public/00_Meta/SSOT_CONTRACT.md`: v1.5 - Section 14 가설 위계 규칙 추가

### Plan
# Plan: Hypothesis 상위 가설 연결 기능

## 목표
Hypothesis 엔티티 간 부모-자식 관계를 추가하여 가설 위계를 표현할 수 있게 함.

## 설계 결정
- **Kind 위계**: Flexible (같은 kind + 상위 kind 모두 허용)
- **Track 제약**: Cross-Track 허용 (다른 Track 가설도 부모로 가능)
- **SSOT 원칙**: `parent_hypothesis_id`만 저장, `child_hypotheses`는 Derived

---

## 1. Schema 변경 (schema_constants.yaml)

### 1.1 known_fields.Hypothesis에 추가
```yaml
Hypothesis:
  - parent_hypothesis_id   # 상위 가설 ID (hyp-*), 선택 필드
```

### 1.2 writable_fields.Hypothesis에 추가
```yaml
Hypothesis:
  - parent_hypothesis_id   # API에서 수정 가능
```

### 1.3 validation_rules.derived_fields에 추가
```yaml
Hypothesis:
  - validated_by           # 기존
  - child_hypotheses       # 신규 (역인덱스로 계산)
```

### 1.4 버전 업데이트
```yaml
schema_version: "5.16"
last_updated: "2026-01-27"
# v5.16: Hypothesis.parent_hypothesis_id 추가 (가설 간 위계 지원)
```

---

## 2. 검증 규칙 (validate_schema.py)

### 2.1 parent_hypothesis_id 패턴 검증
```python
if parent_hypothesis_id:
    if not re.match(r'^hyp-[1-6]-\d{2}$', parent_hypothesis_id):
        ERROR: "Invalid parent_hypothesis_id format"
```

### 2.2 순환 참조 방지
```python
def check_cycle(hyp_id, parent_id, all_hypotheses):
    visited = {hyp_id}
    current = parent_id
    while current:
        if current in visited:
            ERROR: f"Circular reference detected: {hyp_id} -> {current}"
        visited.add(current)
        current = all_hypotheses.get(current, {}).get('parent_hypothesis_id')
```

### 2.3 존재 여부 검증
```python
if parent_hypothesis_id:
    if parent_hypothesis_id not in all_hypothesis_ids:
        ERROR: f"parent_hypothesis_id {parent_hypothesis_id} does not exist"
```

---

## 3. API 변경 (code/api/routers/hypotheses.py)

### 3.1 GET /hypotheses 필터 추가
- `parent_hypothesis_id`: 특정 상위 가설의 자식만 조회
- `has_parent`: boolean - 부모 있는 가설만/없는 가설만

### 3.2 GET /hypotheses/{id} 응답 확장
```json
{
  "entity_id": "hyp-1-05",
  "parent_hypothesis_id": "hyp-1-01",
  "child_hypotheses": ["hyp-1-10", "hyp-1-11"]  // Derived
}
```

### 3.3 GET /hypotheses/{id}/tree (신규)
- 특정 가설의 상위/하위 트리 전체 반환

---

## 4. 수정 대상 파일

| 파일 | 변경 내용 |
|------|----------|
| `public/00_Meta/schema_constants.yaml` | known_fields, writable_fields, derived_fields 추가 |
| `code/scripts/validate_schema.py` | 순환 참조 검증, 패턴 검증 추가 |
| `code/api/routers/hypotheses.py` | 필터, 응답 확장, tree 엔드포인트 |
| `public/00_Meta/_template_hypothesis.md` | parent_hypothesis_id 필드 추가 |
| `public/00_Meta/SSOT_CONTRACT.md` | 가설 위계 규칙 문서화 |

---

## 5. 마이그레이션

### 5.1 기존 가설
- `parent_hypothesis_id: null` (기본값)
- 점진적으로 관계 추가 가능

### 5.2 호환성
- 기존 API 응답에 영향 없음 (새 필드 추가만)
- 기존 가설 파일 수정 불필요

---

## 6. 검증 계획

1. schema_constants.yaml 수정 후 `validate_schema.py` 실행
2. 테스트 가설 2개에 parent_hypothesis_id 추가
3. API 엔드포인트 테스트 (GET /hypotheses?parent_hypothesis_id=hyp-1-01)
4. 순환 참조 시도 → 에러 확인

---

## 예시: 적용 후 가설 구조

```yaml
# hyp-1-01 (Signal) - 루트 가설
entity_id: hyp-1-01
hypothesis_kind: signal
parent_hypothesis_id: null  # 최상위

# hyp-1-05 (Adoption) - hyp-1-01의 자식
entity_id: hyp-1-05
hypothesis_kind: adoption
parent_hypothesis_id: hyp-1-01

# hyp-1-10 (Impact) - hyp-1-05의 자식
entity_id: hyp-1-10
hypothesis_kind: impact
parent_hypothesis_id: hyp-1-05

# hyp-2-03 (Signal) - Cross-Track, hyp-1-01의 자식 가능
entity_id: hyp-2-03
hypothesis_kind: signal
parent_hypothesis_id: hyp-1-01  # Track 2지만 Track 1 가설을 부모로
```
