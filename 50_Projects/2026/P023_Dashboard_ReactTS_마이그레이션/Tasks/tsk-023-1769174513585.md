---
entity_type: Task
entity_id: tsk-023-1769174513585
entity_name: Content OS - YouTube Intro Retention 30초 시청률 수집 시스템 구현
created: '2026-01-23'
updated: '2026-01-23'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
tags: []
type: dev
aliases:
- tsk-023-1769174513585
start_date: '2026-01-23'
due: '2026-01-23'
---

# Content OS - YouTube Intro Retention 30초 시청률 수집 시스템 구현

## Notes

### Summary
YouTube 영상별 첫 30초 시청률(audienceWatchRatio)을 수집하여 Firestore에 저장하고 시계열 추적하는 시스템 구현. Backend API + Frontend feature 모듈 완료.

### Changes Made
- `api/models/firebase_models.py`: Pydantic 모델 추가 (VideoIntroRetention, RetentionDataPoint 등)
- `api/services/firebase_service.py`: Firebase 컬렉션 헬퍼 추가
- `api/routers/content_os/intro_retention.py`: 라우터 생성 (collect, list, get endpoints)
- `api/main.py`: 라우터 등록
- `dashboard-v2/src/types/content-os.ts`: TypeScript 타입 추가
- `dashboard-v2/src/queries/keys.ts`: Query Key 추가
- `dashboard-v2/src/features/content-os/intro-retention/`: Feature 모듈 생성
  - `api.ts` - HTTP 클라이언트 함수
  - `queries.ts` - React Query hooks
  - `components/RetentionBadge.tsx` - 시각 컴포넌트

### Plan
# YouTube Intro Retention (30초 시청률) 데이터 수집 시스템

## 목표
영상별 첫 30초 시청률(audienceWatchRatio)을 수집하고 기간별로 축적하여 시계열 추적

## YouTube Analytics API 사용

```
GET /v2/reports
  dimensions=elapsedVideoTimeRatio
  metrics=audienceWatchRatio,relativeRetentionPerformance
  filters=video=={VIDEO_ID};audienceType==ORGANIC
```

- 영상당 100개 데이터 포인트 (0.01~1.0)
- 제약: 한 번에 1개 video ID만 필터 가능

---

## 1. 데이터 모델

### Firestore 스키마
**Collection**: `loop/main/contentos_intro_retention`
**Document ID**: `{videoId}`

```
{
  videoId: string,
  title: string,
  duration: number,           // 영상 길이 (초)
  publishedAt: string,        // YYYY-MM-DD

  retentionHistory: {
    "2026-01-23": {
      capturedAt: string,     // ISO timestamp
      retention30s: float,    // 0.0~1.0
      relativePerformance30s?: float,
      audienceType: "ORGANIC"
    }
  },

  latestRetention30s: float,  // 최신값 (빠른 조회용)
  latestCapturedAt: string,
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

### TypeScript 타입 (추가)
**파일**: `dashboard-v2/src/types/content-os.ts`

```typescript
export interface RetentionDataPoint {
  capturedAt: string;
  retention30s: number;
  relativePerformance30s?: number;
  audienceType: 'ORGANIC' | 'ALL';
}

export interface VideoIntroRetention {
  videoId: string;
  title: string;
  duration: number;
  publishedAt: string;
  retentionHistory: Record<string, RetentionDataPoint>;
  latestRetention30s: number;
  latestCapturedAt: string;
}

export interface IntroRetentionCollectRequest {
  videoIds: string[];
  audienceType?: 'ORGANIC' | 'ALL';
}

export interface IntroRetentionCollectResult {
  success: boolean;
  collected: number;
  failed: number;
  errors?: Array<{ videoId: string; error: string }>;
}
```

---

## 2. API 엔드포인트

**파일**: `api/routers/content_os/intro_retention.py`

| Method | Path | 설명 |
|--------|------|------|
| POST | `/api/content-os/intro-retention/collect` | 영상 배치 수집 |
| GET | `/api/content-os/intro-retention` | 목록 조회 |
| GET | `/api/content-os/intro-retention/{videoId}` | 단일 영상 조회 |

### 30초 지점 계산 로직

```python
def calculate_30s_retention(retention_curve, video_duration):
    if video_duration <= 30:
        return retention_curve[-1][1]  # 영상이 30초 미만이면 끝 값

    target_ratio = 30 / video_duration  # 예: 120초 영상 → 0.25
    # retention_curve에서 해당 ratio 지점의 값 보간
```

---

## 3. 구현 파일 목록

### Backend (api/)
1. `api/models/firebase_models.py` - Pydantic 모델 추가
2. `api/services/firebase_service.py` - 컬렉션 헬퍼 추가
3. `api/routers/content_os/intro_retention.py` - 신규 라우터
4. `api/routers/content_os/__init__.py` - 라우터 등록

### Frontend (dashboard-v2/)
1. `src/types/content-os.ts` - TypeScript 타입 추가
2. `src/queries/keys.ts` - Query Key 추가
3. `src/features/content-os/intro-retention/` - 신규 feature 모듈
   - `api.ts`
   - `queries.ts`
   - `components/RetentionBadge.tsx`

---

## 4. 구현 순서

### Phase 1: Backend
1. Pydantic 모델 정의 (`firebase_models.py`)
2. Firebase 컬렉션 헬퍼 (`firebase_service.py`)
3. intro_retention.py 라우터 생성
   - YouTube Analytics API 호출
   - 30초 지점 계산
   - Firestore 저장
4. `__init__.py`에 라우터 등록

### Phase 2: Frontend
1. TypeScript 타입 추가
2. Query Key 추가
3. Feature 모듈 생성 (api.ts, queries.ts)
4. RetentionBadge 컴포넌트

### Phase 3: 통합
1. Performance 페이지에 retention 컬럼 추가
2. 수집 버튼 추가

---

## 5. 검증 방법

1. **API 테스트**
   ```bash
   # 수집 테스트
   curl -X POST https://mcp.sosilab.synology.me/api/content-os/intro-retention/collect \
     -H "Content-Type: application/json" \
     -d '{"videoIds": ["VIDEO_ID"]}'

   # 조회 테스트
   curl https://mcp.sosilab.synology.me/api/content-os/intro-retention
   ```

2. **Firestore 확인**
   - Firebase Console에서 `contentos_intro_retention` 컬렉션 확인

3. **Frontend 확인**
   - Performance 페이지에서 retention 배지 표시 확인

---

## 6. 주의사항

- **API 쿼터**: 영상당 1회 호출 필요 (일일 10,000 제한)
- **배치 크기**: 한 번에 50개 이하 권장 (rate limit)
- **캐시**: 24시간 내 재수집 스킵 로직 추가
