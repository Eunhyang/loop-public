---
entity_type: Task
entity_id: tsk-023-1768817911261
entity_name: AI 추론 버그 수정 - 프론트엔드 description 무시 문제
created: '2026-01-19'
updated: '2026-01-19'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-19'
due: '2026-01-19'
aliases:
- tsk-023-1768817911261
tags: []
type: dev
---

# AI 추론 버그 수정 - 프론트엔드 description 무시 문제

## Notes

### Summary
Project drawer의 AI 추론 버튼들이 프론트엔드에서 보낸 description을 무시하고 캐시 데이터만 사용하던 버그 수정. 추가로 시스템 프롬프트의 하드코딩된 Condition/Track 매핑 제거.

### Changes Made
- `api/routers/ai/utils.py`: `get_entity_with_frontend_override()` 공통 함수 추가
- `api/routers/ai/multi.py`: multi-dock, project-summary 엔드포인트에 적용
- `api/routers/ai/hypothesis.py`: hypothesis-map, hypothesis-seed 엔드포인트에 적용
- `api/routers/ai/impact.py`: expected-impact 엔드포인트에 적용
- `api/prompts/project_summary.py`: 하드코딩된 Condition/Track 매핑 제거, 컨텍스트 기반으로 변경

### Commit
```
b8cc854a6 fix(api): use frontend form data for AI inference instead of stale cache
```

### Plan

# Plan: Project Summary 버튼 버그 수정

## 문제 요약

Project drawer의 "요약" 버튼이 잘못된 요약을 생성함:
- "CondD(효율)" 표시 → 실제는 "CondD(Runway)"
- "전면 유료화" 같은 관련없는 내용 생성

## 근본 원인 (2가지)

### 원인 1: 프론트엔드 description 무시
`api/routers/ai/multi.py` (lines 137-140)에서:
```python
if request.entity_id:
    project = get_project_by_id(request.entity_id)  # 캐시에서 가져옴!
else:
    project = {"entity_name": request.entity_name, "description": request.entity_description}
```
- 기존 프로젝트(edit 모드)일 때 **프론트엔드가 보낸 entity_description이 무시됨**
- 캐시된 프로젝트 데이터만 사용 → 최신 폼 데이터 반영 안됨

### 원인 2: 시스템 프롬프트 하드코딩
`api/prompts/project_summary.py`의 시스템 프롬프트에 **하드코딩된 Condition 이름이 실제 vault와 불일치**

### 현재 하드코딩 (lines 22, 117-121)
```
- cond-a: CondA(가치입증) - 핵심 가치 검증, 수익 모델
- cond-b: CondB(데이터) - 데이터 수집, 분석, AI
- cond-c: CondC(채널) - 마케팅, 유통, 파트너십
- cond-d: CondD(효율) - 운영 효율, 자동화
- cond-e: CondE(팀) - 채용, 조직, 역량
```

### 실제 vault 정의
```
- cond-a: Condition_A_PMF (국내 PMF) - 정서–섭식–습관 루프 검증
- cond-b: Condition_B_Loop_Dataset - Loop 데이터셋 구축
- cond-c: Condition_C_Global_Data - 글로벌 데이터 확보
- cond-d: Condition_D_Runway - 월 매출/런웨이 확보
- cond-e: Condition_E_Team - 핵심 팀 구성
```

또한 예시 문장 `"CondA(가치입증)에서 앱 전면 유료화를 테스트해"`가 LLM에 영향을 주어 관련없는 "전면 유료화" 텍스트 생성

## 수정 계획

### 변경 파일
- `api/routers/ai/multi.py` (원인 1 수정)
- `api/prompts/project_summary.py` (원인 2 수정)

### 수정 내용

#### Fix 1: multi.py - 프론트엔드 description 반영

```python
# 변경 전 (lines 137-140)
if request.entity_id:
    project = get_project_by_id(request.entity_id)
else:
    project = {"entity_name": request.entity_name, "description": request.entity_description}

# 변경 후
if request.entity_id:
    project = get_project_by_id(request.entity_id) or {}
    # 프론트엔드에서 보낸 값이 있으면 우선 사용 (최신 폼 데이터 반영)
    if request.entity_name:
        project = {**project, "entity_name": request.entity_name}
    if request.entity_description:
        project = {**project, "description": request.entity_description}
else:
    project = {"entity_name": request.entity_name, "description": request.entity_description}
```

이렇게 하면 사용자가 폼에서 수정 중인 내용이 요약 생성에 반영됨.

#### Fix 2: project_summary.py - 하드코딩 제거

1. **시스템 프롬프트의 Condition 매핑 제거** (line 22)
   - 하드코딩된 Condition 이름 삭제
   - context에서 동적으로 전달되는 Condition 정보 사용하도록 안내

2. **Command 섹션의 Condition 매핑 제거** (lines 117-121)
   - 정적 매핑 삭제
   - "context에 포함된 Condition 정보를 참조하라"로 변경

3. **예시 문장 수정** (lines 27-29)
   - 특정 내용(전면 유료화 등)을 언급하는 예시 제거
   - 더 일반적인 형식 예시로 교체

4. **Track 매핑 검토** (lines 125-130)
   - Track도 vault와 일치하는지 확인 필요

### 수정 후 코드 구조

```python
PROJECT_SUMMARY_SYSTEM_PROMPT = """당신은 LOOP Vault 프로젝트를 처음 보는 사람이 5초 안에
"지금 우리가 전략적으로 어디를 전진시키는지"까지 이해하도록 요약하는 운영 편집자다.

## 문장 골격

[좌표] + 행동(verb) + 이유(한 토막)

좌표는 아래 전략 컨텍스트에서 제공되는 Track 또는 Condition을 사용합니다.
- Track: 상위 Track 정보 (parent_id로 연결됨)
- Condition: 관련 Condition 정보 (conditions_3y로 연결됨)

## 좋은 예시 (형식 참고용)

- "[Track/Condition 이름]에서 [구체적 행동]으로 [목적/이유]를 달성하는 프로젝트."

## 제약
...
"""
```

## 검증 방법

1. 로컬 API 서버 실행
2. Dashboard에서 프로젝트 열기
3. "요약" 버튼 클릭
4. 생성된 요약이 실제 Condition 이름(Runway, PMF 등)을 사용하는지 확인

## 대안 고려사항

더 근본적인 해결: Condition/Track 매핑을 시스템 프롬프트에서 완전히 제거하고, `build_project_summary_prompt`에서 캐시된 Condition/Track 목록을 동적으로 포맷하여 프롬프트에 포함. 하지만 현재 context_builder에서 이미 이 정보를 제공하므로, 시스템 프롬프트의 잘못된 하드코딩만 제거하면 충분함.
