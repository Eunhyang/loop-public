---
entity_type: Task
entity_id: tsk-023-1768107686217
entity_name: Dashboard - Pending Reviews 필터링 기능 수정
created: '2026-01-11'
updated: '2026-01-11'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-11'
due: '2026-01-11'
closed: '2026-01-11'
aliases:
- tsk-023-1768107686217
tags: []
type: dev
---

# Dashboard - Pending Reviews 필터링 기능 수정

> Task ID: `tsk-023-1768107686217` | Project: `prj-023` | Status: todo

## 목표

Pending Reviews 필터링 페이지의 두 드롭다운 기능을 수정:
1. **Workflow 필터**: n8n 워크플로우 이름별로 필터 (현재 비어있음)
2. **Run 필터**: "한 번 실행" 단위로 timestamp 기반 그룹화 (현재 수백 개 개별 run_id로 표시)

---

## 현재 상태 분석

### 문제점

1. **Workflow 드롭다운이 비어있음**
   - 코드에는 `source_workflow` 필드 저장 로직이 있음 (pending.py:321)
   - n8n 워크플로우도 source_workflow 전달하도록 설정됨
   - 실제 데이터에는 source_workflow가 저장되지 않고 있음
   - 원인: autofill API에서 pending 생성 시 source_workflow 파라미터 누락 (ai.py)

2. **Run ID가 세분화됨**
   - 현재: `run-20260111-060024-zsfx2u` 같은 개별 ID가 수백 개 나열됨
   - 원인: 각 entity마다 새로운 run_id 생성됨
   - 해결: timestamp 기반으로 그룹화 ("2026-01-11 06:00 (152건)")

---

## 구현 계획

### Step 1: 데이터 확인 (READ-ONLY)
```bash
curl -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/pending" | jq '.reviews[0]'
```
- source_workflow 필드 확인
- run_id 패턴 확인

### Step 2: source_workflow 저장 수정
**파일**: `api/routers/ai.py`
- autofill 엔드포인트에서 pending 생성 시 source_workflow 제대로 전달되는지 확인
- 필요시 파라미터 추가

### Step 3: timestamp 기반 Run 그룹화
**파일**: `_dashboard/js/components/pending-panel.js` - `updateFilterDropdowns()` 메서드

```javascript
// run_id 대신 timestamp 기반 그룹화
const runGroups = new Map(); // "2026-01-11 06:00" -> count
reviews.forEach(r => {
    if (r.created_at) {
        const ts = new Date(r.created_at);
        const key = ts.toISOString().slice(0, 16).replace('T', ' '); // "2026-01-11 06:00"
        runGroups.set(key, (runGroups.get(key) || 0) + 1);
    }
});

// 드롭다운 옵션: "2026-01-11 06:00 (152건)"
```

### Step 4: 필터 로직 수정
**파일**: `_dashboard/js/components/pending-panel.js` - `getFilteredReviews()` 메서드

```javascript
// created_at timestamp prefix로 필터
if (this.filterRunTimestamp) {
    reviews = reviews.filter(r => {
        const ts = new Date(r.created_at).toISOString().slice(0, 16).replace('T', ' ');
        return ts === this.filterRunTimestamp;
    });
}
```

### Step 5: 테스트 및 배포
- 로컬 테스트
- NAS 동기화
- Docker 재배포

---

## 수정 파일

| 파일 | 내용 |
|------|------|
| `api/routers/ai.py` | source_workflow 전달 확인/수정 |
| `_dashboard/js/components/pending-panel.js` | timestamp 기반 Run 그룹화 |

---

## 검증 기준

- [ ] Workflow 드롭다운에 n8n 워크플로우 이름들이 나타남
- [ ] Run 드롭다운에 timestamp 기반으로 그룹화되어 표시됨
- [ ] 필터 적용 시 해당 조건의 pending만 표시됨
- [ ] "Delete Filtered" 버튼으로 필터된 항목 일괄 삭제 가능

---

## Notes

- 결정사항 (사용자 선택)
  - Run ID 그룹화: timestamp 기반 (2026-01-11 06:00 (152건))
  - Workflow 이름: API 내부 이름 (entity-validator, hypothesis-seeder 등)

## Execution Log (2026-01-11)

### Plan Review
Codex identified 7 critical issues in initial plan:
- Missing rename coherence (filterRunId vs filterRunTimestamp)
- Backend mismatch risk (timestamp prefix vs exact run_id)
- Data loss for items without created_at
- Timezone handling (UTC vs local)
- Date parsing fragility

**Resolution**: Simplified approach - kept filterRunId name, pass explicit IDs to API, robust type checking

### Implementation
- Modified: 1 file (_dashboard/js/components/pending-panel.js)
- Key changes:
  1. updateFilterDropdowns(): Group by created_at timestamp (YYYY-MM-DD HH:MM)
  2. getFilteredReviews(): Filter by timestamp prefix matching
  3. deleteFiltered(): Pass explicit IDs array (no backend changes needed)
  4. Property: availableRunIds → availableRunTimestamps

### Code Review
Codex found 3 issues in implementation:
1. Stale property `availableRunIds` not removed → Fixed
2. Type safety for created_at (string vs Date) → Added type checking + toISOString()
3. Delete API contract verified → Already supports IDs parameter

### Result
- Status: Implementation complete
- Files modified: 1
- Lines changed: ~60
- No backend changes required
- Ready for testing and deployment

### Next
- Test workflow dropdown population
- Test timestamp grouping display
- Test filtering functionality
- Test batch deletion with timestamp filter
- Deploy to NAS dashboard
