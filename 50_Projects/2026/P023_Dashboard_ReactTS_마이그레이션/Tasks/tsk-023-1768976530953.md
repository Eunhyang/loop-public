---
entity_type: Task
entity_id: tsk-023-1768976530953
entity_name: MCP API - Connection Stability & Error Code Standardization
created: '2026-01-21'
updated: '2026-01-21'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
tags: []
type: dev
aliases:
- tsk-023-1768976530953
start_date: '2026-01-21'
due: '2026-01-21'
---

# MCP API - Connection Stability & Error Code Standardization

## 설명

ChatGPT MCP 클라이언트의 연결 안정성 개선 및 에러 응답 표준화.

## 체크리스트

- [x] MCPErrorCode enum 및 MCPErrorResponse 모델 생성
- [x] MCPSessionTracker 세션 추적 서비스 생성
- [x] /api/mcp/connection-status 엔드포인트 추가
- [x] Middleware 에러 응답에 error_code 필드 추가
- [x] Router HTTPException에 표준 에러 코드 적용
- [x] Main 브랜치 머지 완료

## Notes

### Summary
MCP API의 에러 응답을 표준화하여 ChatGPT MCP 클라이언트가 에러를 구분하고 적절한 액션을 취할 수 있도록 개선.

### Changes Made
- **새 파일**:
  - `api/errors.py`: MCPErrorCode enum, MCPErrorResponse, MCPException 클래스
  - `api/services/session_tracker.py`: MCP 세션 추적 서비스 (싱글톤)
- **수정 파일**:
  - `shared/models/common.py`: ErrorResponse에 `error_code`, `action` 필드 추가
  - `loop_mcp/main.py`: `_send_error` 헬퍼 + 401 에러 코드 포함
  - `shared/auth/middleware.py`: 401/403 응답에 에러 코드 포함
  - `api/main.py`: HTTPException 핸들러 + 에러 코드 매핑
  - `api/routers/mcp_composite.py`: `/connection-status` 엔드포인트 + 주요 에러 코드 적용

### 표준 에러 코드
| Code | HTTP | 설명 |
|------|------|------|
| NOT_AUTHENTICATED | 401 | 인증 필요 |
| EXEC_ACCESS_REQUIRED | 403 | exec vault 접근 권한 필요 |
| INSUFFICIENT_SCOPE | 403 | scope 부족 |
| ENTITY_NOT_FOUND | 404 | 엔티티 없음 |
| FILE_ALREADY_EXISTS | 409 | 파일 중복 |
| PATH_TRAVERSAL | 400 | 경로 탈출 시도 |
| VAULT_UNAVAILABLE | 500 | vault 접근 불가 |
| INTERNAL_ERROR | 500 | 내부 오류 |

## 참고

- PRD: Loop MCP Connection Stability & Linkless API
- Commit: `9b0d9ac8b` feat(api): MCP connection stability & error code standardization

## 짧은 회고

에러 코드 표준화로 MCP 클라이언트가 에러 종류를 구분하여 적절한 조치(재연결, 권한 요청 등)를 취할 수 있게 됨. Backward compatible하게 구현하여 기존 클라이언트에 영향 없음.
