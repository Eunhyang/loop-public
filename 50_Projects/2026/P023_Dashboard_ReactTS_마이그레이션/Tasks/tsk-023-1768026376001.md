---
entity_type: Task
entity_id: tsk-023-1768026376001
entity_name: Vault API - Task duplicate 기능
created: '2026-01-10'
updated: '2026-01-10'
status: done
closed: '2026-01-10'
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-10'
due: '2026-01-10'
aliases:
- tsk-023-1768026376001
tags: []
type: dev
target_project: loop
---

# Vault API - Task duplicate 기능

## 설명

Task를 ID만 다르게 완전 복제하는 API 엔드포인트 추가.

**엔드포인트**: `POST /api/tasks/{task_id}/duplicate`

## Tech Spec

### 구현 파일
- `public/api/routers/tasks.py` - `duplicate_task` 엔드포인트 추가

### 구현 로직

```python
@router.post("/{task_id}/duplicate")
async def duplicate_task(task_id: str, cache: VaultCache = Depends(get_cache)):
    # 1. Source task 조회
    source_fm = cache.get_task(task_id)  # 404 if not found
    source_path = cache.get_task_path(task_id)
    body = read_body(source_path)

    # 2. Frontmatter 복제 - ID/날짜만 변경
    new_fm = source_fm.copy()
    new_task_id = ssot_service.generate_task_id(source_fm['project_id'])
    today = datetime.now().strftime("%Y-%m-%d")

    new_fm['entity_id'] = new_task_id
    new_fm['aliases'] = [new_task_id]
    new_fm['created'] = today
    new_fm['updated'] = today
    # 나머지 전부 그대로 (status, assignee, priority, entity_name 등)

    # 3. 파일 생성
    project_dir = cache.get_project_dir(source_fm['project_id'])
    task_file = project_dir / "Tasks" / f"{new_task_id}.md"
    content = f"---\n{yaml.dump(new_fm)}---\n\n{body}"
    task_file.write_text(content)

    # 4. Cache 업데이트 + Audit
    cache.set_task(new_task_id, new_fm, task_file)
    log_entity_action("duplicate", "Task", new_task_id, ...)

    return {"new_task_id": new_task_id, "source_task_id": task_id}
```

### 변경되는 필드 (4개만)

| 필드 | 변경 |
|------|------|
| `entity_id` | 새 ID 생성 |
| `aliases` | 새 ID로 교체 |
| `created` | 오늘 날짜 |
| `updated` | 오늘 날짜 |

나머지 전부 동일: `entity_name`, `status`, `assignee`, `priority`, `type`, `project_id`, `tags`, `conditions_3y`, body 등

## 체크리스트

- [x] `tasks.py`에 `duplicate_task` 엔드포인트 추가
- [x] 코드 구현 완료
- [x] Git 커밋 및 main 브랜치에 병합

## 구현 완료

### 구현 내용

1. **엔드포인트 추가**: `POST /api/tasks/{task_id}/duplicate`
   - 위치: `/Users/gim-eunhyang/dev/loop/public/api/routers/tasks.py`
   - 라인: 433-537

2. **주요 기능**:
   - Source task의 frontmatter와 body를 읽어서 완전 복제
   - 4개 필드만 변경: `entity_id`, `aliases`, `created`, `updated`
   - 나머지 모든 필드 유지: `entity_name`, `status`, `assignee`, `priority`, `type`, `project_id`, `tags`, `conditions_3y`, body 등
   - 캐시 기반 ID 생성 (`cache.get_next_task_id()`)
   - 감사 로그 기록 (action="duplicate")

3. **에러 처리**:
   - 404: Source task가 존재하지 않을 때
   - 500: Frontmatter 형식이 잘못되었을 때
   - 500: Task ID collision (이론적으로 불가능)

### Git 커밋

- Commit 1: `b5e28ef` - 엔드포인트 구현
- Commit 2: `af11cc3` - Task 상태를 done으로 업데이트
- Branch: main (merged and deleted feature branch)

### 다음 단계

API 서버가 재배포되면 다음 명령으로 테스트 가능:

```bash
# 복제 실행
curl -X POST -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/tasks/tsk-023-01/duplicate"

# 새 task 확인
curl -H "Authorization: Bearer $LOOP_API_TOKEN" \
  "$LOOP_API_URL/api/tasks/{new_task_id}"
```

## 참고
