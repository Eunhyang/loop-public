---
entity_type: Task
entity_id: tsk-023-1768621773613
entity_name: API - Expected Impact 프롬프트 SSOT 개선 (Phase 1)
created: '2026-01-17'
updated: '2026-01-17'
status: done
closed: '2026-01-17'
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-17'
due: '2026-01-17'
aliases:
- tsk-023-1768621773613
tags: []
type: dev
---

# API - Expected Impact 프롬프트 SSOT 개선 (Phase 1)

## 설명

Expected Impact 판단 정확도 향상을 위한 프롬프트 구조 개선.

**문제**:
- `build_simple_expected_impact_prompt`: ID만 전달 (Track, Condition, Hypothesis 내용 없음)
- `build_expected_impact_prompt`: entity_id, entity_name, description만 전달 (핵심 필드 누락)
- 순차 처리 (for loop)로 성능 저하

**목표**:
- SSOT 원칙에 따라 프롬프트 함수 단일화
- LLM이 정확한 판단을 위해 필요한 context 충분히 제공
- 병렬 처리로 성능 개선

---

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023 (Dashboard v2)
- Target: loop (LOOP Vault API)

**SSOT 원칙:**
- `build_simple_expected_impact_prompt` 삭제
- `build_expected_impact_prompt`만 사용 (단일 진실의 원천)

**EXCLUDE_FIELDS 정의:**
```python
EXCLUDE_FIELDS = {
    '_path', '_body', '_dir', '_vault',  # 내부 캐시용
    'created', 'updated',                 # 메타데이터
    'aliases', 'tags',                    # 중복/분류용
    'outgoing_relations',                 # ID만 있어 의미 없음
}
```

**File Structure:**
```
api/prompts/context_builder.py     # 공통 context 조립 (v5.5 신규)
api/prompts/expected_impact.py     # SSOT 프롬프트 함수 (수정)
api/prompts/__init__.py            # export 정리
api/routers/impact_batch.py        # 병렬 처리 + 호출부 수정
api/routers/autofill.py            # 호출부 수정
api/routers/ai.py                  # 호출부 수정
api/routers/projects.py            # 호출부 수정
```

**Implementation Details:**

1. **build_expected_impact_prompt 개선**
   - Track 핵심 필드: `hypothesis`, `focus`, `objectives`, `risk_level`
   - Condition 핵심 필드: `condition`, `metrics`, `break_triggers`, `confidence`
   - Hypothesis 핵심 필드: `hypothesis_question`, `success_criteria`, `failure_criteria`, `measurement`
   - `hypotheses` 파라미터 추가

2. **suggest-batch 병렬 처리**
   ```python
   # asyncio.gather로 병렬 실행
   results = await asyncio.gather(*[
       process_single_project(item, cache, llm, config)
       for item in request.items
   ])
   ```

3. **호출부 수정**
   - `build_simple_expected_impact_prompt` import 제거
   - `build_expected_impact_prompt`에 hypotheses 전달

**Edge Cases:**
- Track/Condition/Hypothesis가 None인 경우 → "정보 없음" 표시
- metrics/objectives가 dict가 아닌 경우 → str() 변환
- 병렬 처리 시 rate limit → max 5개 동시 요청

### Todo

- [x] `api/prompts/expected_impact.py`: EXCLUDE_FIELDS 추가
- [x] `api/prompts/expected_impact.py`: _format_* 헬퍼 함수 추가
- [x] `api/prompts/expected_impact.py`: build_expected_impact_prompt 핵심 필드 추가
- [x] `api/prompts/expected_impact.py`: build_simple_expected_impact_prompt 삭제
- [x] `api/prompts/__init__.py`: export 정리
- [x] `api/prompts/context_builder.py`: 공통 context 조립 로직 분리 (v5.5)
- [ ] `api/routers/impact_batch.py`: suggest-batch 병렬 처리 구현 (Phase 2)
- [x] `api/routers/impact_batch.py`: hypotheses context 수집 및 전달
- [x] `api/routers/autofill.py`: 호출부 수정
- [x] `api/routers/ai.py`: 호출부 수정
- [x] `api/routers/projects.py`: 호출부 수정
- [x] 빌드 검증: `poetry run python -c "from api.prompts.expected_impact import build_expected_impact_prompt"`
- [ ] API 테스트: suggest-batch 호출하여 응답 확인 (Phase 2)

## 작업 로그

#### 2026-01-17 13:02
**개요**: Expected Impact 프롬프트 SSOT 개선 완료 (Phase 1)

**변경사항**:
- 삭제: `build_simple_expected_impact_prompt` 함수 (SSOT 위반)
- 개선: `build_expected_impact_prompt`에 핵심 필드 추가
  - Track: hypothesis, focus, objectives, risk_level
  - Condition: condition, metrics, break_triggers, confidence
  - Hypothesis: hypothesis_question, success/failure criteria, measurement
- 추가: EXCLUDE_FIELDS 상수 및 헬퍼 함수 (_format_list_field, _format_objectives, _format_metrics)
- 수정: 모든 호출부에서 전체 context 수집 후 build_expected_impact_prompt 사용

**파일 변경**:
- `api/prompts/expected_impact.py` - EXCLUDE_FIELDS 추가, 헬퍼 함수 추가, build_simple 삭제
- `api/routers/projects.py` - _autofill_expected_impact에서 context 수집
- `api/routers/autofill.py` - autofill_expected_impact에서 context 수집
- `api/routers/ai.py` - 조건부 로직 제거, 항상 full context 사용
- `api/routers/impact_batch.py` - gathered context 활용

**Codex 리뷰**: ✅ 완료 (이슈 3개 발견 - Phase 2에서 처리 권장)

**Codex 발견 이슈 (Out of Scope for Phase 1)**:
1. **Schema mismatch** - autofill.py/projects.py 파서가 여전히 legacy `contributes` 파싱 (v5.3 `condition_contributes` 무시)
2. **Hypothesis lookup bug** - Zero-padding 처리 이슈 (trk-003 → hyp-3- 대신 hyp-003- 필요)
3. **EXCLUDE_FIELDS unused** - 정의되었으나 미사용

→ Phase 2 작업 권장: 파서 업데이트 (condition_contributes, track_contributes, validates 파싱)

**결과**: ✅ 빌드 성공, 배포 완료

**커밋**: `3484ad8d6` on branch `task/tsk-023-1768621773613` (merged to main)

---

#### 2026-01-17 14:30
**개요**: context_builder 분리 리팩토링 (v5.5)

**변경사항**:
- 신규: `api/prompts/context_builder.py` - 공통 context 조립 로직 분리
  - `build_strategic_context()` - Track/Condition/Hypothesis/NorthStar/Similar Projects 포맷팅
  - `EXCLUDE_FIELDS` - 프롬프트에서 제외할 필드 정의
  - 헬퍼 함수: `_format_project`, `_format_track`, `_format_conditions`, `_format_hypotheses` 등
- 수정: `api/prompts/expected_impact.py` - context_builder 사용하도록 리팩토링
  - `build_strategic_context()` 호출 후 `_build_expected_impact_command()` 추가
  - 238줄 → 186줄 (코드 재사용성 향상)
- 수정: `api/prompts/__init__.py` - `build_strategic_context`, `EXCLUDE_FIELDS` export 추가

**구조**:
```
build_expected_impact_prompt()
    ├─► build_strategic_context()      ← context_builder.py (NEW)
    └─► _build_expected_impact_command()  ← expected_impact.py
```

**향후 활용**: `hypothesis_seeder.py`에서도 `build_strategic_context()` 재사용 가능

**결과**: ✅ 빌드 성공

**커밋**: `fedfb9f82` on branch `refactor/prompt-context-builder` (merged to main)

---

## 참고

- 플랜 문서: `/Users/gim-eunhyang/.claude/plans/immutable-cooking-waterfall.md`
- Phase 2 (향후): LLM Tool Use 도입 - MCP 엔드포인트를 LLM Tool로 제공
- Phase 2 권장: 파서 업데이트 (condition_contributes, track_contributes 지원)
