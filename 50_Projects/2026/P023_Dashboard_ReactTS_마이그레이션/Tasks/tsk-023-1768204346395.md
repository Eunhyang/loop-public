---
entity_type: Task
entity_id: tsk-023-1768204346395
entity_name: "Dashboard - Attachment 즉시 텍스트 추출 + 클린아키텍처"

project_id: prj-023
status: done
type: dev
assignee: 김은향
target_project: loop

created: 2026-01-12
updated: 2026-01-12
closed: 2026-01-12
due: null
---

# Dashboard - Attachment 즉시 텍스트 추출 + 클린아키텍처

> Task ID: `tsk-023-1768204346395` | Project: `prj-023` | Status: done

## Objective

PDF 업로드 시 텍스트를 즉시 추출하여 `.txt` 캐시 생성하고, 클린아키텍처로 리팩토링

## Notes

## PRD (from Plan Mode)

### 배경
- PDF 업로드 시 텍스트를 즉시 추출하여 `.txt` 캐시 생성
- n8n Entity Validator에서 이미 추출된 텍스트 재사용
- Dashboard Drawer에서 `.txt` 클릭 시 브라우저 인라인 표시

### 현재 구조 문제점

```
api/routers/attachments.py (591 lines)
├── 보안 헬퍼 함수들 (55-195)
├── upload_attachment (201-327) ← 너무 많은 책임
├── list_attachments (330-385)
├── get_attachment (388-430)
├── delete_attachment (433-492)
└── extract_attachment_text (495-591)
```

**문제**: Router가 HTTP + 파일I/O + 보안 + 비즈니스 로직 모두 담당

### 클린아키텍처 리팩토링 플랜

#### Layer 분리

```
api/
├── routers/attachments.py      # HTTP only (얇은 컨트롤러)
├── services/attachment_service.py  # NEW: 비즈니스 로직
├── services/text_extractor.py  # 유지 (이미 잘 분리됨)
└── utils/file_security.py      # NEW: 보안 헬퍼 분리
```

#### Phase 1: AttachmentService 생성

**`api/services/attachment_service.py`** (NEW)

```python
class AttachmentService:
    """첨부파일 비즈니스 로직"""

    def __init__(self, vault_dir: Path, text_extractor: TextExtractor):
        self.attachments_dir = vault_dir / "_attachments"
        self.text_extractor = text_extractor

    def save_file(self, task_id: str, filename: str, content: bytes) -> AttachmentInfo:
        """파일 저장 + 텍스트 즉시 추출"""
        pass

    def delete_file(self, task_id: str, filename: str) -> bool:
        """파일 삭제 + 캐시 .txt도 삭제"""
        pass

    def list_files(self, task_id: str) -> list[AttachmentInfo]:
        """파일 목록 (캐시 .txt 포함)"""
        pass

    def get_file_path(self, task_id: str, filename: str) -> Path | None:
        """파일 경로 반환 (Unicode 정규화 포함)"""
        pass

    def should_display_inline(self, content_type: str) -> bool:
        """인라인 표시 여부 판단"""
        pass
```

#### Phase 2: 보안 헬퍼 분리

**`api/utils/file_security.py`** (NEW)

```python
# attachments.py에서 이동
def secure_filename(filename: str) -> str: ...
def validate_extension(filename: str) -> bool: ...
def validate_path_safety(base_dir: Path, target_path: Path) -> bool: ...
def find_file_with_unicode_normalization(task_dir: Path, filename: str) -> Path | None: ...
```

#### Phase 3: Router 슬림화

**`api/routers/attachments.py`** (리팩토링)

```python
from ..services.attachment_service import AttachmentService

router = APIRouter(prefix="/api/tasks", tags=["attachments"])

@router.post("/{task_id}/attachments")
async def upload_attachment(task_id: str, file: UploadFile):
    """HTTP 핸들링만 - 비즈니스 로직은 Service로"""
    service = get_attachment_service()
    result = await service.save_file(task_id, file.filename, await file.read())
    return AttachmentResponse(success=True, attachment=result)

@router.delete("/{task_id}/attachments/{filename}")
def delete_attachment(task_id: str, filename: str):
    service = get_attachment_service()
    service.delete_file(task_id, filename)  # .txt 캐시도 삭제
    return AttachmentResponse(success=True)

@router.get("/{task_id}/attachments/{filename}")
def get_attachment(task_id: str, filename: str):
    service = get_attachment_service()
    file_path = service.get_file_path(task_id, filename)
    content_type = mimetypes.guess_type(filename)[0]
    disposition = "inline" if service.should_display_inline(content_type) else "attachment"
    return FileResponse(path=file_path, media_type=content_type, content_disposition_type=disposition)
```

### 구현 체크리스트

#### 1. 새 파일 생성
- [ ] `api/utils/file_security.py` - 보안 헬퍼 함수 이동
- [ ] `api/services/attachment_service.py` - AttachmentService 클래스

#### 2. 기능 구현
- [ ] **Upload 시 즉시 추출**: `save_file()` 내에서 `text_extractor.extract()` 호출
- [ ] **Delete 시 캐시 삭제**: `delete_file()` 내에서 `.txt` 파일도 삭제
- [ ] **인라인 표시**: `should_display_inline()` + Router에서 disposition 설정

#### 3. Router 리팩토링
- [ ] `attachments.py`에서 비즈니스 로직 제거
- [ ] Service 의존성 주입
- [ ] 기존 테스트 통과 확인

#### 4. 테스트
- [ ] PDF 업로드 → `.txt` 즉시 생성 확인
- [ ] PDF 삭제 → `.txt`도 삭제 확인
- [ ] `.txt` 클릭 → 브라우저 인라인 표시 확인
- [ ] n8n Entity Validator 정상 동작 확인

### 파일 변경 요약

| 파일 | 변경 |
|------|------|
| `api/utils/file_security.py` | NEW - 보안 헬퍼 |
| `api/services/attachment_service.py` | NEW - 비즈니스 로직 |
| `api/services/text_extractor.py` | 유지 (변경 없음) |
| `api/routers/attachments.py` | 슬림화 (~200줄로 감소) |
| `api/models/entities.py` | 유지 (변경 없음) |

### 의존성 흐름 (Clean Architecture)

```
Router (HTTP)
    ↓ depends on
Service (Business Logic)
    ↓ depends on
TextExtractor (Domain Service)
    ↓ depends on
FileSystem (Infrastructure)
```

