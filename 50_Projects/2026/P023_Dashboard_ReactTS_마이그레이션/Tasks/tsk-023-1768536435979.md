---
entity_type: Task
entity_id: tsk-023-1768536435979
entity_name: Dashboard - Pending Review validates 배열 필드 병합 표시
created: '2026-01-16'
updated: '2026-01-16'
status: done
project_id: prj-023
parent_id: prj-023
assignee: 김은향
priority: medium
start_date: '2026-01-16'
due: '2026-01-16'
closed: '2026-01-16'
aliases:
- tsk-023-1768536435979
tags: []
type: dev
---

# Dashboard - Pending Review validates 배열 필드 병합 표시

## 설명

Pending Review 페이지에서 validates 필드 표시 시, AI 제안값이 원본 Entity의 validates를 완전히 대체하는 문제 해결.

**현재 문제:**
1. AI suggested가 원본 Entity의 validates를 덮어씀 (원본 hyp-2-01, hyp-2-04 사라짐)
2. 제안된 가설 ID(hyp-001)가 이름 없이 ID만 표시됨

**기대 동작:**
- 원본 validates + AI 제안 validates를 **모두 표시**
- 시각적으로 "원본"과 "제안(추가)"을 구분 (amber border + star)
- 모든 가설에 이름(label) 표시
- 사용자가 최종 선택 가능

## Notes

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-023
- Target: loop (dashboard-v2)
- Feature: `src/features/impact/` + `src/hooks/`

**File Structure:**
```
src/
├── hooks/
│   └── useReviewMode.ts          # getArrayFieldWithMerge() 추가
├── features/
│   └── impact/
│       └── components/
│           └── HypothesisSelector.tsx  # reviewMarkers prop, invalid ID 처리
└── features/
    └── projects/
        └── components/
            └── ProjectForm.tsx    # 배열 필드 병합 로직 연동
```

**Implementation Details:**

### Phase 1: useReviewMode 배열 필드 지원 (`src/hooks/useReviewMode.ts`)

1. `ArrayFieldMerged` 인터페이스 추가:
```typescript
interface ArrayFieldMerged {
  allValues: string[];           // 원본 + 제안 합집합
  originalOnly: Set<string>;     // 원본에만 있음
  suggestedOnly: Set<string>;    // 제안에만 있음 (추가)
  inBoth: Set<string>;           // 둘 다 있음
}
```

2. `getArrayFieldWithMerge(field: string): ArrayFieldMerged | null` 함수 추가:
   - `entityData[field]` (원본) + `suggestedFields[field]` (제안) 병합
   - Set 연산으로 각 값의 출처 메타데이터 계산
   - 반환값으로 UI에서 시각적 구분 가능

### Phase 2: HypothesisSelector 수정 (`src/features/impact/components/HypothesisSelector.tsx`)

1. `reviewMarkers` prop 추가:
```typescript
interface HypothesisSelectorProps {
  // ... existing props
  reviewMarkers?: {
    suggestedAdditions: Set<string>;  // amber + star 표시 대상
    originalOnly: Set<string>;        // normal 스타일 (유지)
  }
}
```

2. 각 가설 항목에 시각적 표시:
   - `suggestedAdditions.has(hyp.id)` → amber border + star icon
   - 기존 스타일: primary rose, 일반 zinc

3. Invalid ID 처리 개선:
   - `normalizedHypotheses.find()` 실패 시
   - 현재: `{ id, label: id }` → 변경: `{ id, label: "${id} (Not Found)", invalid: true }`
   - invalid 스타일: 경고색 (amber/red border)

### Phase 3: ProjectForm 연동 (`src/features/projects/components/ProjectForm.tsx`)

1. review 모드에서 validates 처리 수정 (lines 405-409 영역):
```typescript
// Before: suggested가 원본 완전 대체
const selectedValidates = (getFieldValue('validates') as string[]) || [];

// After: 배열 병합
const validatesInfo = isReviewMode && reviewMode
  ? reviewMode.getArrayFieldWithMerge('validates')
  : null;

const displayValidates = validatesInfo?.allValues ?? selectedValidates;
const reviewMarkers = validatesInfo ? {
  suggestedAdditions: validatesInfo.suggestedOnly,
  originalOnly: validatesInfo.originalOnly,
} : undefined;
```

2. HypothesisSelector에 reviewMarkers 전달:
```tsx
<HypothesisSelector
  hypotheses={hypothesisList}
  validates={displayValidates}
  // ... other props
  reviewMarkers={reviewMarkers}
/>
```

**Edge Cases:**
- suggested가 빈 배열일 경우: 원본만 표시, 추가 없음
- 원본이 빈 배열일 경우: suggested만 표시, 모두 "추가"로 마킹
- 동일 ID가 원본+suggested에 있을 경우: inBoth, 일반 스타일
- 가설 ID가 hypothesisList에 없는 경우: "(Not Found)" 라벨 + 경고 스타일

---

### Codex Review 반영 사항 (CRITICAL)

#### Issue 1: Approval payload drops original validates (BLOCKER)

**문제**: `selectedValues`가 suggested만으로 초기화되어, approve 시 원본 validates가 누락됨

**해결**: `useReviewMode` 초기화 로직 수정
```typescript
// Before (line 64-67): suggested만으로 초기화
const [selectedValues, setSelectedValues] = useState<Record<string, unknown>>(() => {
  return enabled ? { ...suggestedFields } : {};
});

// After: 배열 필드는 병합된 값으로 초기화
const [selectedValues, setSelectedValues] = useState<Record<string, unknown>>(() => {
  if (!enabled) return {};

  const initial = { ...suggestedFields };
  // 배열 필드는 원본+제안 병합으로 초기화 (validates, conditions_3y 등)
  const arrayFields = ['validates', 'conditions_3y'];
  for (const field of arrayFields) {
    const original = (entityData?.[field] as string[]) || [];
    const suggested = (suggestedFields?.[field] as string[]) || [];
    // Union with dedupe, original order first
    initial[field] = [...new Set([...original, ...suggested])];
  }
  return initial;
});
```

**Approve payload 정책**:
- Approve 시 `selectedValues` 전체가 최종값 (수정 안 하면 병합된 상태 그대로)
- 사용자가 UI에서 제거한 항목은 반영됨
- `getModifiedFields()` 대신 `selectedValues` 직접 사용 고려

#### Issue 2: reviewMarkers prop 명세 (BLOCKER)

**TypeScript 인터페이스**:
```typescript
interface ReviewMarkers {
  /** AI가 새로 제안한 항목 (원본에 없음) - amber border + star */
  suggestedAdditions: Set<string>;
  /** 원본에만 있는 항목 (AI가 제안하지 않음) - normal style */
  originalOnly: Set<string>;
}
```

**렌더링 규칙** (HypothesisSelector):
```tsx
// 각 hypothesis item에 적용
const isSuggestedAddition = reviewMarkers?.suggestedAdditions.has(hyp.id);
const isOriginalOnly = reviewMarkers?.originalOnly.has(hyp.id);

// 스타일 결정
const itemClassName = cn(
  'group flex items-start gap-3 rounded-lg border px-3 py-2 transition-colors',
  {
    // Primary (기존)
    'border-rose-200 bg-rose-50 shadow-sm': isPrimary && !isSuggestedAddition,
    // AI 제안 추가 (amber)
    'border-amber-300 bg-amber-50 ring-1 ring-amber-200': isSuggestedAddition,
    // 일반 (zinc)
    'border-zinc-200 bg-white hover:border-zinc-300': !isPrimary && !isSuggestedAddition,
  }
);

// Star icon for suggested additions
{isSuggestedAddition && (
  <span className="text-amber-500 text-xs" title="AI 제안 추가">★</span>
)}
```

#### Issue 3: Merge semantics 명세 (MAJOR)

**병합 알고리즘**:
1. **Union with dedupe**: `[...new Set([...original, ...suggested])]`
2. **순서**: 원본 순서 우선, 새 제안은 뒤에 추가
3. **삭제 처리**: AI가 삭제를 제안하는 케이스는 현재 지원 안 함 (추가만 표시)
   - 향후 필요 시 `suggestedRemovals` 필드 추가 고려
4. **primary_hypothesis_id 충돌**:
   - suggested primary가 원본 validates에 없으면 → validates에 자동 추가
   - UI에서 validates 배열에 없는 primary 선택 불가 (기존 validation 유지)

**가설 이름 조회**:
- `dashboardData.hypotheses`에서 lookup (기존 방식 유지)
- ID만 있고 이름 없으면: `"${id} (Not Found)"` 표시 + `invalid: true` 플래그
- 참고: suggested ID가 hypotheses에 없는 케이스는 n8n 워크플로우 버그 가능성 → 경고 표시로 충분

### Todo

**Phase 1: useReviewMode (BLOCKER 해결)**
- [ ] `src/hooks/useReviewMode.ts`: 배열 필드 병합 초기화 로직 수정 (Issue 1)
- [ ] `src/hooks/useReviewMode.ts`: `ArrayFieldMerged` 인터페이스 추가
- [ ] `src/hooks/useReviewMode.ts`: `getArrayFieldWithMerge()` 함수 구현

**Phase 2: HypothesisSelector (BLOCKER 해결)**
- [ ] `src/features/impact/components/HypothesisSelector.tsx`: `ReviewMarkers` 인터페이스 정의
- [ ] `src/features/impact/components/HypothesisSelector.tsx`: `reviewMarkers` prop 추가
- [ ] `src/features/impact/components/HypothesisSelector.tsx`: suggested 항목에 amber border + star 렌더링
- [ ] `src/features/impact/components/HypothesisSelector.tsx`: invalid ID 처리 ("Not Found" 라벨 + 경고 스타일)

**Phase 3: ProjectForm 연동**
- [ ] `src/features/projects/components/ProjectForm.tsx`: 배열 병합 로직 적용
- [ ] `src/features/projects/components/ProjectForm.tsx`: HypothesisSelector에 reviewMarkers 전달

**검증**
- [ ] 테스트: 기존 validates 있는 프로젝트에 pending review 생성
- [ ] 테스트: 원본+제안 모두 표시되는지 확인
- [ ] 테스트: AI 제안 항목에 amber+star 표시 확인
- [ ] 테스트: Approve 시 병합된 validates 정상 저장 확인 (원본 누락 없음)
- [ ] Build 통과 확인

## 참고

- 관련 컴포넌트: `ReviewFieldWrapper` (기존 amber border 스타일 참조)
- 기존 코드 위치:
  - `useReviewMode.ts`: lines 57-157
  - `HypothesisSelector.tsx`: lines 1-183
  - `ProjectForm.tsx`: lines 405-455 (validates 관련)

## 작업 로그

### 2026-01-16 13:30
**개요**: Pending Review validates 배열 필드 병합 표시 기능 구현 완료

**변경사항**:
- 개발: ArrayFieldMerged 인터페이스 + getArrayFieldWithMerge() 함수 (useReviewMode.ts)
- 개발: ReviewMarkers 인터페이스 + UI 시각적 구분 (HypothesisSelector.tsx)
- 수정: displayValidates 연동 + reviewMarkers 전달 (ProjectForm.tsx)
- 수정: cyanColor 미사용 변수 제거 (HypothesisForm.tsx)

**파일 변경**:
- `dashboard-v2/src/hooks/useReviewMode.ts` (+99 lines): 배열 병합 로직, useEffect로 entityData 로드 후 병합
- `dashboard-v2/src/features/impact/components/HypothesisSelector.tsx` (+46 lines): reviewMarkers 지원, amber border + star, invalid ID 처리
- `dashboard-v2/src/features/projects/components/ProjectForm.tsx` (+16 lines): getFieldValue 사용으로 사용자 수정 반영
- `dashboard-v2/src/features/strategy/components/HypothesisForm.tsx` (-1 line): 미사용 변수 제거

**Codex 리뷰**: ✅ 2회 실행 (초기 + 수정 후)
- Issue 1 (BLOCKER): displayValidates static union → getFieldValue로 수정
- Issue 2 (BLOCKER): selectedValues 초기화 null 문제 → useEffect defer로 수정
- 최종 검증: 모든 이슈 해결 확인

**결과**: ✅ 빌드 성공, 배포 완료

**커밋**: `d9c355e0f` on branch `task/tsk-023-1768536435979`
