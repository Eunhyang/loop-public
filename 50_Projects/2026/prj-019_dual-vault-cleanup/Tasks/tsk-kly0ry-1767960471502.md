---
entity_type: Task
entity_id: tsk-kly0ry-1767960471502
entity_name: LOOP API - Task ID 패턴 수정 (prj_hash 기반)
created: '2026-01-09'
updated: '2026-01-10'
status: done
project_id: prj-019
parent_id: prj-019
assignee: 김은향
priority: high
start_date: '2026-01-09'
due: '2026-01-09'
aliases:
- tsk-kly0ry-1767960471502
tags: []
type: dev
notes: '## Task ID 패턴 수정 계획


  ### 목표


  Task ID가 Project hash를 포함하도록 수정


  - 예: `prj-a7k9m2` → `tsk-a7k9m2-1736412652123`


  ### 현재 상태


  - Task ID 패턴: `tsk-{random_hash}-{epoch13}` (문제)

  - 목표 패턴: `tsk-{prj_hash}-{epoch13}` (Project hash 재사용)


  ### 구현 계획


  **Step 1: ssot_service.py 수정**


  - File: `public/api/services/ssot_service.py`

  - 새 메서드 `_extract_prj_hash()` 추가

  - Legacy prj-001 → deterministic hash 생성

  - 새 prj-a7k9m2 → hash 직접 사용

  - Task ID: `tsk-{prj_hash}-{epoch13}`


  **Step 2: 마이그레이션 스크립트 작성**


  - File: `public/scripts/migrate_task_ids_to_prj_hash.py`

  - 모든 Task 파일 스캔

  - 새 ID 생성 + 파일명 업데이트

  - Git mv로 히스토리 보존

  - Dry-run 모드 지원


  **Step 3: 문서 업데이트**


  - `public/00_Meta/schema_constants.yaml` (패턴 설명)

  - `public/00_Meta/SSOT_CONTRACT.md` (규칙 업데이트)


  **Step 4: 검증**


  - API 테스트: 신규 Task 생성

  - 마이그레이션 dry-run

  - `validate_schema.py` 실행

  - `build_graph_index.py` 실행


  ### 영향 범위


  - 신규 Task 생성: 새 패턴 적용

  - 기존 Task: 마이그레이션 필요 (Phase 2-3)

  - API/스크립트: 패턴 인식 코드 수정 필요


  ### Codex 검증 결과 - 주요 개선사항


  **1. Legacy Hash 명확화**


  - SHA256 → Base36 변환 (기존 `_to_base36()` 사용)

  - 대소문자: 모두 소문자로 정규화

  - 길이: 6자리 (`.zfill(6)`)


  **2. 내부 참조 업데이트**


  - 파일명: `git mv`로 변경

  - 역참조: `build_graph_index.py` 재빌드로 자동 처리

  - 크로스참조: entity_id 기반이므로 자동 호환


  **3. 검증 범위**


  - Phase 1: `validate_schema.py` (ID 패턴)

  - Phase 2: `analyze_task_filenames.py` (100% 통일)

  - Phase 3: API 테스트 (신규 Task 생성)


  **4. Rollback 전략**


  - Git history 유지: git mv 사용 → 실패 시 git reset --hard


  **5. Epoch 안전성**


  - UTC 밀리초 (timezone 독립)

  - 충돌 시 1ms 지연 재시도 (최대 20회)'
---
# LOOP API - Task ID 패턴 수정 (prj_hash 기반)

## 설명

Task ID 형식을 `tsk-{random_hash}-{epoch}` 에서 `tsk-{prj_hash}-{epoch}` 로 변경하여, Task ID만 봐도 소속 Project를 즉시 알 수 있게 개선합니다.

## 구현 체크리스트

- [x] Step 1: ssot_service.py 수정 (`_extract_prj_hash()` 메서드 추가)
- [ ] Step 2: 마이그레이션 스크립트 작성 (`migrate_task_ids_to_prj_hash.py`)
- [x] Step 3: 문서 업데이트 (schema_constants.yaml, SSOT_CONTRACT.md)
- [x] Step 4: 검증 (API 테스트, dry-run, validate_schema.py)
- [ ] Step 5: 마이그레이션 실행 (전체 Task 변환)

## 구현 결과 (2026-01-09)

### 완료된 작업

**1. ssot_service.py 수정**
- `_extract_prj_hash(project_id)` 메서드 추가
  - 새 Project (prj-a7k9m2): 마지막 세그먼트 추출 + 정규화
  - Legacy (prj-001, prj-exec-001): SHA256 deterministic hash
  - Multi-segment (prj-exec-a7k9m2, prj-tips-a7k9m2): 마지막 세그먼트 추출
- `generate_task_id(project_id, entity_name)` 업데이트
  - prj_hash 기반 Task ID 생성
  - Exponential backoff collision 처리 (최대 20회)
  - Wall-clock timestamp 사용 (human-readable)

**2. 문서 업데이트**
- `00_Meta/schema_constants.yaml`: Task ID 패턴 설명 업데이트
- `00_Meta/SSOT_CONTRACT.md`: Section 4.2.5 추가 (Task ID 패턴 설명)

**3. Codex Review 피드백 반영**
- ✅ Multi-segment ID 지원 (prj-exec-a7k9m2, prj-tips-a7k9m2)
- ✅ 마지막 세그먼트 기반 hash 추출
- ✅ Legacy detection 개선 (digits only)
- ✅ Exponential backoff collision 처리
- ✅ 명확한 에러 메시지

**4. 검증 완료**
- Test cases 통과:
  - prj-001 → tsk-7anqcu-{epoch}
  - prj-a7k9m2 → tsk-a7k9m2-{epoch}
  - prj-exec-001 → tsk-dk5gyf-{epoch}
  - prj-exec-a7k9m2 → tsk-a7k9m2-{epoch}
  - prj-tips-a7k9m2 → tsk-a7k9m2-{epoch}

### 남은 작업

**Step 2**: 마이그레이션 스크립트 작성 (별도 Task 권장)
- 기존 Task ID를 새 패턴으로 변환하는 스크립트
- Dry-run 모드 + Git mv 지원
- Backward compatibility 유지

**Step 5**: 전체 Task 마이그레이션 실행 (별도 Task 권장)
- Phase 2-3로 진행 (tsk-019-13 참고)

## 참고

- Plan Mode에서 작성한 상세 계획: `/Users/gim-eunhyang/.claude/plans/linked-jingling-pascal.md`
- Legacy Project (prj-001 등): deterministic hash로 처리
- Collision 안전성: epoch13 (밀리초) + exponential backoff (20회)
