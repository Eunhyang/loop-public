---
entity_type: Task
entity_id: tsk-mzjr8a-1769414529383
entity_name: Recovery - ILOS ë°ì´í„° ë ˆì´ì–´ êµ¬í˜„
created: '2026-01-26'
updated: '2026-01-28'
status: todo
project_id: prj-1t6rif
parent_id: prj-mzjr8a
assignee: ê¹€ì€í–¥
priority: medium
tags: []
type: dev
aliases:
- tsk-mzjr8a-1769414529383
start_date: '2026-02-01'
due: '2026-02-01'
start_time: '16:00'
end_time: '17:00'
notes: "# Recovery - ILOS ë°ì´í„° ë ˆì´ì–´ êµ¬í˜„\n\n## ì„¤ëª…\n\nRecovery Routine + Resetì„ **ILOS\
  \ ì˜¨í†¨ë¡œì§€ ê¸°ë°˜**ìœ¼ë¡œ í”„ë¡œë•ì…˜ì— í†µí•©í•˜ëŠ” ë°ì´í„° ë ˆì´ì–´ êµ¬í˜„.\n\n**í•µì‹¬ ì„¤ê³„ ê²°ì •**:\n\n- âœ… í•˜ë‚˜ì˜ Episodeë¡œ í†µí•© (Recovery\
  \ Routine + Resetì„ ë‹¨ì¼ ì„¸ì…˜ìœ¼ë¡œ)\n- âœ… Full ILOS ì ìš© (Episode + Event ë¶„ë¦¬)\n- âœ… OutcomeMeasurement\
  \ ìë™ ì—°ê²° (2ì‹œê°„ ë‚´ MealDiary ìë™ ë§í¬)\n\n**ILOS ë§¤í•‘ êµ¬ì¡°**:\n\n```\nRecoveryEpisode (Episode)\n\
  â”œâ”€â”€ uuid, episodeType: 'urge_response'\nâ”œâ”€â”€ startedAt, completedAt\nâ”œâ”€â”€ caseType:\
  \ 'home' | 'mobile'\nâ”œâ”€â”€ actionType: 'breathing' | 'water_cup'\nâ”œâ”€â”€ cravingBefore,\
  \ cravingAfter\nâ”‚\nâ”œâ”€â”€ RecoveryEvent[] (Events)\nâ”‚   â”œâ”€â”€ emotion: {emotion: 'anxious',\
  \ emoji: '\U0001F630'}\nâ”‚   â”œâ”€â”€ trigger: {triggers: ['alone', 'stress'], customText:\
  \ '...'}\nâ”‚   â”œâ”€â”€ thought: {thoughtText: '...'}\nâ”‚   â”œâ”€â”€ craving_before: {level:\
  \ 6.5}\nâ”‚   â””â”€â”€ craving_after: {level: 3.0}\nâ”‚\nâ””â”€â”€ MealDiary (OutcomeMeasurement)\n\
  \    â””â”€â”€ recoveryEpisodeUuid â†’ ìë™ ì—°ê²°\n```\n\n---\n\n## Tech Spec\n\n### Architecture\
  \ Compliance\n\n- **Parent Project**: prj-mzjr8a (KkokKkok App v1.0.29 - Release)\n\
  - **Target**: sosi (Flutter)\n- **Pattern**: Local-First + Outbox Pattern (ê¸°ì¡´ ì•„í‚¤í…ì²˜\
  \ ì¤€ìˆ˜)\n- **State**: flutter_bloc + hydrated_bloc\n\n### File Structure - ì‹ ê·œ ìƒì„±\n\
  \n```\nlib/data/models/\nâ”œâ”€â”€ recovery_episode.dart        # Episode ëª¨ë¸ (freezed)\n\
  â”œâ”€â”€ recovery_episode.freezed.dart\nâ”œâ”€â”€ recovery_episode.g.dart\nâ”œâ”€â”€ recovery_event.dart\
  \          # Event ëª¨ë¸ (freezed)\nâ”œâ”€â”€ recovery_event.freezed.dart\nâ””â”€â”€ recovery_event.g.dart\n\
  \nlib/data/local/drift/tables/\nâ”œâ”€â”€ recovery_episode_table.dart  # Drift í…Œì´ë¸” ì •ì˜\n\
  â””â”€â”€ recovery_event_table.dart\n\nlib/data/local/\nâ”œâ”€â”€ recovery_episode_dao.dart\
  \    # Episode CRUD\nâ””â”€â”€ recovery_event_dao.dart      # Event CRUD\n\nlib/data/repositories/\n\
  â””â”€â”€ recovery_repository.dart     # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í†µí•©\n\nlib/data/remote/\nâ”œâ”€â”€ firestore_recovery_episode_data_source.dart\n\
  â””â”€â”€ firestore_recovery_event_data_source.dart\n\nlib/data/local/database/migrations/\n\
  â””â”€â”€ migration_v11.dart           # DB ë§ˆì´ê·¸ë ˆì´ì…˜\n```\n\n### File Structure - ìˆ˜ì •\n\n\
  ```\nlib/data/models/outbox_operation.dart\n  â†’ OutboxEntity enumì— recoveryEpisode,\
  \ recoveryEvent ì¶”ê°€\n\nlib/data/local/drift/app_database.dart\n  â†’ í…Œì´ë¸” ë“±ë¡ + schemaVersion\
  \ 11\n\nlib/data/local/database_helper.dart\n  â†’ DAO ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€\n\nlib/data/services/operation_router.dart\n\
  \  â†’ Recovery í•¸ë“¤ëŸ¬ ì¶”ê°€\n\nlib/data/services/sync_manager_impl.dart\n  â†’ Pull íƒ€ê²Ÿ ì¶”ê°€\n\
  \nlib/data/local/drift/tables/meal_diary_table.dart\n  â†’ recoveryEpisodeUuid ì»¬ëŸ¼\
  \ ì¶”ê°€\n\nlib/data/local/meal_diary_dao.dart\n  â†’ ìë™ì—°ê²° ë©”ì„œë“œ ì¶”ê°€\n```\n\n### Implementation\
  \ Details\n\n1\\. RecoveryEpisode ëª¨ë¸\n\n```dart\n@freezed\nclass RecoveryEpisode\
  \ with _$RecoveryEpisode {\n  const factory RecoveryEpisode({\n    int? id,\n  \
  \  required String uuid,\n    required String episodeType,    // 'urge_response'\
  \ | 'risk_window'\n    required String caseType,       // 'home' | 'mobile'\n  \
  \  required DateTime startedAt,\n    DateTime? completedAt,\n    String? actionType,\
  \             // 'breathing' | 'water_cup' | 'awareness'\n    int? actionDurationSec,\n\
  \    @Default(false) bool actionCompleted,\n    double? cravingBefore,\n    double?\
  \ cravingAfter,\n    String? triggerMealDiaryUuid,\n    required DateTime updatedAt,\n\
  \    DateTime? deletedAt,\n  }) = _RecoveryEpisode;\n}\n```\n\n2\\. RecoveryEvent\
  \ ëª¨ë¸\n\n```dart\n@freezed\nclass RecoveryEvent with _$RecoveryEvent {\n  const factory\
  \ RecoveryEvent({\n    int? id,\n    required String uuid,\n    required String\
  \ episodeUuid,    // FK\n    required String eventType,      // 'emotion' | 'trigger'\
  \ | 'thought' | 'craving_before' | 'craving_after'\n    required String payloadJson,\
  \    // JSON encoded payload\n    required DateTime recordedAt,\n    required DateTime\
  \ updatedAt,\n    DateTime? deletedAt,\n  }) = _RecoveryEvent;\n}\n```\n\n3\\. Drift\
  \ í…Œì´ë¸”\n\n- `RecoveryEpisodeTable`: uuid(PK), episodeType, caseType, startedAt, completedAt,\
  \ actionType, actionDurationSec, actionCompleted, cravingBefore, cravingAfter, triggerMealDiaryUuid,\
  \ updatedAt, deletedAt\n- `RecoveryEventTable`: uuid(PK), episodeUuid(FK), eventType,\
  \ payloadJson, recordedAt, updatedAt, deletedAt\n\n4\\. RecoveryRepository í•µì‹¬ ë©”ì„œë“œ\n\
  \n```dart\nFuture<RecoveryEpisode> startSession(String caseType);\nFuture<void>\
  \ recordEmotion(String episodeUuid, RecoveryEmotion emotion);\nFuture<void> recordTriggers(String\
  \ episodeUuid, List<String> triggers, String? custom);\nFuture<void> recordThought(String\
  \ episodeUuid, String text);\nFuture<void> recordCraving(String episodeUuid, double\
  \ level, String phase);\nFuture<void> completeSession(String episodeUuid, {...});\n\
  Future<void> linkPendingMealOutcome(String mealDiaryUuid);\n```\n\n5\\. Outcome\
  \ ìë™ì—°ê²° ë¡œì§\n\n- MealDiary ì €ì¥ ì‹œ 2ì‹œê°„ ë‚´ ì™„ë£Œëœ RecoveryEpisode ê²€ìƒ‰\n- ë°œê²¬ ì‹œ `recoveryEpisodeUuid`\
  \ í•„ë“œ ìë™ ì„¤ì •\n\n### Edge Cases\n\n1. **ì•± ê°•ì œ ì¢…ë£Œ ì‹œ**: Episodeê°€ completedAt ì—†ì´ ë‚¨ìŒ â†’ 24ì‹œê°„\
  \ ì´ìƒ ë¯¸ì™„ë£Œ EpisodeëŠ” ìë™ ì •ë¦¬ ëŒ€ìƒ\n2. **ë™ì‹œ ì„¸ì…˜ ë°©ì§€**: startSession() í˜¸ì¶œ ì‹œ ì§„í–‰ ì¤‘ì¸ Episode ìˆìœ¼ë©´\
  \ ìë™ ì™„ë£Œ ì²˜ë¦¬\n3. **ë™ê¸°í™” ì¶©ëŒ**: updatedAt ê¸°ì¤€ last-write-wins (ê¸°ì¡´ íŒ¨í„´ ì¤€ìˆ˜)\n4. **Firestore\
  \ ì¿¼ë¦¬ ìµœì í™”**: episodeUuid ì¸ë±ìŠ¤ í•„ìˆ˜\n\n### Firestore Collection êµ¬ì¡°\n\n```\nusers/{uid}/\n\
  â”œâ”€â”€ recovery_episodes/{uuid}\nâ”‚   â”œâ”€â”€ uuid, episodeType, caseType\nâ”‚   â”œâ”€â”€ startedAt,\
  \ completedAt\nâ”‚   â”œâ”€â”€ actionType, actionDurationSec, actionCompleted\nâ”‚   â”œâ”€â”€ cravingBefore,\
  \ cravingAfter\nâ”‚   â””â”€â”€ updatedAt, deletedAt, triggerMealDiaryUuid\nâ”‚\nâ”œâ”€â”€ recovery_events/{uuid}\n\
  â”‚   â”œâ”€â”€ uuid, episodeUuid\nâ”‚   â”œâ”€â”€ eventType, payloadJson\nâ”‚   â”œâ”€â”€ recordedAt\n\
  â”‚   â””â”€â”€ updatedAt, deletedAt\nâ”‚\nâ””â”€â”€ meal_diaries/{uuid}\n    â””â”€â”€ recoveryEpisodeUuid\
  \ (nullable)\n```\n\n---\n\n## ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n### Phase 1: ë°ì´í„° ëª¨ë¸ + DB\n\n- [ ] `lib/data/models/recovery_episode.dart`\
  \ - freezed ëª¨ë¸ ìƒì„±\n\n- [ ] `lib/data/models/recovery_event.dart` - freezed ëª¨ë¸ ìƒì„±\n\
  \n- [ ] `lib/data/local/drift/tables/recovery_episode_table.dart` - Drift í…Œì´ë¸”\n\n\
  - [ ] `lib/data/local/drift/tables/recovery_event_table.dart` - Drift í…Œì´ë¸”\n\n- [\
  \ ] `lib/data/local/database/migrations/migration_v11.dart` - ë§ˆì´ê·¸ë ˆì´ì…˜\n\n- [ ] `lib/data/local/drift/app_database.dart`\
  \ - í…Œì´ë¸” ë“±ë¡ + schemaVersion 11\n\n### Phase 2: DAO\n\n- [ ] `lib/data/local/recovery_episode_dao.dart`\
  \ - BaseDao í™•ì¥\n\n- [ ] `lib/data/local/recovery_event_dao.dart` - BaseDao í™•ì¥\n\n\
  - [ ] `lib/data/local/database_helper.dart` - DAO ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€\n\n### Phase 3: Repository\n\
  \n- [ ] `lib/data/repositories/recovery_repository.dart` - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§\n\n### Phase\
  \ 4: ë™ê¸°í™”\n\n- [ ] `lib/data/models/outbox_operation.dart` - enum í™•ì¥\n\n- [ ] `lib/data/remote/firestore_recovery_episode_data_source.dart`\n\
  \n- [ ] `lib/data/remote/firestore_recovery_event_data_source.dart`\n\n- [ ] `lib/data/services/operation_router.dart`\
  \ - í•¸ë“¤ëŸ¬ ì¶”ê°€\n\n- [ ] `lib/data/services/sync_manager_impl.dart` - Pull íƒ€ê²Ÿ ì¶”ê°€\n\n\
  ### Phase 5: Outcome ì—°ê²°\n\n- [ ] `lib/data/local/drift/tables/meal_diary_table.dart`\
  \ - recoveryEpisodeUuid ì¶”ê°€\n\n- [ ] `lib/data/local/meal_diary_dao.dart` - linkRecoveryEpisode()\
  \ ë©”ì„œë“œ\n\n### Phase 6: ê²€ì¦\n\n- [ ] `flutter pub run build_runner build --delete-conflicting-outputs`\n\
  \n- [ ] `flutter analyze` í†µê³¼\n\n- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ í™•ì¸)\n\n---\n\n## ë¶€ë¡\
  \ A: ìƒì„¸ ìŠ¤í‚¤ë§ˆ ì •ì˜ (Codex ì´ìŠˆ í•´ê²°)\n\n### A1. Enum ê°’ ì •ì˜\n\n```dart\n/// Episode íƒ€ì…\nenum\
  \ RecoveryEpisodeType {\n  urgeResponse,   // ì¶©ë™ ëŒ€ì‘ (ì¦‰ê°ì )\n  riskWindow,     //\
  \ ìœ„í—˜ ì‹œê°„ëŒ€ (ì˜ˆë°©ì )\n}\n\n/// Case íƒ€ì… (UI íë¦„)\nenum RecoveryCaseType {\n  home,    //\
  \ ì§‘ì—ì„œ (ì „ì²´ í”Œë¡œìš°)\n  mobile,  // ì´ë™ ì¤‘ (ê°„ì†Œí™” í”Œë¡œìš°)\n}\n\n/// Action íƒ€ì…\nenum RecoveryActionType\
  \ {\n  breathing,  // í˜¸í¡ ìš´ë™\n  waterCup,   // ë¬¼ í•œ ì»µ\n  awareness,  // ì•Œì•„ì°¨ë¦¼ (ìƒê° ê¸°ë¡ë§Œ)\n\
  }\n\n/// Event íƒ€ì…\nenum RecoveryEventType {\n  emotion,        // ê°ì • ì„ íƒ\n  trigger,\
  \        // íŠ¸ë¦¬ê±° ì„ íƒ\n  thought,        // ìƒê° ê¸°ë¡\n  cravingBefore,  // í–‰ë™ ì „ ê°ˆë§\n \
  \ cravingAfter,   // í–‰ë™ í›„ ê°ˆë§\n}\n```\n\n### A2. Drift í…Œì´ë¸” ìƒì„¸ ìŠ¤í‚¤ë§ˆ\n\n```dart\n//\
  \ recovery_episode_table.dart\n@DataClassName('RecoveryEpisodeEntry')\nclass RecoveryEpisodeTable\
  \ extends Table {\n  @override\n  String get tableName => 'recovery_episode';\n\n\
  \  IntColumn get id => integer().autoIncrement()();\n  TextColumn get uuid => text().unique()();\
  \                    // NOT NULL, UNIQUE\n  TextColumn get episodeType => text()();\
  \                      // NOT NULL\n  TextColumn get caseType => text()();     \
  \                    // NOT NULL\n  DateTimeColumn get startedAt => dateTime()();\
  \                // NOT NULL\n  DateTimeColumn get completedAt => dateTime().nullable()();\
  \   // nullable\n  TextColumn get actionType => text().nullable()();           \
  \ // nullable\n  IntColumn get actionDurationSec => integer().nullable()();   //\
  \ nullable\n  BoolColumn get actionCompleted => boolean().withDefault(const Constant(false))();\n\
  \  RealColumn get cravingBefore => real().nullable()();         // nullable (0.0~10.0)\n\
  \  RealColumn get cravingAfter => real().nullable()();          // nullable (0.0~10.0)\n\
  \  TextColumn get triggerMealDiaryUuid => text().nullable()();  // nullable FK\n\
  \  DateTimeColumn get updatedAt => dateTime()();                // NOT NULL (syncìš©)\n\
  \  DateTimeColumn get deletedAt => dateTime().nullable()();     // soft-delete\n\
  }\n\n// recovery_event_table.dart\n@DataClassName('RecoveryEventEntry')\nclass RecoveryEventTable\
  \ extends Table {\n  @override\n  String get tableName => 'recovery_event';\n\n\
  \  IntColumn get id => integer().autoIncrement()();\n  TextColumn get uuid => text().unique()();\
  \                    // NOT NULL, UNIQUE\n  TextColumn get episodeUuid => text()();\
  \                      // NOT NULL, FK (no cascade)\n  TextColumn get eventType\
  \ => text()();                        // NOT NULL\n  TextColumn get payloadJson\
  \ => text()();                      // NOT NULL, JSON string\n  DateTimeColumn get\
  \ recordedAt => dateTime()();               // NOT NULL\n  DateTimeColumn get updatedAt\
  \ => dateTime()();                // NOT NULL (syncìš©)\n  DateTimeColumn get deletedAt\
  \ => dateTime().nullable()();     // soft-delete\n}\n```\n\n**ì¸ë±ìŠ¤ ì •ì˜** (migration_v11.dartì—ì„œ\
  \ ìƒì„±):\n\n- `recovery_episode`: `uuid` (UNIQUE), `updatedAt` (ë™ê¸°í™” ì¿¼ë¦¬)\n- `recovery_event`:\
  \ `uuid` (UNIQUE), `episodeUuid` (FK ì¡°íšŒ), `episodeUuid + updatedAt` (ë³µí•©)\n\n**FK\
  \ ì •ì±…**: No CASCADE - Episode ì‚­ì œ ì‹œ Eventë„ ëª…ì‹œì  soft-delete ì²˜ë¦¬\n\n### A3. Outbox í”Œë¡œìš°\
  \ ìƒì„¸\n\n```dart\n// outbox_operation.dart ìˆ˜ì •\nenum OutboxEntity {\n  diary,\n  routine,\n\
  \  routineTemplate,\n  profile,\n  routineMealDiaryLink,\n  routineInstance,\n \
  \ weeklyReport,\n  chatMessage,\n  recoveryEpisode,  // \U0001F195 ì¶”ê°€\n  recoveryEvent,\
  \    // \U0001F195 ì¶”ê°€\n}\n\n// OutboxActionì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš©: create, update, delete\n\
  ```\n\n**Outbox Payload ìŠ¤í‚¤ë§ˆ**:\n\n| Entity | Action | Payload |\n| --- | --- | ---\
  \ |\n| recoveryEpisode | create/update | ì „ì²´ í•„ë“œ JSON |\n| recoveryEpisode | delete\
  \ | `{ \"uuid\": \"...\" }` |\n| recoveryEvent | create/update | ì „ì²´ í•„ë“œ JSON |\n\
  | recoveryEvent | delete | `{ \"uuid\": \"...\" }` |\n\n**Delete ì •ì±…**: Soft-delete\
  \ (deletedAt ì„¤ì •) - ê¸°ì¡´ íŒ¨í„´ ì¤€ìˆ˜\n\n### A4. Sync/Pull íƒ€ê²Ÿ ìƒì„¸\n\n```dart\n// sync_manager_impl.dart\
  \ ì¶”ê°€\n_SyncPullTarget(\n  name: 'recovery_episode',\n  fetchUpdated: (s) => recoveryEpisodeDataSource.fetchUpdatedEpisodes(s),\n\
  \  upsertLocal: (e) async {\n    await recoveryEpisodeDao.upsert(e as RecoveryEpisode);\n\
  \  },\n),\n_SyncPullTarget(\n  name: 'recovery_event',\n  fetchUpdated: (s) => recoveryEventDataSource.fetchUpdatedEvents(s),\n\
  \  upsertLocal: (e) async {\n    await recoveryEventDao.upsert(e as RecoveryEvent);\n\
  \  },\n),\n```\n\n**ë™ê¸°í™” ìˆœì„œ**:\n\n1. recovery_episode (ë¨¼ì €)\n2. recovery_event (ë‚˜ì¤‘\
  \ - FK ì˜ì¡´)\n\n**ê³ ì•„ Event ì²˜ë¦¬**:\n\n- Pull ì‹œ episodeUuidê°€ ë¡œì»¬ì— ì—†ìœ¼ë©´ â†’ Event ì €ì¥ ê±´ë„ˆëœ€ (ë‹¤ìŒ\
  \ Sync ì‹œ Episodeê°€ ì˜¬ ìˆ˜ ìˆìŒ)\n- ë˜ëŠ” orphanedEpisodeUuids ë¦¬ìŠ¤íŠ¸ ìœ ì§€ í›„ Episode Pull ì™„ë£Œ í›„\
  \ ì¬ì²˜ë¦¬\n\n**ì¶©ëŒ ì •ì±…**: Last-write-wins (updatedAt ê¸°ì¤€)\n\n### A5. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„¸ (v11)\n\n\
  ```dart\n// database_config.dart\nstatic const int version = 11; // v11 recovery_episode\
  \ + recovery_event\n\n// migration_v11.dart\nFuture<void> migrateToV11(Database\
  \ db) async {\n  await db.transaction((txn) async {\n    // 1. recovery_episode\
  \ í…Œì´ë¸” ìƒì„±\n    await txn.execute('''\n      CREATE TABLE IF NOT EXISTS recovery_episode\
  \ (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        uuid TEXT NOT NULL UNIQUE,\n\
  \        episodeType TEXT NOT NULL,\n        caseType TEXT NOT NULL,\n        startedAt\
  \ TEXT NOT NULL,\n        completedAt TEXT,\n        actionType TEXT,\n        actionDurationSec\
  \ INTEGER,\n        actionCompleted INTEGER NOT NULL DEFAULT 0,\n        cravingBefore\
  \ REAL,\n        cravingAfter REAL,\n        triggerMealDiaryUuid TEXT,\n      \
  \  updatedAt TEXT NOT NULL,\n        deletedAt TEXT\n      )\n    ''');\n\n    //\
  \ 2. recovery_event í…Œì´ë¸” ìƒì„±\n    await txn.execute('''\n      CREATE TABLE IF NOT\
  \ EXISTS recovery_event (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n     \
  \   uuid TEXT NOT NULL UNIQUE,\n        episodeUuid TEXT NOT NULL,\n        eventType\
  \ TEXT NOT NULL,\n        payloadJson TEXT NOT NULL,\n        recordedAt TEXT NOT\
  \ NULL,\n        updatedAt TEXT NOT NULL,\n        deletedAt TEXT\n      )\n   \
  \ ''');\n\n    // 3. ì¸ë±ìŠ¤ ìƒì„±\n    await txn.execute('CREATE INDEX IF NOT EXISTS idx_episode_updated\
  \ ON recovery_episode(updatedAt)');\n    await txn.execute('CREATE INDEX IF NOT\
  \ EXISTS idx_event_episode ON recovery_event(episodeUuid)');\n    await txn.execute('CREATE\
  \ INDEX IF NOT EXISTS idx_event_updated ON recovery_event(updatedAt)');\n\n    //\
  \ 4. meal_diaryì— recoveryEpisodeUuid ì»¬ëŸ¼ ì¶”ê°€\n    final columns = await txn.rawQuery(\"\
  PRAGMA table_info('meal_diary')\");\n    final hasColumn = columns.any((c) => c['name']\
  \ == 'recoveryEpisodeUuid');\n    if (!hasColumn) {\n      await txn.execute('ALTER\
  \ TABLE meal_diary ADD COLUMN recoveryEpisodeUuid TEXT');\n    }\n\n    // 5. ê²€ì¦\n\
  \    await _validateMigration(txn);\n  });\n}\n```\n\n### A6. MealDiary ìë™ì—°ê²° ìƒì„¸\n\
  \n**ê¸°ì¤€ íƒ€ì„ìŠ¤íƒ¬í”„**: `Episode.completedAt`\n\n**ë¡œì§**:\n\n```dart\n// meal_diary_dao.dart\n\
  Future<void> linkRecoveryEpisodeIfNeeded(String mealDiaryUuid, DateTime mealTime)\
  \ async {\n  // 1. mealTime ê¸°ì¤€ 2ì‹œê°„ ì´ì „ ~ mealTime ì‚¬ì´ì— completedAtì´ ìˆëŠ” Episode ê²€ìƒ‰\n\
  \  final twoHoursBefore = mealTime.subtract(Duration(hours: 2));\n\n  final episodes\
  \ = await db.query(\n    'recovery_episode',\n    where: 'completedAt IS NOT NULL\
  \ AND completedAt >= ? AND completedAt <= ? AND deletedAt IS NULL',\n    whereArgs:\
  \ [twoHoursBefore.toIso8601String(), mealTime.toIso8601String()],\n    orderBy:\
  \ 'completedAt DESC',\n    limit: 1,\n  );\n\n  if (episodes.isEmpty) return;\n\n\
  \  final episodeUuid = episodes.first['uuid'] as String;\n\n  // 2. MealDiaryì— ì—°ê²°\
  \ (ì´ë¯¸ ì—°ê²°ëœ ê²½ìš° ë®ì–´ì“°ê¸° ì•ˆ í•¨)\n  await db.update(\n    'meal_diary',\n    {'recoveryEpisodeUuid':\
  \ episodeUuid, 'updatedAt': DateTime.now().toUtc().toIso8601String()},\n    where:\
  \ 'uuid = ? AND recoveryEpisodeUuid IS NULL',\n    whereArgs: [mealDiaryUuid],\n\
  \  );\n\n  // 3. Outbox ê¸°ë¡ (Firestore ë™ê¸°í™”)\n  // ... OutboxOperation ìƒì„±\n}\n```\n\
  \n**ë‹¤ì¤‘ MealDiary ì²˜ë¦¬**: ê°€ì¥ ìµœê·¼ completedAt Episode 1ê°œë§Œ ì—°ê²°\n\n**Episode ì‚­ì œ ì‹œ**: MealDiaryì˜\
  \ recoveryEpisodeUuidë¥¼ NULLë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (íˆìŠ¤í† ë¦¬ ë³´ì¡´)\n\n**ì—°ê²° ì‹œì **: MealDiary INSERT/UPDATE\
  \ í›„ í˜¸ì¶œ\n\n### A7. Repository API ìƒì„¸\n\n```dart\nclass RecoveryRepository {\n  RecoveryRepository({\n\
  \    required this.episodeDao,\n    required this.eventDao,\n    required this.outboxDao,\n\
  \  });\n\n  final RecoveryEpisodeDao episodeDao;\n  final RecoveryEventDao eventDao;\n\
  \  final OutboxDao outboxDao;\n\n  /// ìƒˆ ì„¸ì…˜ ì‹œì‘ - ì§„í–‰ ì¤‘ì¸ Episode ìˆìœ¼ë©´ ìë™ ì™„ë£Œ ì²˜ë¦¬\n  Future<RecoveryEpisode>\
  \ startSession({\n    required RecoveryCaseType caseType,\n    RecoveryEpisodeType\
  \ episodeType = RecoveryEpisodeType.urgeResponse,\n  }) async {\n    // 1. ì§„í–‰ ì¤‘ì¸\
  \ Episode ì™„ë£Œ ì²˜ë¦¬\n    await _completeIncompleteEpisodes();\n\n    // 2. ìƒˆ Episode\
  \ ìƒì„±\n    final episode = RecoveryEpisode(\n      uuid: Uuid().v4(),\n      episodeType:\
  \ episodeType.name,\n      caseType: caseType.name,\n      startedAt: DateTime.now().toUtc(),\n\
  \      updatedAt: DateTime.now().toUtc(),\n    );\n\n    await episodeDao.upsert(episode);\n\
  \    await _enqueueOutbox(OutboxEntity.recoveryEpisode, OutboxAction.create, episode);\n\
  \n    return episode;\n  }\n\n  /// Event ê¸°ë¡ (ë‚´ë¶€ì ìœ¼ë¡œ Outbox ìë™ ìƒì„±)\n  Future<RecoveryEvent>\
  \ _recordEvent({\n    required String episodeUuid,\n    required RecoveryEventType\
  \ eventType,\n    required Map<String, dynamic> payload,\n  }) async {\n    final\
  \ event = RecoveryEvent(\n      uuid: Uuid().v4(),\n      episodeUuid: episodeUuid,\n\
  \      eventType: eventType.name,\n      payloadJson: jsonEncode(payload),\n   \
  \   recordedAt: DateTime.now().toUtc(),\n      updatedAt: DateTime.now().toUtc(),\n\
  \    );\n\n    await eventDao.upsert(event);\n    await _enqueueOutbox(OutboxEntity.recoveryEvent,\
  \ OutboxAction.create, event);\n\n    return event;\n  }\n\n  /// ê°ì • ê¸°ë¡\n  Future<void>\
  \ recordEmotion(String episodeUuid, String emotion, String emoji) =>\n    _recordEvent(\n\
  \      episodeUuid: episodeUuid,\n      eventType: RecoveryEventType.emotion,\n\
  \      payload: {'emotion': emotion, 'emoji': emoji},\n    );\n\n  /// íŠ¸ë¦¬ê±° ê¸°ë¡\n\
  \  Future<void> recordTriggers(String episodeUuid, List<String> triggers, String?\
  \ customText) =>\n    _recordEvent(\n      episodeUuid: episodeUuid,\n      eventType:\
  \ RecoveryEventType.trigger,\n      payload: {'triggers': triggers, 'customText':\
  \ customText},\n    );\n\n  /// ìƒê° ê¸°ë¡\n  Future<void> recordThought(String episodeUuid,\
  \ String text) =>\n    _recordEvent(\n      episodeUuid: episodeUuid,\n      eventType:\
  \ RecoveryEventType.thought,\n      payload: {'thoughtText': text},\n    );\n\n\
  \  /// ê°ˆë§ ë ˆë²¨ ê¸°ë¡\n  Future<void> recordCraving(String episodeUuid, double level,\
  \ String phase) async {\n    final eventType = phase == 'before'\n      ? RecoveryEventType.cravingBefore\n\
  \      : RecoveryEventType.cravingAfter;\n\n    await _recordEvent(\n      episodeUuid:\
  \ episodeUuid,\n      eventType: eventType,\n      payload: {'level': level},\n\
  \    );\n\n    // Episodeì—ë„ denormalized ì €ì¥ (ì¿¼ë¦¬ í¸ì˜)\n    final field = phase ==\
  \ 'before' ? 'cravingBefore' : 'cravingAfter';\n    await episodeDao.updateField(episodeUuid,\
  \ field, level);\n  }\n\n  /// ì„¸ì…˜ ì™„ë£Œ\n  Future<void> completeSession(\n    String\
  \ episodeUuid, {\n    RecoveryActionType? actionType,\n    int? actionDurationSec,\n\
  \    bool actionCompleted = false,\n  }) async {\n    await episodeDao.complete(\n\
  \      episodeUuid,\n      actionType: actionType?.name,\n      actionDurationSec:\
  \ actionDurationSec,\n      actionCompleted: actionCompleted,\n    );\n\n    //\
  \ Outbox update\n    final episode = await episodeDao.findByUuid(episodeUuid);\n\
  \    if (episode != null) {\n      await _enqueueOutbox(OutboxEntity.recoveryEpisode,\
  \ OutboxAction.update, episode);\n    }\n  }\n\n  /// ìµœê·¼ Episode ì¡°íšŒ (í†µê³„ìš©)\n  Future<List<RecoveryEpisode>>\
  \ getRecentEpisodes({int days = 7}) =>\n    episodeDao.fetchRecent(days: days);\n\
  \n  /// Episodeì— ì—°ê²°ëœ Event ì¡°íšŒ\n  Future<List<RecoveryEvent>> getEventsForEpisode(String\
  \ episodeUuid) =>\n    eventDao.fetchByEpisodeUuid(episodeUuid);\n}\n```\n\n###\
  \ A8. Freezed ì§ë ¬í™” ìƒì„¸\n\n```dart\n// recovery_episode.dart\n@freezed\nclass RecoveryEpisode\
  \ with _$RecoveryEpisode {\n  const factory RecoveryEpisode({\n    int? id,\n  \
  \  required String uuid,\n    required String episodeType,\n    required String\
  \ caseType,\n    required DateTime startedAt,\n    DateTime? completedAt,\n    String?\
  \ actionType,\n    int? actionDurationSec,\n    @Default(false) bool actionCompleted,\n\
  \    double? cravingBefore,\n    double? cravingAfter,\n    String? triggerMealDiaryUuid,\n\
  \    required DateTime updatedAt,\n    DateTime? deletedAt,\n  }) = _RecoveryEpisode;\n\
  \n  /// JSON ì§ë ¬í™” (Firestore/Outboxìš©)\n  factory RecoveryEpisode.fromJson(Map<String,\
  \ dynamic> json) =>\n      _$RecoveryEpisodeFromJson(json);\n}\n\n// recovery_episode.g.dart\
  \ (build_runner ìƒì„±)\n// DateTimeì€ ISO8601 Stringìœ¼ë¡œ ìë™ ë³€í™˜\n```\n\n**DAO toMap/fromEntry\
  \ ë³€í™˜**:\n\n```dart\nMap<String, dynamic> toMap(RecoveryEpisode model) => {\n  'id':\
  \ model.id,\n  'uuid': model.uuid,\n  'episodeType': model.episodeType,\n  'caseType':\
  \ model.caseType,\n  'startedAt': model.startedAt.toIso8601String(),\n  'completedAt':\
  \ model.completedAt?.toIso8601String(),\n  // ... ë‚˜ë¨¸ì§€ í•„ë“œ\n  'updatedAt': model.updatedAt.toIso8601String(),\n\
  \  'deletedAt': model.deletedAt?.toIso8601String(),\n};\n\nRecoveryEpisode fromEntry(RecoveryEpisodeEntry\
  \ e) => RecoveryEpisode(\n  id: e.id,\n  uuid: e.uuid,\n  episodeType: e.episodeType,\n\
  \  caseType: e.caseType,\n  startedAt: e.startedAt,\n  completedAt: e.completedAt,\n\
  \  // ... DriftëŠ” DateTime ìë™ ì²˜ë¦¬\n  updatedAt: e.updatedAt,\n  deletedAt: e.deletedAt,\n\
  );\n```\n\n---\n\n## ì°¸ê³ \n\n- **BaseDao íŒ¨í„´**: `lib/data/local/base_dao.dart`\n- **Drift\
  \ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì‹œ**: `lib/data/local/database/migrations/migration_v10.dart`\n- **OutboxEntity\
  \ ì˜ˆì‹œ**: `lib/data/models/outbox_operation.dart`\n- **OperationRouter ì˜ˆì‹œ**: `lib/data/services/operation_router.dart`\n\
  - **SyncManager ì˜ˆì‹œ**: `lib/data/services/sync_manager_impl.dart`\n- **DatabaseConfig**:\
  \ `lib/data/local/database_config.dart` (í˜„ì¬ v10)\n\n---\n\n## ì§§ì€ íšŒê³ "
---
# Recovery - ILOS ë°ì´í„° ë ˆì´ì–´ êµ¬í˜„

## ì„¤ëª…

Recovery Routine + Resetì„ **ILOS ì˜¨í†¨ë¡œì§€ ê¸°ë°˜**ìœ¼ë¡œ í”„ë¡œë•ì…˜ì— í†µí•©í•˜ëŠ” ë°ì´í„° ë ˆì´ì–´ êµ¬í˜„.

**í•µì‹¬ ì„¤ê³„ ê²°ì •**:
- âœ… í•˜ë‚˜ì˜ Episodeë¡œ í†µí•© (Recovery Routine + Resetì„ ë‹¨ì¼ ì„¸ì…˜ìœ¼ë¡œ)
- âœ… Full ILOS ì ìš© (Episode + Event ë¶„ë¦¬)
- âœ… OutcomeMeasurement ìë™ ì—°ê²° (2ì‹œê°„ ë‚´ MealDiary ìë™ ë§í¬)

**ILOS ë§¤í•‘ êµ¬ì¡°**:
```
RecoveryEpisode (Episode)
â”œâ”€â”€ uuid, episodeType: 'urge_response'
â”œâ”€â”€ startedAt, completedAt
â”œâ”€â”€ caseType: 'home' | 'mobile'
â”œâ”€â”€ actionType: 'breathing' | 'water_cup'
â”œâ”€â”€ cravingBefore, cravingAfter
â”‚
â”œâ”€â”€ RecoveryEvent[] (Events)
â”‚   â”œâ”€â”€ emotion: {emotion: 'anxious', emoji: 'ğŸ˜°'}
â”‚   â”œâ”€â”€ trigger: {triggers: ['alone', 'stress'], customText: '...'}
â”‚   â”œâ”€â”€ thought: {thoughtText: '...'}
â”‚   â”œâ”€â”€ craving_before: {level: 6.5}
â”‚   â””â”€â”€ craving_after: {level: 3.0}
â”‚
â””â”€â”€ MealDiary (OutcomeMeasurement)
    â””â”€â”€ recoveryEpisodeUuid â†’ ìë™ ì—°ê²°
```

---

## Tech Spec

### Architecture Compliance
- **Parent Project**: prj-mzjr8a (KkokKkok App v1.0.29 - Release)
- **Target**: sosi (Flutter)
- **Pattern**: Local-First + Outbox Pattern (ê¸°ì¡´ ì•„í‚¤í…ì²˜ ì¤€ìˆ˜)
- **State**: flutter_bloc + hydrated_bloc

### File Structure - ì‹ ê·œ ìƒì„±

```
lib/data/models/
â”œâ”€â”€ recovery_episode.dart        # Episode ëª¨ë¸ (freezed)
â”œâ”€â”€ recovery_episode.freezed.dart
â”œâ”€â”€ recovery_episode.g.dart
â”œâ”€â”€ recovery_event.dart          # Event ëª¨ë¸ (freezed)
â”œâ”€â”€ recovery_event.freezed.dart
â””â”€â”€ recovery_event.g.dart

lib/data/local/drift/tables/
â”œâ”€â”€ recovery_episode_table.dart  # Drift í…Œì´ë¸” ì •ì˜
â””â”€â”€ recovery_event_table.dart

lib/data/local/
â”œâ”€â”€ recovery_episode_dao.dart    # Episode CRUD
â””â”€â”€ recovery_event_dao.dart      # Event CRUD

lib/data/repositories/
â””â”€â”€ recovery_repository.dart     # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í†µí•©

lib/data/remote/
â”œâ”€â”€ firestore_recovery_episode_data_source.dart
â””â”€â”€ firestore_recovery_event_data_source.dart

lib/data/local/database/migrations/
â””â”€â”€ migration_v11.dart           # DB ë§ˆì´ê·¸ë ˆì´ì…˜
```

### File Structure - ìˆ˜ì •

```
lib/data/models/outbox_operation.dart
  â†’ OutboxEntity enumì— recoveryEpisode, recoveryEvent ì¶”ê°€

lib/data/local/drift/app_database.dart
  â†’ í…Œì´ë¸” ë“±ë¡ + schemaVersion 11

lib/data/local/database_helper.dart
  â†’ DAO ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€

lib/data/services/operation_router.dart
  â†’ Recovery í•¸ë“¤ëŸ¬ ì¶”ê°€

lib/data/services/sync_manager_impl.dart
  â†’ Pull íƒ€ê²Ÿ ì¶”ê°€

lib/data/local/drift/tables/meal_diary_table.dart
  â†’ recoveryEpisodeUuid ì»¬ëŸ¼ ì¶”ê°€

lib/data/local/meal_diary_dao.dart
  â†’ ìë™ì—°ê²° ë©”ì„œë“œ ì¶”ê°€
```

### Implementation Details

#### 1. RecoveryEpisode ëª¨ë¸
```dart
@freezed
class RecoveryEpisode with _$RecoveryEpisode {
  const factory RecoveryEpisode({
    int? id,
    required String uuid,
    required String episodeType,    // 'urge_response' | 'risk_window'
    required String caseType,       // 'home' | 'mobile'
    required DateTime startedAt,
    DateTime? completedAt,
    String? actionType,             // 'breathing' | 'water_cup' | 'awareness'
    int? actionDurationSec,
    @Default(false) bool actionCompleted,
    double? cravingBefore,
    double? cravingAfter,
    String? triggerMealDiaryUuid,
    required DateTime updatedAt,
    DateTime? deletedAt,
  }) = _RecoveryEpisode;
}
```

#### 2. RecoveryEvent ëª¨ë¸
```dart
@freezed
class RecoveryEvent with _$RecoveryEvent {
  const factory RecoveryEvent({
    int? id,
    required String uuid,
    required String episodeUuid,    // FK
    required String eventType,      // 'emotion' | 'trigger' | 'thought' | 'craving_before' | 'craving_after'
    required String payloadJson,    // JSON encoded payload
    required DateTime recordedAt,
    required DateTime updatedAt,
    DateTime? deletedAt,
  }) = _RecoveryEvent;
}
```

#### 3. Drift í…Œì´ë¸”
- `RecoveryEpisodeTable`: uuid(PK), episodeType, caseType, startedAt, completedAt, actionType, actionDurationSec, actionCompleted, cravingBefore, cravingAfter, triggerMealDiaryUuid, updatedAt, deletedAt
- `RecoveryEventTable`: uuid(PK), episodeUuid(FK), eventType, payloadJson, recordedAt, updatedAt, deletedAt

#### 4. RecoveryRepository í•µì‹¬ ë©”ì„œë“œ
```dart
Future<RecoveryEpisode> startSession(String caseType);
Future<void> recordEmotion(String episodeUuid, RecoveryEmotion emotion);
Future<void> recordTriggers(String episodeUuid, List<String> triggers, String? custom);
Future<void> recordThought(String episodeUuid, String text);
Future<void> recordCraving(String episodeUuid, double level, String phase);
Future<void> completeSession(String episodeUuid, {...});
Future<void> linkPendingMealOutcome(String mealDiaryUuid);
```

#### 5. Outcome ìë™ì—°ê²° ë¡œì§
- MealDiary ì €ì¥ ì‹œ 2ì‹œê°„ ë‚´ ì™„ë£Œëœ RecoveryEpisode ê²€ìƒ‰
- ë°œê²¬ ì‹œ `recoveryEpisodeUuid` í•„ë“œ ìë™ ì„¤ì •

### Edge Cases

1. **ì•± ê°•ì œ ì¢…ë£Œ ì‹œ**: Episodeê°€ completedAt ì—†ì´ ë‚¨ìŒ â†’ 24ì‹œê°„ ì´ìƒ ë¯¸ì™„ë£Œ EpisodeëŠ” ìë™ ì •ë¦¬ ëŒ€ìƒ
2. **ë™ì‹œ ì„¸ì…˜ ë°©ì§€**: startSession() í˜¸ì¶œ ì‹œ ì§„í–‰ ì¤‘ì¸ Episode ìˆìœ¼ë©´ ìë™ ì™„ë£Œ ì²˜ë¦¬
3. **ë™ê¸°í™” ì¶©ëŒ**: updatedAt ê¸°ì¤€ last-write-wins (ê¸°ì¡´ íŒ¨í„´ ì¤€ìˆ˜)
4. **Firestore ì¿¼ë¦¬ ìµœì í™”**: episodeUuid ì¸ë±ìŠ¤ í•„ìˆ˜

### Firestore Collection êµ¬ì¡°

```
users/{uid}/
â”œâ”€â”€ recovery_episodes/{uuid}
â”‚   â”œâ”€â”€ uuid, episodeType, caseType
â”‚   â”œâ”€â”€ startedAt, completedAt
â”‚   â”œâ”€â”€ actionType, actionDurationSec, actionCompleted
â”‚   â”œâ”€â”€ cravingBefore, cravingAfter
â”‚   â””â”€â”€ updatedAt, deletedAt, triggerMealDiaryUuid
â”‚
â”œâ”€â”€ recovery_events/{uuid}
â”‚   â”œâ”€â”€ uuid, episodeUuid
â”‚   â”œâ”€â”€ eventType, payloadJson
â”‚   â”œâ”€â”€ recordedAt
â”‚   â””â”€â”€ updatedAt, deletedAt
â”‚
â””â”€â”€ meal_diaries/{uuid}
    â””â”€â”€ recoveryEpisodeUuid (nullable)
```

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ë°ì´í„° ëª¨ë¸ + DB
- [ ] `lib/data/models/recovery_episode.dart` - freezed ëª¨ë¸ ìƒì„±
- [ ] `lib/data/models/recovery_event.dart` - freezed ëª¨ë¸ ìƒì„±
- [ ] `lib/data/local/drift/tables/recovery_episode_table.dart` - Drift í…Œì´ë¸”
- [ ] `lib/data/local/drift/tables/recovery_event_table.dart` - Drift í…Œì´ë¸”
- [ ] `lib/data/local/database/migrations/migration_v11.dart` - ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] `lib/data/local/drift/app_database.dart` - í…Œì´ë¸” ë“±ë¡ + schemaVersion 11

### Phase 2: DAO
- [ ] `lib/data/local/recovery_episode_dao.dart` - BaseDao í™•ì¥
- [ ] `lib/data/local/recovery_event_dao.dart` - BaseDao í™•ì¥
- [ ] `lib/data/local/database_helper.dart` - DAO ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€

### Phase 3: Repository
- [ ] `lib/data/repositories/recovery_repository.dart` - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### Phase 4: ë™ê¸°í™”
- [ ] `lib/data/models/outbox_operation.dart` - enum í™•ì¥
- [ ] `lib/data/remote/firestore_recovery_episode_data_source.dart`
- [ ] `lib/data/remote/firestore_recovery_event_data_source.dart`
- [ ] `lib/data/services/operation_router.dart` - í•¸ë“¤ëŸ¬ ì¶”ê°€
- [ ] `lib/data/services/sync_manager_impl.dart` - Pull íƒ€ê²Ÿ ì¶”ê°€

### Phase 5: Outcome ì—°ê²°
- [ ] `lib/data/local/drift/tables/meal_diary_table.dart` - recoveryEpisodeUuid ì¶”ê°€
- [ ] `lib/data/local/meal_diary_dao.dart` - linkRecoveryEpisode() ë©”ì„œë“œ

### Phase 6: ê²€ì¦
- [ ] `flutter pub run build_runner build --delete-conflicting-outputs`
- [ ] `flutter analyze` í†µê³¼
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ í™•ì¸)

---

## ë¶€ë¡ A: ìƒì„¸ ìŠ¤í‚¤ë§ˆ ì •ì˜ (Codex ì´ìŠˆ í•´ê²°)

### A1. Enum ê°’ ì •ì˜

```dart
/// Episode íƒ€ì…
enum RecoveryEpisodeType {
  urgeResponse,   // ì¶©ë™ ëŒ€ì‘ (ì¦‰ê°ì )
  riskWindow,     // ìœ„í—˜ ì‹œê°„ëŒ€ (ì˜ˆë°©ì )
}

/// Case íƒ€ì… (UI íë¦„)
enum RecoveryCaseType {
  home,    // ì§‘ì—ì„œ (ì „ì²´ í”Œë¡œìš°)
  mobile,  // ì´ë™ ì¤‘ (ê°„ì†Œí™” í”Œë¡œìš°)
}

/// Action íƒ€ì…
enum RecoveryActionType {
  breathing,  // í˜¸í¡ ìš´ë™
  waterCup,   // ë¬¼ í•œ ì»µ
  awareness,  // ì•Œì•„ì°¨ë¦¼ (ìƒê° ê¸°ë¡ë§Œ)
}

/// Event íƒ€ì…
enum RecoveryEventType {
  emotion,        // ê°ì • ì„ íƒ
  trigger,        // íŠ¸ë¦¬ê±° ì„ íƒ
  thought,        // ìƒê° ê¸°ë¡
  cravingBefore,  // í–‰ë™ ì „ ê°ˆë§
  cravingAfter,   // í–‰ë™ í›„ ê°ˆë§
}
```

### A2. Drift í…Œì´ë¸” ìƒì„¸ ìŠ¤í‚¤ë§ˆ

```dart
// recovery_episode_table.dart
@DataClassName('RecoveryEpisodeEntry')
class RecoveryEpisodeTable extends Table {
  @override
  String get tableName => 'recovery_episode';

  IntColumn get id => integer().autoIncrement()();
  TextColumn get uuid => text().unique()();                    // NOT NULL, UNIQUE
  TextColumn get episodeType => text()();                      // NOT NULL
  TextColumn get caseType => text()();                         // NOT NULL
  DateTimeColumn get startedAt => dateTime()();                // NOT NULL
  DateTimeColumn get completedAt => dateTime().nullable()();   // nullable
  TextColumn get actionType => text().nullable()();            // nullable
  IntColumn get actionDurationSec => integer().nullable()();   // nullable
  BoolColumn get actionCompleted => boolean().withDefault(const Constant(false))();
  RealColumn get cravingBefore => real().nullable()();         // nullable (0.0~10.0)
  RealColumn get cravingAfter => real().nullable()();          // nullable (0.0~10.0)
  TextColumn get triggerMealDiaryUuid => text().nullable()();  // nullable FK
  DateTimeColumn get updatedAt => dateTime()();                // NOT NULL (syncìš©)
  DateTimeColumn get deletedAt => dateTime().nullable()();     // soft-delete
}

// recovery_event_table.dart
@DataClassName('RecoveryEventEntry')
class RecoveryEventTable extends Table {
  @override
  String get tableName => 'recovery_event';

  IntColumn get id => integer().autoIncrement()();
  TextColumn get uuid => text().unique()();                    // NOT NULL, UNIQUE
  TextColumn get episodeUuid => text()();                      // NOT NULL, FK (no cascade)
  TextColumn get eventType => text()();                        // NOT NULL
  TextColumn get payloadJson => text()();                      // NOT NULL, JSON string
  DateTimeColumn get recordedAt => dateTime()();               // NOT NULL
  DateTimeColumn get updatedAt => dateTime()();                // NOT NULL (syncìš©)
  DateTimeColumn get deletedAt => dateTime().nullable()();     // soft-delete
}
```

**ì¸ë±ìŠ¤ ì •ì˜** (migration_v11.dartì—ì„œ ìƒì„±):
- `recovery_episode`: `uuid` (UNIQUE), `updatedAt` (ë™ê¸°í™” ì¿¼ë¦¬)
- `recovery_event`: `uuid` (UNIQUE), `episodeUuid` (FK ì¡°íšŒ), `episodeUuid + updatedAt` (ë³µí•©)

**FK ì •ì±…**: No CASCADE - Episode ì‚­ì œ ì‹œ Eventë„ ëª…ì‹œì  soft-delete ì²˜ë¦¬

### A3. Outbox í”Œë¡œìš° ìƒì„¸

```dart
// outbox_operation.dart ìˆ˜ì •
enum OutboxEntity {
  diary,
  routine,
  routineTemplate,
  profile,
  routineMealDiaryLink,
  routineInstance,
  weeklyReport,
  chatMessage,
  recoveryEpisode,  // ğŸ†• ì¶”ê°€
  recoveryEvent,    // ğŸ†• ì¶”ê°€
}

// OutboxActionì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš©: create, update, delete
```

**Outbox Payload ìŠ¤í‚¤ë§ˆ**:

| Entity | Action | Payload |
|--------|--------|---------|
| recoveryEpisode | create/update | ì „ì²´ í•„ë“œ JSON |
| recoveryEpisode | delete | `{ "uuid": "..." }` |
| recoveryEvent | create/update | ì „ì²´ í•„ë“œ JSON |
| recoveryEvent | delete | `{ "uuid": "..." }` |

**Delete ì •ì±…**: Soft-delete (deletedAt ì„¤ì •) - ê¸°ì¡´ íŒ¨í„´ ì¤€ìˆ˜

### A4. Sync/Pull íƒ€ê²Ÿ ìƒì„¸

```dart
// sync_manager_impl.dart ì¶”ê°€
_SyncPullTarget(
  name: 'recovery_episode',
  fetchUpdated: (s) => recoveryEpisodeDataSource.fetchUpdatedEpisodes(s),
  upsertLocal: (e) async {
    await recoveryEpisodeDao.upsert(e as RecoveryEpisode);
  },
),
_SyncPullTarget(
  name: 'recovery_event',
  fetchUpdated: (s) => recoveryEventDataSource.fetchUpdatedEvents(s),
  upsertLocal: (e) async {
    await recoveryEventDao.upsert(e as RecoveryEvent);
  },
),
```

**ë™ê¸°í™” ìˆœì„œ**:
1. recovery_episode (ë¨¼ì €)
2. recovery_event (ë‚˜ì¤‘ - FK ì˜ì¡´)

**ê³ ì•„ Event ì²˜ë¦¬**:
- Pull ì‹œ episodeUuidê°€ ë¡œì»¬ì— ì—†ìœ¼ë©´ â†’ Event ì €ì¥ ê±´ë„ˆëœ€ (ë‹¤ìŒ Sync ì‹œ Episodeê°€ ì˜¬ ìˆ˜ ìˆìŒ)
- ë˜ëŠ” orphanedEpisodeUuids ë¦¬ìŠ¤íŠ¸ ìœ ì§€ í›„ Episode Pull ì™„ë£Œ í›„ ì¬ì²˜ë¦¬

**ì¶©ëŒ ì •ì±…**: Last-write-wins (updatedAt ê¸°ì¤€)

### A5. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„¸ (v11)

```dart
// database_config.dart
static const int version = 11; // v11 recovery_episode + recovery_event

// migration_v11.dart
Future<void> migrateToV11(Database db) async {
  await db.transaction((txn) async {
    // 1. recovery_episode í…Œì´ë¸” ìƒì„±
    await txn.execute('''
      CREATE TABLE IF NOT EXISTS recovery_episode (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        uuid TEXT NOT NULL UNIQUE,
        episodeType TEXT NOT NULL,
        caseType TEXT NOT NULL,
        startedAt TEXT NOT NULL,
        completedAt TEXT,
        actionType TEXT,
        actionDurationSec INTEGER,
        actionCompleted INTEGER NOT NULL DEFAULT 0,
        cravingBefore REAL,
        cravingAfter REAL,
        triggerMealDiaryUuid TEXT,
        updatedAt TEXT NOT NULL,
        deletedAt TEXT
      )
    ''');

    // 2. recovery_event í…Œì´ë¸” ìƒì„±
    await txn.execute('''
      CREATE TABLE IF NOT EXISTS recovery_event (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        uuid TEXT NOT NULL UNIQUE,
        episodeUuid TEXT NOT NULL,
        eventType TEXT NOT NULL,
        payloadJson TEXT NOT NULL,
        recordedAt TEXT NOT NULL,
        updatedAt TEXT NOT NULL,
        deletedAt TEXT
      )
    ''');

    // 3. ì¸ë±ìŠ¤ ìƒì„±
    await txn.execute('CREATE INDEX IF NOT EXISTS idx_episode_updated ON recovery_episode(updatedAt)');
    await txn.execute('CREATE INDEX IF NOT EXISTS idx_event_episode ON recovery_event(episodeUuid)');
    await txn.execute('CREATE INDEX IF NOT EXISTS idx_event_updated ON recovery_event(updatedAt)');

    // 4. meal_diaryì— recoveryEpisodeUuid ì»¬ëŸ¼ ì¶”ê°€
    final columns = await txn.rawQuery("PRAGMA table_info('meal_diary')");
    final hasColumn = columns.any((c) => c['name'] == 'recoveryEpisodeUuid');
    if (!hasColumn) {
      await txn.execute('ALTER TABLE meal_diary ADD COLUMN recoveryEpisodeUuid TEXT');
    }

    // 5. ê²€ì¦
    await _validateMigration(txn);
  });
}
```

### A6. MealDiary ìë™ì—°ê²° ìƒì„¸

**ê¸°ì¤€ íƒ€ì„ìŠ¤íƒ¬í”„**: `Episode.completedAt`

**ë¡œì§**:
```dart
// meal_diary_dao.dart
Future<void> linkRecoveryEpisodeIfNeeded(String mealDiaryUuid, DateTime mealTime) async {
  // 1. mealTime ê¸°ì¤€ 2ì‹œê°„ ì´ì „ ~ mealTime ì‚¬ì´ì— completedAtì´ ìˆëŠ” Episode ê²€ìƒ‰
  final twoHoursBefore = mealTime.subtract(Duration(hours: 2));

  final episodes = await db.query(
    'recovery_episode',
    where: 'completedAt IS NOT NULL AND completedAt >= ? AND completedAt <= ? AND deletedAt IS NULL',
    whereArgs: [twoHoursBefore.toIso8601String(), mealTime.toIso8601String()],
    orderBy: 'completedAt DESC',
    limit: 1,
  );

  if (episodes.isEmpty) return;

  final episodeUuid = episodes.first['uuid'] as String;

  // 2. MealDiaryì— ì—°ê²° (ì´ë¯¸ ì—°ê²°ëœ ê²½ìš° ë®ì–´ì“°ê¸° ì•ˆ í•¨)
  await db.update(
    'meal_diary',
    {'recoveryEpisodeUuid': episodeUuid, 'updatedAt': DateTime.now().toUtc().toIso8601String()},
    where: 'uuid = ? AND recoveryEpisodeUuid IS NULL',
    whereArgs: [mealDiaryUuid],
  );

  // 3. Outbox ê¸°ë¡ (Firestore ë™ê¸°í™”)
  // ... OutboxOperation ìƒì„±
}
```

**ë‹¤ì¤‘ MealDiary ì²˜ë¦¬**: ê°€ì¥ ìµœê·¼ completedAt Episode 1ê°œë§Œ ì—°ê²°

**Episode ì‚­ì œ ì‹œ**: MealDiaryì˜ recoveryEpisodeUuidë¥¼ NULLë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (íˆìŠ¤í† ë¦¬ ë³´ì¡´)

**ì—°ê²° ì‹œì **: MealDiary INSERT/UPDATE í›„ í˜¸ì¶œ

### A7. Repository API ìƒì„¸

```dart
class RecoveryRepository {
  RecoveryRepository({
    required this.episodeDao,
    required this.eventDao,
    required this.outboxDao,
  });

  final RecoveryEpisodeDao episodeDao;
  final RecoveryEventDao eventDao;
  final OutboxDao outboxDao;

  /// ìƒˆ ì„¸ì…˜ ì‹œì‘ - ì§„í–‰ ì¤‘ì¸ Episode ìˆìœ¼ë©´ ìë™ ì™„ë£Œ ì²˜ë¦¬
  Future<RecoveryEpisode> startSession({
    required RecoveryCaseType caseType,
    RecoveryEpisodeType episodeType = RecoveryEpisodeType.urgeResponse,
  }) async {
    // 1. ì§„í–‰ ì¤‘ì¸ Episode ì™„ë£Œ ì²˜ë¦¬
    await _completeIncompleteEpisodes();

    // 2. ìƒˆ Episode ìƒì„±
    final episode = RecoveryEpisode(
      uuid: Uuid().v4(),
      episodeType: episodeType.name,
      caseType: caseType.name,
      startedAt: DateTime.now().toUtc(),
      updatedAt: DateTime.now().toUtc(),
    );

    await episodeDao.upsert(episode);
    await _enqueueOutbox(OutboxEntity.recoveryEpisode, OutboxAction.create, episode);

    return episode;
  }

  /// Event ê¸°ë¡ (ë‚´ë¶€ì ìœ¼ë¡œ Outbox ìë™ ìƒì„±)
  Future<RecoveryEvent> _recordEvent({
    required String episodeUuid,
    required RecoveryEventType eventType,
    required Map<String, dynamic> payload,
  }) async {
    final event = RecoveryEvent(
      uuid: Uuid().v4(),
      episodeUuid: episodeUuid,
      eventType: eventType.name,
      payloadJson: jsonEncode(payload),
      recordedAt: DateTime.now().toUtc(),
      updatedAt: DateTime.now().toUtc(),
    );

    await eventDao.upsert(event);
    await _enqueueOutbox(OutboxEntity.recoveryEvent, OutboxAction.create, event);

    return event;
  }

  /// ê°ì • ê¸°ë¡
  Future<void> recordEmotion(String episodeUuid, String emotion, String emoji) =>
    _recordEvent(
      episodeUuid: episodeUuid,
      eventType: RecoveryEventType.emotion,
      payload: {'emotion': emotion, 'emoji': emoji},
    );

  /// íŠ¸ë¦¬ê±° ê¸°ë¡
  Future<void> recordTriggers(String episodeUuid, List<String> triggers, String? customText) =>
    _recordEvent(
      episodeUuid: episodeUuid,
      eventType: RecoveryEventType.trigger,
      payload: {'triggers': triggers, 'customText': customText},
    );

  /// ìƒê° ê¸°ë¡
  Future<void> recordThought(String episodeUuid, String text) =>
    _recordEvent(
      episodeUuid: episodeUuid,
      eventType: RecoveryEventType.thought,
      payload: {'thoughtText': text},
    );

  /// ê°ˆë§ ë ˆë²¨ ê¸°ë¡
  Future<void> recordCraving(String episodeUuid, double level, String phase) async {
    final eventType = phase == 'before'
      ? RecoveryEventType.cravingBefore
      : RecoveryEventType.cravingAfter;

    await _recordEvent(
      episodeUuid: episodeUuid,
      eventType: eventType,
      payload: {'level': level},
    );

    // Episodeì—ë„ denormalized ì €ì¥ (ì¿¼ë¦¬ í¸ì˜)
    final field = phase == 'before' ? 'cravingBefore' : 'cravingAfter';
    await episodeDao.updateField(episodeUuid, field, level);
  }

  /// ì„¸ì…˜ ì™„ë£Œ
  Future<void> completeSession(
    String episodeUuid, {
    RecoveryActionType? actionType,
    int? actionDurationSec,
    bool actionCompleted = false,
  }) async {
    await episodeDao.complete(
      episodeUuid,
      actionType: actionType?.name,
      actionDurationSec: actionDurationSec,
      actionCompleted: actionCompleted,
    );

    // Outbox update
    final episode = await episodeDao.findByUuid(episodeUuid);
    if (episode != null) {
      await _enqueueOutbox(OutboxEntity.recoveryEpisode, OutboxAction.update, episode);
    }
  }

  /// ìµœê·¼ Episode ì¡°íšŒ (í†µê³„ìš©)
  Future<List<RecoveryEpisode>> getRecentEpisodes({int days = 7}) =>
    episodeDao.fetchRecent(days: days);

  /// Episodeì— ì—°ê²°ëœ Event ì¡°íšŒ
  Future<List<RecoveryEvent>> getEventsForEpisode(String episodeUuid) =>
    eventDao.fetchByEpisodeUuid(episodeUuid);
}
```

### A8. Freezed ì§ë ¬í™” ìƒì„¸

```dart
// recovery_episode.dart
@freezed
class RecoveryEpisode with _$RecoveryEpisode {
  const factory RecoveryEpisode({
    int? id,
    required String uuid,
    required String episodeType,
    required String caseType,
    required DateTime startedAt,
    DateTime? completedAt,
    String? actionType,
    int? actionDurationSec,
    @Default(false) bool actionCompleted,
    double? cravingBefore,
    double? cravingAfter,
    String? triggerMealDiaryUuid,
    required DateTime updatedAt,
    DateTime? deletedAt,
  }) = _RecoveryEpisode;

  /// JSON ì§ë ¬í™” (Firestore/Outboxìš©)
  factory RecoveryEpisode.fromJson(Map<String, dynamic> json) =>
      _$RecoveryEpisodeFromJson(json);
}

// recovery_episode.g.dart (build_runner ìƒì„±)
// DateTimeì€ ISO8601 Stringìœ¼ë¡œ ìë™ ë³€í™˜
```

**DAO toMap/fromEntry ë³€í™˜**:
```dart
Map<String, dynamic> toMap(RecoveryEpisode model) => {
  'id': model.id,
  'uuid': model.uuid,
  'episodeType': model.episodeType,
  'caseType': model.caseType,
  'startedAt': model.startedAt.toIso8601String(),
  'completedAt': model.completedAt?.toIso8601String(),
  // ... ë‚˜ë¨¸ì§€ í•„ë“œ
  'updatedAt': model.updatedAt.toIso8601String(),
  'deletedAt': model.deletedAt?.toIso8601String(),
};

RecoveryEpisode fromEntry(RecoveryEpisodeEntry e) => RecoveryEpisode(
  id: e.id,
  uuid: e.uuid,
  episodeType: e.episodeType,
  caseType: e.caseType,
  startedAt: e.startedAt,
  completedAt: e.completedAt,
  // ... DriftëŠ” DateTime ìë™ ì²˜ë¦¬
  updatedAt: e.updatedAt,
  deletedAt: e.deletedAt,
);
```

---

## ì°¸ê³ 

- **BaseDao íŒ¨í„´**: `lib/data/local/base_dao.dart`
- **Drift ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì‹œ**: `lib/data/local/database/migrations/migration_v10.dart`
- **OutboxEntity ì˜ˆì‹œ**: `lib/data/models/outbox_operation.dart`
- **OperationRouter ì˜ˆì‹œ**: `lib/data/services/operation_router.dart`
- **SyncManager ì˜ˆì‹œ**: `lib/data/services/sync_manager_impl.dart`
- **DatabaseConfig**: `lib/data/local/database_config.dart` (í˜„ì¬ v12 - Codex í™•ì¸)

---

## ë¶€ë¡ B: Codex ë¦¬ë·° ê²°ê³¼ (2026-01-28)

### ğŸ” ë°œê²¬ëœ ì´ìŠˆ 6ê°œ

| # | ì´ìŠˆ | ì‹¬ê°ë„ | í•´ê²°ì±… |
|---|------|--------|--------|
| 1 | **DB ë²„ì „ ì¶©ëŒ** - í˜„ì¬ v12ì¸ë° ê³„íšì€ v11 ì¶”ê°€ | ğŸ”´ Critical | **v13**ìœ¼ë¡œ ë³€ê²½ |
| 2 | **ì‹ ê·œ ì„¤ì¹˜ ìŠ¤í‚¤ë§ˆ ëˆ„ë½** - schema_definitions.dart ë¯¸ì—…ë°ì´íŠ¸ | ğŸ”´ Critical | CREATE TABLE ì¶”ê°€ |
| 3 | **Drift í†µí•© ëˆ„ë½** - app_database.dart í…Œì´ë¸” ë¯¸ë“±ë¡ | ğŸ”´ Critical | @include + schemaVersion=13 |
| 4 | **MealDiary ëª¨ë¸ ëˆ„ë½** - recoveryEpisodeUuid í•„ë“œ ì—†ìŒ | ğŸŸ¡ High | ëª¨ë¸+DAO+í…Œì´ë¸” ìˆ˜ì • |
| 5 | **DI ì™€ì´ì–´ë§ ëˆ„ë½** - main.dartì—ì„œ ì£¼ì… ë¯¸ì„¤ì • | ğŸŸ¡ High | Repository+DataSource ë“±ë¡ |
| 6 | **Sync ìˆœì„œ ë¯¸ë³´ì¥** - Episode/Event ìˆœì„œ ì—†ìŒ | ğŸŸ¡ High | Episode ë¨¼ì €, Event ë‚˜ì¤‘ |

### ğŸ“‹ ìˆ˜ì •ëœ êµ¬í˜„ ê³„íš v2

#### í•µì‹¬ ë³€ê²½ì‚¬í•­
- âœ… DB ë²„ì „: v11 â†’ **v13** (í˜„ì¬ v12)
- âœ… `schema_definitions.dart` ì—…ë°ì´íŠ¸ (ì‹ ê·œ ì„¤ì¹˜ ëŒ€ì‘)
- âœ… Drift `app_database.dart` í…Œì´ë¸” ë“±ë¡ + schemaVersion=13
- âœ… `MealDiary` ëª¨ë¸ + DAO + Drift í…Œì´ë¸” ìˆ˜ì • (`recoveryEpisodeUuid`)
- âœ… `main.dart` DI ì™€ì´ì–´ë§ ì™„ì „ ëª…ì‹œ
- âœ… Sync ìˆœì„œ ë³´ì¥: Episode â†’ Event (ìˆœì°¨)

#### ìˆ˜ì •ëœ êµ¬í˜„ ìˆœì„œ

| ìˆœì„œ | ì‘ì—… | íŒŒì¼ |
|------|------|------|
| 1 | OutboxEntity í™•ì¥ | `outbox_operation.dart` |
| 2 | **MealDiary ëª¨ë¸ í™•ì¥** | `meal_diary.dart` (recoveryEpisodeUuid ì¶”ê°€) |
| 3 | RecoveryEpisode ëª¨ë¸ | `recovery_episode.dart` |
| 4 | RecoveryEvent ëª¨ë¸ | `recovery_event.dart` |
| 5 | **MealDiary Drift í…Œì´ë¸” ìˆ˜ì •** | `meal_diary_table.dart` |
| 6 | RecoveryEpisode í…Œì´ë¸” | `recovery_episode_table.dart` |
| 7 | RecoveryEvent í…Œì´ë¸” | `recovery_event_table.dart` |
| 8 | **ë§ˆì´ê·¸ë ˆì´ì…˜ v13** | `migration_v13.dart` |
| 9 | **DatabaseProvider ì—…ë°ì´íŠ¸** | `database_provider.dart` (migrateToV13 import) |
| 10 | **schema_definitions ì—…ë°ì´íŠ¸** | `schema_definitions.dart` (ì‹ ê·œ ì„¤ì¹˜ìš©) |
| 11 | AppDatabase ë“±ë¡ | `app_database.dart` (í…Œì´ë¸” + schemaVersion=13) |
| 12 | DatabaseConfig ì—…ë°ì´íŠ¸ | `database_config.dart` (version=13) |
| 13 | RecoveryEpisodeDao | `recovery_episode_dao.dart` |
| 14 | RecoveryEventDao | `recovery_event_dao.dart` |
| 15 | DatabaseHelper DAO ë“±ë¡ | `database_helper.dart` |
| 16 | **MealDiary DAO í™•ì¥** | `meal_diary_dao.dart` (toMap + linkRecoveryEpisode) |
| 17 | RecoveryRepository | `recovery_repository.dart` |
| 18 | Firestore DataSource (Episode) | `firestore_recovery_episode_data_source.dart` |
| 19 | Firestore DataSource (Event) | `firestore_recovery_event_data_source.dart` |
| 20 | **OperationRouter í•¸ë“¤ëŸ¬** | `operation_router.dart` (ìƒì„±ì ìˆ˜ì • + í•¸ë“¤ëŸ¬) |
| 21 | **SyncManager Pull íƒ€ê²Ÿ** | `sync_manager_impl.dart` (ìƒì„±ì ìˆ˜ì • + ìˆœì°¨ Pull) |
| 22 | **main.dart DI ì™€ì´ì–´ë§** | `main.dart` (Repository + DataSource ì£¼ì…) |
| 23 | ê²€ì¦ | build_runner + flutter analyze |

#### ì¶”ê°€ëœ ìˆ˜ì • ëŒ€ìƒ íŒŒì¼

```
lib/data/models/meal_diary.dart
  â†’ recoveryEpisodeUuid í•„ë“œ ì¶”ê°€
  â†’ toJson/fromJson ì—…ë°ì´íŠ¸

lib/data/local/database_provider.dart
  â†’ import migration_v13.dart
  â†’ onUpgradeì—ì„œ from < 13 ì²˜ë¦¬

lib/data/local/database/schema_definitions.dart
  â†’ recovery_episode, recovery_event CREATE TABLE ì¶”ê°€
  â†’ meal_diaryì— recoveryEpisodeUuid ì»¬ëŸ¼ í¬í•¨

lib/main.dart
  â†’ FirestoreRecoveryEpisodeDataSource ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  â†’ FirestoreRecoveryEventDataSource ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  â†’ RecoveryRepository Provider ë“±ë¡
  â†’ SyncManagerImpl ìƒì„± ì‹œ recovery DataSource ì£¼ì…
  â†’ OperationRouter ìƒì„± ì‹œ recovery DAO ì£¼ì…
```

#### ìˆ˜ì •ëœ ì²´í¬ë¦¬ìŠ¤íŠ¸

##### Phase 1: ë°ì´í„° ëª¨ë¸ + DB (v13)
- [ ] `lib/data/models/outbox_operation.dart` - enum í™•ì¥ (recoveryEpisode, recoveryEvent)
- [ ] `lib/data/models/meal_diary.dart` - recoveryEpisodeUuid í•„ë“œ ì¶”ê°€
- [ ] `lib/data/models/recovery_episode.dart` - freezed ëª¨ë¸ ìƒì„±
- [ ] `lib/data/models/recovery_event.dart` - freezed ëª¨ë¸ ìƒì„±
- [ ] `lib/data/local/drift/tables/meal_diary_table.dart` - recoveryEpisodeUuid ì»¬ëŸ¼ ì¶”ê°€
- [ ] `lib/data/local/drift/tables/recovery_episode_table.dart` - Drift í…Œì´ë¸”
- [ ] `lib/data/local/drift/tables/recovery_event_table.dart` - Drift í…Œì´ë¸”
- [ ] `lib/data/local/database/migrations/migration_v13.dart` - ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] `lib/data/local/database_provider.dart` - migrateToV13 import + onUpgrade
- [ ] `lib/data/local/database/schema_definitions.dart` - ì‹ ê·œ ì„¤ì¹˜ìš© í…Œì´ë¸” ì •ì˜
- [ ] `lib/data/local/drift/app_database.dart` - í…Œì´ë¸” ë“±ë¡ + schemaVersion 13
- [ ] `lib/data/local/database_config.dart` - version = 13

##### Phase 2: DAO
- [ ] `lib/data/local/recovery_episode_dao.dart` - BaseDao í™•ì¥
- [ ] `lib/data/local/recovery_event_dao.dart` - BaseDao í™•ì¥
- [ ] `lib/data/local/database_helper.dart` - DAO ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€
- [ ] `lib/data/local/meal_diary_dao.dart` - toMap ìˆ˜ì • + linkRecoveryEpisodeIfNeeded()

##### Phase 3: Repository
- [ ] `lib/data/repositories/recovery_repository.dart` - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

##### Phase 4: ë™ê¸°í™”
- [ ] `lib/data/remote/firestore_recovery_episode_data_source.dart`
- [ ] `lib/data/remote/firestore_recovery_event_data_source.dart`
- [ ] `lib/data/services/operation_router.dart` - ìƒì„±ì ìˆ˜ì • + í•¸ë“¤ëŸ¬ ì¶”ê°€
- [ ] `lib/data/services/sync_manager_impl.dart` - ìƒì„±ì ìˆ˜ì • + Pull íƒ€ê²Ÿ ì¶”ê°€ (ìˆœì°¨)

##### Phase 5: DI ì™€ì´ì–´ë§
- [ ] `lib/main.dart` - RecoveryRepository + DataSource ì£¼ì…

##### Phase 6: ê²€ì¦
- [ ] `flutter pub run build_runner build --delete-conflicting-outputs`
- [ ] `flutter analyze` í†µê³¼
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ (v12 â†’ v13)

---

## ì‘ì—… ë¡œê·¸

### 2026-01-28 17:10 - Codex ë¦¬ë·° ì™„ë£Œ
- êµ¬í˜„ ê³„íš v1 ì‘ì„± í›„ Codex ê²€ì¦ ì‹¤í–‰
- 6ê°œ ì´ìŠˆ ë°œê²¬ (DB ë²„ì „ ì¶©ëŒ, ìŠ¤í‚¤ë§ˆ ëˆ„ë½, DI ì™€ì´ì–´ë§ ë“±)
- ê³„íš v2ë¡œ ìˆ˜ì • ì™„ë£Œ
- ë‹¤ìŒ ë‹¨ê³„: `/do-dev-task` ì¬ì‹¤í–‰í•˜ì—¬ êµ¬í˜„ ì§„í–‰

---

## ì§§ì€ íšŒê³ 
