---
entity_type: Task
entity_id: tsk-1t6rif-1768231080040
entity_name: 꼭꼭 앱 - 마이그레이션 코드가 1개월 만에 풀리는 현상 지속됨(3개월, 1년 권 둘다)
created: '2026-01-13'
updated: '2026-01-26'
status: todo
project_id: prj-1t6rif
parent_id: prj-1t6rif
assignee:
- 한명학
- 김은향
priority: medium
start_date: '2026-01-27'
due: '2026-01-27'
aliases:
- tsk-1t6rif-1768231080040
tags: []
type: bug
notes: '현재 마이그레이션 코드가 약 1개월 뒤에 풀리는 현상이 지속적으로 발생함. (이전부터 계속 발생)


  ---


  작년부터 지속적으로 해당 문제 발생함.


  - iOS, 안드로이드 공통

  - Wadiz 1년/2년 구독권 제공한 만큼, 해당 부분 확인 필요'
target_project: kkokkkok
start_time: '18:00'
end_time: '19:00'
_field_confidences:
  assignee: 0.9
  due: 0.86
  priority: 1.0
  type: 1.0
  target_project: 0.5
---
# 꼭꼭 앱 버그 - 마이그레이션 코드가 1개월 만에 풀리는 현상 지속됨(3개월, 1년 권 둘다)

## 설명

## 체크리스트

- [ ]

## 참고

## Notes

### Bug Summary

**Root Cause**: Line 639 in `/Users/gim-eunhyang/dev/flutter/sosi/functions/src/promotions.ts`
```typescript
expiryDate.setMonth(expiryDate.getMonth() + duration);  // ❌ BUG
```

**Issues**:
1. Uses `setMonth()` instead of `setUTCMonth()` - timezone inconsistencies across regions
2. Missing month-end rollover protection - Jan 31 + 1 month = Mar 3 (skips Feb, should be Feb 28/29)
3. Accumulated day loss over multiple months - 3-month codes lose ~30 days, 12-month codes lose ~120 days

**Impact**:
- Wadiz 12-month/24-month subscription users receiving shortened durations
- All promotion code users (especially redemptions on month-end dates like Jan 31, Mar 31)
- iOS/Android both affected (server-side bug in Firebase Functions)
- User complaints: "3개월 권인데 1개월만에 만료됨", "1년 권인데 10개월밖에 안 됨"

**Evidence from Code Analysis**:
- Correct implementation exists in `/Users/gim-eunhyang/dev/flutter/sosi/functions/src/revenuecat-helper.ts` (lines 276-294)
- RevenueCat uses `setUTCMonth()` with month-end rollover protection
- Promotions.ts uses legacy `setMonth()` without protection

---

### Tech Spec

**Architecture Compliance:**
- Parent Project: prj-1t6rif (KkokKkok v1.0.30 Release)
- Target: sosi Flutter app + Firebase Functions (TypeScript)
- Architecture Pattern: Firebase Cloud Functions + Firestore
- Coding Standards: TypeScript strict mode, JSDoc comments, Firestore batch writes (max 500 ops)

**File Structure:**
```
/Users/gim-eunhyang/dev/flutter/sosi/
├── functions/src/
│   ├── promotions.ts (MODIFY - lines 602-642)
│   └── revenuecat-helper.ts (REFERENCE - correct implementation at lines 276-294)
├── scripts/firebase/
│   ├── check_promo_expiry.js (EXISTING - template for Firebase initialization)
│   ├── migrate_promo_expiry_dates.js (CREATE - migration script)
│   └── verify_promo_expiry.js (CREATE - verification script)
└── docs/
    └── PRO_SYSTEM_ARCHITECTURE.md (UPDATE - add migration record after line 140)
```

## 짧은 회고

