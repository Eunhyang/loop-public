# ============================================
# LOOP Schema Constants (Single Source of Truth)
# ============================================
# 이 파일을 수정하면 API 서버 rebuild 필요:
#   /mcp-server rebuild
#
# 참조하는 파일들:
#   - api/constants.py (Python)
#   - _dashboard/js/state.js (via API)
#   - CLAUDE.md (문서)
#
# 이 파일이 유일한 스키마 정의 소스입니다.
# schema_registry.md는 이 파일로 통합되어 삭제되었습니다.
#
# ============================================
# SSOT + Derived 원칙 (v5.2)
# ============================================
# 모든 데이터는 한 곳에만 저장(SSOT), 나머지는 계산(Derived)
#
# 1. Project ↔ Hypothesis 관계:
#    - SSOT: Project.validates = [hyp-...]
#    - Derived: Hypothesis.validated_by (역인덱스로 계산)
#
# 2. A/B Score + Window 롤업:
#    - SSOT: Project.realized_impact @ 월간 window
#    - Derived: Track.realized_sum @ 분기 (하위 Project B 집계)
#    - Derived: Condition.realized_sum @ 반기 (하위 Project B 집계)
#
# Track/Condition에 realized_impact 직접 저장 금지!
# → build_impact.py가 실행 시 Project B를 window로 묶어 계산

# ============================================
# Task
# ============================================
task:
  status:
    - todo      # 시작 전
    - doing     # 진행 중
    - hold      # 보류 (외부 의존성 대기 등)
    - done      # 완료
    - blocked   # 차단됨 (문제 발생)
  status_default: todo
  status_labels:
    todo: "To Do"
    doing: "Doing"
    hold: "Hold"
    done: "Done"
    blocked: "Blocked"
  status_colors:
    todo: "#6b7280"      # gray
    doing: "#3b82f6"     # blue
    hold: "#f59e0b"      # amber
    done: "#10b981"      # green
    blocked: "#ef4444"   # red
  # Task 유형 (dev Task 연동용)
  types:
    - dev        # 개발 작업 (신규 기능)
    - bug        # 버그 수정
    - strategy   # 전략 작업
    - research   # 리서치
    - ops        # 운영
    - meeting    # 미팅/약속/일정
  # 외부 프로젝트 (type=dev|bug일 때)
  target_projects:
    - sosi       # SoSi 앱
    - kkokkkok   # 꼭꼭 앱
    - loop-api   # LOOP API 서버
    - loop       # LOOP Vault 자체

# ============================================
# Project
# ============================================
project:
  status:
    - planning   # 기획 중
    - doing      # 진행 중
    - done       # 완료
    - hold       # 보류/일시 중단
    - cancelled  # 취소
  status_default: planning
  status_labels:
    planning: "Planning"
    doing: "Doing"
    done: "Done"
    hold: "Hold"
    cancelled: "Cancelled"
  status_colors:
    planning: "#6b7280"   # gray
    doing: "#3b82f6"      # blue
    done: "#10b981"       # green
    hold: "#f59e0b"       # amber
    cancelled: "#ef4444"  # red

# ============================================
# Priority
# ============================================
priority:
  values:
    - critical  # 긴급
    - high      # 높음
    - medium    # 보통
    - low       # 낮음
  default: medium
  labels:
    critical: "Critical"
    high: "High"
    medium: "Medium"
    low: "Low"
  colors:
    critical: "#dc2626"  # red-600
    high: "#f97316"      # orange-500
    medium: "#eab308"    # yellow-500
    low: "#22c55e"       # green-500

# ============================================
# Entity Types
# ============================================
entity_types:
  - NorthStar
  - MetaHypothesis
  - Condition
  - Track
  - Program
  - Project
  - Task
  - Hypothesis
  - Experiment
  - Evidence      # v5.2 추가: 프로젝트 결과/학습 기록
  # loop_exec 전용
  - Candidate
  - TaskExecDetail
  - Retrospective

# ============================================
# Condition IDs (3Y 전략 조건)
# ============================================
condition_ids:
  - cond-a
  - cond-b
  - cond-c
  - cond-d
  - cond-e

# ============================================
# Condition Labels (Dashboard UI용)
# ============================================
condition_labels:
  cond-a: "CondA-PMF신호"
  cond-b: "CondB-패턴/데이터"
  cond-c: "CondC-글로벌데이터"
  cond-d: "CondD-런웨이"
  cond-e: "CondE-팀"

# ============================================
# Program Types (상시 운영 프로그램)
# ============================================
program_types:
  - hiring         # 채용
  - fundraising    # 투자 유치
  - grants         # 지원사업
  - launch         # 런칭
  - experiments    # 실험
  - infrastructure # 인프라

# ============================================
# Risk Level
# ============================================
risk_level:
  values:
    - low
    - medium
    - high
    - critical
  default: medium

# ============================================
# Hypothesis (가설 상태)
# ============================================
hypothesis:
  evidence_status:
    - assumed      # 가정됨
    - validating   # 검증 중
    - validated    # 검증됨
    - falsified    # 반증됨
    - learning     # 학습 중

# ============================================
# NorthStar (북극성)
# ============================================
northstar:
  status:
    - fixed        # 고정됨 (변경 불가)

# ============================================
# Candidate (loop_exec 전용)
# ============================================
candidate:
  status:
    - screening    # 서류 심사
    - pilot        # 파일럿 진행
    - offer        # 오퍼 제안
    - hired        # 채용 완료
    - rejected     # 탈락
  verdict:
    - filtering_success
    - hired
    - offer_declined

# ============================================
# Retrospective (loop_exec 전용)
# ============================================
retrospective:
  verdict:
    - filtering_success
    - hired
    - failed

# ============================================
# Experiment
# ============================================
experiment:
  outcome:
    - positive
    - negative
    - inconclusive

# ============================================
# Project Kind (프로젝트 검증 단계)
# ============================================
project_kind:
  values:
    - signal      # 신호 검증
    - adoption    # 채택 실험
    - impact      # 임팩트 실증
  default: signal
  labels:
    signal: "Signal"
    adoption: "Adoption"
    impact: "Impact"
  labels_ko:
    signal: "신호"
    adoption: "채택"
    impact: "임팩트"
  colors:
    signal: "#3b82f6"     # blue-500
    adoption: "#f59e0b"   # amber-500
    impact: "#10b981"     # green-500

# ============================================
# Hypothesis Kind (가설 검증 단계)
# ============================================
hypothesis_kind:
  values:
    - signal
    - adoption
    - impact
  default: signal
  labels:
    signal: "Signal"
    adoption: "Adoption"
    impact: "Impact"
  labels_ko:
    signal: "신호"
    adoption: "채택"
    impact: "임팩트"
  colors:
    signal: "#3b82f6"
    adoption: "#f59e0b"
    impact: "#10b981"

# ============================================
# Paths (검증/인덱싱 대상 경로)
# ============================================
paths:
  # 검증 대상 폴더 (validate_schema.py, build_graph_index.py)
  include:
    - "01_North_Star"
    - "20_Strategy"
    - "50_Projects"
    - "60_Hypotheses"
    - "70_Experiments"
  # 제외 폴더
  exclude:
    - "00_Meta/_TEMPLATES"
    - "10_Study"
    - "30_Ontology"
    - "40_LOOP_OS"
    - "90_Archive"
    - "00_Inbox"
  # 제외 파일
  exclude_files:
    - "_INDEX.md"
    - "_ENTRY_POINT.md"
    - "CLAUDE.md"
    - "README.md"
    - "_HOME.md"
    - "_Graph_Index.md"

# ============================================
# ID Patterns (엔티티별 ID 정규식)
# ============================================
# Updated: Task ID now includes Project hash (tsk-kly0ry-1767960471502)
# New format:
#   Project: prj-{hash6} (e.g., prj-a7k9m2)
#   Task: tsk-{prj_hash}-{epoch13} (e.g., tsk-a7k9m2-1736412652123)
#     - prj_hash: Extracted from parent Project ID (6-char base36)
#     - epoch13: Millisecond timestamp for uniqueness
#     - Legacy Project IDs (prj-001) get deterministic hash
#   Exec Project: prj-exec-{hash6} or prj-{keyword}-{hash6}
#   Exec Task: tsk-exec-{hash6}-{epoch13} or tsk-{keyword}-{hash6}-{epoch13}
#
# Backward compatibility maintained for legacy sequential IDs
# ============================================
id_patterns:
  ns: "^ns-\\d{3}$"                                    # ns-001
  mh: "^mh-[1-4]$"                                     # mh-1 ~ mh-4
  cond: "^cond-[a-e]$"                                 # cond-a ~ cond-e
  trk: "^trk-[1-6]$"                                   # trk-1 ~ trk-6
  # Project patterns (4 variants):
  # 1. Legacy sequential: prj-001
  # 2. New hash: prj-a7k9m2 (6-char hash)
  # 3. Exec standalone: prj-exec-a7k9m2
  # 4. Exec program round: prj-tips-a7k9m2 (keyword 3-10 chars)
  prj: "^prj-(\\d{3}|[a-z0-9]{6}|exec-[a-z0-9]{6}|[a-z]{3,10}-[a-z0-9]{6})$"
  # Task patterns (4 variants):
  # 1. Legacy sequential: tsk-001-01
  # 2. New hash+epoch: tsk-a7k9m2-1736412652123
  # 3. Exec standalone: tsk-exec-a7k9m2-1736412652123
  # 4. Exec program round: tsk-primer-a7k9m2-1736412652123
  tsk: "^tsk-(\\d{3}-\\d{2}|[a-z0-9]{6}-\\d{13}|exec-[a-z0-9]{6}-\\d{13}|[a-z]{3,10}-[a-z0-9]{6}-\\d{13})$"
  hyp: "^hyp-[1-6]-\\d{2}$"                            # hyp-1-01 (Track기반)
  exp: "^exp-\\d{3}$"                                  # exp-001
  pl: "^pl-[1-9]$"                                     # pl-1 ~ pl-9
  ps: "^ps-[1-9]$"                                     # ps-1 ~ ps-9
  pgm: "^pgm-[a-z][a-z0-9-]*$"                         # pgm-hiring
  retro: "^retro-\\d{3}-\\d{2}$"                       # retro-015-01
  cand: "^cand-\\d{3}$"                                # cand-001 (loop_exec)
  res: "^res-\\d{3}-\\d{2}$"                           # res-001-01
  status: "^status-[a-z-]+$"                           # status documents
  concept: "^concept-[a-z-]+$"                         # concept documents

# ============================================
# Required Fields (엔티티별 필수 필드)
# ============================================
required_fields:
  # 모든 엔티티 공통
  all:
    - entity_type
    - entity_id
    - entity_name
    - created
    - updated
    - status
  # 엔티티별 추가 필수 필드
  NorthStar: []
  MetaHypothesis:
    - if_broken
  Condition:
    - if_broken
  Track:
    - owner
    - horizon
    - conditions_3y
  Program:
    - program_type
    - owner
  Project:
    - owner
    - parent_id
    - conditions_3y
    - expected_impact
  Task:
    - assignee
    - project_id
    - parent_id
  Hypothesis: []   # hypothesis_question OR hypothesis_text 별도 검증
  Experiment:
    - hypothesis_id
    - metrics
  # loop_exec 전용
  Candidate:
    - name
    - hiring_project
  TaskExecDetail:
    - source_task
    - source_project
    - source_vault
  Retrospective:
    - source_project
    - verdict
  Evidence:
    - project
    - normalized_delta
    - evidence_strength

# ============================================
# Collaboration Fields (모든 엔티티 공통 사용 가능)
# ============================================
collaboration_fields:
  - notes         # 단일 텍스트 (마크다운)
  - links         # [{label, url}]
  - attachments   # [{name, path, type, uploaded}]

# ============================================
# Known Fields (freshness check용 - 스키마에 정의된 필드)
# ============================================
known_fields:
  # 모든 엔티티 공통
  all:
    - entity_type
    - entity_id
    - entity_name
    - created
    - updated
    - status
    - parent_id
    - aliases
    - outgoing_relations
    - validates
    - validated_by
    - tags
    - priority_flag
    - conditions_3y
    # === 협업 필드 (모든 엔티티 사용 가능) ===
    - notes
    - links
    - attachments
  # 엔티티별 추가 필드
  NorthStar: []
  MetaHypothesis:
    - if_broken
    - evidence_status
    - confidence
  Condition:
    - unlock
    - if_broken
    - metrics          # 구조: [{name, threshold, current, status}]
  Track:
    - horizon          # "12month" | "6month" | "3month"
    - hypothesis       # 핵심 가설 (텍스트)
    - focus            # [string]
    - owner
    - objectives       # 구조: [{metric, target, current, status}]
    - quarters         # 구조: [{q, period, goals, success_criteria}] - 분기별 목표 (legacy)
    - quarter_objectives  # 구조: {YYYYQN: {objective, kpi, target, owner?, evidence_link?}} - 분기별 측정 가능 목표
  Program:
    - program_type
    - owner
    - principles       # [string]
    - process_steps    # [string]
    - templates        # [string]
    - kpis             # 구조: [{name, description}]
    - exec_rounds_path # loop_exec 라운드 폴더 경로
  Project:
    - owner
    - summary          # 1-2줄 프로젝트 요약 (리스트/hover용)
    - start_date       # 프로젝트 공식 시작일 (YYYY-MM-DD)
    - budget           # number | null
    - deadline         # date | null
    - program_id       # 소속 프로그램 ID
    - cycle            # 사이클/라운드 (예: "2026Q1")
    - project_kind     # signal | adoption | impact (검증 단계)
    - expected_impact  # 구조: {statement, metric, target}
    - realized_impact  # 구조: {verdict, outcome, evidence_links, decided, window_id, time_range, metrics_snapshot}
    - hypothesis_id           # deprecated → primary_hypothesis_id
    - primary_hypothesis_id   # 신규: 프로젝트 생성 근본 질문 (hyp-*)
    - experiments
    - hypothesis_text  # deprecated → expected_impact.statement
    - condition_contributes  # 구조: [{to, weight, description}] - Condition 기여
    - track_contributes      # 구조: [{to, weight, description}] - Secondary Track 기여
  Task:
    - project_id
    - assignee
    - start_date
    - due
    - priority
    - estimated_hours
    - actual_hours
    - type             # dev | strategy | research | ops
    - target_project   # sosi | kkokkkok | loop-api | loop
    - candidate_id     # loop_exec 연결
    - has_exec_details # boolean
    - closed           # 완료일
    - archived_at      # 아카이브 이동일
    - closed_inferred  # updated | git_commit_date | today
    - pr_url           # GitHub PR URL (dev Task용)
    - merged_commit    # 머지된 커밋 해시
    - start_time       # 시작 시간 (HH:MM) - Week view timeblock
    - end_time         # 종료 시간 (HH:MM) - Week view timeblock
    - video_id         # YouTube video ID (Content OS Performance 연결)
  Hypothesis:
    - hypothesis_question  # 질문 형태 ("?"로 끝나야 함)
    - start_date             # 검증 대상으로 공식 채택한 날짜 (YYYY-MM-DD)
    - success_criteria     # 숫자/기간/표본 포함
    - failure_criteria     # 피벗/중단 기준
    - measurement          # 어디서/무엇을/어떻게
    - horizon              # 검증 목표 연도 (예: "2026")
    - deadline
    - evidence_status
    - confidence           # 0.0 ~ 1.0
    - loop_layer           # emotional | eating | habit | reward | autonomic
    - hypothesis_kind      # signal | adoption | impact (검증 단계)
    - hypothesis_text      # deprecated → hypothesis_question
    - parent_hypothesis_id # 상위 가설 ID (hyp-*), 선택 필드
  Experiment:
    - hypothesis_id
    - protocol
    - metrics
    - start_date
    - end_date
    - result_summary
    - outcome              # positive | negative | inconclusive
  # loop_exec 전용
  Candidate:
    - name
    - github
    - position
    - hiring_project
    - pilot_project
    - related_tasks
    - retrospective
    - verdict
    - verdict_date
  TaskExecDetail:
    - source_task
    - source_project
    - source_vault         # "LOOP" 고정
  Retrospective:
    - source_project
    - candidate_id
    - verdict
    - verdict_date
    - signals              # [string] 핵심 판별 신호
    - system_updates       # [string] 시스템 개선 항목
  Evidence:
    - project                    # 필수: 연결된 Project ID
    - normalized_delta           # 필수: 목표 대비 달성률 (0.0 ~ 1.0)
    - evidence_strength          # 필수: strong | medium | weak
    - attribution_share          # 권장: 기여 비율 (default 1.0)
    - window_id                  # 권장: 평가 윈도우 ID
    - time_range                 # 권장: 평가 기간
    - impact_metric
    - learning_value
    - validated_hypotheses       # [hyp-*] 이 Evidence가 확증한 가설
    - falsified_hypotheses       # [hyp-*] 이 Evidence가 반증한 가설
    - confirmed_insights
    # === 품질 메타 필드 (v5.3 추가) ===
    - provenance                 # auto | human | mixed - 데이터 출처
    - source_refs                # [string] 쿼리 URL/링크/샘플 ID
    - sample_size                # number | null - 표본 크기
    - measurement_quality        # low | medium | high - 측정 품질
    - counterfactual             # none | before_after | controlled - 대조군/비교 유형
    - confounders                # [string] 외부 변수 목록
    - query_version              # string - 계산 규칙/버전 (예: "build_impact_v1.2.0")

# ============================================
# Field Structures (중첩 필드 구조 정의)
# ============================================
field_structures:
  # Condition.metrics
  metrics:
    fields:
      - name: string
      - threshold: string
      - current: "string | number"
      - status: string     # on_track | at_risk | failed

  # Track.objectives
  objectives:
    fields:
      - metric: string
      - target: string
      - current: "string | number"
      - status: string

  # Track.quarters (분기별 목표) - legacy, quarter_objectives 권장
  quarters:
    fields:
      - q: string              # Q1, Q2, Q3, Q4, Q3-Q4 등
      - period: string         # "2026-01 ~ 2026-03" 형식
      - goals: "[string]"      # 해당 분기 목표 목록
      - success_criteria: string  # 성공 기준

  # Track.quarter_objectives (분기별 측정 가능 목표) - 권장
  # 맵 형태: 키는 YYYYQN (예: 2026Q1, 2026Q2)
  quarter_objectives:
    description: "분기별 목표를 측정 가능한 약속으로 구조화. 대시보드/롤업/리뷰 자동화 지원."
    key_pattern: "YYYYQN"      # 예: 2026Q1, 2026Q2, 2027Q1
    fields:
      - objective: string      # 분기 목표 (무엇을 달성할 것인가)
      - kpi: string            # 핵심 지표 (어떻게 측정할 것인가)
      - target: string         # 목표치 (얼마나)
      - owner: "string | null" # 담당자 (선택)
      - evidence_link: "string | null"  # 근거 문서 링크 (선택)

  # Program.kpis
  kpis:
    fields:
      - name: string
      - description: string

  # Project.expected_impact
  expected_impact:
    fields:
      - statement: string  # "이 프로젝트가 성공하면 X가 증명된다"
      - metric: string
      - target: string

  # Project.realized_impact (v5.2 확장)
  realized_impact:
    fields:
      - verdict: string    # pending | go | no-go | pivot
      - outcome: string    # supported | rejected | inconclusive
      - evidence_links: "[string]"
      - decided: date      # 결정일 (YYYY-MM-DD)
      - window_id: string  # 평가 윈도우 ID (YYYY-MM | YYYY-QN | YYYY-HN | YYYY-WNN)
      - time_range: string # 평가 기간 (YYYY-MM-DD..YYYY-MM-DD)
      - metrics_snapshot: object  # 당시 지표 스냅샷 {metric_name: scalar_value}

  # Collaboration: links
  links:
    fields:
      - label: string
      - url: string        # https:// 또는 http://

  # Collaboration: attachments
  attachments:
    fields:
      - name: string       # 파일명
      - path: string       # 상대 경로 또는 URL
      - type: string       # image | document | video | other
      - uploaded: date     # 업로드일

  # Project.condition_contributes (Condition 기여 - 필수)
  condition_contributes:
    fields:
      - to: string         # cond-a ~ cond-e
      - weight: number     # 0.0 ~ 1.0, 합계 ≤ 1.0
      - description: string

  # Project.track_contributes (Secondary Track 기여 - 선택)
  # Primary Track = parent_id (암묵적 weight 1.0)
  # Secondary Track = 이 필드로 추가 기여 명시
  track_contributes:
    fields:
      - to: string         # trk-1 ~ trk-6
      - weight: number     # 0.0 ~ 1.0, 합계 ≤ 1.0
      - description: string

  # Evidence.quality_meta (품질 메타 - v5.3 추가)
  evidence_quality_meta:
    description: "Evidence의 신뢰 구조 - 숫자(B Score)의 품질을 담보"
    fields:
      - provenance: string           # auto | human | mixed
      - source_refs: "[string]"      # 쿼리 URL, 링크, 샘플 ID
      - sample_size: "number | null"
      - measurement_quality: string  # low | medium | high
      - counterfactual: string       # none | before_after | controlled
      - confounders: "[string]"      # 외부 변수 목록
      - query_version: string        # 계산 규칙/버전

# ============================================
# Validation Rules (검증 규칙)
# ============================================
validation_rules:
  # Derived 필드 (저장 금지 - 빌드 시 역인덱스 계산)
  # 이 필드들에 값이 저장되어 있으면 경고
  derived_fields:
    Hypothesis:
      - validated_by         # Evidence에서 역인덱스 계산
      - child_hypotheses     # parent_hypothesis_id 역인덱스 계산
    Track:
      - realized_sum         # 하위 Project B 집계 (build_impact.py)
    Condition:
      - realized_sum         # 하위 Project B 집계 (build_impact.py)

  # parent_id 참조 대상
  parent_references:
    MetaHypothesis: NorthStar
    Condition: MetaHypothesis
    Track: Condition
    Project: Track
    Task: Project
    Hypothesis: Track

  # 조건부 필수 필드
  conditional_required:
    Project:
      - field: realized_impact
        when: "status in [done, cancelled]"
    Task:
      - field: closed
        when: "status = done"
      - field: target_project
        when: "type in [dev, bug]"

  # 값 형식 규칙
  format_rules:
    Hypothesis:
      hypothesis_question: "must end with '?'"
    NorthStar:
      status: "must be 'fixed'"
    Program:
      status: "always 'doing' (닫지 않음)"
    Evidence:
      provenance: "must be one of [auto, human, mixed]"
      measurement_quality: "must be one of [high, medium, low]"
      counterfactual: "must be one of [none, before_after, controlled]"

  # 금지 규칙
  forbidden:
    Task:
      - validates    # Task는 전략 판단에 개입하지 않음

  # ============================================
  # SSOT v1.3 가드레일 (Project parent_id 의미 고정)
  # ============================================
  # Issue: parent_id가 "전략 축(Track)"과 "운영 축(Program)" 두 의미로 혼용되어 SSOT 흔들림
  # Solution: parent_id는 Track만, program_id는 Program으로 축 분리
  guardrails:
    # 가드1: parent_id 패턴 검증 (ERROR)
    parent_id_pattern:
      entity: Project
      rule: "parent_id must be Track (trk-*)"
      severity: error
      check: "parent_id.startswith('trk-')"

    # 가드2: conditions_3y 필수 (ERROR)
    conditions_3y_required:
      entity: Project
      rule: "conditions_3y required (minimum 1 Condition)"
      severity: error
      check: "conditions_3y is not empty list"

    # 가드3: program_id와 폴더 경로 일치 (WARNING)
    program_folder_match:
      entity: Project
      rule: "program_id should match folder structure"
      severity: warning
      check: "program_id matches folder name (if program_id present)"
      note: "폴더는 Derived, program_id가 SSOT. 불일치 시 warning만"

# ============================================
# File Locations (파일 위치 규칙)
# ============================================
file_locations:
  # 기본 위치
  NorthStar: "01_North_Star/"
  MetaHypothesis: "01_North_Star/"
  Condition: "20_Strategy/3Y_Conditions_{period}/"
  Track: "20_Strategy/12M_Tracks/{year}/"
  Program: "50_Projects/{ProgramName}/_PROGRAM.md"
  Project: "50_Projects/{year}/{folder}/"
  Task: "50_Projects/.../Tasks/"
  Hypothesis: "60_Hypotheses/{year}/"
  Experiment: "70_Experiments/"

  # 파일명 규칙: {entity_id}_{snake_case_name}.md
  # 예: prj-001_ontology_v0.1.md, hyp-001_loop_modeling.md

# ============================================
# Cross-Vault (Dual Vault 규칙)
# ============================================
cross_vault:
  # LOOP (Shared) - 이 vault
  shared:
    - Program        # 원칙/프로세스
    - Project        # 공개 정보만
    - Task           # stub (has_exec_details로 연결)

  # loop_exec (C-Level) - /Volumes/LOOP_CLevel/vault/loop_exec
  exec_only:
    - Candidate
    - TaskExecDetail
    - Retrospective

  # 연결 필드
  linking_fields:
    Task:
      - candidate_id      # → Candidate
      - has_exec_details  # boolean
    TaskExecDetail:
      - source_task       # → Task
      - source_vault      # "LOOP"

  # ============================================
  # Exec Vault ID 패턴 (SSOT v5.5 - Hash+Epoch)
  # ============================================
  # public vault와 절대 충돌하지 않는 ID 체계
  #
  # 핵심 규칙: exec vault에서 순차 번호(prj-NNN, tsk-NNN-NN) 절대 금지
  # Updated: Hash+Epoch based IDs (tsk-019-13)
  #
  exec_id_patterns:
    # 1. 민감 단독 프로젝트 (다온, 채용 후보 등)
    #    - Hash-based IDs with exec prefix
    standalone:
      project: "^prj-exec-[a-z0-9]{6}$"              # prj-exec-a7k9m2
      task: "^tsk-exec-[a-z0-9]{6}-\\d{13}$"         # tsk-exec-a7k9m2-1736412652123
      examples:
        - prj-exec-a7k9m2                   # 다온 영상편집자
        - tsk-exec-a7k9m2-1736412652123     # 다온 첫 연락

    # 2. Program Round 프로젝트 (지원사업, 채용 라운드 등)
    #    - Program 키워드 + Hash-based ID
    #    - Program은 public vault에 존재, Round는 exec에 존재
    program_round:
      project: "^prj-[a-z]{3,10}-[a-z0-9]{6}$"                    # prj-tips-a7k9m2, prj-grants-b3x8n1
      task: "^tsk-[a-z]{3,10}-[a-z0-9]{6}-\\d{13}$"               # tsk-primer-a7k9m2-1736412652123
      examples:
        - prj-tips-a7k9m2                   # TIPS 배치 - 프라이머
        - prj-tips-b3x8n1                   # TIPS 배치 - 아이디어파트너스
        - prj-grants-c9y2m5                 # 지원사업 - JEMI 디딤돌
        - prj-grants-d4k7p3                 # 지원사업 - 청년창업사관학교
        - tsk-primer-a7k9m2-1736412652123   # 프라이머 사업계획서 작성
        - tsk-grants-b3x8n1-1736412652456   # JEMI 정산증빙자료 수집

    # 3. 키워드 결정 규칙
    #    - Program: pgm-xxx → xxx (pgm- 제거)
    #    - Round: 프로젝트 고유 키워드 (예: primer, idp, jemi)
    keyword_rules:
      program_from: "pgm-{keyword} → {keyword}"
      round_examples:
        tips-batch:
          - primer      # 프라이머
          - idp         # 아이디어파트너스
          - spark       # 스파크
        grants:
          - jemi        # JEMI 디딤돌
          - youth       # 청년창업사관학교
        hiring:
          - daon        # 다온 (영상편집자)
          - freelancer  # 프리랜서 일반

    # 금지 패턴 (충돌 방지)
    forbidden:
      - "^prj-\\d{3}$"        # prj-017 금지 (public과 충돌)
      - "^tsk-\\d{3}-\\d{2}$" # tsk-017-01 금지 (public과 충돌)

# ============================================
# Role Rules (역할 분리 규칙)
# ============================================
# "레이어가 부족한 게 아니라 레이어의 책임이 흐려지는 것이 문제다"
role_rules:
  Hypothesis:
    allowed:
      - 질문 형태 ("?"로 끝남)
      - 검증 가능한 기준 명시
      - success/failure criteria
    forbidden:
      - 슬로건/선언문 형태
      - 모호한 목표
      - 기준 없는 희망사항

  Project:
    allowed:
      - Expected Impact 선언 (A)
      - Realized Impact 기록 (A')
      - 가설 검증 (validates)
    forbidden:
      - Impact 없는 작업 목록
      - 결과 없는 완료 처리
    note: "유일한 판정 단위"

  Task:
    allowed:
      - 단순 행동 기록
      - 완료/미완료 상태
      - 담당자/마감일
    forbidden:
      - 전략적 의미 기술
      - 점수/판정 기록
      - validates 관계 설정

  # 위험 신호 (이런 증상이 나타나면 역할이 섞인 것)
  warning_signs:
    - "Task에 '이 작업이 중요한 이유'를 쓰기 시작"
    - "Task에 validates 관계 설정"
    - "Project에 가설/Impact 없이 작업만 나열"
    - "Hypothesis가 질문이 아니라 슬로건"

# ============================================
# Entity Order (정렬 순서 - Graph Index용)
# ============================================
entity_order:
  - NorthStar
  - MetaHypothesis
  - Condition
  - Track
  - Program
  - Project
  - Task
  - Hypothesis
  - Experiment

# ============================================
# Status Mapping (Dashboard용 - Project/Legacy → Task 상태 매핑)
# ============================================
status_mapping:
  # Project status → Task status (Dashboard 표준화용)
  planning: todo
  doing: doing
  hold: hold
  cancelled: blocked
  # Legacy status (이전 데이터 호환용)
  active: doing      # deprecated → doing
  paused: hold       # deprecated → hold
  todo: todo         # deprecated → planning
  pending: todo
  in_progress: doing
  completed: done
  complete: done
  failed: blocked
  learning: done

# ============================================
# Impact (Project expected_impact용)
# ============================================
impact:
  tiers:
    - strategic     # 전략적
    - enabling      # 지원
    - operational   # 운영
    - none          # 영향 없음
  magnitudes:
    - high
    - mid
    - low

# ============================================
# Migration Rules (마이그레이션 규칙 - 참고용)
# ============================================
# Phase 1: Alias 추가
#   - 기존 파일에 aliases 필드 추가하여 기존 링크 유지
#   - 예: aliases: [PRJ-001, P3_Ontology_v0.1]
#
# Phase 2: 링크 점진적 변환
#   - 새 문서는 새 ID 형식 사용
#   - 기존 문서는 점진적 변환
#
# Phase 3: Alias 제거
#   - 3개월 후 aliases 제거 (모든 링크 변환 완료 후)

# ============================================
# Write Targets (API 수정 허용 필드 - SSOT)
# ============================================
# 이 섹션만이 API에서 어떤 필드를 수정할 수 있는지 결정합니다.
# 규칙: writable_fields[Entity] ⊆ known_fields[Entity]
# 새 필드 추가 시 이 파일만 수정하면 API가 자동으로 허용합니다.
write_targets:
  writable_fields:
    Task:
      # 기본 필드
      - status
      - assignee
      - due
      - priority
      - start_date
      - closed           # 완료일
      - estimated_hours
      - actual_hours
      - notes
      # 확장 필드 (Dashboard EditForm 지원)
      - entity_name      # 이름 변경
      - type             # 태스크 유형 (dev, strategy, research, ops)
      - links            # 링크 추가
      - pr_url           # GitHub PR URL
      - merged_commit    # 머지 커밋 해시
      - tags             # 태그
      - conditions_3y    # 전략 연결
      - project_id       # 프로젝트 변경
      - start_time       # 시작 시간 (Week view timeblock)
      - end_time         # 종료 시간 (Week view timeblock)
      - video_id         # YouTube video ID (Content OS Performance 연결)
    Project:
      # 기본 필드
      - status
      - owner
      - start_date
      - deadline
      - summary
      - project_kind           # 검증 단계 (signal | adoption | impact)
      - expected_impact
      - realized_impact
      - notes
      - conditions_3y          # 3년 조건 연결
      - condition_contributes  # 기여 조건
      - track_contributes      # 트랙 기여 연결
      # 확장 필드 (Dashboard EditForm 지원)
      - entity_name           # 이름 변경
      - parent_id             # Track 연결
      - program_id            # Program 연결
      - priority_flag         # 우선순위
      - validates             # 가설 검증 연결
      - primary_hypothesis_id # 주요 가설
      - links                 # 링크
      - attachments           # 첨부파일
      - tags                  # 태그
    Hypothesis:
      # 기본 필드
      - status
      - evidence_status
      - confidence
      - start_date
      - deadline
      - hypothesis_kind      # 검증 단계 (signal | adoption | impact)
      - notes
      # 확장 필드 (Dashboard EditForm 지원)
      - entity_name         # 이름 변경
      - parent_id           # Track 연결
      - hypothesis_question # 가설 질문
      - success_criteria    # 성공 기준
      - failure_criteria    # 실패 기준
      - measurement         # 측정 방법
      - horizon             # 시간 범위 (검증 목표 연도)
      - loop_layer          # Loop 레이어
      - tags                # 태그
      - parent_hypothesis_id  # 상위 가설 ID (hyp-*)

# ============================================
# Schema Version
# ============================================
schema_version: "5.16"
last_updated: "2026-01-27"
# v5.16 변경 (2026-01-27):
# - known_fields.Hypothesis에 parent_hypothesis_id 추가 (가설 간 위계 지원)
# - writable_fields.Hypothesis에 parent_hypothesis_id 추가
# - derived_fields.Hypothesis에 child_hypotheses 추가 (역인덱스 계산)
# - 가설 간 부모-자식 관계 표현 가능 (Cross-Track 허용, Flexible Kind)
# v5.15 변경 (2026-01-26):
# - known_fields.Task에 video_id 추가 (Content OS Performance 연결)
# - writable_fields.Task에 video_id 추가
# - YouTube 업로드 콘텐츠와 Task 1:1 매핑 지원
# v5.14 변경 (2026-01-21):
# - project_kind enum 추가 (signal | adoption | impact) - 프로젝트 검증 단계
# - hypothesis_kind enum 추가 (signal | adoption | impact) - 가설 검증 단계
# - known_fields.Project에 project_kind 추가
# - known_fields.Hypothesis에 hypothesis_kind 추가
# - writable_fields.Project에 project_kind 추가
# - writable_fields.Hypothesis에 hypothesis_kind 추가
# v5.13 변경 (2026-01-21):
# - known_fields.Task에 start_time, end_time 추가 (Week view timeblock 지원)
# - writable_fields.Task에 start_time, end_time 추가
# v5.12 변경 (2026-01-21):
# - writable_fields 대폭 확장 (Dashboard EditForm 필드 일치)
#   - Task: 9 → 17개 (entity_name, type, links, pr_url, merged_commit, tags, conditions_3y, project_id 추가)
#   - Project: 11 → 20개 (entity_name, parent_id, program_id, priority_flag, validates, primary_hypothesis_id, links, attachments, tags 추가)
#   - Hypothesis: 6 → 15개 (entity_name, parent_id, hypothesis_question, success_criteria, failure_criteria, measurement, horizon, loop_layer, tags 추가)
# - known_fields.Task에 pr_url, merged_commit 추가
# v5.10 변경 (2026-01-21):
# - Track.quarter_objectives 필드 추가 (분기별 측정 가능 목표)
#   - 맵 형태: {YYYYQN: {objective, kpi, target, owner?, evidence_link?}}
#   - 기존 quarters(배열)보다 대시보드/롤업/자동화에 적합
#   - 연도 확장 시 키만 추가 (2026Q1, 2027Q1 등)
# v5.9 변경 (2026-01-21):
# - Project.start_date 필드 추가
#   - 의미: "프로젝트 공식 시작일" (YYYY-MM-DD)
#   - created(생성일)와 구분: 문서 생성 ≠ 프로젝트 시작
# v5.8 변경 (2026-01-21):
# - Hypothesis.start_date 필드 추가
#   - 의미: "이 가설을 검증 대상으로 공식 채택한 날짜" (YYYY-MM-DD)
#   - created(생성일)와 구분: 문서 생성 ≠ 검증 시작
# v5.7 변경 (2026-01-17):
# - Project.summary 필드 추가 (1-2줄 프로젝트 요약, 리스트/hover용)
# v5.6 변경 (2026-01-13):
# - validation_rules.guardrails 섹션 추가 (Project parent_id 의미 고정)
# - Program.default_track_id, default_conditions_3y 필드 추가 (자동 채움용)
# - 3개 가드레일: parent_id 패턴(ERROR), conditions_3y 필수(ERROR), program_folder_match(WARNING)
# - SSOT v1.3 반영: parent_id는 Track만, program_id는 Program 별도 축
# v5.5 변경 (2026-01-12):
# - collaboration_fields 섹션 추가 (notes, links, attachments)
# - known_fields.all에 협업 필드 통합 (모든 엔티티 사용 가능)
# - field_structures.attachments 구조 정의
# - Project/Task 중복 필드 정의 제거 (links는 all로, notes/links는 Task에서 제거)
# - 모든 엔티티에서 협업 필드 사용 가능
# v5.4 변경:
# - cross_vault.exec_id_patterns 섹션 추가 (exec vault 전용 ID 체계 SSOT)
# - standalone 패턴: prj-exec-NNN, tsk-exec-NNN
# - program_round 패턴: prj-{program}-{round}, tsk-{keyword}-NN
# - 금지 패턴 명시: exec에서 prj-NNN, tsk-NNN-NN 사용 금지
# v5.3 변경:
# - Evidence 품질 메타 필드 7개 추가 (provenance, source_refs, sample_size, measurement_quality, counterfactual, confounders, query_version)
# - field_structures.evidence_quality_meta 구조 정의
# - LOOP_PHILOSOPHY 8.1 "Evidence 신뢰 구조" 반영
# v5.2 변경:
# - Evidence 엔티티 정식 등록 (entity_types, required_fields, known_fields)
# - Project.primary_hypothesis_id 필드 추가 (hypothesis_id deprecated)
# - validation_rules.derived_fields 섹션 추가 (저장 금지 필드 규칙)
# - Hypothesis.validated_by, Track/Condition.realized_sum은 빌드 시 계산
# v5.1 변경: contributes → condition_contributes + track_contributes 분리 (Option A)
# 이전 버전: schema_registry.md v4.1 → 이 파일로 통합
