# ============================================
# LOOP Schema Constants (Single Source of Truth)
# ============================================
# 이 파일을 수정하면 API 서버 rebuild 필요:
#   /mcp-server rebuild
#
# 참조하는 파일들:
#   - api/constants.py (Python)
#   - _dashboard/js/state.js (via API)
#   - CLAUDE.md (문서)
#
# 이 파일이 유일한 스키마 정의 소스입니다.
# schema_registry.md는 이 파일로 통합되어 삭제되었습니다.
#
# ============================================
# SSOT + Derived 원칙 (v5.2)
# ============================================
# 모든 데이터는 한 곳에만 저장(SSOT), 나머지는 계산(Derived)
#
# 1. Project ↔ Hypothesis 관계:
#    - SSOT: Project.validates = [hyp-...]
#    - Derived: Hypothesis.validated_by (역인덱스로 계산)
#
# 2. A/B Score + Window 롤업:
#    - SSOT: Project.realized_impact @ 월간 window
#    - Derived: Track.realized_sum @ 분기 (하위 Project B 집계)
#    - Derived: Condition.realized_sum @ 반기 (하위 Project B 집계)
#
# Track/Condition에 realized_impact 직접 저장 금지!
# → build_impact.py가 실행 시 Project B를 window로 묶어 계산

# ============================================
# Task
# ============================================
task:
  status:
    - todo      # 시작 전
    - doing     # 진행 중
    - hold      # 보류 (외부 의존성 대기 등)
    - done      # 완료
    - blocked   # 차단됨 (문제 발생)
  status_default: todo
  status_labels:
    todo: "To Do"
    doing: "Doing"
    hold: "Hold"
    done: "Done"
    blocked: "Blocked"
  status_colors:
    todo: "#6b7280"      # gray
    doing: "#3b82f6"     # blue
    hold: "#f59e0b"      # amber
    done: "#10b981"      # green
    blocked: "#ef4444"   # red
  # Task 유형 (dev Task 연동용)
  types:
    - dev        # 개발 작업 (신규 기능)
    - bug        # 버그 수정
    - strategy   # 전략 작업
    - research   # 리서치
    - ops        # 운영
  # 외부 프로젝트 (type=dev|bug일 때)
  target_projects:
    - sosi       # SoSi 앱
    - kkokkkok   # 꼭꼭 앱
    - loop-api   # LOOP API 서버
    - loop       # LOOP Vault 자체

# ============================================
# Project
# ============================================
project:
  status:
    - planning   # 기획 중
    - active     # 진행 중
    - paused     # 일시 중단
    - done       # 완료
    - cancelled  # 취소
  status_default: planning
  status_labels:
    planning: "Planning"
    active: "Active"
    paused: "Paused"
    done: "Done"
    cancelled: "Cancelled"
  status_colors:
    planning: "#6b7280"   # gray
    active: "#3b82f6"     # blue
    paused: "#f59e0b"     # amber
    done: "#10b981"       # green
    cancelled: "#ef4444"  # red

# ============================================
# Priority
# ============================================
priority:
  values:
    - critical  # 긴급
    - high      # 높음
    - medium    # 보통
    - low       # 낮음
  default: medium
  labels:
    critical: "Critical"
    high: "High"
    medium: "Medium"
    low: "Low"
  colors:
    critical: "#dc2626"  # red-600
    high: "#f97316"      # orange-500
    medium: "#eab308"    # yellow-500
    low: "#22c55e"       # green-500

# ============================================
# Entity Types
# ============================================
entity_types:
  - NorthStar
  - MetaHypothesis
  - Condition
  - Track
  - Program
  - Project
  - Task
  - Hypothesis
  - Experiment
  - Evidence      # v5.2 추가: 프로젝트 결과/학습 기록
  # loop_exec 전용
  - Candidate
  - TaskExecDetail
  - Retrospective

# ============================================
# Condition IDs (3Y 전략 조건)
# ============================================
condition_ids:
  - cond-a
  - cond-b
  - cond-c
  - cond-d
  - cond-e

# ============================================
# Program Types (상시 운영 프로그램)
# ============================================
program_types:
  - hiring         # 채용
  - fundraising    # 투자 유치
  - grants         # 지원사업
  - launch         # 런칭
  - experiments    # 실험
  - infrastructure # 인프라

# ============================================
# Risk Level
# ============================================
risk_level:
  values:
    - low
    - medium
    - high
    - critical
  default: medium

# ============================================
# Hypothesis (가설 상태)
# ============================================
hypothesis:
  evidence_status:
    - assumed      # 가정됨
    - validating   # 검증 중
    - validated    # 검증됨
    - falsified    # 반증됨
    - learning     # 학습 중

# ============================================
# NorthStar (북극성)
# ============================================
northstar:
  status:
    - fixed        # 고정됨 (변경 불가)

# ============================================
# Candidate (loop_exec 전용)
# ============================================
candidate:
  status:
    - screening    # 서류 심사
    - pilot        # 파일럿 진행
    - offer        # 오퍼 제안
    - hired        # 채용 완료
    - rejected     # 탈락
  verdict:
    - filtering_success
    - hired
    - offer_declined

# ============================================
# Retrospective (loop_exec 전용)
# ============================================
retrospective:
  verdict:
    - filtering_success
    - hired
    - failed

# ============================================
# Experiment
# ============================================
experiment:
  outcome:
    - positive
    - negative
    - inconclusive

# ============================================
# Paths (검증/인덱싱 대상 경로)
# ============================================
paths:
  # 검증 대상 폴더 (validate_schema.py, build_graph_index.py)
  include:
    - "01_North_Star"
    - "20_Strategy"
    - "50_Projects"
    - "60_Hypotheses"
    - "70_Experiments"
  # 제외 폴더
  exclude:
    - "00_Meta/_TEMPLATES"
    - "10_Study"
    - "30_Ontology"
    - "40_LOOP_OS"
    - "90_Archive"
    - "00_Inbox"
  # 제외 파일
  exclude_files:
    - "_INDEX.md"
    - "_ENTRY_POINT.md"
    - "CLAUDE.md"
    - "README.md"
    - "_HOME.md"
    - "_Graph_Index.md"

# ============================================
# ID Patterns (엔티티별 ID 정규식)
# ============================================
id_patterns:
  ns: "^ns-\\d{3}$"                                    # ns-001
  mh: "^mh-[1-4]$"                                     # mh-1 ~ mh-4
  cond: "^cond-[a-e]$"                                 # cond-a ~ cond-e
  trk: "^trk-[1-6]$"                                   # trk-1 ~ trk-6
  prj: "^prj-(\\d{3}|[a-z][a-z0-9-]+)$"               # prj-001 또는 prj-vault-gpt
  tsk: "^tsk-(\\d{3}-\\d{2}|[a-z][a-z0-9-]+-\\d{2})$" # tsk-001-01 또는 tsk-vault-gpt-01
  hyp: "^hyp-[1-6]-\\d{2}$"                            # hyp-1-01 (Track기반)
  exp: "^exp-\\d{3}$"                                  # exp-001
  pl: "^pl-[1-9]$"                                     # pl-1 ~ pl-9
  ps: "^ps-[1-9]$"                                     # ps-1 ~ ps-9
  pgm: "^pgm-[a-z][a-z0-9-]*$"                         # pgm-hiring
  retro: "^retro-\\d{3}-\\d{2}$"                       # retro-015-01
  cand: "^cand-\\d{3}$"                                # cand-001 (loop_exec)
  res: "^res-\\d{3}-\\d{2}$"                           # res-001-01
  status: "^status-[a-z-]+$"                           # status documents
  concept: "^concept-[a-z-]+$"                         # concept documents

# ============================================
# Required Fields (엔티티별 필수 필드)
# ============================================
required_fields:
  # 모든 엔티티 공통
  all:
    - entity_type
    - entity_id
    - entity_name
    - created
    - updated
    - status
  # 엔티티별 추가 필수 필드
  NorthStar: []
  MetaHypothesis:
    - if_broken
  Condition:
    - if_broken
  Track:
    - owner
    - horizon
    - conditions_3y
  Program:
    - program_type
    - owner
  Project:
    - owner
    - parent_id
    - conditions_3y
    - expected_impact
  Task:
    - assignee
    - project_id
    - parent_id
    - conditions_3y
  Hypothesis: []   # hypothesis_question OR hypothesis_text 별도 검증
  Experiment:
    - hypothesis_id
    - metrics
  # loop_exec 전용
  Candidate:
    - name
    - hiring_project
  TaskExecDetail:
    - source_task
    - source_project
    - source_vault
  Retrospective:
    - source_project
    - verdict
  Evidence:
    - project
    - normalized_delta
    - evidence_strength

# ============================================
# Known Fields (freshness check용 - 스키마에 정의된 필드)
# ============================================
known_fields:
  # 모든 엔티티 공통
  all:
    - entity_type
    - entity_id
    - entity_name
    - created
    - updated
    - status
    - parent_id
    - aliases
    - outgoing_relations
    - validates
    - validated_by
    - tags
    - priority_flag
    - conditions_3y
  # 엔티티별 추가 필드
  NorthStar: []
  MetaHypothesis:
    - if_broken
    - evidence_status
    - confidence
  Condition:
    - unlock
    - if_broken
    - metrics          # 구조: [{name, threshold, current, status}]
  Track:
    - horizon          # "12month" | "6month" | "3month"
    - hypothesis       # 핵심 가설 (텍스트)
    - focus            # [string]
    - owner
    - objectives       # 구조: [{metric, target, current, status}]
  Program:
    - program_type
    - owner
    - principles       # [string]
    - process_steps    # [string]
    - templates        # [string]
    - kpis             # 구조: [{name, description}]
    - exec_rounds_path # loop_exec 라운드 폴더 경로
  Project:
    - owner
    - budget           # number | null
    - deadline         # date | null
    - program_id       # 소속 프로그램 ID
    - cycle            # 사이클/라운드 (예: "2026Q1")
    - expected_impact  # 구조: {statement, metric, target}
    - realized_impact  # 구조: {verdict, outcome, evidence_links, decided, window_id, time_range, metrics_snapshot}
    - hypothesis_id           # deprecated → primary_hypothesis_id
    - primary_hypothesis_id   # 신규: 프로젝트 생성 근본 질문 (hyp-*)
    - experiments
    - hypothesis_text  # deprecated → expected_impact.statement
    - links            # 구조: [{label, url}]
    - condition_contributes  # 구조: [{to, weight, description}] - Condition 기여
    - track_contributes      # 구조: [{to, weight, description}] - Secondary Track 기여
  Task:
    - project_id
    - assignee
    - start_date
    - due
    - priority
    - estimated_hours
    - actual_hours
    - type             # dev | strategy | research | ops
    - target_project   # sosi | kkokkkok | loop-api | loop
    - candidate_id     # loop_exec 연결
    - has_exec_details # boolean
    - closed           # 완료일
    - archived_at      # 아카이브 이동일
    - closed_inferred  # updated | git_commit_date | today
    - notes
    - links            # 구조: [{label, url}]
  Hypothesis:
    - hypothesis_question  # 질문 형태 ("?"로 끝나야 함)
    - success_criteria     # 숫자/기간/표본 포함
    - failure_criteria     # 피벗/중단 기준
    - measurement          # 어디서/무엇을/어떻게
    - horizon              # 검증 목표 연도 (예: "2026")
    - deadline
    - evidence_status
    - confidence           # 0.0 ~ 1.0
    - loop_layer           # emotional | eating | habit | reward | autonomic
    - hypothesis_text      # deprecated → hypothesis_question
  Experiment:
    - hypothesis_id
    - protocol
    - metrics
    - start_date
    - end_date
    - result_summary
    - outcome              # positive | negative | inconclusive
  # loop_exec 전용
  Candidate:
    - name
    - github
    - position
    - hiring_project
    - pilot_project
    - related_tasks
    - retrospective
    - verdict
    - verdict_date
  TaskExecDetail:
    - source_task
    - source_project
    - source_vault         # "LOOP" 고정
  Retrospective:
    - source_project
    - candidate_id
    - verdict
    - verdict_date
    - signals              # [string] 핵심 판별 신호
    - system_updates       # [string] 시스템 개선 항목
  Evidence:
    - project                    # 필수: 연결된 Project ID
    - normalized_delta           # 필수: 목표 대비 달성률 (0.0 ~ 1.0)
    - evidence_strength          # 필수: strong | medium | weak
    - attribution_share          # 권장: 기여 비율 (default 1.0)
    - window_id                  # 권장: 평가 윈도우 ID
    - time_range                 # 권장: 평가 기간
    - impact_metric
    - learning_value
    - validated_hypotheses       # [hyp-*] 이 Evidence가 확증한 가설
    - falsified_hypotheses       # [hyp-*] 이 Evidence가 반증한 가설
    - confirmed_insights

# ============================================
# Field Structures (중첩 필드 구조 정의)
# ============================================
field_structures:
  # Condition.metrics
  metrics:
    fields:
      - name: string
      - threshold: string
      - current: "string | number"
      - status: string     # on_track | at_risk | failed

  # Track.objectives
  objectives:
    fields:
      - metric: string
      - target: string
      - current: "string | number"
      - status: string

  # Program.kpis
  kpis:
    fields:
      - name: string
      - description: string

  # Project.expected_impact
  expected_impact:
    fields:
      - statement: string  # "이 프로젝트가 성공하면 X가 증명된다"
      - metric: string
      - target: string

  # Project.realized_impact (v5.2 확장)
  realized_impact:
    fields:
      - verdict: string    # pending | go | no-go | pivot
      - outcome: string    # supported | rejected | inconclusive
      - evidence_links: "[string]"
      - decided: date      # 결정일 (YYYY-MM-DD)
      - window_id: string  # 평가 윈도우 ID (YYYY-MM | YYYY-QN | YYYY-HN | YYYY-WNN)
      - time_range: string # 평가 기간 (YYYY-MM-DD..YYYY-MM-DD)
      - metrics_snapshot: object  # 당시 지표 스냅샷 {metric_name: scalar_value}

  # Project/Task.links
  links:
    fields:
      - label: string
      - url: string        # https:// 또는 http://

  # Project.condition_contributes (Condition 기여 - 필수)
  condition_contributes:
    fields:
      - to: string         # cond-a ~ cond-e
      - weight: number     # 0.0 ~ 1.0, 합계 ≤ 1.0
      - description: string

  # Project.track_contributes (Secondary Track 기여 - 선택)
  # Primary Track = parent_id (암묵적 weight 1.0)
  # Secondary Track = 이 필드로 추가 기여 명시
  track_contributes:
    fields:
      - to: string         # trk-1 ~ trk-6
      - weight: number     # 0.0 ~ 1.0, 합계 ≤ 1.0
      - description: string

# ============================================
# Validation Rules (검증 규칙)
# ============================================
validation_rules:
  # Derived 필드 (저장 금지 - 빌드 시 역인덱스 계산)
  # 이 필드들에 값이 저장되어 있으면 경고
  derived_fields:
    Hypothesis:
      - validated_by         # Evidence에서 역인덱스 계산
    Track:
      - realized_sum         # 하위 Project B 집계 (build_impact.py)
    Condition:
      - realized_sum         # 하위 Project B 집계 (build_impact.py)

  # parent_id 참조 대상
  parent_references:
    MetaHypothesis: NorthStar
    Condition: MetaHypothesis
    Track: Condition
    Project: Track
    Task: Project
    Hypothesis: Track

  # 조건부 필수 필드
  conditional_required:
    Project:
      - field: realized_impact
        when: "status in [done, cancelled]"
    Task:
      - field: closed
        when: "status = done"
      - field: target_project
        when: "type in [dev, bug]"

  # 값 형식 규칙
  format_rules:
    Hypothesis:
      hypothesis_question: "must end with '?'"
    NorthStar:
      status: "must be 'fixed'"
    Program:
      status: "always 'doing' (닫지 않음)"

  # 금지 규칙
  forbidden:
    Task:
      - validates    # Task는 전략 판단에 개입하지 않음

# ============================================
# File Locations (파일 위치 규칙)
# ============================================
file_locations:
  # 기본 위치
  NorthStar: "01_North_Star/"
  MetaHypothesis: "01_North_Star/"
  Condition: "20_Strategy/3Y_Conditions_{period}/"
  Track: "20_Strategy/12M_Tracks/{year}/"
  Program: "50_Projects/{ProgramName}/_PROGRAM.md"
  Project: "50_Projects/{year}/{folder}/"
  Task: "50_Projects/.../Tasks/"
  Hypothesis: "60_Hypotheses/{year}/"
  Experiment: "70_Experiments/"

  # 파일명 규칙: {entity_id}_{snake_case_name}.md
  # 예: prj-001_ontology_v0.1.md, hyp-001_loop_modeling.md

# ============================================
# Cross-Vault (Dual Vault 규칙)
# ============================================
cross_vault:
  # LOOP (Shared) - 이 vault
  shared:
    - Program        # 원칙/프로세스
    - Project        # 공개 정보만
    - Task           # stub (has_exec_details로 연결)

  # loop_exec (C-Level) - /Volumes/LOOP_CLevel/vault/loop_exec
  exec_only:
    - Candidate
    - TaskExecDetail
    - Retrospective

  # 연결 필드
  linking_fields:
    Task:
      - candidate_id      # → Candidate
      - has_exec_details  # boolean
    TaskExecDetail:
      - source_task       # → Task
      - source_vault      # "LOOP"

# ============================================
# Role Rules (역할 분리 규칙)
# ============================================
# "레이어가 부족한 게 아니라 레이어의 책임이 흐려지는 것이 문제다"
role_rules:
  Hypothesis:
    allowed:
      - 질문 형태 ("?"로 끝남)
      - 검증 가능한 기준 명시
      - success/failure criteria
    forbidden:
      - 슬로건/선언문 형태
      - 모호한 목표
      - 기준 없는 희망사항

  Project:
    allowed:
      - Expected Impact 선언 (A)
      - Realized Impact 기록 (A')
      - 가설 검증 (validates)
    forbidden:
      - Impact 없는 작업 목록
      - 결과 없는 완료 처리
    note: "유일한 판정 단위"

  Task:
    allowed:
      - 단순 행동 기록
      - 완료/미완료 상태
      - 담당자/마감일
    forbidden:
      - 전략적 의미 기술
      - 점수/판정 기록
      - validates 관계 설정

  # 위험 신호 (이런 증상이 나타나면 역할이 섞인 것)
  warning_signs:
    - "Task에 '이 작업이 중요한 이유'를 쓰기 시작"
    - "Task에 validates 관계 설정"
    - "Project에 가설/Impact 없이 작업만 나열"
    - "Hypothesis가 질문이 아니라 슬로건"

# ============================================
# Entity Order (정렬 순서 - Graph Index용)
# ============================================
entity_order:
  - NorthStar
  - MetaHypothesis
  - Condition
  - Track
  - Program
  - Project
  - Task
  - Hypothesis
  - Experiment

# ============================================
# Status Mapping (Dashboard용 - Project/Legacy → Task 상태 매핑)
# ============================================
status_mapping:
  # Project status → Task status (Dashboard 표준화용)
  planning: todo
  active: doing
  paused: hold
  cancelled: blocked
  # Legacy/Alternative status
  pending: todo
  in_progress: doing
  completed: done
  complete: done
  failed: blocked
  learning: done

# ============================================
# Impact (Project expected_impact용)
# ============================================
impact:
  tiers:
    - strategic     # 전략적
    - enabling      # 지원
    - operational   # 운영
    - none          # 영향 없음
  magnitudes:
    - high
    - mid
    - low

# ============================================
# Migration Rules (마이그레이션 규칙 - 참고용)
# ============================================
# Phase 1: Alias 추가
#   - 기존 파일에 aliases 필드 추가하여 기존 링크 유지
#   - 예: aliases: [PRJ-001, P3_Ontology_v0.1]
#
# Phase 2: 링크 점진적 변환
#   - 새 문서는 새 ID 형식 사용
#   - 기존 문서는 점진적 변환
#
# Phase 3: Alias 제거
#   - 3개월 후 aliases 제거 (모든 링크 변환 완료 후)

# ============================================
# Schema Version
# ============================================
schema_version: "5.2"
last_updated: "2025-12-27"
# v5.2 변경:
# - Evidence 엔티티 정식 등록 (entity_types, required_fields, known_fields)
# - Project.primary_hypothesis_id 필드 추가 (hypothesis_id deprecated)
# - validation_rules.derived_fields 섹션 추가 (저장 금지 필드 규칙)
# - Hypothesis.validated_by, Track/Condition.realized_sum은 빌드 시 계산
# v5.1 변경: contributes → condition_contributes + track_contributes 분리 (Option A)
# 이전 버전: schema_registry.md v4.1 → 이 파일로 통합
