{
  "name": "LOOP Entity Validator & Auto-filler",
  "nodes": [
    {
      "parameters": {},
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [100, 500],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      }
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/strategy/context",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-strategy-context",
      "name": "Get Strategy Context",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [300, 500],
      "notes": "í•œ ë²ˆì˜ API í˜¸ì¶œë¡œ ì „ì²´ ì „ëµ ê³„ì¸µ (NorthStar, MH, Conditions, Tracks, Hypotheses) ì¡°íšŒ"
    },
    {
      "parameters": {
        "jsCode": "// Build Strategy Context Text for LLM prompts\n// ì „ëµ ê³„ì¸µì„ LLMì´ ì´í•´í•  ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ë¡œ ë³€í™˜\n\nconst input = $input.first().json;\n\nconst northstars = input.northstars || [];\nconst metahypotheses = input.metahypotheses || [];\nconst conditions = input.conditions || [];\nconst tracks = input.tracks || [];\nconst hypotheses = input.hypotheses || [];\n\n// Format as human-readable for LLM prompt\nconst strategyContextText = `\n## ì „ëµ ê³„ì¸µ (Strategy Hierarchy)\n\n### 10-year Vision (North Star)\n${northstars.map(ns => `- ${ns.entity_id}: ${ns.entity_name}`).join('\\n')}\n\n### Meta Hypotheses (MH1-4)\n${metahypotheses.map(mh => `- ${mh.entity_id}: ${mh.entity_name}\\n  - if_broken: ${mh.if_broken || 'N/A'}`).join('\\n')}\n\n### 3-year Conditions (cond-a ~ cond-e)\n${conditions.map(c => `- ${c.entity_id}: ${c.entity_name}\\n  - unlock: ${c.unlock || 'N/A'}\\n  - if_broken: ${c.if_broken || 'N/A'}`).join('\\n')}\n\n### 12-month Tracks (trk-1 ~ trk-6)\n${tracks.map(t => `- ${t.entity_id}: ${t.entity_name}\\n  - hypothesis: ${t.hypothesis || 'N/A'}\\n  - focus: ${(t.focus || []).join(', ')}\\n  - conditions_3y: ${(t.conditions_3y || []).join(', ')}`).join('\\n')}\n\n### Hypotheses (hyp-*)\n${hypotheses.slice(0, 15).map(h => `- ${h.entity_id}: ${h.entity_name}\\n  - question: ${h.hypothesis_question || h.hypothesis_text || 'N/A'}`).join('\\n')}\n${hypotheses.length > 15 ? `\\n... (${hypotheses.length - 15} more hypotheses)` : ''}\n`;\n\nreturn [{\n  json: {\n    strategyContext: {\n      northstars: northstars,\n      metahypotheses: metahypotheses,\n      conditions: conditions,\n      tracks: tracks,\n      hypotheses: hypotheses\n    },\n    strategyContextText: strategyContextText\n  }\n}];"
      },
      "id": "build-context",
      "name": "Build Strategy Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 500]
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/tasks",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-tasks",
      "name": "Get Tasks",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "// Phase 1: Task Schema Validation\n// - done/blocked ìƒíƒœëŠ” due_date ì²´í¬ ìŠ¤í‚µ\n// - missing_due_date, missing_assignee, missing_conditions_3yëŠ” LLMìœ¼ë¡œ\n// - v2: ì „ëµ ì»¨í…ìŠ¤íŠ¸ë¥¼ í”„ë¡¬í”„íŠ¸ì— í¬í•¨\n\nconst tasksInput = $input.first().json;\nconst contextInput = $('Build Strategy Context').first().json;\n\nconst tasks = tasksInput.tasks || [];\nconst strategyContextText = contextInput.strategyContextText || '';\nconst strategyContext = contextInput.strategyContext || {};\n\nconst results = [];\n\n// Valid values from schema_constants.yaml\nconst VALID_STATUS = ['todo', 'doing', 'hold', 'done', 'blocked'];\nconst VALID_PRIORITY = ['critical', 'high', 'medium', 'low'];\nconst VALID_TYPES = ['dev', 'strategy', 'research', 'ops', null];\nconst VALID_ASSIGNEES = ['ê¹€ì€í–¥', 'ì†Œìƒë¯¼'];\n\n// LLMì´ í•„ìš”í•œ ì´ìŠˆ ëª©ë¡\nconst LLM_REQUIRED_ISSUES = ['missing_conditions_3y', 'missing_due_date', 'missing_assignee'];\n\n// LLM í”„ë¡¬í”„íŠ¸ ë¹Œë” í•¨ìˆ˜\nfunction buildLlmPrompt(task, issues) {\n  const taskJson = JSON.stringify(task, null, 2);\n  const issueList = Array.isArray(issues) && issues.length > 0 ? issues.join(', ') : 'none';\n  \n  return `You are a LOOP Vault schema expert. Given the following Task entity and strategy context, suggest appropriate values for missing or invalid fields.\n\n${strategyContextText}\n\n---\n\n## Task to Validate\n\\`\\`\\`json\n${taskJson}\n\\`\\`\\`\n\n## Issues Detected\n${issueList}\n\n## Instructions\n\nFor conditions_3y, choose from:\n- cond-a: Product-Market Fit (ì œí’ˆ-ì‹œì¥ ì í•©ì„±)\n- cond-b: Revenue Model (ìˆ˜ìµ ëª¨ë¸)\n- cond-c: Scalability (í™•ì¥ì„±)\n- cond-d: Team (íŒ€)\n- cond-e: Tech/Infrastructure (ê¸°ìˆ /ì¸í”„ë¼)\n\nFor assignee, choose from: ${VALID_ASSIGNEES.join(', ')}\n\nFor due, suggest a reasonable date in YYYY-MM-DD format based on task complexity and current date (today is ${new Date().toISOString().split('T')[0]}).\n\nIMPORTANT: Analyze the task name (entity_name), notes, project_id, and tags to understand the task context. Match conditions_3y to the strategic area that this task contributes to.\n\nRespond with ONLY a valid JSON object (no markdown, no code blocks) with these fields:\n- suggested_fields: object with field names and suggested values\n- reasoning: object with field names and brief Korean explanation for each suggestion`;\n}\n\nfor (const task of tasks) {\n  const issues = [];\n  const suggestions = {};\n  const reasoning = {};\n\n  // Required field checks\n  if (!task.entity_id) {\n    issues.push('missing_entity_id');\n  }\n  if (!task.entity_name) {\n    issues.push('missing_entity_name');\n  }\n  if (!task.project_id) {\n    issues.push('missing_project_id');\n  }\n\n  // Status validation\n  if (task.status && !VALID_STATUS.includes(task.status)) {\n    issues.push('invalid_status');\n    suggestions.status = 'todo';\n    reasoning.status = `Invalid status \"${task.status}\". Defaulting to \"todo\".`;\n  }\n\n  // Priority validation\n  if (task.priority && !VALID_PRIORITY.includes(task.priority)) {\n    issues.push('invalid_priority');\n    suggestions.priority = 'medium';\n    reasoning.priority = `Invalid priority \"${task.priority}\". Defaulting to \"medium\".`;\n  }\n\n  // Type validation\n  if (task.type && !VALID_TYPES.includes(task.type)) {\n    issues.push('invalid_type');\n    suggestions.type = null;\n    reasoning.type = `Invalid type \"${task.type}\". Setting to null.`;\n  }\n\n  // conditions_3y validation (required for Tasks)\n  if (!task.conditions_3y || task.conditions_3y.length === 0) {\n    issues.push('missing_conditions_3y');\n    reasoning.conditions_3y = 'TaskëŠ” 3Y Condition ì—°ê²° í•„ìˆ˜. LLM ì¶”ë¡  í•„ìš”.';\n  }\n\n  // assignee check\n  if (!task.assignee) {\n    issues.push('missing_assignee');\n    reasoning.assignee = 'assignee ë¯¸ì§€ì •. ë§¥ë½ ê¸°ë°˜ ì¶”ë¡  í•„ìš”.';\n  }\n\n  // due date check - todo/doing ìƒíƒœë§Œ ì²´í¬ (done/blockedëŠ” ìŠ¤í‚µ)\n  const needsDueDate = ['todo', 'doing'].includes(task.status);\n  if (needsDueDate && !task.due && !task.due_date) {\n    issues.push('missing_due_date');\n    reasoning.due = 'due_date ë¯¸ì§€ì •. ë§¥ë½ ê¸°ë°˜ ì¶”ë¡  í•„ìš”.';\n  }\n\n  // ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°ë§Œ ê²°ê³¼ì— ì¶”ê°€\n  if (issues.length > 0) {\n    // LLM í•„ìš” ì—¬ë¶€ íŒë‹¨\n    const needsLlm = issues.some(issue => LLM_REQUIRED_ISSUES.includes(issue));\n    \n    // deterministic_fixesê°€ ë¹„ì–´ìˆê³  LLMë„ í•„ìš”ì—†ìœ¼ë©´ ìŠ¤í‚µ\n    const hasDeterministicFixes = Object.keys(suggestions).length > 0;\n    if (!needsLlm && !hasDeterministicFixes) {\n      continue; // ì˜ë¯¸ì—†ëŠ” pending ìƒì„± ë°©ì§€\n    }\n\n    const result = {\n      entity_id: task.entity_id,\n      entity_name: task.entity_name,\n      entity_type: 'Task',\n      phase: 'task_schema',\n      issues: issues,\n      deterministic_fixes: suggestions,\n      needs_llm: needsLlm,\n      has_deterministic_fixes: hasDeterministicFixes,\n      reasoning: reasoning,\n      original_entity: task\n    };\n    \n    // LLMì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ í”„ë¡¬í”„íŠ¸ ìƒì„±\n    if (needsLlm) {\n      result.llm_prompt = buildLlmPrompt(task, issues);\n    }\n    \n    results.push(result);\n  }\n}\n\nreturn results.map(r => ({ json: r }));"
      },
      "id": "validate-tasks",
      "name": "Validate Tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_llm === true && !!$json.llm_prompt }}",
              "value2": true
            }
          ]
        }
      },
      "id": "tasks-need-llm",
      "name": "Tasks Need LLM?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.OPENAI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "string",
        "body": "={{ JSON.stringify({ model: 'gpt-5.2', messages: [{ role: 'user', content: String($json.llm_prompt || '') }], temperature: 0.3 }) }}",
        "options": {}
      },
      "id": "call-openai-tasks",
      "name": "Call OpenAI (Tasks)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1300, 200],
      "notes": "HTTP Request node - expressions work correctly per item"
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM response for Tasks\nconst input = $input.first().json;\nconst validateData = $('Validate Tasks').first().json;\n\n// OpenAI API ì‘ë‹µ êµ¬ì¡°: choices[0].message.content\nconst llmResponse = input.choices?.[0]?.message?.content || '';\n\nlet parsed = { suggested_fields: {}, reasoning: {} };\n\ntry {\n  if (!llmResponse) {\n    throw new Error('Empty LLM response');\n  }\n  \n  // Extract JSON from response (handle markdown code blocks)\n  let jsonStr = llmResponse;\n  const jsonMatch = llmResponse.match(/```json\\n?([\\s\\S]*?)\\n?```/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[1];\n  } else {\n    const objMatch = llmResponse.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) jsonStr = objMatch[0];\n  }\n  parsed = JSON.parse(jsonStr);\n} catch (e) {\n  parsed = { \n    suggested_fields: {}, \n    reasoning: { error: `Failed to parse LLM response: ${e.message}` } \n  };\n}\n\nreturn [{\n  json: {\n    entity_id: validateData.entity_id,\n    entity_type: 'Task',\n    entity_name: validateData.entity_name,\n    phase: 'task_schema',\n    suggested_fields: parsed.suggested_fields || {},\n    reasoning: parsed.reasoning || {}\n  }\n}];"
      },
      "id": "parse-tasks-response",
      "name": "Parse Tasks Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/pending",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"entity_id\": $json.entity_id, \"entity_type\": $json.entity_type, \"entity_name\": $json.entity_name, \"phase\": $json.phase, \"suggested_fields\": $json.suggested_fields, \"reasoning\": $json.reasoning } }}",
        "options": {}
      },
      "id": "create-pending-tasks",
      "name": "Create Pending (Tasks)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1700, 200]
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/projects",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-projects",
      "name": "Get Projects",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 700]
    },
    {
      "parameters": {
        "jsCode": "// Phase 2: Project Schema Validation (v5.2)\n// - owner, parent_id (Track), conditions_3y í•„ìˆ˜\n// - primary_hypothesis_id, validates, condition_contributes, track_contributes LLM ì¶”ë¡ \n// - validated_byëŠ” derived í•„ë“œ â†’ ì œì•ˆí•˜ì§€ ì•ŠìŒ\n// - v3: Schema v5.2 ë°˜ì˜ (prj-impact-schema-v2)\n\nconst projectsInput = $input.first().json;\nconst contextInput = $('Build Strategy Context').first().json;\n\nconst projects = projectsInput.projects || [];\nconst strategyContextText = contextInput.strategyContextText || '';\nconst strategyContext = contextInput.strategyContext || {};\n\nconst results = [];\n\n// Valid values\nconst VALID_STATUS = ['planning', 'active', 'paused', 'done', 'cancelled'];\nconst VALID_PRIORITY = ['critical', 'high', 'medium', 'low'];\nconst VALID_OWNERS = ['ê¹€ì€í–¥', 'ì†Œìƒë¯¼'];\nconst VALID_CONDITION_IDS = ['cond-a', 'cond-b', 'cond-c', 'cond-d', 'cond-e'];\nconst VALID_TRACK_IDS = ['trk-1', 'trk-2', 'trk-3', 'trk-4', 'trk-5', 'trk-6'];\n\n// LLMì´ í•„ìš”í•œ ì´ìŠˆ ëª©ë¡ (v5.2: hypothesis_id â†’ primary_hypothesis_id, validates ì¶”ê°€)\nconst LLM_REQUIRED_ISSUES = [\n  'missing_owner', 'missing_parent_id', 'missing_conditions_3y',\n  'missing_primary_hypothesis_id', 'missing_validates',\n  'missing_condition_contributes', 'missing_track_contributes'\n];\n\n// LLM í”„ë¡¬í”„íŠ¸ ë¹Œë” í•¨ìˆ˜ (v5.2)\nfunction buildLlmPrompt(project, issues) {\n  const projectJson = JSON.stringify(project, null, 2);\n  const issueList = Array.isArray(issues) && issues.length > 0 ? issues.join(', ') : 'none';\n  \n  // Hypothesis ëª©ë¡ (LLMì´ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)\n  const hypothesesList = (strategyContext.hypotheses || []).map(h => \n    `- ${h.entity_id}: ${h.entity_name}`\n  ).join('\\n');\n  \n  return `You are a LOOP Vault schema expert (Schema v5.2). Given the following Project entity and strategy context, suggest appropriate values for missing or invalid fields.\n\n${strategyContextText}\n\n---\n\n## Project to Validate\n\\`\\`\\`json\n${projectJson}\n\\`\\`\\`\n\n## Issues Detected\n${issueList}\n\n## Instructions\n\n### For owner\nChoose from: ${VALID_OWNERS.join(', ')}\n\n### For parent_id (Track)\nChoose the primary Track this project belongs to:\n${VALID_TRACK_IDS.map(t => `- ${t}`).join('\\n')}\n\n### For conditions_3y\nList of 3Y Conditions this project contributes to (array):\n- cond-a: Product-Market Fit (ì œí’ˆ-ì‹œì¥ ì í•©ì„±)\n- cond-b: Revenue Model (ìˆ˜ìµ ëª¨ë¸)\n- cond-c: Scalability (í™•ì¥ì„±)\n- cond-d: Team (íŒ€)\n- cond-e: Tech/Infrastructure (ê¸°ìˆ /ì¸í”„ë¼)\n\n### For validates (optional but recommended) - v5.2\nArray of Hypothesis IDs this project validates.\nSelect from 60_Hypotheses:\n${hypothesesList}\nExample: [\"hyp-2-01\", \"hyp-2-03\"]\nIf no hypotheses to validate, set to empty array [].\n\n### For primary_hypothesis_id (optional) - v5.2\nThe MAIN hypothesis this project was created to validate.\nMust be one of the values in validates array, or null.\nâš ï¸ DEPRECATED: hypothesis_id - Use primary_hypothesis_id instead.\n\n### For condition_contributes (required) - v5.1\nArray of Condition contribution weights. Example:\n[\n  { \"to\": \"cond-a\", \"weight\": 0.6, \"description\": \"PMF ê²€ì¦ì— 60% ê¸°ì—¬\" },\n  { \"to\": \"cond-e\", \"weight\": 0.4, \"description\": \"ê¸°ìˆ  ì¸í”„ë¼ êµ¬ì¶•ì— 40% ê¸°ì—¬\" }\n]\n- Weights should sum to â‰¤ 1.0\n- Choose conditions based on what this project actually contributes to\n\n### For track_contributes (optional) - v5.1\nIf this project contributes to secondary Tracks (beyond parent_id), specify:\n[\n  { \"to\": \"trk-2\", \"weight\": 0.3, \"description\": \"ë°ì´í„° íŒŒì´í”„ë¼ì¸ì— ë¶€ë¶„ ê¸°ì—¬\" }\n]\n- Only include if the project genuinely contributes to other Tracks\n- Leave empty array [] if only primary Track\n\n### â›” NEVER suggest these derived fields (v5.2):\n- validated_by: computed from Evidence (ì—­ì¸ë±ìŠ¤ ê³„ì‚°)\n- realized_sum: computed from child Projects (í•˜ìœ„ ì§‘ê³„)\n\nIMPORTANT: Analyze the project name (entity_name), notes, and context to understand what this project is about. Match strategic elements based on actual project purpose.\n\nRespond with ONLY a valid JSON object (no markdown, no code blocks) with these fields:\n- suggested_fields: object with field names and suggested values\n- reasoning: object with field names and brief Korean explanation for each suggestion`;\n}\n\nfor (const project of projects) {\n  const issues = [];\n  const suggestions = {};\n  const reasoning = {};\n\n  // Required field checks\n  if (!project.entity_id) {\n    issues.push('missing_entity_id');\n  }\n  if (!project.entity_name) {\n    issues.push('missing_entity_name');\n  }\n\n  // Status validation\n  if (project.status && !VALID_STATUS.includes(project.status)) {\n    issues.push('invalid_status');\n    suggestions.status = 'planning';\n    reasoning.status = `Invalid status \"${project.status}\". Defaulting to \"planning\".`;\n  }\n\n  // owner check\n  if (!project.owner) {\n    issues.push('missing_owner');\n    reasoning.owner = 'owner ë¯¸ì§€ì •. ë§¥ë½ ê¸°ë°˜ ì¶”ë¡  í•„ìš”.';\n  }\n\n  // parent_id check (Track)\n  if (!project.parent_id) {\n    issues.push('missing_parent_id');\n    reasoning.parent_id = 'parent_id (Track) ë¯¸ì§€ì •. ë§¥ë½ ê¸°ë°˜ ì¶”ë¡  í•„ìš”.';\n  }\n\n  // conditions_3y validation\n  if (!project.conditions_3y || project.conditions_3y.length === 0) {\n    issues.push('missing_conditions_3y');\n    reasoning.conditions_3y = 'ProjectëŠ” 3Y Condition ì—°ê²° í•„ìˆ˜. LLM ì¶”ë¡  í•„ìš”.';\n  }\n\n  // validates check (v5.2 - optional but recommended)\n  if (!project.validates || project.validates.length === 0) {\n    issues.push('missing_validates');\n    reasoning.validates = 'validates ë¯¸ì§€ì •. ê²€ì¦í•˜ë ¤ëŠ” ê°€ì„¤ì´ ìˆë‹¤ë©´ ì—°ê²° ê¶Œì¥.';\n  }\n\n  // primary_hypothesis_id check (v5.2 - replaces hypothesis_id)\n  if (!project.primary_hypothesis_id && !project.hypothesis_id) {\n    issues.push('missing_primary_hypothesis_id');\n    reasoning.primary_hypothesis_id = 'primary_hypothesis_id ë¯¸ì§€ì •. validates ì¤‘ í•µì‹¬ ê°€ì„¤ 1ê°œ ì—°ê²° ê¶Œì¥.';\n  }\n\n  // condition_contributes check (required for impact calculation)\n  if (!project.condition_contributes || project.condition_contributes.length === 0) {\n    issues.push('missing_condition_contributes');\n    reasoning.condition_contributes = 'condition_contributes ë¯¸ì§€ì •. ê° Conditionì— ëŒ€í•œ ê¸°ì—¬ë„ í•„ìš”.';\n  }\n\n  // ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°ë§Œ ê²°ê³¼ì— ì¶”ê°€\n  if (issues.length > 0) {\n    const needsLlm = issues.some(issue => LLM_REQUIRED_ISSUES.includes(issue));\n    const hasDeterministicFixes = Object.keys(suggestions).length > 0;\n    \n    if (!needsLlm && !hasDeterministicFixes) {\n      continue;\n    }\n\n    const result = {\n      entity_id: project.entity_id,\n      entity_name: project.entity_name,\n      entity_type: 'Project',\n      phase: 'project_schema',\n      issues: issues,\n      deterministic_fixes: suggestions,\n      needs_llm: needsLlm,\n      has_deterministic_fixes: hasDeterministicFixes,\n      reasoning: reasoning,\n      original_entity: project\n    };\n    \n    if (needsLlm) {\n      result.llm_prompt = buildLlmPrompt(project, issues);\n    }\n    \n    results.push(result);\n  }\n}\n\nreturn results.map(r => ({ json: r }));"
      },
      "id": "validate-projects",
      "name": "Validate Projects",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 700]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_llm === true && !!$json.llm_prompt }}",
              "value2": true
            }
          ]
        }
      },
      "id": "projects-need-llm",
      "name": "Projects Need LLM?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 700]
    },
    {
      "parameters": {
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.OPENAI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "string",
        "body": "={{ JSON.stringify({ model: 'gpt-5.2', messages: [{ role: 'user', content: String($json.llm_prompt || '') }], temperature: 0.3 }) }}",
        "options": {}
      },
      "id": "call-openai-projects",
      "name": "Call OpenAI (Projects)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1300, 600]
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM response for Projects\nconst input = $input.first().json;\nconst validateData = $('Validate Projects').first().json;\n\nconst llmResponse = input.choices?.[0]?.message?.content || '';\n\nlet parsed = { suggested_fields: {}, reasoning: {} };\n\ntry {\n  if (!llmResponse) {\n    throw new Error('Empty LLM response');\n  }\n  \n  let jsonStr = llmResponse;\n  const jsonMatch = llmResponse.match(/```json\\n?([\\s\\S]*?)\\n?```/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[1];\n  } else {\n    const objMatch = llmResponse.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) jsonStr = objMatch[0];\n  }\n  parsed = JSON.parse(jsonStr);\n} catch (e) {\n  parsed = { \n    suggested_fields: {}, \n    reasoning: { error: `Failed to parse LLM response: ${e.message}` } \n  };\n}\n\nreturn [{\n  json: {\n    entity_id: validateData.entity_id,\n    entity_type: 'Project',\n    entity_name: validateData.entity_name,\n    phase: 'project_schema',\n    suggested_fields: parsed.suggested_fields || {},\n    reasoning: parsed.reasoning || {}\n  }\n}];"
      },
      "id": "parse-projects-response",
      "name": "Parse Projects Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 600]
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/pending",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"entity_id\": $json.entity_id, \"entity_type\": $json.entity_type, \"entity_name\": $json.entity_name, \"phase\": $json.phase, \"suggested_fields\": $json.suggested_fields, \"reasoning\": $json.reasoning } }}",
        "options": {}
      },
      "id": "create-pending-projects",
      "name": "Create Pending (Projects)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1700, 600]
    },
    {
      "parameters": {
        "jsCode": "// Phase 3: Project Impact Auto-fill (v5.2)\n// Filter projects that need expected_impact OR realized_impact\n// - expected_impact: ì—†ê±°ë‚˜ tierê°€ nullì¸ ê²½ìš°\n// - realized_impact: done/cancelled ìƒíƒœì¸ë° ì—†ëŠ” ê²½ìš°\n// - v3: Schema v5.2 ë°˜ì˜ (prj-impact-schema-v2)\n//   - contributes â†’ condition_contributes\n//   - track_contributes, validates, primary_hypothesis_id ì¶”ê°€\n//   - window_id, time_range, metrics_snapshot ì¶”ê°€\n\nconst projectsInput = $('Get Projects').first().json;\nconst contextInput = $('Build Strategy Context').first().json;\n\nconst projects = projectsInput.projects || [];\nconst strategyContextText = contextInput.strategyContextText || '';\nconst strategyContext = contextInput.strategyContext || {};\n\nconst results = [];\n\n// window_id ìë™ ê³„ì‚° í•¨ìˆ˜ (v5.2)\nfunction calculateWindowFields(decidedDate) {\n  const date = decidedDate ? new Date(decidedDate) : new Date();\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const window_id = `${year}-${month}`;\n  const lastDay = new Date(year, date.getMonth() + 1, 0).getDate();\n  const time_range = `${window_id}-01..${window_id}-${String(lastDay).padStart(2, '0')}`;\n  return { window_id, time_range };\n}\n\nfunction buildExpectedImpactPrompt(project) {\n  const projectJson = JSON.stringify(project, null, 2);\n  \n  // Hypothesis ëª©ë¡ (validates ì œì•ˆìš©)\n  const hypothesesList = (strategyContext.hypotheses || []).slice(0, 20).map(h => \n    `- ${h.entity_id}: ${h.entity_name}`\n  ).join('\\n');\n  \n  return `You are a LOOP Vault strategy expert (Schema v5.2). Given the following Project and strategy context, determine its expected strategic impact.\n\n${strategyContextText}\n\n---\n\n## Project to Analyze\n\\`\\`\\`json\n${projectJson}\n\\`\\`\\`\n\n## Instructions\n\nAnalyze this project and determine its expected_impact and related fields:\n\n### tier (required) - Project ë£¨íŠ¸ ë ˆë²¨\nChoose one:\n- strategic: ì „ëµì  ì˜í–¥ - í•µì‹¬ ê°€ì„¤ ê²€ì¦, ì¤‘ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ê²°ì •ì— ì˜í–¥\n- enabling: ì§€ì› ì˜í–¥ - ì „ëµì  í”„ë¡œì íŠ¸ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•¨\n- operational: ìš´ì˜ ì˜í–¥ - ì¼ìƒ ìš´ì˜ì— í•„ìš”\n- none: ì˜í–¥ ì—†ìŒ - ì‹¤í—˜ì ì´ê±°ë‚˜ í•™ìŠµ ëª©ì \n\n### impact_magnitude (required if tier != none) - Project ë£¨íŠ¸ ë ˆë²¨\nChoose one:\n- high: ë†’ì€ ì„íŒ©íŠ¸\n- mid: ì¤‘ê°„ ì„íŒ©íŠ¸\n- low: ë‚®ì€ ì„íŒ©íŠ¸\n\n### confidence (required) - Project ë£¨íŠ¸ ë ˆë²¨\nA number between 0.0 and 1.0 representing confidence in the impact assessment.\n\n### condition_contributes (required) - v5.1 í•„ë“œëª… ë³€ê²½\nArray of Condition contribution weights. Example:\n[\n  { \"to\": \"cond-a\", \"weight\": 0.6, \"description\": \"PMF ê²€ì¦ì— ê¸°ì—¬\" },\n  { \"to\": \"cond-e\", \"weight\": 0.3, \"description\": \"ê¸°ìˆ  ì¸í”„ë¼ì— ê¸°ì—¬\" }\n]\n- Weights should sum to â‰¤ 1.0\n\n### track_contributes (optional) - v5.1\nIf this project contributes to secondary Tracks (beyond parent_id):\n[\n  { \"to\": \"trk-2\", \"weight\": 0.3, \"description\": \"ë°ì´í„° íŒŒì´í”„ë¼ì¸ì— ë¶€ë¶„ ê¸°ì—¬\" }\n]\nLeave empty array [] if only primary Track.\n\n### validates (optional) - v5.2\nArray of Hypothesis IDs this project validates:\n${hypothesesList}\nExample: [\"hyp-2-01\", \"hyp-2-03\"]\n\n### primary_hypothesis_id (optional) - v5.2\nThe MAIN hypothesis (must be in validates array, or null).\n\n### expected_impact (required) - nested object\n{\n  \"statement\": \"ì´ í”„ë¡œì íŠ¸ê°€ ì„±ê³µí•˜ë©´ [ì¦ëª…ë  ê°€ì„¤]ì´ ì¦ëª…ëœë‹¤\",\n  \"metric\": \"í•µì‹¬ ì¸¡ì • ì§€í‘œëª…\",\n  \"target\": \"ëª©í‘œê°’ ë˜ëŠ” ì •ì„±ì  ê¸°ì¤€\"\n}\n\nBased on the project name, context, and strategic alignment, provide your assessment.\n\nRespond with ONLY a valid JSON object (no markdown, no code blocks):\n{\n  \"suggested_fields\": {\n    \"tier\": \"...\",\n    \"impact_magnitude\": \"...\",\n    \"confidence\": 0.X,\n    \"condition_contributes\": [...],\n    \"track_contributes\": [],\n    \"validates\": [...],\n    \"primary_hypothesis_id\": \"...\" or null,\n    \"expected_impact\": {\n      \"statement\": \"...\",\n      \"metric\": \"...\",\n      \"target\": \"...\"\n    }\n  },\n  \"reasoning\": {\n    \"tier\": \"...\",\n    \"condition_contributes\": \"...\",\n    \"validates\": \"...\"\n  }\n}`;\n}\n\nfunction buildRealizedImpactPrompt(project) {\n  const projectJson = JSON.stringify(project, null, 2);\n  const today = new Date().toISOString().split('T')[0];\n  const windowFields = calculateWindowFields(today);\n  \n  return `You are a LOOP Vault strategy expert (Schema v5.2). This Project is completed (${project.status}). Analyze its realized impact.\n\n${strategyContextText}\n\n---\n\n## Completed Project\n\\`\\`\\`json\n${projectJson}\n\\`\\`\\`\n\n## Instructions\n\nAnalyze this completed project and determine its realized_impact (v5.2 êµ¬ì¡°):\n\n### verdict (required) - ğŸ‘¤ ì‚¬ëŒ íŒë‹¨ í•„ìˆ˜ì´ë‚˜ LLM ì´ˆì•ˆ ê°€ëŠ¥\nChoose one:\n- go: ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ, ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰\n- no-go: ì‹¤íŒ¨ ë˜ëŠ” ì¤‘ë‹¨ ê²°ì •\n- pivot: ë°©í–¥ ì „í™˜ í•„ìš”\n- pending: ì•„ì§ í‰ê°€ ì¤‘ (í™•ì‹  ì—†ì„ ë•Œ ì´ê²ƒ ì„ íƒ)\n\n### outcome (required) - ğŸ‘¤ ì‚¬ëŒ íŒë‹¨ í•„ìˆ˜ì´ë‚˜ LLM ì´ˆì•ˆ ê°€ëŠ¥\nChoose one:\n- supported: ê°€ì„¤ì´ ì§€ì§€ë¨\n- rejected: ê°€ì„¤ì´ ë°˜ì¦ë¨\n- inconclusive: ê²°ë¡  ë¶ˆê°€ (í™•ì‹  ì—†ì„ ë•Œ ì´ê²ƒ ì„ íƒ)\n\n### evidence_links (optional)\nArray of evidence document links. Example: [\"[[ev:2025-0001]]\"]\nLeave empty if no evidence yet.\n\n### decided (required)\nDate of decision in YYYY-MM-DD format. Use today: ${today}\n\n### window_id (auto-calculated) - v5.2\nFormat: YYYY-MM (e.g., \"${windowFields.window_id}\")\nBased on decided date.\n\n### time_range (auto-calculated) - v5.2\nFormat: YYYY-MM-DD..YYYY-MM-DD (e.g., \"${windowFields.time_range}\")\nFull month range based on window_id.\n\n### metrics_snapshot (optional) - v5.2\nObject with key metrics at decision time. Example:\n{\n  \"completion_rate\": 0.85,\n  \"user_count\": 150\n}\nLeave empty {} if no metrics available.\n\nâš ï¸ NOTE: verdictì™€ outcomeì€ ì‚¬ëŒ íŒë‹¨ì´ í•„ìˆ˜ì…ë‹ˆë‹¤. LLMì€ ì´ˆì•ˆ/í…œí”Œë¦¿ë§Œ ì œê³µí•©ë‹ˆë‹¤.\ní™•ì‹ ì´ ì—†ìœ¼ë©´ verdict: \"pending\", outcome: \"inconclusive\"ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n\nRespond with ONLY a valid JSON object (no markdown, no code blocks):\n{\n  \"suggested_fields\": {\n    \"realized_impact\": {\n      \"verdict\": \"...\",\n      \"outcome\": \"...\",\n      \"evidence_links\": [],\n      \"decided\": \"${today}\",\n      \"window_id\": \"${windowFields.window_id}\",\n      \"time_range\": \"${windowFields.time_range}\",\n      \"metrics_snapshot\": {}\n    }\n  },\n  \"reasoning\": {\n    \"verdict\": \"...\",\n    \"outcome\": \"...\"\n  },\n  \"human_required\": [\"verdict\", \"outcome\", \"metrics_snapshot\"]\n}`;\n}\n\nfor (const project of projects) {\n  // Check if expected_impact is missing or incomplete\n  const needsExpectedImpact = !project.expected_impact || \n    !project.expected_impact.tier ||\n    project.expected_impact.tier === null ||\n    project.tier === null;\n  \n  // Check if realized_impact is needed (done/cancelled projects)\n  const isCompleted = ['done', 'cancelled'].includes(project.status);\n  const needsRealizedImpact = isCompleted && (!project.realized_impact || !project.realized_impact.verdict);\n  \n  if (needsExpectedImpact) {\n    results.push({\n      json: {\n        entity_id: project.entity_id,\n        entity_name: project.entity_name,\n        entity_type: 'Project',\n        phase: 'expected_impact',\n        needs_llm: true,\n        llm_prompt: buildExpectedImpactPrompt(project),\n        original_entity: project\n      }\n    });\n  }\n  \n  if (needsRealizedImpact) {\n    results.push({\n      json: {\n        entity_id: project.entity_id,\n        entity_name: project.entity_name,\n        entity_type: 'Project',\n        phase: 'realized_impact',\n        needs_llm: true,\n        llm_prompt: buildRealizedImpactPrompt(project),\n        original_entity: project\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "filter-impact-needed",
      "name": "Filter Impact Needed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 1000]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_llm === true && !!$json.llm_prompt }}",
              "value2": true
            }
          ]
        }
      },
      "id": "impact-need-llm",
      "name": "Impact Need LLM?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 1000]
    },
    {
      "parameters": {
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.OPENAI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "string",
        "body": "={{ JSON.stringify({ model: 'gpt-5.2', messages: [{ role: 'user', content: String($json.llm_prompt || '') }], temperature: 0.3 }) }}",
        "options": {}
      },
      "id": "call-openai-impact",
      "name": "Call OpenAI (Impact)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1100, 1000]
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM response for Impact\nconst input = $input.first().json;\nconst filterData = $('Filter Impact Needed').first().json;\n\nconst llmResponse = input.choices?.[0]?.message?.content || '';\n\nlet parsed = { suggested_fields: {}, reasoning: {} };\n\ntry {\n  if (!llmResponse) {\n    throw new Error('Empty LLM response');\n  }\n  \n  let jsonStr = llmResponse;\n  const jsonMatch = llmResponse.match(/```json\\n?([\\s\\S]*?)\\n?```/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[1];\n  } else {\n    const objMatch = llmResponse.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) jsonStr = objMatch[0];\n  }\n  parsed = JSON.parse(jsonStr);\n} catch (e) {\n  parsed = { \n    suggested_fields: {}, \n    reasoning: { error: `Failed to parse LLM response: ${e.message}` } \n  };\n}\n\nreturn [{\n  json: {\n    entity_id: filterData.entity_id,\n    entity_type: 'Project',\n    entity_name: filterData.entity_name,\n    phase: filterData.phase,\n    suggested_fields: parsed.suggested_fields || {},\n    reasoning: parsed.reasoning || {}\n  }\n}];"
      },
      "id": "parse-impact-response",
      "name": "Parse Impact Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 1000]
    },
    {
      "parameters": {
        "url": "https://mcp.sosilab.synology.me/api/pending",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.LOOP_API_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"entity_id\": $json.entity_id, \"entity_type\": $json.entity_type, \"entity_name\": $json.entity_name, \"phase\": $json.phase, \"suggested_fields\": $json.suggested_fields, \"reasoning\": $json.reasoning } }}",
        "options": {}
      },
      "id": "create-pending-impact",
      "name": "Create Pending (Impact)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1500, 1000]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          { "node": "Get Strategy Context", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get Strategy Context": {
      "main": [
        [
          { "node": "Build Strategy Context", "type": "main", "index": 0 }
        ]
      ]
    },
    "Build Strategy Context": {
      "main": [
        [
          { "node": "Get Tasks", "type": "main", "index": 0 },
          { "node": "Get Projects", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get Tasks": {
      "main": [
        [
          { "node": "Validate Tasks", "type": "main", "index": 0 }
        ]
      ]
    },
    "Validate Tasks": {
      "main": [
        [
          { "node": "Tasks Need LLM?", "type": "main", "index": 0 }
        ]
      ]
    },
    "Tasks Need LLM?": {
      "main": [
        [
          { "node": "Call OpenAI (Tasks)", "type": "main", "index": 0 }
        ],
        []
      ]
    },
    "Call OpenAI (Tasks)": {
      "main": [
        [
          { "node": "Parse Tasks Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Parse Tasks Response": {
      "main": [
        [
          { "node": "Create Pending (Tasks)", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get Projects": {
      "main": [
        [
          { "node": "Validate Projects", "type": "main", "index": 0 },
          { "node": "Filter Impact Needed", "type": "main", "index": 0 }
        ]
      ]
    },
    "Validate Projects": {
      "main": [
        [
          { "node": "Projects Need LLM?", "type": "main", "index": 0 }
        ]
      ]
    },
    "Projects Need LLM?": {
      "main": [
        [
          { "node": "Call OpenAI (Projects)", "type": "main", "index": 0 }
        ],
        []
      ]
    },
    "Call OpenAI (Projects)": {
      "main": [
        [
          { "node": "Parse Projects Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Parse Projects Response": {
      "main": [
        [
          { "node": "Create Pending (Projects)", "type": "main", "index": 0 }
        ]
      ]
    },
    "Filter Impact Needed": {
      "main": [
        [
          { "node": "Impact Need LLM?", "type": "main", "index": 0 }
        ]
      ]
    },
    "Impact Need LLM?": {
      "main": [
        [
          { "node": "Call OpenAI (Impact)", "type": "main", "index": 0 }
        ],
        []
      ]
    },
    "Call OpenAI (Impact)": {
      "main": [
        [
          { "node": "Parse Impact Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Parse Impact Response": {
      "main": [
        [
          { "node": "Create Pending (Impact)", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "entity-validator-autofiller-v3",
    "created": "2025-12-27",
    "updated": "2025-12-27",
    "schemaVersion": "5.2",
    "description": "Unified workflow for LOOP vault entity validation and auto-fill. v3: Schema v5.2 support (prj-impact-schema-v2). Changes: (1) contributes â†’ condition_contributes, (2) hypothesis_id â†’ primary_hypothesis_id, (3) validates array for hypothesis relationships, (4) realized_impact with window_id/time_range/metrics_snapshot, (5) derived fields warning (validated_by, realized_sum)."
  }
}
