<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOOP Strategy Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .header-meta {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f0f0f0;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 32px;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 24px 32px;
        }

        .tab-content.active {
            display: block;
        }

        /* ì´ˆê¸° í™”ë©´ */
        .init-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .init-screen h2 {
            font-size: 1.5em;
            margin-bottom: 16px;
            color: #333;
        }

        .init-screen p {
            color: #666;
            margin-bottom: 24px;
        }

        .init-screen .btn {
            font-size: 1.1em;
            padding: 14px 32px;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9em;
        }

        /* ì¹¸ë°˜ ë³´ë“œ */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .kanban-column {
            flex: 1;
            min-width: 300px;
            max-width: 350px;
            background: #f8f9fa;
            border-radius: 12px;
            border-top: 4px solid var(--column-color);
        }

        .column-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .column-title {
            font-weight: 600;
            font-size: 1em;
        }

        .column-count {
            background: var(--column-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .column-body {
            padding: 12px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .task-card {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .task-card.priority-high {
            border-left-color: #f44336;
        }

        .task-card.priority-medium {
            border-left-color: #FF9800;
        }

        .task-card.priority-low {
            border-left-color: #4CAF50;
        }

        .task-header {
            margin-bottom: 10px;
        }

        .task-name {
            font-weight: 600;
            font-size: 0.95em;
            display: block;
            margin-bottom: 4px;
            color: #333;
        }

        .task-id {
            font-size: 0.75em;
            color: #888;
            font-family: monospace;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .task-project {
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .project-link {
            color: #667eea;
            text-decoration: none;
        }

        .project-link:hover {
            text-decoration: underline;
        }

        .validates {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .validates-link {
            color: #f5576c;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .validates-link:hover {
            text-decoration: underline;
        }

        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag {
            font-size: 0.7em;
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 10px;
        }

        .empty-column {
            text-align: center;
            color: #999;
            padding: 24px;
            font-style: italic;
        }

        /* ì „ëµ ê³„ì¸µ */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .entity-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .entity-section h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 1.1em;
        }

        .entity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entity-item:hover {
            background: #e8f4fd;
            transform: translateX(4px);
        }

        .entity-name {
            font-weight: 500;
        }

        .entity-id {
            font-size: 0.8em;
            color: #888;
            font-family: monospace;
        }

        .entity-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            background: #e0e0e0;
        }

        /* í”„ë¡œì íŠ¸ ì„¹ì…˜ */
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .project-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }

        .project-title:hover {
            color: #667eea;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        .task-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-list-item:hover {
            background: #e8f4fd;
        }

        .status-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            color: white;
            border-radius: 10px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .tabs {
                padding: 0 16px;
                overflow-x: auto;
            }

            .tab {
                padding: 12px 16px;
                white-space: nowrap;
            }

            .tab-content {
                padding: 16px;
            }

            .kanban-board {
                flex-direction: column;
            }

            .kanban-column {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>LOOP Strategy Dashboard</h1>
            <div class="header-meta" id="headerMeta">Vaultì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshData()" id="refreshBtn" style="display:none;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-primary" onclick="selectFolder()" id="selectBtn">ğŸ“ Vault í´ë” ì„ íƒ</button>
        </div>
    </div>

    <div id="initScreen" class="init-screen">
        <h2>ğŸ“ Vault í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
        <p>LOOP vault í´ë”ë¥¼ ì„ íƒí•˜ë©´ ëŒ€ì‹œë³´ë“œê°€ ë¡œë“œë©ë‹ˆë‹¤.</p>
        <button class="btn btn-primary" onclick="selectFolder()">í´ë” ì„ íƒí•˜ê¸°</button>
        <div class="warning">
            âš ï¸ Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="mainContent" style="display:none;">
        <div class="tabs">
            <div class="tab active" onclick="showTab('kanban')">ğŸ“‹ Kanban Board</div>
            <div class="tab" onclick="showTab('strategy')">ğŸ¯ Strategy</div>
            <div class="tab" onclick="showTab('projects')">ğŸ“ Projects</div>
        </div>

        <div id="kanban" class="tab-content active">
            <div class="kanban-board" id="kanbanBoard"></div>
        </div>

        <div id="strategy" class="tab-content">
            <div class="strategy-grid" id="strategyGrid"></div>
        </div>

        <div id="projects" class="tab-content">
            <div id="projectsList"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let vaultHandle = null;
        let vaultName = 'LOOP';
        let entities = {};
        let members = {};
        let allEntitiesMap = {};
        let db = null;

        // IndexedDB ì´ˆê¸°í™”
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('LOOPDashboard', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('handles')) {
                        database.createObjectStore('handles');
                    }
                };
            });
        }

        // í•¸ë“¤ ì €ì¥
        async function saveHandle(handle) {
            if (!db) return;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('handles', 'readwrite');
                const store = tx.objectStore('handles');
                const request = store.put(handle, 'vaultHandle');
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // í•¸ë“¤ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHandle() {
            if (!db) return null;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('handles', 'readonly');
                const store = tx.objectStore('handles');
                const request = store.get('vaultHandle');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ì €ì¥ëœ í•¸ë“¤ë¡œ ì¬ì—°ê²° ì‹œë„
        async function tryReconnect() {
            try {
                const savedHandle = await loadHandle();
                if (!savedHandle) return false;

                // ê¶Œí•œ í™•ì¸
                const permission = await savedHandle.queryPermission({ mode: 'read' });
                if (permission === 'granted') {
                    vaultHandle = savedHandle;
                    vaultName = savedHandle.name;
                    await loadData();
                    showMainContent();
                    return true;
                }

                // ê¶Œí•œ ìš”ì²­ í•„ìš” - ì¬ì—°ê²° ë²„íŠ¼ í‘œì‹œ
                showReconnectScreen(savedHandle.name);
                return false;
            } catch (err) {
                console.log('ì¬ì—°ê²° ì‹¤íŒ¨:', err.message);
                return false;
            }
        }

        // ì¬ì—°ê²° í™”ë©´ í‘œì‹œ
        function showReconnectScreen(folderName) {
            document.getElementById('initScreen').innerHTML = `
                <h2>ğŸ“ ì´ì „ Vaultì— ì¬ì—°ê²°</h2>
                <p>ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©í•œ í´ë”: <strong>${folderName}</strong></p>
                <button class="btn btn-primary" onclick="reconnect()" style="margin-bottom: 12px;">ğŸ”— ì¬ì—°ê²°</button>
                <p style="font-size: 0.9em; color: #666;">ë˜ëŠ”</p>
                <button class="btn btn-secondary" onclick="selectFolder()" style="background: #e0e0e0; color: #333;">ğŸ“ ë‹¤ë¥¸ í´ë” ì„ íƒ</button>
                <div class="warning" style="margin-top: 16px;">
                    ğŸ’¡ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì¬ì—°ê²° í´ë¦­ì´ í•„ìš”í•©ë‹ˆë‹¤
                </div>
            `;
        }

        // ì¬ì—°ê²°
        async function reconnect() {
            try {
                const savedHandle = await loadHandle();
                if (!savedHandle) {
                    alert('ì €ì¥ëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                // ê¶Œí•œ ìš”ì²­
                const permission = await savedHandle.requestPermission({ mode: 'read' });
                if (permission === 'granted') {
                    vaultHandle = savedHandle;
                    vaultName = savedHandle.name;
                    await loadData();
                    showMainContent();
                } else {
                    alert('í´ë” ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('ì¬ì—°ê²° ì—ëŸ¬:', err);
                alert('ì¬ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í´ë”ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        }

        // ë©”ì¸ í™”ë©´ í‘œì‹œ
        function showMainContent() {
            document.getElementById('initScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('refreshBtn').style.display = 'inline-block';
            document.getElementById('selectBtn').textContent = 'ğŸ“ ë‹¤ë¥¸ Vault ì„ íƒ';
        }

        // í´ë” ì„ íƒ
        async function selectFolder() {
            try {
                vaultHandle = await window.showDirectoryPicker();
                vaultName = vaultHandle.name;
                await saveHandle(vaultHandle);  // IndexedDBì— ì €ì¥
                await loadData();
                showMainContent();
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('í´ë” ì„ íƒ ì—ëŸ¬:', err);
                    alert('í´ë” ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            if (!vaultHandle) return;
            await loadData();
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            entities = {
                NorthStar: [],
                MetaHypothesis: [],
                Condition: [],
                Track: [],
                Project: [],
                Task: [],
            };
            allEntitiesMap = {};

            // ë©¤ë²„ ë¡œë“œ
            await loadMembers();

            // ì—”í‹°í‹° ìŠ¤ìº”
            const scanFolders = ['01_North_Star', '20_Strategy', '50_Projects', '60_Hypotheses'];
            for (const folder of scanFolders) {
                await scanFolder(folder);
            }

            // entity_id -> entity ë§¤í•‘
            for (const [type, list] of Object.entries(entities)) {
                for (const entity of list) {
                    if (entity.entity_id) {
                        allEntitiesMap[entity.entity_id] = entity;
                    }
                }
            }

            // ë Œë”ë§
            renderKanban();
            renderStrategy();
            renderProjects();
            updateHeader();
        }

        // ë©¤ë²„ ë¡œë“œ
        async function loadMembers() {
            try {
                const metaHandle = await vaultHandle.getDirectoryHandle('00_Meta');
                const fileHandle = await metaHandle.getFileHandle('members.yaml');
                const file = await fileHandle.getFile();
                const content = await file.text();
                const data = parseYaml(content);
                if (data && data.members) {
                    for (const member of data.members) {
                        if (member.id) {
                            members[member.id] = member;
                        }
                    }
                }
            } catch (err) {
                console.log('members.yaml ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', err.message);
            }
        }

        // í´ë” ìŠ¤ìº”
        async function scanFolder(folderPath) {
            try {
                const parts = folderPath.split('/');
                let handle = vaultHandle;
                for (const part of parts) {
                    handle = await handle.getDirectoryHandle(part);
                }
                await scanDirectoryRecursive(handle, folderPath);
            } catch (err) {
                console.log(`í´ë” ìŠ¤ìº” ì‹¤íŒ¨ (${folderPath}):`, err.message);
            }
        }

        // ì¬ê·€ ë””ë ‰í† ë¦¬ ìŠ¤ìº”
        async function scanDirectoryRecursive(dirHandle, currentPath) {
            for await (const entry of dirHandle.values()) {
                const entryPath = `${currentPath}/${entry.name}`;

                if (entry.kind === 'directory') {
                    // ì œì™¸ í´ë” ì²´í¬
                    if (entry.name === '_TEMPLATES' || entry.name === 'Legacy') continue;
                    await scanDirectoryRecursive(entry, entryPath);
                } else if (entry.kind === 'file' && entry.name.endsWith('.md')) {
                    await processMarkdownFile(entry, entryPath);
                }
            }
        }

        // ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì²˜ë¦¬
        async function processMarkdownFile(fileHandle, filePath) {
            try {
                const file = await fileHandle.getFile();
                const content = await file.text();
                const frontmatter = extractFrontmatter(content);

                if (frontmatter && frontmatter.entity_type) {
                    frontmatter._file_path = filePath;
                    frontmatter._file_name = fileHandle.name.replace('.md', '');

                    if (entities[frontmatter.entity_type]) {
                        entities[frontmatter.entity_type].push(frontmatter);
                    }
                }
            } catch (err) {
                console.log(`íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨ (${filePath}):`, err.message);
            }
        }

        // Frontmatter ì¶”ì¶œ
        function extractFrontmatter(content) {
            const match = content.match(/^---\s*\n([\s\S]*?)\n---/);
            if (!match) return null;
            return parseYaml(match[1]);
        }

        // ê°„ë‹¨í•œ YAML íŒŒì„œ
        function parseYaml(yamlStr) {
            const result = {};
            const lines = yamlStr.split('\n');
            let currentKey = null;
            let currentArray = null;

            for (let line of lines) {
                // ì£¼ì„ ë¬´ì‹œ
                if (line.trim().startsWith('#')) continue;

                // ë°°ì—´ í•­ëª©
                if (line.match(/^\s+-\s+/)) {
                    const value = line.replace(/^\s+-\s+/, '').trim();
                    if (currentKey && result[currentKey]) {
                        // ê°ì²´ ë°°ì—´ì¸ì§€ ë‹¨ìˆœ ë°°ì—´ì¸ì§€ ì²´í¬
                        if (value.startsWith('type:') || value.startsWith('id:')) {
                            // ê°ì²´ ì‹œì‘
                            const obj = {};
                            const keyVal = value.split(':');
                            obj[keyVal[0].trim()] = keyVal.slice(1).join(':').trim().replace(/^["']|["']$/g, '');
                            result[currentKey].push(obj);
                        } else if (value.includes(':')) {
                            // ì´ì „ ê°ì²´ì— ì¶”ê°€
                            const lastObj = result[currentKey][result[currentKey].length - 1];
                            if (lastObj && typeof lastObj === 'object') {
                                const keyVal = value.split(':');
                                lastObj[keyVal[0].trim()] = keyVal.slice(1).join(':').trim().replace(/^["']|["']$/g, '');
                            }
                        } else {
                            result[currentKey].push(value.replace(/^["']|["']$/g, ''));
                        }
                    }
                    continue;
                }

                // í‚¤:ê°’ ìŒ
                const keyMatch = line.match(/^(\w+):\s*(.*)/);
                if (keyMatch) {
                    const key = keyMatch[1];
                    let value = keyMatch[2].trim();

                    // ë°°ì—´ ì‹œì‘
                    if (value === '' || value === '[]') {
                        result[key] = [];
                        currentKey = key;
                        continue;
                    }

                    // ì¸ë¼ì¸ ë°°ì—´
                    if (value.startsWith('[') && value.endsWith(']')) {
                        const items = value.slice(1, -1).split(',').map(s => s.trim().replace(/^["']|["']$/g, ''));
                        result[key] = items.filter(s => s);
                        currentKey = null;
                        continue;
                    }

                    // ì¼ë°˜ ê°’
                    value = value.replace(/^["']|["']$/g, '');
                    if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    else if (value === 'null') value = null;
                    else if (!isNaN(value) && value !== '') value = parseFloat(value);

                    result[key] = value;
                    currentKey = null;
                }
            }

            return result;
        }

        // ë©¤ë²„ í‘œì‹œëª… ê°€ì ¸ì˜¤ê¸°
        function getMemberDisplay(assigneeId) {
            if (members[assigneeId]) {
                const member = members[assigneeId];
                return `${member.icon || 'ğŸ‘¤'} ${member.name || assigneeId}`;
            }
            return `ğŸ‘¤ ${assigneeId}`;
        }

        // Obsidian URI ìƒì„±
        function getObsidianUri(filePath) {
            const encodedPath = encodeURIComponent(filePath);
            return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodedPath}`;
        }

        // íŒŒì¼ ì—´ê¸°
        function openFile(filePath) {
            window.location.href = getObsidianUri(filePath);
        }

        // ì¹¸ë°˜ ë Œë”ë§
        function renderKanban() {
            const board = document.getElementById('kanbanBoard');
            const tasks = entities.Task || [];

            const tasksByStatus = {
                todo: tasks.filter(t => t.status === 'todo'),
                doing: tasks.filter(t => t.status === 'doing'),
                done: tasks.filter(t => t.status === 'done'),
                blocked: tasks.filter(t => t.status === 'blocked'),
            };

            const columns = [
                { status: 'todo', emoji: 'ğŸ“‹', color: '#FF9800' },
                { status: 'doing', emoji: 'âš¡', color: '#2196F3' },
                { status: 'done', emoji: 'âœ…', color: '#4CAF50' },
                { status: 'blocked', emoji: 'ğŸš«', color: '#f44336' },
            ];

            board.innerHTML = columns.map(col => {
                const colTasks = tasksByStatus[col.status] || [];
                const cardsHtml = colTasks.map(task => renderTaskCard(task)).join('');

                return `
                    <div class="kanban-column" style="--column-color: ${col.color}">
                        <div class="column-header">
                            <span class="column-title">${col.emoji} ${col.status.toUpperCase()}</span>
                            <span class="column-count">${colTasks.length}</span>
                        </div>
                        <div class="column-body">
                            ${cardsHtml || '<div class="empty-column">No tasks</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Task ì¹´ë“œ ë Œë”ë§
        function renderTaskCard(task) {
            const name = task.entity_name || task._file_name || 'Unknown';
            const entityId = task.entity_id || '';
            const assigneeDisplay = getMemberDisplay(task.assignee || 'unassigned');
            const priority = task.priority || 'medium';
            const tags = task.tags || [];
            const due = task.due || '';
            const filePath = task._file_path || '';

            // Project ì •ë³´
            const projectId = task.project_id || '';
            const projectInfo = allEntitiesMap[projectId] || {};
            const projectName = projectInfo.entity_name || projectId;
            const projectPath = projectInfo._file_path || '';

            // validates ì •ë³´
            const validates = [];
            if (task.validates && Array.isArray(task.validates)) {
                for (const targetId of task.validates) {
                    const target = allEntitiesMap[targetId];
                    validates.push({
                        id: targetId,
                        name: target ? target.entity_name : targetId,
                        path: target ? target._file_path : '',
                    });
                }
            }

            const tagsHtml = tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('');

            let validatesHtml = '';
            if (validates.length > 0) {
                const links = validates.map(v =>
                    v.path
                        ? `<span class="validates-link" onclick="event.stopPropagation(); openFile('${v.path}')">${v.name}</span>`
                        : `<span class="validates-link">${v.name}</span>`
                ).join(' ');
                validatesHtml = `<div class="validates">validates: ${links}</div>`;
            }

            let projectHtml = '';
            if (projectId) {
                projectHtml = projectPath
                    ? `<div class="task-project">ğŸ“ <span class="project-link" onclick="event.stopPropagation(); openFile('${projectPath}')">${projectName}</span></div>`
                    : `<div class="task-project">ğŸ“ ${projectName}</div>`;
            }

            return `
                <div class="task-card priority-${priority}" onclick="openFile('${filePath}')">
                    <div class="task-header">
                        <span class="task-name">${name}</span>
                        <span class="task-id">${entityId}</span>
                    </div>
                    <div class="task-meta">
                        <span class="assignee">${assigneeDisplay}</span>
                        ${due ? `<span class="due">ğŸ“… ${due}</span>` : ''}
                    </div>
                    ${projectHtml}
                    ${validatesHtml}
                    <div class="task-tags">${tagsHtml}</div>
                </div>
            `;
        }

        // ì „ëµ ë Œë”ë§
        function renderStrategy() {
            const grid = document.getElementById('strategyGrid');

            const sections = [
                { type: 'NorthStar', title: 'North Star', emoji: 'ğŸ¯' },
                { type: 'MetaHypothesis', title: 'Meta Hypotheses', emoji: 'ğŸ”¬' },
                { type: 'Condition', title: 'Conditions', emoji: 'ğŸ“‹' },
                { type: 'Track', title: 'Tracks', emoji: 'ğŸ›¤ï¸' },
            ];

            grid.innerHTML = sections.map(section => {
                const items = entities[section.type] || [];
                if (items.length === 0) return '';

                const itemsHtml = items
                    .sort((a, b) => (a.entity_id || '').localeCompare(b.entity_id || ''))
                    .map(entity => {
                        const name = entity.entity_name || entity._file_name || 'Unknown';
                        const entityId = entity.entity_id || '';
                        const status = entity.status || '';
                        const filePath = entity._file_path || '';

                        return `
                            <div class="entity-item" onclick="openFile('${filePath}')">
                                <span class="entity-name">${name}</span>
                                <span>
                                    <span class="entity-id">${entityId}</span>
                                    ${status ? `<span class="entity-status">${status}</span>` : ''}
                                </span>
                            </div>
                        `;
                    }).join('');

                return `
                    <div class="entity-section">
                        <h3>${section.emoji} ${section.title}</h3>
                        <div class="entity-list">${itemsHtml}</div>
                    </div>
                `;
            }).join('');
        }

        // í”„ë¡œì íŠ¸ ë Œë”ë§
        function renderProjects() {
            const container = document.getElementById('projectsList');
            const projects = entities.Project || [];
            const tasks = entities.Task || [];

            if (projects.length === 0) {
                container.innerHTML = '<p style="color: #999;">No projects found.</p>';
                return;
            }

            container.innerHTML = projects
                .sort((a, b) => (a.entity_id || '').localeCompare(b.entity_id || ''))
                .map(project => {
                    const name = project.entity_name || project._file_name || 'Unknown';
                    const entityId = project.entity_id || '';
                    const filePath = project._file_path || '';
                    const trackId = project.track_id || '';
                    const trackInfo = allEntitiesMap[trackId] || {};
                    const trackName = trackInfo.entity_name || trackId;
                    const trackPath = trackInfo._file_path || '';

                    const projectTasks = tasks.filter(t => t.project_id === entityId);
                    const doneCount = projectTasks.filter(t => t.status === 'done').length;
                    const totalCount = projectTasks.length;
                    const progress = totalCount > 0 ? Math.round((doneCount / totalCount) * 100) : 0;

                    const statusColors = {
                        todo: '#FF9800',
                        doing: '#2196F3',
                        done: '#4CAF50',
                        blocked: '#f44336',
                    };

                    const tasksHtml = projectTasks
                        .sort((a, b) => {
                            const order = { doing: 0, todo: 1, blocked: 2, done: 3 };
                            return (order[a.status] || 4) - (order[b.status] || 4);
                        })
                        .map(task => {
                            const tName = task.entity_name || task._file_name || '';
                            const tStatus = task.status || 'todo';
                            const tAssignee = getMemberDisplay(task.assignee || 'unassigned');
                            const tPath = task._file_path || '';
                            const statusColor = statusColors[tStatus] || '#999';

                            return `
                                <div class="task-list-item" onclick="openFile('${tPath}')">
                                    <span>${tName}</span>
                                    <span style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 0.8em; color: #666;">${tAssignee}</span>
                                        <span class="status-badge" style="background: ${statusColor}">${tStatus}</span>
                                    </span>
                                </div>
                            `;
                        }).join('');

                    const trackHtml = trackPath
                        ? `<span class="project-link" onclick="event.stopPropagation(); openFile('${trackPath}')">${trackName}</span>`
                        : trackName || 'N/A';

                    return `
                        <div class="project-card">
                            <div class="project-header">
                                <div>
                                    <div class="project-title" onclick="openFile('${filePath}')">${name}</div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        <code>${entityId}</code> | Track: ${trackHtml}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9em; color: #666;">Tasks: ${doneCount}/${totalCount}</div>
                                    <div class="progress-bar" style="width: 120px;">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 12px;">
                                ${tasksHtml || '<p style="color: #999; font-style: italic;">No tasks</p>'}
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeader() {
            const taskCount = (entities.Task || []).length;
            const projectCount = (entities.Project || []).length;
            const now = new Date().toLocaleString('ko-KR');
            document.getElementById('headerMeta').textContent =
                `Vault: ${vaultName} | Tasks: ${taskCount} | Projects: ${projectCount} | Updated: ${now}`;
        }

        // íƒ­ ì „í™˜
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // File System Access API ì§€ì› ì²´í¬ ë° ì´ˆê¸°í™”
        async function init() {
            if (!('showDirectoryPicker' in window)) {
                document.getElementById('initScreen').innerHTML = `
                    <h2>âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €</h2>
                    <p>File System Access APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <div class="warning">
                        Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                    </div>
                `;
                return;
            }

            // IndexedDB ì´ˆê¸°í™” ë° ì¬ì—°ê²° ì‹œë„
            try {
                await initDB();
                await tryReconnect();
            } catch (err) {
                console.log('ì´ˆê¸°í™” ì—ëŸ¬:', err.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
